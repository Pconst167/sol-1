0001   0000             ; ------------------------------------------------------------------------------------------------------------------;
0002   0000             ; Solarium - Sol-1 Homebrew Minicomputer Operating System Kernel.
0003   0000             ; ------------------------------------------------------------------------------------------------------------------;
0004   0000             
0005   0000             ; memory map
0006   0000             ; ------------------------------------------------------------------------------------------------------------------;
0007   0000             ; 0000 ... 7fff - rom space
0008   0000             ; 8000 ... f7ff - ram space
0009   0000             ; f7ff          - stack root
0010   0000             
0011   0000             ; i/o map
0012   0000             ; ------------------------------------------------------------------------------------------------------------------;
0013   0000             ; ff80 - uart 0 (16550)
0014   0000             ; ff88 - uart 1 (16550)
0015   0000             ; ffa0 - rtc    (m48t02)
0016   0000             ; ffb0 - pio 0  (8255)
0017   0000             ; ffc0 - fdd    (5.25" floppy drive block)
0018   0000             ;   - ffc0      output port (377 flip-flop)                  
0019   0000             ;   - ffc1      input port  (244 buffer)                     
0020   0000             ;   - ffc8      wd1770 status/command    
0021   0000             ;   - ffc9      wd1770 track register
0022   0000             ;   - ffca      wd1770 sector register
0023   0000             ;   - ffcb      wd1770 data register
0024   0000             ;      
0025   0000             ; ffd0 - ide    (compact flash / pata)
0026   0000             ; ffe0 - timer  (8253)
0027   0000             ; fff0 - bios configuration nv-ram store area
0028   0000             ; ------------------------------------------------------------------------------------------------------------------;
0029   0000             
0030   0000             ; ------------------------------------------------------------------------------------------------------------------;
0031   0000             ; system constants
0032   0000             ; ------------------------------------------------------------------------------------------------------------------;
0033   0000             _uart0_data       .equ $ff80         ; data
0034   0000             _uart0_dlab_0     .equ $ff80         ; divisor latch low byte
0035   0000             _uart0_dlab_1     .equ $ff81         ; divisor latch high byte
0036   0000             _uart0_ier        .equ $ff81         ; interrupt enable register
0037   0000             _uart0_fcr        .equ $ff82         ; fifo control register
0038   0000             _uart0_lcr        .equ $ff83         ; line control register
0039   0000             _uart0_lsr        .equ $ff85         ; line status register
0040   0000             
0041   0000             _uart1_data       .equ $ff88         ; data
0042   0000             _uart1_dlab_0     .equ $ff88         ; divisor latch low byte
0043   0000             _uart1_dlab_1     .equ $ff89         ; divisor latch high byte
0044   0000             _uart1_ier        .equ $ff89         ; interrupt enable register
0045   0000             _uart1_fcr        .equ $ff8A         ; fifo control register
0046   0000             _uart1_lcr        .equ $ff8B         ; line control register
0047   0000             _uart1_lsr        .equ $ff8D         ; line status register
0048   0000             
0049   0000             _ide_base         .equ $ffd0         ; ide base
0050   0000             _ide_r0           .equ _ide_base + 0 ; data port
0051   0000             _ide_r1           .equ _ide_base + 1 ; read: error code, write: feature
0052   0000             _ide_r2           .equ _ide_base + 2 ; number of sectors to transfer
0053   0000             _ide_r3           .equ _ide_base + 3 ; sector address lba 0 [0:7]
0054   0000             _ide_r4           .equ _ide_base + 4 ; sector address lba 1 [8:15]
0055   0000             _ide_r5           .equ _ide_base + 5 ; sector address lba 2 [16:23]
0056   0000             _ide_r6           .equ _ide_base + 6 ; sector address lba 3 [24:27 (lsb)]
0057   0000             _ide_r7           .equ _ide_base + 7 ; read: status, write: command       
0058   0000             
0059   0000             _til311_display   .equ $ffb0         ; bios post code hex display (2 digits) (connected to pio a)
0060   0000             _bios_post_ctrl   .equ $ffb3         ; bios post display control register, 80h = as output
0061   0000             _pio_a            .equ $ffb0    
0062   0000             _pio_b            .equ $ffb1
0063   0000             _pio_c            .equ $ffb2
0064   0000             _pio_control      .equ $ffb3         ; pio control port
0065   0000             
0066   0000             _fdc_config       .equ $ffc0         ; 0 = select_0, 1 = select_1, 2 = side_select, 3 = dden, 4 = in_use_or_head_load, 5 = wd1770_rst
0067   0000             _fdc_status_0     .equ $ffc1         ; 0 = drq, 1 = ready
0068   0000             _fdc_stat_cmd     .equ $ffc8         ; status / command register
0069   0000             _fdc_track        .equ $ffc9         ; track register
0070   0000             _fdc_sector       .equ $ffca         ; sector register
0071   0000             _fdc_data         .equ $ffcb         ; data register
0072   0000             
0073   0000             _timer_c_0        .equ $ffe0         ; timer counter 0
0074   0000             _timer_c_1        .equ $ffe1         ; timer counter 1
0075   0000             _timer_c_2        .equ $ffe2         ; timer counter 2
0076   0000             _timer_ctrl       .equ $ffe3         ; timer control register
0077   0000             
0078   0000             _stack_top        .equ $f7ff         ; beginning of stack
0079   0000             _fifo_size        .equ 4096
0080   0000             
0081   0000             text_org                .equ $400          ; code origin address for all user processes
0082   0000             
0083   0000             block_bitmap_start      .equ 2048 * 2
0084   0000             block_bitmap_sec_start  .equ 8
0085   0000             inode_bitmap_start      .equ 2048 * 6
0086   0000             inode_bitmap_sect_start .equ 24
0087   0000             inode_table_start       .equ 2048 * 7
0088   0000             inode_table_sect_start  .equ 28 ; inode table starts at sector 28
0089   0000             data_blocks_start       .equ 2111488
0090   0000             data_blocks_sect_start  .equ 4124
0091   0000             
0092   0000             ;  ------------------------------------------------------------------------------------------------------------------;
0093   0000             ;  DISK LAYOUT:
0094   0000             ;  Metadata               | Size (bytes)      | Blocks (2048 bytes)              |Start Block |  Comment
0095   0000             ;  ---------------------- | ----------------- | -------------------------------- |------------|-----------------------------------
0096   0000             ;  Bootloader/MBR         | 1024 bytes        | 0.5 (1 sector)                   |  0         |
0097   0000             ;  Superblock             | 1024 bytes        | 1 block (2048 bytes, must align) |  0         |
0098   0000             ;                         |                   | 1 block (2048 bytes)             |  1         | reserved
0099   0000             ;  Block Bitmap           | 8,192 bytes       | 4 blocks                         |  2         | 4*2048*8 = 4*16384 = 65536 raw data blocks.  65536*2048 bytes = 134217728 bytes of disk space = 128MB
0100   0000             ;  Inode Bitmap           | 2,048 bytes       | 1 block                          |  6         | 2048*8=16384. total of 16384 bits, meaning 16384 inodes, which is 1 inode per 8KB of disk space
0101   0000             ;  Inode Table            | 2,097,152 bytes   | 1024 blocks                      |  7         | 128bytes per inode entry. 2097152 / 128 = 16384 inodes
0102   0000             ;  Data Blocks            | 134,217,728 bytes | 65528 blocks                     | 1031       | 65528 blocks = 134,201,344 bytes
0103   0000             ;  
0104   0000             ;  first 1024 bytes: bootloader from 0 to 959, MBR partition table from 960 (64 bytes)
0105   0000             ;  up to 4 partitions, each 16 bytes long
0106   0000             ;  MBR:
0107   0000             ;  Byte | Description
0108   0000             ;  -----|----------------------------
0109   0000             ;  0    | Boot flag (0x80 active, 0x00 inactive)
0110   0000             ;  1-3  | Start CHS (head, sector, cylinder)
0111   0000             ;  4    | Partition type (filesystem ID)
0112   0000             ;    0x83 = Linux native (ext2/3/4)
0113   0000             ;    0x07 = NTFS/exFAT
0114   0000             ;    0x0B = FAT32 CHS
0115   0000             ;    0x0C = FAT32 LBA
0116   0000             ;    0x05 = Extended partition
0117   0000             ;    0x86 = Sol-1 partition
0118   0000             ;  5-7  | End CHS
0119   0000             ;  8-11 | Start LBA (little endian)
0120   0000             ;  12-15| Size in sectors (little endian)
0121   0000             ;  
0122   0000             ;  
0123   0000             ;  the superblock describers the filesystem as a whole such as inode count, free inode count, location of the raw data bitmap, inode table, etc.  
0124   0000             ;  SUPERBLOCK:
0125   0000             ;  | Field               | Description                               | Typical Size (bytes) | Notes                           |
0126   0000             ;  | ------------------- | ----------------------------------------- | -------------------- | ------------------------------- |
0127   0000             ;  | inodes_count        | Total number of inodes in the filesystem  | 2                    | 16-bit unsigned int             |
0128   0000             ;  | blocks_count        | Total number of data blocks               | 2                    | 16-bit unsigned int             |
0129   0000             ;  | free_inodes_count   | Number of free inodes                     | 2                    | 16-bit unsigned int             |
0130   0000             ;  | free_blocks_count   | Number of free blocks                     | 2                    | 16-bit unsigned int             |
0131   0000             ;  | block_bitmap        | Block ID of the **block bitmap**          | 2                    | 16-bit unsigned int
0132   0000             ;  | inode_bitmap        | Block ID of the **inode bitmap**          | 2                    | 16-bit unsigned int
0133   0000             ;  | inode_table         | Starting block of **inode table**         | 2                    | 16-bit unsigned int
0134   0000             ;  | first_data_block    | Block number of the first data block      | 2                    | 16-bit unsigned int             |
0135   0000             ;  | used_dirs_count     | Number of inodes allocated to directories | 2
0136   0000             ;  | log_block_size      | Block size = 1024 << `s_log_block_size    | 2                    | 16-bit unsigned int             |
0137   0000             ;  | mtime               | Last mount time                           | 4                    | 32-bit unsigned int (Unix time) |
0138   0000             ;  | wtime               | Last write time                           | 4                    | 32-bit unsigned int (Unix time) |
0139   0000             ;  | uuid                | Unique ID of the filesystem               | 16                   | 128-bit UUID                    |
0140   0000             ;  | volume_name         | Label of the filesystem                   | 16                   | Usually ASCII, padded           |
0141   0000             ;  | feature_flags       | Compatibility flags                       | 4                    | 32-bit unsigned int             |
0142   0000             ;  
0143   0000             ;  inode for root dir is #2, #0 and #1 not used
0144   0000             ;  raw data block #0 is not used. because 0 as a block ID means not used
0145   0000             ;  block size: 2048
0146   0000             ;  inode-table format:
0147   0000             ;  | Field         | Size (bytes) | Description                                                                                  |
0148   0000             ;  | ------------- | ------------ | -------------------------------------------------------------------------------------------- |
0149   0000             ;  | `mode`        | 2            | File type and permissions                                                                    |
0150   0000             ;  | `uid`         | 2            | Owner user ID                                                                                |
0151   0000             ;  | `size`        | 4            | Size of the file in bytes                                                                    |
0152   0000             ;  | `atime`       | 4            | Last access time (timestamp)                                                                 |
0153   0000             ;  | `ctime`       | 4            | Creation time (timestamp)                                                                    |
0154   0000             ;  | `mtime`       | 4            | Last modification time (timestamp)                                                           |
0155   0000             ;  | `dtime`       | 4            | Deletion time (timestamp)                                                                    |
0156   0000             ;  | `gid`         | 2            | Group ID                                                                                     |
0157   0000             ;  | `links_count` | 2            | Number of hard links                                                                         |
0158   0000             ;  | `blocks`      | 2            | Number of 2048-byte blocks allocated                                                         |
0159   0000             ;  | `flags`       | 4            | File flags                                                                                   |
0160   0000             ;  | `block`       | 47 * 2 = 94  | Pointers to data blocks (47 direct only) 
0161   0000             ;
0162   0000             ;
0163   0000             ;  DIRECTORY ENTRY
0164   0000             ;  this is the structure for file entries inside a directory.
0165   0000             ;  2048 / 64 = 32 entries
0166   0000             ;
0167   0000             ;  each entry is 64 bytes wide
0168   0000             ;  uint16_t inode;      // Inode number (0 if entry is unused)
0169   0000             ;  char     name[62];   // File name (null terminated)
0170   0000             
0171   0000             
0172   0000             
0173   0000             ; ------------------------------------------------------------------------------------------------------------------;
0174   0000             ; global system variables
0175   0000             ; ------------------------------------------------------------------------------------------------------------------;
0176   0000             
0177   0000             ; ------------------------------------------------------------------------------------------------------------------;
0178   0000             ; irq table
0179   0000             ; highest priority at lowest address
0180   0000             ; ------------------------------------------------------------------------------------------------------------------;
0181   0000 30 00       .dw int_0_fdc
0182   0002 37 00       .dw int_1
0183   0004 38 00       .dw int_2
0184   0006 39 00       .dw int_3
0185   0008 3A 00       .dw int_4
0186   000A 3B 00       .dw int_5_uart1
0187   000C 5D 00       .dw int_6_timer
0188   000E 5E 00       .dw int_7_uart0
0189   0010             
0190   0010             ; ------------------------------------------------------------------------------------------------------------------;
0191   0010             ; kernel reset vector
0192   0010             ; ------------------------------------------------------------------------------------------------------------------;
0193   0010 61 04       .dw kernel_reset_vector
0194   0012             
0195   0012             ; ------------------------------------------------------------------------------------------------------------------;
0196   0012             ; exception vector table
0197   0012             ; total of 7 entries, starting at address $0012
0198   0012             ; ------------------------------------------------------------------------------------------------------------------;
0199   0012 CB 00       .dw trap_privilege
0200   0014 92 01       .dw trap_div_zero
0201   0016 9F 01       .dw trap_undef_opcode
0202   0018 00 00       .dw 0
0203   001A 00 00       .dw 0
0204   001C 00 00       .dw 0
0205   001E 00 00       .dw 0
0206   0020             
0207   0020             ; ------------------------------------------------------------------------------------------------------------------;
0208   0020             ; system call vector table
0209   0020             ; starts at address $0020
0210   0020             ; ------------------------------------------------------------------------------------------------------------------;
0211   0020 D7 00       .dw syscall_break
0212   0022 A0 01       .dw syscall_rtc
0213   0024 C3 02       .dw syscall_ide
0214   0026 83 03       .dw syscall_io
0215   0028 2E 04       .dw syscall_file_system
0216   002A D2 01       .dw syscall_datetime
0217   002C BF 00       .dw syscall_reboot
0218   002E 8B 00       .dw syscall_system
0219   0030             
0220   0030             ; ------------------------------------------------------------------------------------------------------------------;
0221   0030             ; system call aliases
0222   0030             ; ------------------------------------------------------------------------------------------------------------------;
0223   0030             sys_break            .equ 0
0224   0030             sys_rtc              .equ 1
0225   0030             sys_ide              .equ 2
0226   0030             sys_io               .equ 3
0227   0030             sys_filesystem       .equ 4
0228   0030             sys_datetime         .equ 5
0229   0030             sys_reboot           .equ 6
0230   0030             sys_system           .equ 7
0231   0030             sys_fdc              .equ 8
0232   0030             
0233   0030             ; ------------------------------------------------------------------------------------------------------------------;
0234   0030             ; alias exports
0235   0030             ; ------------------------------------------------------------------------------------------------------------------;
0236   0030             .export text_org
0237   0030             .export sys_break
0238   0030             .export sys_rtc
0239   0030             .export sys_ide
0240   0030             .export sys_io
0241   0030             .export sys_filesystem
0242   0030             .export sys_datetime
0243   0030             .export sys_reboot
0244   0030             .export sys_system
0245   0030             .export sys_fdc
0246   0030             
0247   0030             .export _til311_display
0248   0030             
0249   0030             .export _fdc_config        
0250   0030             .export _fdc_status_0      
0251   0030             .export _fdc_stat_cmd     
0252   0030             
0253   0030             ; ------------------------------------------------------------------------------------------------------------------;
0254   0030             ; irqs' code block
0255   0030             ; ------------------------------------------------------------------------------------------------------------------;
0256   0030             ; 5.25" floppy drive controller irq
0257   0030             int_0_fdc:
0258   0030 3B 27 0E      mov d, s_fdc_irq
0259   0033 07 B8 06      call _puts
0260   0036 06            sysret
0261   0037             int_1:
0262   0037 06            sysret
0263   0038             int_2:
0264   0038 06            sysret
0265   0039             int_3:
0266   0039 06            sysret
0267   003A             int_4:
0268   003A 06            sysret
0269   003B             
0270   003B             ; ------------------------------------------------------------------------------------------------------------------;
0271   003B             ; uart1 interrupt
0272   003B             ; ------------------------------------------------------------------------------------------------------------------;
0273   003B             int_5_uart1:
0274   003B D7            push a
0275   003C DA            push d
0276   003D E1            pushf
0277   003E 1D 88 FF      mov al, [_uart1_data]       ; get character
0278   0041               ;mov [[d]], al              ; TODO: implement this double indirection instruction
0279   0041 3B EB 0B      mov d, fifo_in
0280   0044 FD 2A         mov d, [d]
0281   0046 3E            mov [d], al                 ; add to fifo
0282   0047 13            mov a, d
0283   0048 77            inc a
0284   0049 AF 79 1E      cmp a, fifo + _fifo_size     ; check if pointer reached the end of the fifo
0285   004C C7 52 00      jne int_5_continue
0286   004F 10 79 0E      mov a, fifo  
0287   0052             int_5_continue:  
0288   0052 42 EB 0B      mov [fifo_in], a            ; update fifo pointer
0289   0055 1A            mov al, ah
0290   0056 3D B0 FF      mov [_til311_display], al
0291   0059 EE            popf
0292   005A E7            pop d
0293   005B E4            pop a  
0294   005C 06            sysret
0295   005D             
0296   005D             ; ------------------------------------------------------------------------------------------------------------------;
0297   005D             ; timer irq
0298   005D             ; ------------------------------------------------------------------------------------------------------------------;
0299   005D             int_6_timer:  
0300   005D 06            sysret
0301   005E             
0302   005E             ; ------------------------------------------------------------------------------------------------------------------;
0303   005E             ; uart0 interrupt
0304   005E             ; ------------------------------------------------------------------------------------------------------------------;
0305   005E             int_7_uart0:
0306   005E D7            push a
0307   005F DA            push d
0308   0060 E1            pushf
0309   0061 1D 80 FF      mov al, [_uart0_data]       ; get character
0310   0064               ;mov [[d]], al              ; TODO: implement this double indirection instruction
0311   0064 3B EB 0B      mov d, fifo_in
0312   0067 FD 2A         mov d, [d]
0313   0069 3E            mov [d], al                 ; add to fifo
0314   006A 13            mov a, d
0315   006B 77            inc a
0316   006C AF 79 1E      cmp a, fifo + _fifo_size     ; check if pointer reached the end of the fifo
0317   006F C7 75 00      jne int_7_continue
0318   0072 10 79 0E      mov a, fifo  
0319   0075             int_7_continue:  
0320   0075 42 EB 0B      mov [fifo_in], a            ; update fifo pointer
0321   0078 1A            mov al, ah
0322   0079 3D B0 FF      mov [_til311_display], al
0323   007C EE            popf
0324   007D E7            pop d
0325   007E E4            pop a  
0326   007F 06            sysret
0327   0080             
0328   0080             sys_mkfs:
0329   0080 06            sysret
0330   0081             
0331   0081             ; ------------------------------------------------------------------------------------------------------------------;
0332   0081             ; system syscalls
0333   0081             ; ------------------------------------------------------------------------------------------------------------------;
0334   0081             system_jmptbl:
0335   0081 B7 00         .dw system_uname
0336   0083 BE 00         .dw system_whoami
0337   0085 91 00         .dw system_poke
0338   0087 94 00         .dw system_bootloader_install
0339   0089 8F 00         .dw system_peek
0340   008B             syscall_system:
0341   008B FD 0A 81 00   jmp [system_jmptbl + al]
0342   008F             
0343   008F             ; param register address in register d
0344   008F             ; param value in register bl
0345   008F             system_peek:
0346   008F 32            mov bl, [d]
0347   0090 06            sysret
0348   0091             
0349   0091             ; param register address in register d
0350   0091             ; param value in register bl
0351   0091             system_poke:
0352   0091 FD 3E         mov [d], bl
0353   0093 06            sysret
0354   0094             
0355   0094             ; kernel LBA address in 'b'
0356   0094             system_bootloader_install:
0357   0094 D8            push b
0358   0095 26 00 00      mov b, 0
0359   0098 38 00 00      mov c, 0
0360   009B 22 01         mov ah, $01                 ; 1 sector
0361   009D 3B 79 20      mov d, transient_area
0362   00A0 07 F2 02      call ide_read_sect          ; read sector
0363   00A3 E5            pop b
0364   00A4 FD 44 FE 01   mov [d + 510], b            ; update LBA address
0365   00A8 26 00 00      mov b, 0
0366   00AB 38 00 00      mov c, 0
0367   00AE 22 01         mov ah, $01                 ; 1 sector
0368   00B0 3B 79 20      mov d, transient_area
0369   00B3 07 18 03      call ide_write_sect         ; write sector
0370   00B6 06            sysret
0371   00B7             
0372   00B7             system_uname:
0373   00B7 3B FC 0B      mov d, s_uname
0374   00BA 07 B8 06      call _puts
0375   00BD 06            sysret
0376   00BE             
0377   00BE             system_whoami:
0378   00BE 06            sysret
0379   00BF             
0380   00BF             ; reboot system
0381   00BF             syscall_reboot:
0382   00BF FD D7 FF FF   push word $ffff 
0383   00C3 FD DB 00      push byte %00000000             ; dma_ack = 0, interrupts disabled, mode = supervisor, paging = off, halt=0, display_reg_load=0, dir=0
0384   00C6 FD D7 90 01   push word bios_reset_vector     ; and then push reset vector of the shell to the stack
0385   00CA 06            sysret
0386   00CB             
0387   00CB             
0388   00CB             ; ------------------------------------------------------------------------------------------------------------------;
0389   00CB             ; exceptions code block
0390   00CB             ; ------------------------------------------------------------------------------------------------------------------;
0391   00CB             ; privilege exception
0392   00CB             ; ------------------------------------------------------------------------------------------------------------------;
0393   00CB             trap_privilege:
0394   00CB 0A BF 00      jmp syscall_reboot
0395   00CE DA            push d
0396   00CF 3B 14 0D      mov d, s_priviledge
0397   00D2 07 B8 06      call _puts
0398   00D5 E7            pop d
0399   00D6 06            sysret
0400   00D7             
0401   00D7             ; ------------------------------------------------------------------------------------------------------------------;
0402   00D7             ; breakpoint
0403   00D7             ; important: values in the stack are being pushed in big endian. i.e.: msb at low address
0404   00D7             ; and lsb at high address. *** need to correct this in the microcode and make it little endian again ***
0405   00D7             ; ------------------------------------------------------------------------------------------------------------------;
0406   00D7             syscall_break:
0407   00D7 4B            pusha
0408   00D8             syscall_break_prompt:
0409   00D8 3B 46 0D      mov d, s_break1
0410   00DB 07 B8 06      call _puts
0411   00DE 07 65 06      call printnl
0412   00E1 07 BA 07      call scan_u16d
0413   00E4 AF 00 00      cmp a, 0
0414   00E7 C6 F2 00      je syscall_break_regs
0415   00EA AF 01 00      cmp a, 1
0416   00ED C6 15 01      je syscall_break_mem
0417   00F0             syscall_break_end:  
0418   00F0 4C            popa
0419   00F1 06            sysret
0420   00F2             syscall_break_regs:
0421   00F2 48            mov a, sp
0422   00F3 53 0E 00      add a, 14               ; back-track 7 registers
0423   00F6 3C            mov d, a
0424   00F7 3A 07         mov cl, 7
0425   00F9             syscall_regs_l0:
0426   00F9 2A            mov b, [d]
0427   00FA FD AB         swp b
0428   00FC 07 14 07      call print_u16x         ; print register value
0429   00FF 07 65 06      call printnl
0430   0102 63 02 00      sub d, 2
0431   0105 71 01         sub cl, 1
0432   0107 C3 00         cmp cl, 0
0433   0109 C7 F9 00      jne syscall_regs_l0
0434   010C 0A D8 00      jmp syscall_break_prompt
0435   010F 07 65 06      call printnl
0436   0112 0A D8 00      jmp syscall_break_prompt
0437   0115             syscall_break_mem:
0438   0115 07 65 06      call printnl
0439   0118 07 36 07      call scan_u16x
0440   011B 4D            mov si, a               ; data source from user space
0441   011C FD 4F 79 1E   mov di, scrap_sector    ; destination in kernel space
0442   0120 38 00 02      mov c, 512
0443   0123 04            load                    ; transfer data to kernel space!
0444   0124 3B 79 1E      mov d, scrap_sector     ; dump pointer in d
0445   0127 38 00 00      mov c, 0
0446   012A             dump_loop:
0447   012A 84            mov al, cl
0448   012B 87 0F         and al, $0f
0449   012D C6 7B 01      jz print_base
0450   0130             back:
0451   0130 1E            mov al, [d]             ; read byte
0452   0131 2F            mov bl, al
0453   0132 07 58 07      call print_u8x
0454   0135 10 00 20      mov a, $2000
0455   0138 05 03         syscall sys_io          ; space
0456   013A 84            mov al, cl
0457   013B 87 0F         and al, $0f
0458   013D B9 0F         cmp al, $0f
0459   013F C6 50 01      je print_ascii
0460   0142             back1:
0461   0142 79            inc d
0462   0143 78            inc c
0463   0144 C2 00 02      cmp c, 512
0464   0147 C7 2A 01      jne dump_loop
0465   014A 07 65 06      call printnl
0466   014D 0A D8 00      jmp syscall_break_prompt  ; go to syscall_break return point
0467   0150             print_ascii:
0468   0150 10 00 20      mov a, $2000
0469   0153 05 03         syscall sys_io
0470   0155 63 10 00      sub d, 16
0471   0158 26 10 00      mov b, 16
0472   015B             print_ascii_l:
0473   015B 79            inc d
0474   015C 1E            mov al, [d]               ; read byte
0475   015D B9 20         cmp al, $20
0476   015F C8 67 01      jlu dot
0477   0162 B9 7E         cmp al, $7e
0478   0164 D0 6F 01      jleu ascii
0479   0167             dot:
0480   0167 10 00 2E      mov a, $2e00
0481   016A 05 03         syscall sys_io
0482   016C 0A 74 01      jmp ascii_continue
0483   016F             ascii:
0484   016F 23            mov ah, al
0485   0170 19 00         mov al, 0
0486   0172 05 03         syscall sys_io
0487   0174             ascii_continue:
0488   0174 FD A9 5B 01   loopb print_ascii_l
0489   0178 0A 42 01      jmp back1
0490   017B             print_base:
0491   017B 07 65 06      call printnl
0492   017E 2D            mov b, d
0493   017F 61 79 1E      sub b, scrap_sector      ; remove this later and fix address bases which display incorrectly
0494   0182 07 14 07      call print_u16x          ; display row
0495   0185 10 00 3A      mov a, $3a00
0496   0188 05 03         syscall sys_io
0497   018A 10 00 20      mov a, $2000
0498   018D 05 03         syscall sys_io
0499   018F 0A 30 01      jmp back
0500   0192             
0501   0192             ; ------------------------------------------------------------------------------------------------------------------;
0502   0192             ; divide by zero exception
0503   0192             ; ------------------------------------------------------------------------------------------------------------------;
0504   0192             trap_div_zero:
0505   0192 D7            push a
0506   0193 DA            push d
0507   0194 E1            pushf
0508   0195 3B 2B 0D      mov d, s_divzero
0509   0198 07 B8 06      call _puts
0510   019B EE            popf
0511   019C E7            pop d
0512   019D E4            pop a
0513   019E 06            sysret ; enable interrupts
0514   019F             
0515   019F             ; ------------------------------------------------------------------------------------------------------------------;
0516   019F             ; undefined opcode exception
0517   019F             ; ------------------------------------------------------------------------------------------------------------------;
0518   019F             trap_undef_opcode:
0519   019F 06            sysret
0520   01A0             
0521   01A0             ; ------------------------------------------------------------------------------------------------------------------;
0522   01A0             ; real-time clock services syscall
0523   01A0             ; rtc i/o bank = ffa0 to ffaf
0524   01A0             ; ffa0 to ffa7 is scratch ram
0525   01A0             ; control register at $ffa8 [ w | r | s | cal4..cal0 ]
0526   01A0             ; al = 0..6 -> get
0527   01A0             ; al = 7..d -> set
0528   01A0             ; ------------------------------------------------------------------------------------------------------------------;
0529   01A0             syscall_rtc:
0530   01A0 DB            push al
0531   01A1 DA            push d
0532   01A2 B9 06         cmp al, 6
0533   01A4 D1 B9 01      jgu syscall_rtc_set
0534   01A7             syscall_rtc_get:
0535   01A7 6A A9         add al, $a9             ; generate rtc address to get to address a9 of clock
0536   01A9 22 FF         mov ah, $ff    
0537   01AB 3C            mov d, a                ; get to ffa9 + offset
0538   01AC F2 A8 FF 40   mov byte[$ffa8], $40    ; set r bit to 1
0539   01B0 1E            mov al, [d]             ; get data
0540   01B1 F2 A8 FF 00   mov byte[$ffa8], 0      ; reset r bit
0541   01B5 23            mov ah, al
0542   01B6 E7            pop d
0543   01B7 E8            pop al
0544   01B8 06            sysret
0545   01B9             syscall_rtc_set:
0546   01B9 DD            push bl
0547   01BA 99            mov bl, ah              ; set data aside
0548   01BB 6A A2         add al, $a2             ; generate rtc address to get to address a9 of clock
0549   01BD 22 FF         mov ah, $ff    
0550   01BF 3C            mov d, a                ; get to ffa9 + offset
0551   01C0 1B            mov al, bl              ; get data back
0552   01C1 F2 A8 FF 80   mov byte[$ffa8], $80    ; set w bit to 1
0553   01C5 3E            mov [d], al             ; set data
0554   01C6 F2 A8 FF 00   mov byte[$ffa8], 0      ; reset write bit
0555   01CA EA            pop bl
0556   01CB E7            pop d
0557   01CC E8            pop al
0558   01CD 06            sysret
0559   01CE             
0560   01CE             datetime_serv_tbl:
0561   01CE D6 01         .dw print_date
0562   01D0 4A 02         .dw set_date
0563   01D2             syscall_datetime:
0564   01D2 FD 0A CE 01   jmp [datetime_serv_tbl + al]      
0565   01D6             print_date:
0566   01D6 10 00 0D      mov a, $0d00           ; print carriage return char
0567   01D9 19 03         mov al, 3
0568   01DB 05 01         syscall sys_rtc        ; get week
0569   01DD 1A            mov al, ah
0570   01DE 22 00         mov ah, 0
0571   01E0 FD 9D 02      shl a, 2          
0572   01E3 3B 0B 0E      mov d, s_week
0573   01E6 59            add d, a
0574   01E7 07 B8 06      call _puts
0575   01EA 10 00 20      mov a, $2000
0576   01ED 05 03         syscall sys_io         ; display ' '
0577   01EF 19 04         mov al, 4
0578   01F1 05 01         syscall sys_rtc        ; get day
0579   01F3 99            mov bl, ah
0580   01F4 07 58 07      call print_u8x
0581   01F7 10 00 20      mov a, $2000
0582   01FA 05 03         syscall sys_io         ; display ' '
0583   01FC             ; there is a problem with the month displaying
0584   01FC             ; the month is stored as bcd. so when retrieving the month, the value will be in binary
0585   01FC             ; even though it is to be understood as bcd.
0586   01FC             ; when retrieving the value and adding the string table address offset the value will go overboard!  
0587   01FC 19 05         mov al, 05
0588   01FE 05 01         syscall sys_rtc        ; get month
0589   0200 1A            mov al, ah
0590   0201 22 00         mov ah, 0
0591   0203 FD 9D 02      shl a, 2          
0592   0206 3B D7 0D      mov d, s_months
0593   0209 59            add d, a
0594   020A 07 B8 06      call _puts
0595   020D 10 00 20      mov a, $2000
0596   0210 05 03         syscall sys_io         ; display ' '
0597   0212 2E 20         mov bl, $20
0598   0214 07 58 07      call print_u8x         ; print 20 for year prefix
0599   0217 19 06         mov al, 06
0600   0219 05 01         syscall sys_rtc        ; get year
0601   021B 99            mov bl, ah
0602   021C 07 58 07      call print_u8x
0603   021F 10 00 20      mov a, $2000  
0604   0222 05 03         syscall sys_io         ; display ' '
0605   0224 19 02         mov al, 2
0606   0226 05 01         syscall sys_rtc        ; get hours
0607   0228 99            mov bl, ah
0608   0229 07 58 07      call print_u8x
0609   022C 10 00 3A      mov a, $3a00    
0610   022F 05 03         syscall sys_io         ; display ':'
0611   0231 19 01         mov al, 01
0612   0233 05 01         syscall sys_rtc        ; get minutes
0613   0235 99            mov bl, ah
0614   0236 07 58 07      call print_u8x
0615   0239 10 00 3A      mov a, $3a00  
0616   023C 05 03         syscall sys_io         ; display ':'
0617   023E 19 00         mov al, 0
0618   0240 05 01         syscall sys_rtc        ; get seconds
0619   0242 99            mov bl, ah
0620   0243 07 58 07      call print_u8x
0621   0246 07 65 06      call printnl
0622   0249 06            sysret
0623   024A             set_date:
0624   024A 3B 9C 0D      mov d, s_set_year
0625   024D 07 B8 06      call _puts
0626   0250 07 A3 07      call scan_u8x          ; read integer into a
0627   0253 FD 9D 08      shl a, 8               ; only al used, move to ah
0628   0256 19 0D         mov al, 0dh            ; set rtc year
0629   0258 05 01         syscall sys_rtc        ; set rtc
0630   025A 3B A3 0D      mov d, s_set_month
0631   025D 07 B8 06      call _puts
0632   0260 07 A3 07      call scan_u8x          ; read integer into a
0633   0263 FD 9D 08      shl a, 8               ; only al used, move to ah
0634   0266 19 0C         mov al, 0ch            ; set rtc month
0635   0268 05 01         syscall sys_rtc        ; set rtc
0636   026A 3B AB 0D      mov d, s_set_day
0637   026D 07 B8 06      call _puts
0638   0270 07 A3 07      call scan_u8x          ; read integer into a
0639   0273 FD 9D 08      shl a, 8               ; only al used, move to ah
0640   0276 19 0B         mov al, 0bh            ; set rtc month
0641   0278 05 01         syscall sys_rtc        ; set rtc
0642   027A 3B B1 0D      mov d, s_set_week
0643   027D 07 B8 06      call _puts
0644   0280 07 A3 07      call scan_u8x          ; read integer into a
0645   0283 FD 9D 08      shl a, 8               ; only al used, move to ah
0646   0286 19 0A         mov al, 0ah            ; set rtc month
0647   0288 05 01         syscall sys_rtc        ; set rtc
0648   028A 3B BB 0D      mov d, s_set_hours
0649   028D 07 B8 06      call _puts
0650   0290 07 A3 07      call scan_u8x          ; read integer into a
0651   0293 FD 9D 08      shl a, 8               ; only al used, move to ah
0652   0296 19 09         mov al, 09h            ; set rtc month
0653   0298 05 01         syscall sys_rtc        ; set rtc
0654   029A 3B C3 0D      mov d, s_set_minutes
0655   029D 07 B8 06      call _puts
0656   02A0 07 A3 07      call scan_u8x          ; read integer into a
0657   02A3 FD 9D 08      shl a, 8               ; only al used, move to ah
0658   02A6 19 08         mov al, 08h            ; set rtc month
0659   02A8 05 01         syscall sys_rtc        ; set rtc
0660   02AA 3B CD 0D      mov d, s_set_seconds
0661   02AD 07 B8 06      call _puts
0662   02B0 07 A3 07      call scan_u8x          ; read integer into a
0663   02B3 FD 9D 08      shl a, 8               ; only al used, move to ah
0664   02B6 19 07         mov al, 07h            ; set rtc month
0665   02B8 05 01         syscall sys_rtc        ; set rtc
0666   02BA 06            sysret
0667   02BB             
0668   02BB             ; ------------------------------------------------------------------------------------------------------------------;
0669   02BB             ; ide services syscall
0670   02BB             ; al = option
0671   02BB             ; 0 = ide reset, 1 = ide sleep, 2 = read sector, 3 = write sector
0672   02BB             ; ide read/write sector
0673   02BB             ; 512 bytes
0674   02BB             ; user buffer pointer in d
0675   02BB             ; ah = number of sectors
0676   02BB             ; cb = lba bytes 3..0
0677   02BB             ; ------------------------------------------------------------------------------------------------------------------;
0678   02BB             ide_serv_tbl:
0679   02BB C7 02         .dw ide_reset
0680   02BD DB 02         .dw ide_sleep
0681   02BF EA 02         .dw ide_read_sect_wrapper
0682   02C1 EE 02         .dw ide_write_sect_wrapper
0683   02C3             syscall_ide:
0684   02C3 FD 0A BB 02   jmp [ide_serv_tbl + al]    
0685   02C7             
0686   02C7             ide_reset:      
0687   02C7 F2 D7 FF 04   mov byte[_ide_r7], 4            ; reset ide
0688   02CB 07 74 03      call ide_wait                   ; wait for ide ready             
0689   02CE F2 D6 FF E0   mov byte[_ide_r6], $e0          ; lba3= 0, master, mode= lba        
0690   02D2 F2 D1 FF 01   mov byte[_ide_r1], 1            ; 8-bit transfers      
0691   02D6 F2 D7 FF EF   mov byte[_ide_r7], $ef          ; set feature command
0692   02DA 06            sysret
0693   02DB             ide_sleep:
0694   02DB 07 74 03      call ide_wait                   ; wait for ide ready             
0695   02DE F2 D6 FF 40   mov byte [_ide_r6], %01000000   ; lba[3:0](reserved), bit 6=1
0696   02E2 F2 D7 FF E6   mov byte [_ide_r7], $e6         ; sleep command
0697   02E6 07 74 03      call ide_wait                   ; wait for ide ready
0698   02E9 06            sysret
0699   02EA             ide_read_sect_wrapper:
0700   02EA 07 F2 02      call ide_read_sect
0701   02ED 06            sysret
0702   02EE             ide_write_sect_wrapper:
0703   02EE 07 18 03      call ide_write_sect
0704   02F1 06            sysret
0705   02F2             ide_read_sect:
0706   02F2 1A            mov al, ah
0707   02F3 24            mov ah, bl
0708   02F4 42 D2 FF      mov [_ide_r2], a                ; number of sectors (0..255)
0709   02F7 1C            mov al, bh
0710   02F8 3D D4 FF      mov [_ide_r4], al
0711   02FB 12            mov a, c
0712   02FC 3D D5 FF      mov [_ide_r5], al
0713   02FF 1A            mov al, ah
0714   0300 87 0F         and al, %00001111
0715   0302 8B E0         or al, %11100000                ; mode lba, master
0716   0304 3D D6 FF      mov [_ide_r6], al
0717   0307             ide_read_sect_wait:
0718   0307 1D D7 FF      mov al, [_ide_r7]  
0719   030A 87 80         and al, $80                     ; busy flag
0720   030C C7 07 03      jnz ide_read_sect_wait
0721   030F 19 20         mov al, $20
0722   0311 3D D7 FF      mov [_ide_r7], al               ; read sector cmd
0723   0314 07 3E 03      call ide_read  
0724   0317 09            ret
0725   0318             ide_write_sect:
0726   0318 1A            mov al, ah
0727   0319 24            mov ah, bl
0728   031A 42 D2 FF      mov [_ide_r2], a                ; number of sectors (0..255)
0729   031D 1C            mov al, bh
0730   031E 3D D4 FF      mov [_ide_r4], al
0731   0321 12            mov a, c
0732   0322 3D D5 FF      mov [_ide_r5], al
0733   0325 1A            mov al, ah
0734   0326 87 0F         and al, %00001111
0735   0328 8B E0         or al, %11100000                ; mode lba, master
0736   032A 3D D6 FF      mov [_ide_r6], al
0737   032D             ide_write_sect_wait:
0738   032D 1D D7 FF      mov al, [_ide_r7]  
0739   0330 87 80         and al, $80                     ; busy flag
0740   0332 C7 2D 03      jnz ide_write_sect_wait
0741   0335 19 30         mov al, $30
0742   0337 3D D7 FF      mov [_ide_r7], al               ; write sector cmd
0743   033A 07 59 03      call ide_write      
0744   033D 09            ret
0745   033E             
0746   033E             ;----------------------------------------------------------------------------------------------------;
0747   033E             ; read ide data
0748   033E             ; pointer in d
0749   033E             ;----------------------------------------------------------------------------------------------------;
0750   033E             ide_read:
0751   033E DA            push d
0752   033F             ide_read_loop:
0753   033F 1D D7 FF      mov al, [_ide_r7]  
0754   0342 87 80         and al, 80h                     ; busy flag
0755   0344 C7 3F 03      jnz ide_read_loop               ; wait loop
0756   0347 1D D7 FF      mov al, [_ide_r7]
0757   034A 87 08         and al, %00001000               ; drq flag
0758   034C C6 57 03      jz ide_read_end
0759   034F 1D D0 FF      mov al, [_ide_r0]
0760   0352 3E            mov [d], al
0761   0353 79            inc d
0762   0354 0A 3F 03      jmp ide_read_loop
0763   0357             ide_read_end:
0764   0357 E7            pop d
0765   0358 09            ret
0766   0359             
0767   0359             ;----------------------------------------------------------------------------------------------------;
0768   0359             ; write ide data
0769   0359             ; data pointer in d
0770   0359             ;----------------------------------------------------------------------------------------------------;
0771   0359             ide_write:
0772   0359 DA            push d
0773   035A             ide_write_loop:
0774   035A 1D D7 FF      mov al, [_ide_r7]  
0775   035D 87 80         and al, 80h             ; busy flag
0776   035F C7 5A 03      jnz ide_write_loop      ; wait loop
0777   0362 1D D7 FF      mov al, [_ide_r7]
0778   0365 87 08         and al, %00001000       ; drq flag
0779   0367 C6 72 03      jz ide_write_end
0780   036A 1E            mov al, [d]
0781   036B 3D D0 FF      mov [_ide_r0], al
0782   036E 79            inc d 
0783   036F 0A 5A 03      jmp ide_write_loop
0784   0372             ide_write_end:
0785   0372 E7            pop d
0786   0373 09            ret
0787   0374             
0788   0374             ;----------------------------------------------------------------------------------------------------;
0789   0374             ; wait for ide to be ready
0790   0374             ;----------------------------------------------------------------------------------------------------;
0791   0374             ide_wait:
0792   0374 1D D7 FF      mov al, [_ide_r7]  
0793   0377 87 80         and al, 80h        ; busy flag
0794   0379 C7 74 03      jnz ide_wait
0795   037C 09            ret
0796   037D             
0797   037D             ;----------------------------------------------------------------------------------------------------;
0798   037D             ; io syscall
0799   037D             ;----------------------------------------------------------------------------------------------------;
0800   037D             ; baud  divisor
0801   037D             ; 50    2304
0802   037D             ; 110   1047
0803   037D             ; 300    384
0804   037D             ; 600    192
0805   037D             ; 1200    96
0806   037D             ; 9600    12
0807   037D             ; 19200    6
0808   037D             ; 38400    3
0809   037D             syscall_io_jmp:
0810   037D D8 03         .dw syscall_io_putchar
0811   037F E5 03         .dw syscall_io_getch
0812   0381 87 03         .dw syscall_io_uart_setup
0813   0383             syscall_io:
0814   0383 FD 0A 7D 03   jmp [syscall_io_jmp + al]
0815   0387             ; bit7 is the divisor latch access bit (dlab). it must be set high (logic 1) to access the divisor latches
0816   0387             ; of the baud generator during a read or write operation. it must be set low (logic 0) to access the receiver
0817   0387             ; buffer, the transmitter holding register, or the interrupt enable register.
0818   0387             syscall_io_uart_setup:
0819   0387 1D E1 0B      mov al, [sys_uart0_lcr]
0820   038A 8B 80         or al, $80                ; set dlab access bit
0821   038C 3D 83 FF      mov [_uart0_lcr], al      ; 8 data, 2 stop, even parity 
0822   038F 1D E4 0B      mov al, [sys_uart0_div0]
0823   0392 3D 80 FF      mov [_uart0_dlab_0], al   ; divisor latch byte 0
0824   0395 1D E5 0B      mov al, [sys_uart0_div1]
0825   0398 3D 81 FF      mov [_uart0_dlab_1], al   ; divisor latch byte 1      
0826   039B 1D E1 0B      mov al, [sys_uart0_lcr]
0827   039E 87 7F         and al, $7f               ; clear dlab access bit 
0828   03A0 3D 83 FF      mov [_uart0_lcr], al
0829   03A3 1D E2 0B      mov al, [sys_uart0_inten]
0830   03A6 3D 81 FF      mov [_uart0_ier], al      ; interrupts
0831   03A9 1D E3 0B      mov al, [sys_uart0_fifoen]
0832   03AC 3D 82 FF      mov [_uart0_fcr], al      ; fifo control
0833   03AF             
0834   03AF             ; uart1:
0835   03AF 1D E6 0B      mov al, [sys_uart1_lcr]
0836   03B2 8B 80         or al, $80                ; set dlab access bit
0837   03B4 3D 8B FF      mov [_uart1_lcr], al      ; 8 data, 2 stop, even parity 
0838   03B7 1D E9 0B      mov al, [sys_uart1_div0]
0839   03BA 3D 88 FF      mov [_uart1_dlab_0], al   ; divisor latch byte 0
0840   03BD 1D EA 0B      mov al, [sys_uart1_div1]
0841   03C0 3D 89 FF      mov [_uart1_dlab_1], al   ; divisor latch byte 1      
0842   03C3 1D E6 0B      mov al, [sys_uart1_lcr]
0843   03C6 87 7F         and al, $7f               ; clear dlab access bit 
0844   03C8 3D 8B FF      mov [_uart1_lcr], al
0845   03CB 1D E7 0B      mov al, [sys_uart1_inten]
0846   03CE 3D 89 FF      mov [_uart1_ier], al      ; interrupts
0847   03D1 1D E8 0B      mov al, [sys_uart1_fifoen]
0848   03D4 3D 8A FF      mov [_uart1_fcr], al      ; fifo control
0849   03D7 06            sysret
0850   03D8             
0851   03D8             ; char in ah
0852   03D8             syscall_io_putchar:
0853   03D8             syscall_io_putchar_l0:
0854   03D8 1D 85 FF      mov al, [_uart0_lsr]         ; read line status register
0855   03DB 93 20         test al, $20
0856   03DD C6 D8 03      jz syscall_io_putchar_l0    
0857   03E0 1A            mov al, ah
0858   03E1 3D 80 FF      mov [_uart0_data], al        ; write char to transmitter holding register
0859   03E4 06            sysret
0860   03E5             
0861   03E5             ; char in ah
0862   03E5             ; al = sucess code
0863   03E5             syscall_io_getch:
0864   03E5 D8            push b
0865   03E6 DA            push d
0866   03E7 FD 0C         sti
0867   03E9             syscall_io_getch_l0:  
0868   03E9 14 ED 0B      mov a, [fifo_out]
0869   03EC 29 EB 0B      mov b, [fifo_in]
0870   03EF B0            cmp a, b
0871   03F0 C6 E9 03      je syscall_io_getch_l0
0872   03F3 3C            mov d, a
0873   03F4 77            inc a
0874   03F5 AF 79 1E      cmp a, fifo + _fifo_size      ; check if pointer reached the end of the fifo
0875   03F8 C7 FE 03      jne syscall_io_getch_cont
0876   03FB 10 79 0E      mov a, fifo  
0877   03FE             syscall_io_getch_cont:  
0878   03FE 42 ED 0B      mov [fifo_out], a             ; update fifo pointer
0879   0401 1E            mov al, [d]                   ; get char
0880   0402 23            mov ah, al
0881   0403             ; here we just echo the char back to the console
0882   0403             syscall_io_getch_echo_l0:
0883   0403 1D 85 FF      mov al, [_uart0_lsr]         ; read line status register
0884   0406 87 20         and al, $20                 ; isolate transmitter empty
0885   0408 C6 03 04      jz syscall_io_getch_echo_l0
0886   040B 1A            mov al, ah
0887   040C 3D 80 FF      mov [_uart0_data], al        ; write char to transmitter holding register
0888   040F             syscall_io_getch_echo_l1:
0889   040F 1D 8D FF      mov al, [_uart1_lsr]         ; read line status register
0890   0412 87 20         and al, $20                 ; isolate transmitter empty
0891   0414 C6 0F 04      jz syscall_io_getch_echo_l1
0892   0417 1A            mov al, ah
0893   0418 3D 88 FF      mov [_uart1_data], al        ; write char to transmitter holding register
0894   041B             syscall_io_getch_noecho:
0895   041B 19 01         mov al, 1                    ; al = 1 means a char successfully received
0896   041D E7            pop d
0897   041E E5            pop b
0898   041F 06            sysret
0899   0420             
0900   0420             ;------------------------------------------------------------------------------------------------------;
0901   0420             ; file system data
0902   0420             ;------------------------------------------------------------------------------------------------------;
0903   0420             ; infor for : ide services interrupt
0904   0420             ; ide read/write 512-byte sector
0905   0420             ; al = option
0906   0420             ; user buffer pointer in d
0907   0420             ; ah = number of sectors
0908   0420             ; cb = lba bytes 3..0  
0909   0420             ;------------------------------------------------------------------------------------------------------;
0910   0420             ; file system data structure
0911   0420             ;------------------------------------------------------------------------------------------------------;
0912   0420             ; first directory on disk is the root directory '/'
0913   0420             file_system_jmptbl:
0914   0420 33 04         .dw fs_cd                     
0915   0422 34 04         .dw fs_ls                     
0916   0424 38 04         .dw fs_pwd                    
0917   0426 39 04         .dw fs_rmdir                  
0918   0428 32 04         .dw fs_mkdir
0919   042A 3A 04         .dw fs_rm                     
0920   042C 3B 04         .dw fs_mv                     
0921   042E             
0922   042E             syscall_file_system:
0923   042E FD 0A 20 04   jmp [file_system_jmptbl + al]
0924   0432             
0925   0432             ;------------------------------------------------------------------------------------------------------;
0926   0432             ; create new directory
0927   0432             ;------------------------------------------------------------------------------------------------------;
0928   0432             ; search list for null name entry. add new directory to list
0929   0432             fs_mkdir:
0930   0432 06            sysret
0931   0433             
0932   0433             ;------------------------------------------------------------------------------------------------------;
0933   0433             ; cd
0934   0433             ;------------------------------------------------------------------------------------------------------;
0935   0433             fs_cd:
0936   0433 06            sysret  
0937   0434             
0938   0434             ;------------------------------------------------------------------------------------------------------;
0939   0434             ; ls
0940   0434             ;------------------------------------------------------------------------------------------------------;
0941   0434             ; inode in a
0942   0434             fs_ls:
0943   0434 3B 1C 00      mov d, inode_table_sect_start
0944   0437             
0945   0437 06            sysret
0946   0438             
0947   0438             ;------------------------------------------------------------------------------------------------------;
0948   0438             ; pwd - print working directory
0949   0438             ;------------------------------------------------------------------------------------------------------;    
0950   0438             fs_pwd:
0951   0438 06            sysret
0952   0439             
0953   0439             ;------------------------------------------------------------------------------------------------------;
0954   0439             ; rmdir - remove dir by dirid
0955   0439             ;------------------------------------------------------------------------------------------------------;
0956   0439             fs_rmdir:
0957   0439 06            sysret
0958   043A             
0959   043A             ;------------------------------------------------------------------------------------------------------;
0960   043A             ; rm - remove file
0961   043A             ;------------------------------------------------------------------------------------------------------;
0962   043A             fs_rm:
0963   043A 06            sysret  
0964   043B             
0965   043B             ;------------------------------------------------------------------------------------------------------;
0966   043B             ; mv - move / change file name
0967   043B             ;------------------------------------------------------------------------------------------------------;
0968   043B             fs_mv:
0969   043B 06            sysret
0970   043C             
0971   043C             
0972   043C             ;----------------------------------------------------------------------------------------------;
0973   043C             ; get hex file
0974   043C             ; di = destination address
0975   043C             ; return length in bytes in c
0976   043C             ;----------------------------------------------------------------------------------------------;
0977   043C             _load_hex:
0978   043C D7            push a
0979   043D D8            push b
0980   043E DA            push d
0981   043F E2            push si
0982   0440 E3            push di
0983   0441 38 00 00      mov c, 0
0984   0444 50            mov a, di
0985   0445 3C            mov d, a          ; start of string data block
0986   0446 07 93 05      call _gets        ; get program string
0987   0449 4D            mov si, a
0988   044A             __load_hex_loop:
0989   044A F6            lodsb             ; load from [si] to al
0990   044B B9 00         cmp al, 0         ; check if ascii 0
0991   044D C6 5B 04      jz __load_hex_ret
0992   0450 36            mov bh, al
0993   0451 F6            lodsb
0994   0452 2F            mov bl, al
0995   0453 07 49 05      call _atoi        ; convert ascii byte in b to int (to al)
0996   0456 F7            stosb             ; store al to [di]
0997   0457 78            inc c
0998   0458 0A 4A 04      jmp __load_hex_loop
0999   045B             __load_hex_ret:
1000   045B F0            pop di
1001   045C EF            pop si
1002   045D E7            pop d
1003   045E E5            pop b
1004   045F E4            pop a
1005   0460 09            ret
1006   0461             
1007   0461             ; ---------------------------------------------------------------------
1008   0461             ; kernel reset vector
1009   0461             ; ---------------------------------------------------------------------
1010   0461             kernel_reset_vector:  
1011   0461 FD 49 FF F7   mov bp, _stack_top
1012   0465 FD 47 FF F7   mov sp, _stack_top
1013   0469               
1014   0469 0C            lodstat
1015   046A 87 DF         and al, %11011111             ; disable display register loading
1016   046C 0D            stostat
1017   046D             
1018   046D             ; reset fifo pointers
1019   046D 10 79 0E      mov a, fifo
1020   0470 3B EB 0B      mov d, fifo_in
1021   0473 43            mov [d], a
1022   0474 3B ED 0B      mov d, fifo_out
1023   0477 43            mov [d], a  
1024   0478 19 02         mov al, 2
1025   047A 05 03         syscall sys_io                ; enable uart in interrupt mode
1026   047C             
1027   047C 19 A0         mov al, %10100000             ; uart0 | timer | uart1 | 0 | 0 | 0 | 0| fdc
1028   047E FD 0F         stomsk                        
1029   0480 FD 0C         sti  
1030   0482             
1031   0482 3B 40 0C      mov d, s_kernel_welcome
1032   0485 07 B8 06      call _puts
1033   0488             
1034   0488 3B 38 0E      mov d, s_fdc_config
1035   048B 07 B8 06      call _puts
1036   048E             
1037   048E F2 C0 FF 0D   mov byte [_fdc_config], %00001101  ; %00001001 : turn led on / head load, disable double density, select side 0, select drive 0, do not select drive 1
1038   0492 F2 C8 FF 0B   mov byte [_fdc_stat_cmd], %00001011     ; leave this restore command in order to clear BUSY flag
1039   0496 F2 C9 FF 00   mov byte [_fdc_track], $00 ; reset track
1040   049A             
1041   049A             
1042   049A 10 00 00      mov a, 0
1043   049D             ker_loop:
1044   049D 77            inc a
1045   049E 3D B0 FF      mov [_til311_display], al
1046   04A1 0A 9D 04      jmp ker_loop
1047   04A4             
1048   04A4               ;syscall sys_create_proc       ; launch init as a new process
1049   04A4             
1050   04A4             ; file includes
1051   04A4             .include "bios.exp"         ; to obtain the bios_reset_vector location (for reboots)
0001+  04A4             boot_origin      .EQU  $8004
0002+  04A4             bios_uart        .EQU  $0002
0003+  04A4             bios_ide         .EQU  $0003
0004+  04A4             bios_reset_vector .EQU  $0190
0005+  04A4             ide_buffer       .EQU  $8404
0006+  04A4             inode_buffer     .EQU  $8c04
0007+  04A4             noname.__print_u16x .EQU  $01f6
0008+  04A4             noname.__xput_u8 .EQU  $023e
0009+  04A4             noname.__puts    .EQU  $0252
0010+  04A4             noname.__print_u16d .EQU  $0379
1052   04A4             .include "lib/stdio.asm"
0001+  04A4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002+  04A4             ; stdio.s
0003+  04A4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004+  04A4             .include "lib/string.asm"
0001++ 04A4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002++ 04A4             ; string.s
0003++ 04A4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004++ 04A4             
0005++ 04A4             
0006++ 04A4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0007++ 04A4             ; _strrev
0008++ 04A4             ; reverse a string
0009++ 04A4             ; d = string address
0010++ 04A4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0011++ 04A4             ; 01234
0012++ 04A4             _strrev:
0013++ 04A4 4B          	pusha
0014++ 04A5 07 EB 04    	call _strlen	; length in c
0015++ 04A8 12          	mov a, c
0016++ 04A9 AF 01 00    	cmp a, 1
0017++ 04AC D0 C6 04    	jleu _strrev_end	; check string length. string len must be > 1
0018++ 04AF 7D          	dec a
0019++ 04B0 FD 4E       	mov si, d	; beginning of string
0020++ 04B2 FD 50       	mov di, d	; beginning of string (for destinations)
0021++ 04B4 59          	add d, a	; end of string
0022++ 04B5 12          	mov a, c
0023++ 04B6 FD 9B       	shr a		; divide by 2
0024++ 04B8 39          	mov c, a	; c now counts the steps
0025++ 04B9             _strrev_l0:
0026++ 04B9 32          	mov bl, [d]	; save load right-side char into bl
0027++ 04BA F6          	lodsb		; load left-side char into al; increase si
0028++ 04BB 3E          	mov [d], al	; store left char into right side
0029++ 04BC 1B          	mov al, bl
0030++ 04BD F7          	stosb		; store right-side char into left-side; increase di
0031++ 04BE 7E          	dec c
0032++ 04BF 7F          	dec d
0033++ 04C0 C2 00 00    	cmp c, 0
0034++ 04C3 C7 B9 04    	jne _strrev_l0
0035++ 04C6             _strrev_end:
0036++ 04C6 4C          	popa
0037++ 04C7 09          	ret
0038++ 04C8             	
0039++ 04C8             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0040++ 04C8             ; _strchr
0041++ 04C8             ; search string in d for char in al
0042++ 04C8             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0043++ 04C8             _strchr:
0044++ 04C8             _strchr_l0:
0045++ 04C8 32          	mov bl, [d]
0046++ 04C9 C1 00       	cmp bl, 0
0047++ 04CB C6 D6 04    	je _strchr_end
0048++ 04CE BA          	cmp al, bl
0049++ 04CF C6 D6 04    	je _strchr_end
0050++ 04D2 79          	inc d
0051++ 04D3 0A C8 04    	jmp _strchr_l0
0052++ 04D6             _strchr_end:
0053++ 04D6 1B          	mov al, bl
0054++ 04D7 09          	ret
0055++ 04D8             
0056++ 04D8             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0057++ 04D8             ; _strstr
0058++ 04D8             ; find sub-string
0059++ 04D8             ; str1 in si
0060++ 04D8             ; str2 in di
0061++ 04D8             ; si points to end of source string
0062++ 04D8             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0063++ 04D8             _strstr:
0064++ 04D8 DB          	push al
0065++ 04D9 DA          	push d
0066++ 04DA E3          	push di
0067++ 04DB             _strstr_loop:
0068++ 04DB F3          	cmpsb					; compare a byte of the strings
0069++ 04DC C7 E7 04    	jne _strstr_ret
0070++ 04DF FC 00 00    	lea d, [di + 0]
0071++ 04E2 BD 00       	cmp byte[d], 0				; check if at end of string (null)
0072++ 04E4 C7 DB 04    	jne _strstr_loop				; equal chars but not at end
0073++ 04E7             _strstr_ret:
0074++ 04E7 F0          	pop di
0075++ 04E8 E7          	pop d
0076++ 04E9 E8          	pop al
0077++ 04EA 09          	ret
0078++ 04EB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0079++ 04EB             ; length of null terminated string
0080++ 04EB             ; result in c
0081++ 04EB             ; pointer in d
0082++ 04EB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0083++ 04EB             _strlen:
0084++ 04EB DA          	push d
0085++ 04EC 38 00 00    	mov c, 0
0086++ 04EF             _strlen_l1:
0087++ 04EF BD 00       	cmp byte [d], 0
0088++ 04F1 C6 F9 04    	je _strlen_ret
0089++ 04F4 79          	inc d
0090++ 04F5 78          	inc c
0091++ 04F6 0A EF 04    	jmp _strlen_l1
0092++ 04F9             _strlen_ret:
0093++ 04F9 E7          	pop d
0094++ 04FA 09          	ret
0095++ 04FB             
0096++ 04FB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0097++ 04FB             ; strcmp
0098++ 04FB             ; compare two strings
0099++ 04FB             ; str1 in si
0100++ 04FB             ; str2 in di
0101++ 04FB             ; create a string compairon instrucion ?????
0102++ 04FB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0103++ 04FB             _strcmp:
0104++ 04FB DB          	push al
0105++ 04FC DA          	push d
0106++ 04FD E3          	push di
0107++ 04FE E2          	push si
0108++ 04FF             _strcmp_loop:
0109++ 04FF F3          	cmpsb					; compare a byte of the strings
0110++ 0500 C7 0B 05    	jne _strcmp_ret
0111++ 0503 FB FF FF    	lea d, [si +- 1]
0112++ 0506 BD 00       	cmp byte[d], 0				; check if at end of string (null)
0113++ 0508 C7 FF 04    	jne _strcmp_loop				; equal chars but not at end
0114++ 050B             _strcmp_ret:
0115++ 050B EF          	pop si
0116++ 050C F0          	pop di
0117++ 050D E7          	pop d
0118++ 050E E8          	pop al
0119++ 050F 09          	ret
0120++ 0510             
0121++ 0510             
0122++ 0510             ; strcpy
0123++ 0510             ; copy null terminated string from si to di
0124++ 0510             ; source in si
0125++ 0510             ; destination in di
0126++ 0510             _strcpy:
0127++ 0510 E2          	push si
0128++ 0511 E3          	push di
0129++ 0512 DB          	push al
0130++ 0513             _strcpy_l1:
0131++ 0513 F6          	lodsb
0132++ 0514 F7          	stosb
0133++ 0515 B9 00       	cmp al, 0
0134++ 0517 C7 13 05    	jne _strcpy_l1
0135++ 051A             _strcpy_end:
0136++ 051A E8          	pop al
0137++ 051B F0          	pop di
0138++ 051C EF          	pop si
0139++ 051D 09          	ret
0140++ 051E             
0141++ 051E             ; strcat
0142++ 051E             ; concatenate a null terminated string into string at di, from string at si
0143++ 051E             ; source in si
0144++ 051E             ; destination in di
0145++ 051E             _strcat:
0146++ 051E E2          	push si
0147++ 051F E3          	push di
0148++ 0520 D7          	push a
0149++ 0521 DA          	push d
0150++ 0522 50          	mov a, di
0151++ 0523 3C          	mov d, a
0152++ 0524             _strcat_goto_end_l1:
0153++ 0524 BD 00       	cmp byte[d], 0
0154++ 0526 C6 2D 05    	je _strcat_start
0155++ 0529 79          	inc d
0156++ 052A 0A 24 05    	jmp _strcat_goto_end_l1
0157++ 052D             _strcat_start:
0158++ 052D FD 50       	mov di, d
0159++ 052F             _strcat_l1:
0160++ 052F F6          	lodsb
0161++ 0530 F7          	stosb
0162++ 0531 B9 00       	cmp al, 0
0163++ 0533 C7 2F 05    	jne _strcat_l1
0164++ 0536             _strcat_end:
0165++ 0536 E7          	pop d
0166++ 0537 E4          	pop a
0167++ 0538 F0          	pop di
0168++ 0539 EF          	pop si
0169++ 053A 09          	ret
0170++ 053B             
0171++ 053B             
0005+  053B             
0006+  053B             
0007+  053B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0008+  053B             ; convert ascii 'o'..'f' to integer 0..15
0009+  053B             ; ascii in bl
0010+  053B             ; result in al
0011+  053B             ; ascii for f = 0100 0110
0012+  053B             ; ascii for 9 = 0011 1001
0013+  053B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0014+  053B             hex_ascii_encode:
0015+  053B 1B            mov al, bl
0016+  053C 93 40         test al, $40        ; test if letter or number
0017+  053E C7 44 05      jnz hex_letter
0018+  0541 87 0F         and al, $0f        ; get number
0019+  0543 09            ret
0020+  0544             hex_letter:
0021+  0544 87 0F         and al, $0f        ; get letter
0022+  0546 6A 09         add al, 9
0023+  0548 09            ret
0024+  0549             
0025+  0549             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0026+  0549             ; atoi
0027+  0549             ; 2 letter hex string in b
0028+  0549             ; 8bit integer returned in al
0029+  0549             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0030+  0549             _atoi:
0031+  0549 D8            push b
0032+  054A 07 3B 05      call hex_ascii_encode      ; convert bl to 4bit code in al
0033+  054D 30            mov bl, bh
0034+  054E DB            push al          ; save a
0035+  054F 07 3B 05      call hex_ascii_encode
0036+  0552 EA            pop bl  
0037+  0553 FD 9E 04      shl al, 4
0038+  0556 8C            or al, bl
0039+  0557 E5            pop b
0040+  0558 09            ret  
0041+  0559             
0042+  0559             
0043+  0559             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0044+  0559             ; scanf
0045+  0559             ; no need for explanations!
0046+  0559             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0047+  0559             scanf:
0048+  0559 09            ret
0049+  055A             
0050+  055A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0051+  055A             ; itoa
0052+  055A             ; 8bit value in bl
0053+  055A             ; 2 byte ascii result in a
0054+  055A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0055+  055A             _itoa:
0056+  055A DA            push d
0057+  055B D8            push b
0058+  055C A7 00         mov bh, 0
0059+  055E FD A4 04      shr bl, 4  
0060+  0561 74            mov d, b
0061+  0562 1F F4 07      mov al, [d + s_hex_digits]
0062+  0565 23            mov ah, al
0063+  0566               
0064+  0566 E5            pop b
0065+  0567 D8            push b
0066+  0568 A7 00         mov bh, 0
0067+  056A FD 87 0F      and bl, $0f
0068+  056D 74            mov d, b
0069+  056E 1F F4 07      mov al, [d + s_hex_digits]
0070+  0571 E5            pop b
0071+  0572 E7            pop d
0072+  0573 09            ret
0073+  0574             
0074+  0574             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0075+  0574             ; hex string to binary
0076+  0574             ; di = destination address
0077+  0574             ; si = source
0078+  0574             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0079+  0574             _hex_to_int:
0080+  0574             _hex_to_int_l1:
0081+  0574 F6            lodsb          ; load from [si] to al
0082+  0575 B9 00         cmp al, 0        ; check if ascii 0
0083+  0577 C6 84 05      jz _hex_to_int_ret
0084+  057A 36            mov bh, al
0085+  057B F6            lodsb
0086+  057C 2F            mov bl, al
0087+  057D 07 49 05      call _atoi        ; convert ascii byte in b to int (to al)
0088+  0580 F7            stosb          ; store al to [di]
0089+  0581 0A 74 05      jmp _hex_to_int_l1
0090+  0584             _hex_to_int_ret:
0091+  0584 09            ret    
0092+  0585             
0093+  0585             
0094+  0585             
0095+  0585             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0096+  0585             ; getchar
0097+  0585             ; char in ah
0098+  0585             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0099+  0585             getch:
0100+  0585 DB            push al
0101+  0586             getch_retry:
0102+  0586 19 01         mov al, 1
0103+  0588 05 03         syscall sys_io      ; receive in ah
0104+  058A E8            pop al
0105+  058B 09            ret
0106+  058C             
0107+  058C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0108+  058C             ; putchar
0109+  058C             ; char in ah
0110+  058C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0111+  058C             _putchar:
0112+  058C DB            push al
0113+  058D 19 00         mov al, 0
0114+  058F 05 03         syscall sys_io      ; char in ah
0115+  0591 E8            pop al
0116+  0592 09            ret
0117+  0593             
0118+  0593             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0119+  0593             ;; input a string
0120+  0593             ;; terminates with null
0121+  0593             ;; pointer in d
0122+  0593             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0123+  0593             _gets:
0124+  0593 D7            push a
0125+  0594 DA            push d
0126+  0595             _gets_loop:
0127+  0595 19 01         mov al, 1
0128+  0597 05 03         syscall sys_io      ; receive in ah
0129+  0599 76 1B         cmp ah, 27
0130+  059B C6 BC 05      je _gets_ansi_esc
0131+  059E 76 0A         cmp ah, $0a        ; lf
0132+  05A0 C6 18 06      je _gets_end
0133+  05A3 76 0D         cmp ah, $0d        ; cr
0134+  05A5 C6 18 06      je _gets_end
0135+  05A8 76 5C         cmp ah, $5c        ; '\\'
0136+  05AA C6 DE 05      je _gets_escape
0137+  05AD 76 08         cmp ah, $08      ; check for backspace
0138+  05AF C6 B8 05      je _gets_backspace
0139+  05B2 1A            mov al, ah
0140+  05B3 3E            mov [d], al
0141+  05B4 79            inc d
0142+  05B5 0A 95 05      jmp _gets_loop
0143+  05B8             _gets_backspace:
0144+  05B8 7F            dec d
0145+  05B9 0A 95 05      jmp _gets_loop
0146+  05BC             _gets_ansi_esc:
0147+  05BC 19 01         mov al, 1
0148+  05BE 05 03         syscall sys_io        ; receive in ah without echo
0149+  05C0 76 5B         cmp ah, '['
0150+  05C2 C7 95 05      jne _gets_loop
0151+  05C5 19 01         mov al, 1
0152+  05C7 05 03         syscall sys_io          ; receive in ah without echo
0153+  05C9 76 64         cmp ah, 'd'
0154+  05CB C6 D6 05      je _gets_left_arrow
0155+  05CE 76 63         cmp ah, 'c'
0156+  05D0 C6 DA 05      je _gets_right_arrow
0157+  05D3 0A 95 05      jmp _gets_loop
0158+  05D6             _gets_left_arrow:
0159+  05D6 7F            dec d
0160+  05D7 0A 95 05      jmp _gets_loop
0161+  05DA             _gets_right_arrow:
0162+  05DA 79            inc d
0163+  05DB 0A 95 05      jmp _gets_loop
0164+  05DE             _gets_escape:
0165+  05DE 19 01         mov al, 1
0166+  05E0 05 03         syscall sys_io      ; receive in ah
0167+  05E2 76 6E         cmp ah, 'n'
0168+  05E4 C6 03 06      je _gets_lf
0169+  05E7 76 72         cmp ah, 'r'
0170+  05E9 C6 0A 06      je _gets_cr
0171+  05EC 76 30         cmp ah, '0'
0172+  05EE C6 11 06      je _gets_null
0173+  05F1 76 5C         cmp ah, $5c  ; '\'
0174+  05F3 C6 FC 05      je _gets_slash
0175+  05F6 1A            mov al, ah        ; if not a known escape, it is just a normal letter
0176+  05F7 3E            mov [d], al
0177+  05F8 79            inc d
0178+  05F9 0A 95 05      jmp _gets_loop
0179+  05FC             _gets_slash:
0180+  05FC 19 5C         mov al, $5c
0181+  05FE 3E            mov [d], al
0182+  05FF 79            inc d
0183+  0600 0A 95 05      jmp _gets_loop
0184+  0603             _gets_lf:
0185+  0603 19 0A         mov al, $0a
0186+  0605 3E            mov [d], al
0187+  0606 79            inc d
0188+  0607 0A 95 05      jmp _gets_loop
0189+  060A             _gets_cr:
0190+  060A 19 0D         mov al, $0d
0191+  060C 3E            mov [d], al
0192+  060D 79            inc d
0193+  060E 0A 95 05      jmp _gets_loop
0194+  0611             _gets_null:
0195+  0611 19 00         mov al, $00
0196+  0613 3E            mov [d], al
0197+  0614 79            inc d
0198+  0615 0A 95 05      jmp _gets_loop
0199+  0618             _gets_end:
0200+  0618 19 00         mov al, 0
0201+  061A 3E            mov [d], al        ; terminate string
0202+  061B E7            pop d
0203+  061C E4            pop a
0204+  061D 09            ret
0205+  061E             
0206+  061E             
0207+  061E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0208+  061E             ;; input text
0209+  061E             ;; terminated with ctrl+d
0210+  061E             ;; pointer in d
0211+  061E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0212+  061E             _gettxt:
0213+  061E D7            push a
0214+  061F DA            push d
0215+  0620             _gettxt_loop:
0216+  0620 19 01         mov al, 1
0217+  0622 05 03         syscall sys_io      ; receive in ah
0218+  0624 76 04         cmp ah, 4      ; eot
0219+  0626 C6 5F 06      je _gettxt_end
0220+  0629 76 08         cmp ah, $08      ; check for backspace
0221+  062B C6 5B 06      je _gettxt_backspace
0222+  062E 76 5C         cmp ah, $5c        ; '\'
0223+  0630 C6 39 06      je _gettxt_escape
0224+  0633 1A            mov al, ah
0225+  0634 3E            mov [d], al
0226+  0635 79            inc d
0227+  0636 0A 20 06      jmp _gettxt_loop
0228+  0639             _gettxt_escape:
0229+  0639 19 01         mov al, 1
0230+  063B 05 03         syscall sys_io      ; receive in ah
0231+  063D 76 6E         cmp ah, 'n'
0232+  063F C6 4D 06      je _gettxt_lf
0233+  0642 76 72         cmp ah, 'r'
0234+  0644 C6 54 06      je _gettxt_cr
0235+  0647 1A            mov al, ah        ; if not a known escape, it is just a normal letter
0236+  0648 3E            mov [d], al
0237+  0649 79            inc d
0238+  064A 0A 20 06      jmp _gettxt_loop
0239+  064D             _gettxt_lf:
0240+  064D 19 0A         mov al, $0a
0241+  064F 3E            mov [d], al
0242+  0650 79            inc d
0243+  0651 0A 20 06      jmp _gettxt_loop
0244+  0654             _gettxt_cr:
0245+  0654 19 0D         mov al, $0d
0246+  0656 3E            mov [d], al
0247+  0657 79            inc d
0248+  0658 0A 20 06      jmp _gettxt_loop
0249+  065B             _gettxt_backspace:
0250+  065B 7F            dec d
0251+  065C 0A 20 06      jmp _gettxt_loop
0252+  065F             _gettxt_end:
0253+  065F 19 00         mov al, 0
0254+  0661 3E            mov [d], al        ; terminate string
0255+  0662 E7            pop d
0256+  0663 E4            pop a
0257+  0664 09            ret
0258+  0665             
0259+  0665             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0260+  0665             ; print new line
0261+  0665             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0262+  0665             printnl:
0263+  0665 D7            push a
0264+  0666 10 00 0A      mov a, $0a00
0265+  0669 05 03         syscall sys_io
0266+  066B 10 00 0D      mov a, $0d00
0267+  066E 05 03         syscall sys_io
0268+  0670 E4            pop a
0269+  0671 09            ret
0270+  0672             
0271+  0672             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0272+  0672             ; _strtoint
0273+  0672             ; 4 digit hex string number in d
0274+  0672             ; integer returned in a
0275+  0672             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0276+  0672             _strtointx:
0277+  0672 D8            push b
0278+  0673 32            mov bl, [d]
0279+  0674 37            mov bh, bl
0280+  0675 33 01 00      mov bl, [d + 1]
0281+  0678 07 49 05      call _atoi        ; convert to int in al
0282+  067B 23            mov ah, al        ; move to ah
0283+  067C 33 02 00      mov bl, [d + 2]
0284+  067F 37            mov bh, bl
0285+  0680 33 03 00      mov bl, [d + 3]
0286+  0683 07 49 05      call _atoi        ; convert to int in al
0287+  0686 E5            pop b
0288+  0687 09            ret
0289+  0688             
0290+  0688             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0291+  0688             ; _strtoint
0292+  0688             ; 5 digit base10 string number in d
0293+  0688             ; integer returned in a
0294+  0688             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0295+  0688             _strtoint:
0296+  0688 E2            push si
0297+  0689 D8            push b
0298+  068A D9            push c
0299+  068B DA            push d
0300+  068C 07 EB 04      call _strlen      ; get string length in c
0301+  068F 7E            dec c
0302+  0690 FD 4E         mov si, d
0303+  0692 12            mov a, c
0304+  0693 FD 99         shl a
0305+  0695 3B 0C 08      mov d, table_power
0306+  0698 59            add d, a
0307+  0699 38 00 00      mov c, 0
0308+  069C             _strtoint_l0:
0309+  069C F6            lodsb      ; load ascii to al
0310+  069D B9 00         cmp al, 0
0311+  069F C6 B2 06      je _strtoint_end
0312+  06A2 6F 30         sub al, $30    ; make into integer
0313+  06A4 22 00         mov ah, 0
0314+  06A6 2A            mov b, [d]
0315+  06A7 AC            mul a, b      ; result in b since it fits in 16bits
0316+  06A8 11            mov a, b
0317+  06A9 28            mov b, c
0318+  06AA 54            add a, b
0319+  06AB 39            mov c, a
0320+  06AC 63 02 00      sub d, 2
0321+  06AF 0A 9C 06      jmp _strtoint_l0
0322+  06B2             _strtoint_end:
0323+  06B2 12            mov a, c
0324+  06B3 E7            pop d
0325+  06B4 E6            pop c
0326+  06B5 E5            pop b
0327+  06B6 EF            pop si
0328+  06B7 09            ret
0329+  06B8             
0330+  06B8             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0331+  06B8             ; print null terminated string
0332+  06B8             ; pointer in d
0333+  06B8             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0334+  06B8             _puts:
0335+  06B8 D7            push a
0336+  06B9 DA            push d
0337+  06BA             _puts_l1:
0338+  06BA 1E            mov al, [d]
0339+  06BB B9 00         cmp al, 0
0340+  06BD C6 C9 06      jz _puts_end
0341+  06C0 23            mov ah, al
0342+  06C1 19 00         mov al, 0
0343+  06C3 05 03         syscall sys_io
0344+  06C5 79            inc d
0345+  06C6 0A BA 06      jmp _puts_l1
0346+  06C9             _puts_end:
0347+  06C9 E7            pop d
0348+  06CA E4            pop a
0349+  06CB 09            ret
0350+  06CC             
0351+  06CC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0352+  06CC             ; print n size string
0353+  06CC             ; pointer in d
0354+  06CC             ; size in c
0355+  06CC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0356+  06CC             _putsn:
0357+  06CC DB            push al
0358+  06CD DA            push d
0359+  06CE D9            push c
0360+  06CF             _putsn_l0:
0361+  06CF 1E            mov al, [d]
0362+  06D0 23            mov ah, al
0363+  06D1 19 00         mov al, 0
0364+  06D3 05 03         syscall sys_io
0365+  06D5 79            inc d
0366+  06D6 7E            dec c  
0367+  06D7 C2 00 00      cmp c, 0
0368+  06DA C7 CF 06      jne _putsn_l0
0369+  06DD             _putsn_end:
0370+  06DD E6            pop c
0371+  06DE E7            pop d
0372+  06DF E8            pop al
0373+  06E0 09            ret
0374+  06E1             
0375+  06E1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0376+  06E1             ; print 16bit decimal number
0377+  06E1             ; input number in a
0378+  06E1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0379+  06E1             print_u16d:
0380+  06E1 D7            push a
0381+  06E2 D8            push b
0382+  06E3 FD D8         push g
0383+  06E5 26 10 27      mov b, 10000
0384+  06E8 AE            div a, b      ; get 10000's coeff.
0385+  06E9 07 0D 07      call print_number
0386+  06EC 11            mov a, b
0387+  06ED 26 E8 03      mov b, 1000
0388+  06F0 AE            div a, b      ; get 1000's coeff.
0389+  06F1 07 0D 07      call print_number
0390+  06F4 11            mov a, b
0391+  06F5 26 64 00      mov b, 100
0392+  06F8 AE            div a, b
0393+  06F9 07 0D 07      call print_number
0394+  06FC 11            mov a, b
0395+  06FD 26 0A 00      mov b, 10
0396+  0700 AE            div a, b
0397+  0701 07 0D 07      call print_number
0398+  0704 1B            mov al, bl      ; 1's coeff in bl
0399+  0705 07 0D 07      call print_number
0400+  0708 FD F1         pop g
0401+  070A E5            pop b
0402+  070B E4            pop a
0403+  070C 09            ret
0404+  070D             
0405+  070D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0406+  070D             ; print al
0407+  070D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0408+  070D             print_number:
0409+  070D 6A 30         add al, $30
0410+  070F 23            mov ah, al
0411+  0710 07 8C 05      call _putchar
0412+  0713 09            ret
0413+  0714             
0414+  0714             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0415+  0714             ; print 16bit hex integer
0416+  0714             ; integer value in reg b
0417+  0714             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0418+  0714             print_u16x:
0419+  0714 D7            push a
0420+  0715 D8            push b
0421+  0716 DD            push bl
0422+  0717 30            mov bl, bh
0423+  0718 07 5A 05      call _itoa        ; convert bh to char in a
0424+  071B 2F            mov bl, al        ; save al
0425+  071C 19 00         mov al, 0
0426+  071E 05 03         syscall sys_io        ; display ah
0427+  0720 24            mov ah, bl        ; retrieve al
0428+  0721 19 00         mov al, 0
0429+  0723 05 03         syscall sys_io        ; display al
0430+  0725             
0431+  0725 EA            pop bl
0432+  0726 07 5A 05      call _itoa        ; convert bh to char in a
0433+  0729 2F            mov bl, al        ; save al
0434+  072A 19 00         mov al, 0
0435+  072C 05 03         syscall sys_io        ; display ah
0436+  072E 24            mov ah, bl        ; retrieve al
0437+  072F 19 00         mov al, 0
0438+  0731 05 03         syscall sys_io        ; display al
0439+  0733             
0440+  0733 E5            pop b
0441+  0734 E4            pop a
0442+  0735 09            ret
0443+  0736             
0444+  0736             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0445+  0736             ; input 16bit hex integer
0446+  0736             ; read 16bit integer into a
0447+  0736             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0448+  0736             scan_u16x:
0449+  0736 F8 10 00      enter 16
0450+  0739 D8            push b
0451+  073A DA            push d
0452+  073B             
0453+  073B FA F1 FF      lea d, [bp + -15]
0454+  073E 07 93 05      call _gets        ; get number
0455+  0741             
0456+  0741 32            mov bl, [d]
0457+  0742 37            mov bh, bl
0458+  0743 33 01 00      mov bl, [d + 1]
0459+  0746 07 49 05      call _atoi        ; convert to int in al
0460+  0749 23            mov ah, al        ; move to ah
0461+  074A             
0462+  074A 33 02 00      mov bl, [d + 2]
0463+  074D 37            mov bh, bl
0464+  074E 33 03 00      mov bl, [d + 3]
0465+  0751 07 49 05      call _atoi        ; convert to int in al
0466+  0754             
0467+  0754 E7            pop d
0468+  0755 E5            pop b
0469+  0756 F9            leave
0470+  0757 09            ret
0471+  0758             
0472+  0758             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0473+  0758             ; print 8bit hex integer
0474+  0758             ; integer value in reg bl
0475+  0758             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0476+  0758             print_u8x:
0477+  0758 D7            push a
0478+  0759 DD            push bl
0479+  075A             
0480+  075A 07 5A 05      call _itoa        ; convert bl to char in a
0481+  075D 2F            mov bl, al        ; save al
0482+  075E 19 00         mov al, 0
0483+  0760 05 03         syscall sys_io        ; display ah
0484+  0762 24            mov ah, bl        ; retrieve al
0485+  0763 19 00         mov al, 0
0486+  0765 05 03         syscall sys_io        ; display al
0487+  0767             
0488+  0767 EA            pop bl
0489+  0768 E4            pop a
0490+  0769 09            ret
0491+  076A             
0492+  076A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0493+  076A             ; print 8bit decimal unsigned number
0494+  076A             ; input number in al
0495+  076A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0496+  076A             print_u8d:
0497+  076A D7            push a
0498+  076B D8            push b
0499+  076C FD D8         push g
0500+  076E 22 00         mov ah, 0
0501+  0770 26 64 00      mov b, 100
0502+  0773 AE            div a, b
0503+  0774 D8            push b      ; save remainder
0504+  0775 B9 00         cmp al, 0
0505+  0777 C6 81 07      je skip100
0506+  077A 6A 30         add al, $30
0507+  077C 23            mov ah, al
0508+  077D 19 00         mov al, 0
0509+  077F 05 03         syscall sys_io  ; print coeff
0510+  0781             skip100:
0511+  0781 E4            pop a
0512+  0782 22 00         mov ah, 0
0513+  0784 26 0A 00      mov b, 10
0514+  0787 AE            div a, b
0515+  0788 D8            push b      ; save remainder
0516+  0789 B9 00         cmp al, 0
0517+  078B C6 95 07      je skip10
0518+  078E 6A 30         add al, $30
0519+  0790 23            mov ah, al
0520+  0791 19 00         mov al, 0
0521+  0793 05 03         syscall sys_io  ; print coeff
0522+  0795             skip10:
0523+  0795 E4            pop a
0524+  0796 1B            mov al, bl
0525+  0797 6A 30         add al, $30
0526+  0799 23            mov ah, al
0527+  079A 19 00         mov al, 0
0528+  079C 05 03         syscall sys_io  ; print coeff
0529+  079E FD F1         pop g
0530+  07A0 E5            pop b
0531+  07A1 E4            pop a
0532+  07A2 09            ret
0533+  07A3             
0534+  07A3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0535+  07A3             ; input 8bit hex integer
0536+  07A3             ; read 8bit integer into al
0537+  07A3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0538+  07A3             scan_u8x:
0539+  07A3 F8 04 00      enter 4
0540+  07A6 D8            push b
0541+  07A7 DA            push d
0542+  07A8             
0543+  07A8 FA FD FF      lea d, [bp + -3]
0544+  07AB 07 93 05      call _gets        ; get number
0545+  07AE             
0546+  07AE 32            mov bl, [d]
0547+  07AF 37            mov bh, bl
0548+  07B0 33 01 00      mov bl, [d + 1]
0549+  07B3 07 49 05      call _atoi        ; convert to int in al
0550+  07B6             
0551+  07B6 E7            pop d
0552+  07B7 E5            pop b
0553+  07B8 F9            leave
0554+  07B9 09            ret
0555+  07BA             
0556+  07BA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0557+  07BA             ; input decimal number
0558+  07BA             ; result in a
0559+  07BA             ; 655'\0'
0560+  07BA             ; low--------high
0561+  07BA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0562+  07BA             scan_u16d:
0563+  07BA F8 08 00      enter 8
0564+  07BD E2            push si
0565+  07BE D8            push b
0566+  07BF D9            push c
0567+  07C0 DA            push d
0568+  07C1 FA F9 FF      lea d, [bp +- 7]
0569+  07C4 07 93 05      call _gets
0570+  07C7 07 EB 04      call _strlen      ; get string length in c
0571+  07CA 7E            dec c
0572+  07CB FD 4E         mov si, d
0573+  07CD 12            mov a, c
0574+  07CE FD 99         shl a
0575+  07D0 3B 0C 08      mov d, table_power
0576+  07D3 59            add d, a
0577+  07D4 38 00 00      mov c, 0
0578+  07D7             mul_loop:
0579+  07D7 F6            lodsb      ; load ascii to al
0580+  07D8 B9 00         cmp al, 0
0581+  07DA C6 ED 07      je mul_exit
0582+  07DD 6F 30         sub al, $30    ; make into integer
0583+  07DF 22 00         mov ah, 0
0584+  07E1 2A            mov b, [d]
0585+  07E2 AC            mul a, b      ; result in b since it fits in 16bits
0586+  07E3 11            mov a, b
0587+  07E4 28            mov b, c
0588+  07E5 54            add a, b
0589+  07E6 39            mov c, a
0590+  07E7 63 02 00      sub d, 2
0591+  07EA 0A D7 07      jmp mul_loop
0592+  07ED             mul_exit:
0593+  07ED 12            mov a, c
0594+  07EE E7            pop d
0595+  07EF E6            pop c
0596+  07F0 E5            pop b
0597+  07F1 EF            pop si
0598+  07F2 F9            leave
0599+  07F3 09            ret
0600+  07F4             
0601+  07F4             
0602+  07F4 30 31 32 33 s_hex_digits:    .db "0123456789abcdef"  
0602+  07F8 34 35 36 37 
0602+  07FC 38 39 61 62 
0602+  0800 63 64 65 66 
0603+  0804 1B 5B 32 6A s_telnet_clear:  .db "\033[2j\033[h", 0
0603+  0808 1B 5B 68 00 
0604+  080C             
0605+  080C             table_power:
0606+  080C 01 00         .dw 1
0607+  080E 0A 00         .dw 10
0608+  0810 64 00         .dw 100
0609+  0812 E8 03         .dw 1000
0610+  0814 10 27         .dw 100001053   0816             .include "lib/ctype.asm"
0001+  0816             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002+  0816             ; ctype.s
0003+  0816             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004+  0816             
0005+  0816             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0006+  0816             ;; c character classification is an operation provided by a group of functions in the ansi c standard library
0007+  0816             ;; for the c programming language. these functions are used to test characters for membership in a particular
0008+  0816             ;; class of characters, such as alphabetic characters, control characters, etc. both single-byte, and wide
0009+  0816             ;; characters are supported.
0010+  0816             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0011+  0816             ;; _isalnum 
0012+  0816             ;; _isalpha 
0013+  0816             ;; islower 
0014+  0816             ;; isupper 
0015+  0816             ;; _isdigit 
0016+  0816             ;; isxdigit
0017+  0816             ;; iscntrl 
0018+  0816             ;; isgraph 
0019+  0816             ;; _isspace 
0020+  0816             ;; isblank 
0021+  0816             ;; isprint 
0022+  0816             ;; ispunct 
0023+  0816             ;; tolower 
0024+  0816             ;; toupper
0025+  0816             
0026+  0816             
0027+  0816             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0028+  0816             ;; is alphanumeric
0029+  0816             ;; sets zf according with result
0030+  0816             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0031+  0816             _isalnum:
0032+  0816 07 33 08    	call _isalpha
0033+  0819 C6 1F 08    	je _isalnum_exit
0034+  081C 07 20 08    	call _isdigit
0035+  081F             _isalnum_exit:
0036+  081F 09          	ret	
0037+  0820             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0038+  0820             ;; is digit
0039+  0820             ;; sets zf according with result
0040+  0820             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0041+  0820             _isdigit:
0042+  0820 DB          	push al
0043+  0821 B9 30       	cmp al, '0'
0044+  0823 C8 2F 08    	jlu _isdigit_false
0045+  0826 B9 39       	cmp al, '9'
0046+  0828 D1 2F 08    	jgu _isdigit_false
0047+  082B 87 00       	and al, 0	; set zf
0048+  082D E8          	pop al
0049+  082E 09          	ret
0050+  082F             _isdigit_false:
0051+  082F 8B 01       	or al, 1	; clear zf
0052+  0831 E8          	pop al
0053+  0832 09          	ret	
0054+  0833             	
0055+  0833             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0056+  0833             ;; is alpha
0057+  0833             ;; sets zf according with result
0058+  0833             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0059+  0833             _isalpha:
0060+  0833 DB          	push al
0061+  0834 B9 5F       	cmp al, '_'
0062+  0836 C6 56 08    	je _isalpha_true
0063+  0839 B9 2E       	cmp al, '.'
0064+  083B C6 56 08    	je _isalpha_true
0065+  083E B9 61       	cmp al, 'a'
0066+  0840 C8 52 08    	jlu _isalpha_false
0067+  0843 B9 7A       	cmp al, 'z'
0068+  0845 D1 52 08    	jgu _isalpha_false
0069+  0848 B9 7A       	cmp al, 'z'
0070+  084A D0 56 08    	jleu _isalpha_true
0071+  084D B9 61       	cmp al, 'a'
0072+  084F C9 56 08    	jgeu _isalpha_true
0073+  0852             _isalpha_false:
0074+  0852 8B 01       	or al, 1	; clear zf
0075+  0854 E8          	pop al
0076+  0855 09          	ret
0077+  0856             _isalpha_true:
0078+  0856 87 00       	and al, 0	; set zf
0079+  0858 E8          	pop al
0080+  0859 09          	ret
0081+  085A             
0082+  085A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0083+  085A             ;; is path-alpha
0084+  085A             ;; sets zf according with result
0085+  085A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0086+  085A             ispath:
0087+  085A DB          	push al
0088+  085B 07 20 08    	call _isdigit
0089+  085E C6 88 08    	je ispath_true
0090+  0861 B9 5F       	cmp al, '_'
0091+  0863 C6 88 08    	je ispath_true
0092+  0866 B9 2F       	cmp al, '/'
0093+  0868 C6 88 08    	je ispath_true
0094+  086B B9 2E       	cmp al, '.'
0095+  086D C6 88 08    	je ispath_true
0096+  0870 B9 61       	cmp al, 'a'
0097+  0872 C8 84 08    	jlu ispath_false
0098+  0875 B9 7A       	cmp al, 'z'
0099+  0877 D1 84 08    	jgu ispath_false
0100+  087A B9 7A       	cmp al, 'z'
0101+  087C D0 88 08    	jleu ispath_true
0102+  087F B9 61       	cmp al, 'a'
0103+  0881 C9 88 08    	jgeu ispath_true
0104+  0884             ispath_false:
0105+  0884 8B 01       	or al, 1	; clear zf
0106+  0886 E8          	pop al
0107+  0887 09          	ret
0108+  0888             ispath_true:
0109+  0888 87 00       	and al, 0	; set zf
0110+  088A E8          	pop al
0111+  088B 09          	ret
0112+  088C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0113+  088C             ;; is space
0114+  088C             ;; sets zf according with result
0115+  088C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0116+  088C             _isspace:
0117+  088C B9 20       	cmp al, $20		; ' '
0118+  088E C6 A2 08    	je _isspace_exit
0119+  0891 B9 09       	cmp al, $09		; '\t'
0120+  0893 C6 A2 08    	je _isspace_exit
0121+  0896 B9 0A       	cmp al, $0a		; '\n'
0122+  0898 C6 A2 08    	je _isspace_exit
0123+  089B B9 0D       	cmp al, $0d		; '\r'
0124+  089D C6 A2 08    	je _isspace_exit
0125+  08A0 B9 0B       	cmp al, $0b		; '\v'
0126+  08A2             _isspace_exit:
0127+  08A2 09          	ret	
0128+  08A3             
0129+  08A3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0130+  08A3             ; to lower
0131+  08A3             ; input in al
0132+  08A3             ; output in al
0133+  08A3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0134+  08A3             _to_lower:
0135+  08A3 B9 7A       	cmp al, 'z'
0136+  08A5 D1 AA 08    	jgu _to_lower_ret
0137+  08A8 6A 20       	add al, $20				; convert to lower case
0138+  08AA             _to_lower_ret:
0139+  08AA 09          	ret
0140+  08AB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0141+  08AB             ; to upper
0142+  08AB             ; input in al
0143+  08AB             ; output in al
0144+  08AB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0145+  08AB             _to_upper:
0146+  08AB B9 61       	cmp al, 'a'
0147+  08AD C8 B2 08    	jlu _to_upper_ret
0148+  08B0 6F 20       	sub al, $20			; convert to upper case
0149+  08B2             _to_upper_ret:
0150+  08B2 09          	ret
0151+  08B3             
1054   08B3             .include "lib/token.asm"
0001+  08B3             toktyp_identifier  .equ 0
0002+  08B3             toktyp_keyword     .equ 1
0003+  08B3             toktyp_delimiter   .equ 2
0004+  08B3             toktyp_string      .equ 3
0005+  08B3             toktyp_char        .equ 4
0006+  08B3             toktyp_numeric     .equ 5
0007+  08B3             toktyp_end         .equ 6
0008+  08B3             
0009+  08B3             tok_null           .equ 0
0010+  08B3             tok_fslash         .equ 1
0011+  08B3             tok_times          .equ 2
0012+  08B3             tok_plus           .equ 3
0013+  08B3             tok_minus          .equ 4
0014+  08B3             tok_dot            .equ 5
0015+  08B3             tok_semi           .equ 6
0016+  08B3             tok_angle          .equ 7
0017+  08B3             tok_tilde          .equ 8
0018+  08B3             tok_equal          .equ 9
0019+  08B3             tok_colon          .equ 10
0020+  08B3             tok_comma          .equ 11
0021+  08B3             
0022+  08B3             tok_end            .equ 20
0023+  08B3             
0024+  08B3             
0025+  08B3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0026+  08B3             ;; read a full command argment from shell input buffer
0027+  08B3             ;; argument is written into tokstr
0028+  08B3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0029+  08B3             get_arg:
0030+  08B3 D7            push a
0031+  08B4 E2            push si
0032+  08B5 E3            push di
0033+  08B6 19 00         mov al, 0
0034+  08B8 3D E1 0A      mov [tokstr], al      ; nullify tokstr string
0035+  08BB 14 DD 0A      mov a, [prog]
0036+  08BE 4D            mov si, a
0037+  08BF FD 4F E1 0A   mov di, tokstr
0038+  08C3             get_arg_skip_spaces:
0039+  08C3 F6            lodsb
0040+  08C4 07 8C 08      call _isspace
0041+  08C7 C6 C3 08      je get_arg_skip_spaces
0042+  08CA             get_arg_l0:
0043+  08CA B9 3B         cmp al, $3b        ; check if is ';'
0044+  08CC C6 D9 08      je get_arg_end
0045+  08CF B9 00         cmp al, 0
0046+  08D1 C6 D9 08      je get_arg_end      ; check if end of input
0047+  08D4 F7            stosb
0048+  08D5 F6            lodsb
0049+  08D6 0A CA 08      jmp get_arg_l0
0050+  08D9             get_arg_end:
0051+  08D9 19 00         mov al, 0
0052+  08DB F7            stosb
0053+  08DC D5 01 00      sub si, 1
0054+  08DF 4E            mov a, si
0055+  08E0 42 DD 0A      mov [prog], a    ; update pointer
0056+  08E3 F0            pop di
0057+  08E4 EF            pop si
0058+  08E5 E4            pop a
0059+  08E6 09            ret
0060+  08E7             
0061+  08E7             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0062+  08E7             ;; read a path formation from shell input buffer
0063+  08E7             ;; path is written into tokstr
0064+  08E7             ;; /usr/bin
0065+  08E7             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0066+  08E7             get_path:
0067+  08E7 D7            push a
0068+  08E8 E2            push si
0069+  08E9 E3            push di
0070+  08EA 19 00         mov al, 0
0071+  08EC 3D E1 0A      mov [tokstr], al      ; nullify tokstr string
0072+  08EF 14 DD 0A      mov a, [prog]
0073+  08F2 4D            mov si, a
0074+  08F3 FD 4F E1 0A   mov di, tokstr
0075+  08F7             get_path_skip_spaces:
0076+  08F7 F6            lodsb
0077+  08F8 07 8C 08      call _isspace
0078+  08FB C6 F7 08      je get_path_skip_spaces
0079+  08FE             get_path_is_pathchar:
0080+  08FE F7            stosb
0081+  08FF F6            lodsb
0082+  0900 07 16 08      call _isalnum      ;check if is alphanumeric
0083+  0903 C6 FE 08      je get_path_is_pathchar
0084+  0906 B9 2F         cmp al, '/'        ; check if is '/'
0085+  0908 C6 FE 08      je get_path_is_pathchar
0086+  090B 19 00         mov al, 0
0087+  090D F7            stosb
0088+  090E D5 01 00      sub si, 1
0089+  0911 4E            mov a, si
0090+  0912 42 DD 0A      mov [prog], a    ; update pointer
0091+  0915             get_path_end:
0092+  0915 F0            pop di
0093+  0916 EF            pop si
0094+  0917 E4            pop a
0095+  0918 09            ret
0096+  0919             
0097+  0919             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0098+  0919             ;; read a line
0099+  0919             ;; line is written into tokstr
0100+  0919             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0101+  0919             get_line:
0102+  0919 D7            push a
0103+  091A E2            push si
0104+  091B E3            push di
0105+  091C 19 00         mov al, 0
0106+  091E 3D E1 0A      mov [tokstr], al      ; nullify tokstr string
0107+  0921 14 DD 0A      mov a, [prog]
0108+  0924 4D            mov si, a
0109+  0925 FD 4F E1 0A   mov di, tokstr
0110+  0929             get_line_l0:
0111+  0929 F6            lodsb
0112+  092A B9 0A         cmp al, $0a    ; check for new line
0113+  092C C6 33 09      je get_line_exit
0114+  092F F7            stosb
0115+  0930 0A 29 09      jmp get_line_l0
0116+  0933             get_line_exit:
0117+  0933 19 00         mov al, 0
0118+  0935 F7            stosb
0119+  0936 4E            mov a, si
0120+  0937 42 DD 0A      mov [prog], a    ; update pointer
0121+  093A F0            pop di
0122+  093B EF            pop si
0123+  093C E4            pop a
0124+  093D 09            ret
0125+  093E             
0126+  093E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0127+  093E             ;; token parser
0128+  093E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0129+  093E             get_token:
0130+  093E D7            push a
0131+  093F DA            push d
0132+  0940 E2            push si
0133+  0941 E3            push di
0134+  0942 19 00         mov al, 0
0135+  0944 3D E1 0A      mov [tokstr], al      ; nullify tokstr string
0136+  0947 19 00         mov al, tok_null
0137+  0949 3D E0 0A      mov [tok], al        ; nullify token
0138+  094C 14 DD 0A      mov a, [prog]
0139+  094F 4D            mov si, a
0140+  0950 FD 4F E1 0A   mov di, tokstr
0141+  0954             get_tok_skip_spaces:
0142+  0954 F6            lodsb
0143+  0955 07 8C 08      call _isspace
0144+  0958 C6 54 09      je get_tok_skip_spaces
0145+  095B B9 00         cmp al, 0      ; check for end of input (null)
0146+  095D C6 42 0A      je get_token_end
0147+  0960 B9 23         cmp al, '#'      ; comments!
0148+  0962 C6 70 0A      je get_tok_comment
0149+  0965 07 16 08      call _isalnum
0150+  0968 C6 4F 0A      jz is_alphanumeric
0151+  096B             ; other token types
0152+  096B             get_token_slash:
0153+  096B B9 2F         cmp al, '/'        ; check if '/'
0154+  096D C7 85 09      jne get_token_minus
0155+  0970 F7            stosb          ; store '/' into token string
0156+  0971 19 00         mov al, 0
0157+  0973 F7            stosb          ; terminate token string
0158+  0974 19 01         mov al, tok_fslash
0159+  0976 3D E0 0A      mov [tok], al      
0160+  0979 19 02         mov al, toktyp_delimiter
0161+  097B 3D DF 0A      mov [toktyp], al
0162+  097E 4E            mov a, si
0163+  097F 42 DD 0A      mov [prog], a    ; update pointer
0164+  0982 0A 6B 0A      jmp get_token_return
0165+  0985             get_token_minus:
0166+  0985 B9 2D         cmp al, '-'        ; check if '-'
0167+  0987 C7 9F 09      jne get_token_comma
0168+  098A F7            stosb          ; store '-' into token string
0169+  098B 19 00         mov al, 0
0170+  098D F7            stosb          ; terminate token string
0171+  098E 19 04         mov al, tok_minus
0172+  0990 3D E0 0A      mov [tok], al      
0173+  0993 19 02         mov al, toktyp_delimiter
0174+  0995 3D DF 0A      mov [toktyp], al
0175+  0998 4E            mov a, si
0176+  0999 42 DD 0A      mov [prog], a    ; update pointer
0177+  099C 0A 6B 0A      jmp get_token_return
0178+  099F             get_token_comma:
0179+  099F B9 2C         cmp al, ','        ; check if ','
0180+  09A1 C7 B9 09      jne get_token_semi
0181+  09A4 F7            stosb          ; store ',' into token string
0182+  09A5 19 00         mov al, 0
0183+  09A7 F7            stosb          ; terminate token string
0184+  09A8 19 0B         mov al, tok_comma
0185+  09AA 3D E0 0A      mov [tok], al      
0186+  09AD 19 02         mov al, toktyp_delimiter
0187+  09AF 3D DF 0A      mov [toktyp], al
0188+  09B2 4E            mov a, si
0189+  09B3 42 DD 0A      mov [prog], a    ; update pointer
0190+  09B6 0A 6B 0A      jmp get_token_return
0191+  09B9             get_token_semi:
0192+  09B9 B9 3B         cmp al, $3b        ; check if ';'
0193+  09BB C7 D3 09      jne get_token_colon
0194+  09BE F7            stosb          ; store ';' into token string
0195+  09BF 19 00         mov al, 0
0196+  09C1 F7            stosb          ; terminate token string
0197+  09C2 19 06         mov al, tok_semi
0198+  09C4 3D E0 0A      mov [tok], al      
0199+  09C7 19 02         mov al, toktyp_delimiter
0200+  09C9 3D DF 0A      mov [toktyp], al
0201+  09CC 4E            mov a, si
0202+  09CD 42 DD 0A      mov [prog], a    ; update pointer
0203+  09D0 0A 6B 0A      jmp get_token_return
0204+  09D3             get_token_colon:
0205+  09D3 B9 3A         cmp al, $3a        ; check if ':'
0206+  09D5 C7 ED 09      jne get_token_angle
0207+  09D8 F7            stosb          ; store ':' into token string
0208+  09D9 19 00         mov al, 0
0209+  09DB F7            stosb          ; terminate token string
0210+  09DC 19 0A         mov al, tok_colon
0211+  09DE 3D E0 0A      mov [tok], al      
0212+  09E1 19 02         mov al, toktyp_delimiter
0213+  09E3 3D DF 0A      mov [toktyp], al
0214+  09E6 4E            mov a, si
0215+  09E7 42 DD 0A      mov [prog], a    ; update pointer
0216+  09EA 0A 6B 0A      jmp get_token_return
0217+  09ED             get_token_angle:
0218+  09ED B9 3E         cmp al, $3e        ; check if '>'
0219+  09EF C7 07 0A      jne get_token_tilde
0220+  09F2 F7            stosb          ; store '>' into token string
0221+  09F3 19 00         mov al, 0
0222+  09F5 F7            stosb          ; terminate token string
0223+  09F6 19 07         mov al, tok_angle
0224+  09F8 3D E0 0A      mov [tok], al      
0225+  09FB 19 02         mov al, toktyp_delimiter
0226+  09FD 3D DF 0A      mov [toktyp], al
0227+  0A00 4E            mov a, si
0228+  0A01 42 DD 0A      mov [prog], a    ; update pointer
0229+  0A04 0A 6B 0A      jmp get_token_return
0230+  0A07             get_token_tilde:
0231+  0A07 B9 7E         cmp al, '~'        ; check if '~'
0232+  0A09 C7 21 0A      jne get_token_equal
0233+  0A0C F7            stosb          ; store '~' into token string
0234+  0A0D 19 00         mov al, 0
0235+  0A0F F7            stosb          ; terminate token string
0236+  0A10 19 08         mov al, tok_tilde
0237+  0A12 3D E0 0A      mov [tok], al      
0238+  0A15 19 02         mov al, toktyp_delimiter
0239+  0A17 3D DF 0A      mov [toktyp], al
0240+  0A1A 4E            mov a, si
0241+  0A1B 42 DD 0A      mov [prog], a    ; update pointer
0242+  0A1E 0A 6B 0A      jmp get_token_return
0243+  0A21             get_token_equal:
0244+  0A21 B9 3D         cmp al, '='        ; check if '='
0245+  0A23 C7 3B 0A      jne get_token_skip
0246+  0A26 F7            stosb          ; store '=' into token string
0247+  0A27 19 00         mov al, 0
0248+  0A29 F7            stosb          ; terminate token string
0249+  0A2A 19 09         mov al, tok_equal
0250+  0A2C 3D E0 0A      mov [tok], al      
0251+  0A2F 19 02         mov al, toktyp_delimiter
0252+  0A31 3D DF 0A      mov [toktyp], al
0253+  0A34 4E            mov a, si
0254+  0A35 42 DD 0A      mov [prog], a    ; update pointer
0255+  0A38 0A 6B 0A      jmp get_token_return
0256+  0A3B             get_token_skip:
0257+  0A3B 4E            mov a, si
0258+  0A3C 42 DD 0A      mov [prog], a    ; update pointer
0259+  0A3F 0A 6B 0A      jmp get_token_return
0260+  0A42             get_token_end:        ; end of file token
0261+  0A42 19 14         mov al, tok_end
0262+  0A44 3D E0 0A      mov [tok], al
0263+  0A47 19 06         mov al, toktyp_end
0264+  0A49 3D DF 0A      mov [toktyp], al
0265+  0A4C 0A 6B 0A      jmp get_token_return
0266+  0A4F             is_alphanumeric:
0267+  0A4F F7            stosb
0268+  0A50 F6            lodsb
0269+  0A51 07 16 08      call _isalnum      ;check if is alphanumeric
0270+  0A54 C6 4F 0A      jz is_alphanumeric
0271+  0A57 B9 2E         cmp al, $2e        ; check if is '.'
0272+  0A59 C6 4F 0A      je is_alphanumeric
0273+  0A5C 19 00         mov al, 0
0274+  0A5E F7            stosb
0275+  0A5F 19 00         mov al, toktyp_identifier
0276+  0A61 3D DF 0A      mov [toktyp], al
0277+  0A64 D5 01 00      sub si, 1
0278+  0A67 4E            mov a, si
0279+  0A68 42 DD 0A      mov [prog], a    ; update pointer
0280+  0A6B             get_token_return:
0281+  0A6B F0            pop di
0282+  0A6C EF            pop si
0283+  0A6D E7            pop d
0284+  0A6E E4            pop a
0285+  0A6F 09            ret
0286+  0A70             get_tok_comment:
0287+  0A70 F6            lodsb
0288+  0A71 B9 0A         cmp al, $0a      ; new line
0289+  0A73 C7 70 0A      jne get_tok_comment
0290+  0A76 0A 54 09      jmp get_tok_skip_spaces
0291+  0A79             
0292+  0A79             
0293+  0A79             get_number:
0294+  0A79 D7            push a
0295+  0A7A DA            push d
0296+  0A7B E2            push si
0297+  0A7C E3            push di
0298+  0A7D 19 00         mov al, 0
0299+  0A7F 3D E1 0A      mov [tokstr], al      ; nullify tokstr string
0300+  0A82 19 00         mov al, tok_null
0301+  0A84 3D E0 0A      mov [tok], al        ; nullify token
0302+  0A87 14 DD 0A      mov a, [prog]
0303+  0A8A 4D            mov si, a
0304+  0A8B FD 4F E1 0A   mov di, tokstr
0305+  0A8F             get_number_skip_spaces:
0306+  0A8F F6            lodsb
0307+  0A90 07 8C 08      call _isspace
0308+  0A93 C6 8F 0A      je get_number_skip_spaces
0309+  0A96 B9 00         cmp al, 0      ; check for end of input (null)
0310+  0A98 C7 A8 0A      jne get_number_l0
0311+  0A9B 19 14         mov al, tok_end
0312+  0A9D 3D E0 0A      mov [tok], al
0313+  0AA0 19 06         mov al, toktyp_end
0314+  0AA2 3D DF 0A      mov [toktyp], al
0315+  0AA5 0A BF 0A      jmp get_number_return
0316+  0AA8             get_number_l0:
0317+  0AA8 F7            stosb
0318+  0AA9 F6            lodsb
0319+  0AAA 07 20 08      call _isdigit      ;check if is numeric
0320+  0AAD C6 A8 0A      jz get_number_l0
0321+  0AB0 19 00         mov al, 0
0322+  0AB2 F7            stosb
0323+  0AB3 19 05         mov al, toktyp_numeric
0324+  0AB5 3D DF 0A      mov [toktyp], al
0325+  0AB8 D5 01 00      sub si, 1
0326+  0ABB 4E            mov a, si
0327+  0ABC 42 DD 0A      mov [prog], a    ; update pointer
0328+  0ABF             get_number_return:
0329+  0ABF F0            pop di
0330+  0AC0 EF            pop si
0331+  0AC1 E7            pop d
0332+  0AC2 E4            pop a
0333+  0AC3 09            ret
0334+  0AC4             
0335+  0AC4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0336+  0AC4             ;; put back token
0337+  0AC4             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  
0338+  0AC4             _putback:
0339+  0AC4 D7            push a
0340+  0AC5 E2            push si
0341+  0AC6 FD 4D E1 0A   mov si, tokstr  
0342+  0ACA             _putback_loop:
0343+  0ACA F6            lodsb
0344+  0ACB B9 00         cmp al, 0
0345+  0ACD C6 DA 0A      je _putback_end
0346+  0AD0 14 DD 0A      mov a, [prog]
0347+  0AD3 7D            dec a
0348+  0AD4 42 DD 0A      mov [prog], a      ; update pointer
0349+  0AD7 0A CA 0A      jmp _putback_loop
0350+  0ADA             _putback_end:
0351+  0ADA EF            pop si
0352+  0ADB E4            pop a
0353+  0ADC 09            ret
0354+  0ADD             
0355+  0ADD             
0356+  0ADD             
0357+  0ADD             
0358+  0ADD 00 00       prog:      .dw 0          ; pointer to current position in buffer
0359+  0ADF             
0360+  0ADF 00          toktyp:    .db 0          ; token type symbol
0361+  0AE0 00          tok:       .db 0          ; current token symbol
0362+  0AE1 00 00 00 00 tokstr:    .fill 256, 0   ; token as a string
0362+  0AE5 00 00 00 00 
0362+  0AE9 00 00 00 00 
0362+  0AED 00 00 00 00 
0362+  0AF1 00 00 00 00 
0362+  0AF5 00 00 00 00 
0362+  0AF9 00 00 00 00 
0362+  0AFD 00 00 00 00 
0362+  0B01 00 00 00 00 
0362+  0B05 00 00 00 00 
0362+  0B09 00 00 00 00 
0362+  0B0D 00 00 00 00 
0362+  0B11 00 00 00 00 
0362+  0B15 00 00 00 00 
0362+  0B19 00 00 00 00 
0362+  0B1D 00 00 00 00 
0362+  0B21 00 00 00 00 
0362+  0B25 00 00 00 00 
0362+  0B29 00 00 00 00 
0362+  0B2D 00 00 00 00 
0362+  0B31 00 00 00 00 
0362+  0B35 00 00 00 00 
0362+  0B39 00 00 00 00 
0362+  0B3D 00 00 00 00 
0362+  0B41 00 00 00 00 
0362+  0B45 00 00 00 00 
0362+  0B49 00 00 00 00 
0362+  0B4D 00 00 00 00 
0362+  0B51 00 00 00 00 
0362+  0B55 00 00 00 00 
0362+  0B59 00 00 00 00 
0362+  0B5D 00 00 00 00 
0362+  0B61 00 00 00 00 
0362+  0B65 00 00 00 00 
0362+  0B69 00 00 00 00 
0362+  0B6D 00 00 00 00 
0362+  0B71 00 00 00 00 
0362+  0B75 00 00 00 00 
0362+  0B79 00 00 00 00 
0362+  0B7D 00 00 00 00 
0362+  0B81 00 00 00 00 
0362+  0B85 00 00 00 00 
0362+  0B89 00 00 00 00 
0362+  0B8D 00 00 00 00 
0362+  0B91 00 00 00 00 
0362+  0B95 00 00 00 00 
0362+  0B99 00 00 00 00 
0362+  0B9D 00 00 00 00 
0362+  0BA1 00 00 00 00 
0362+  0BA5 00 00 00 00 
0362+  0BA9 00 00 00 00 
0362+  0BAD 00 00 00 00 
0362+  0BB1 00 00 00 00 
0362+  0BB5 00 00 00 00 
0362+  0BB9 00 00 00 00 
0362+  0BBD 00 00 00 00 
0362+  0BC1 00 00 00 00 
0362+  0BC5 00 00 00 00 
0362+  0BC9 00 00 00 00 
0362+  0BCD 00 00 00 00 
0362+  0BD1 00 00 00 00 
0362+  0BD5 00 00 00 00 
0362+  0BD9 00 00 00 00 
0362+  0BDD 00 00 00 00 
1055   0BE1             
1056   0BE1             ; kernel parameters
1057   0BE1             ; baud  divisor
1058   0BE1             ; 50    2304
1059   0BE1             ; 110   1047
1060   0BE1             ; 300    384
1061   0BE1             ; 600    192
1062   0BE1             ; 1200    96
1063   0BE1             ; 9600    12
1064   0BE1             ; 19200    6
1065   0BE1             ; 38400    3
1066   0BE1             sys_uart0_lcr:
1067   0BE1 0F            .db %00001111 ; 8 data bits, 2 stop bits, enable parity, even parity
1068   0BE2             sys_uart0_inten:
1069   0BE2 01            .db 1
1070   0BE3             sys_uart0_fifoen:
1071   0BE3 00            .db 0
1072   0BE4             sys_uart0_div0:
1073   0BE4 03            .db 3
1074   0BE5             sys_uart0_div1:
1075   0BE5 00            .db 0   ; default baud = 38400
1076   0BE6             
1077   0BE6             sys_uart1_lcr:
1078   0BE6 0F            .db %00001111 ; 8 data bits, 2 stop bits, enable parity, even parity
1079   0BE7             sys_uart1_inten:
1080   0BE7 01            .db 1
1081   0BE8             sys_uart1_fifoen:
1082   0BE8 00            .db 0
1083   0BE9             sys_uart1_div0:
1084   0BE9 03            .db 3
1085   0BEA             sys_uart1_div1:
1086   0BEA 00            .db 0   ; default baud = 38400
1087   0BEB             
1088   0BEB             fifo_in:
1089   0BEB 79 0E         .dw fifo
1090   0BED             fifo_out:
1091   0BED 79 0E         .dw fifo
1092   0BEF             
1093   0BEF             ; file system variables
1094   0BEF             current_dir_id:
1095   0BEF 00 00         .dw 0     ; keep dirid of current directory
1096   0BF1             s_init_path:
1097   0BF1 2F 73 62 69   .db "/sbin/init", 0
1097   0BF5 6E 2F 69 6E 
1097   0BF9 69 74 00 
1098   0BFC             
1099   0BFC             s_uname:
1100   0BFC 73 6F 6C 61   .db "solarium v.1.0", 0
1100   0C00 72 69 75 6D 
1100   0C04 20 76 2E 31 
1100   0C08 2E 30 00 
1101   0C0B             s_dataentry:
1102   0C0B 3E 20 00      .db "> ", 0
1103   0C0E             s_parent_dir:
1104   0C0E 2E 2E 00      .db "..", 0
1105   0C11             s_current_dir:
1106   0C11 2E 00         .db ".", 0
1107   0C13             s_fslash:
1108   0C13 2F 00         .db "/", 0
1109   0C15             file_attrib:
1110   0C15 2D 72 77 20   .db "-rw x"      ; chars at powers of 2
1110   0C19 78 
1111   0C1A             file_type:
1112   0C1A 2D 64 63      .db "-dc"
1113   0C1D             s_ps_header:
1114   0C1D 70 69 64 20   .db "pid command\n", 0
1114   0C21 63 6F 6D 6D 
1114   0C25 61 6E 64 0A 
1114   0C29 00 
1115   0C2A             s_ls_total:
1116   0C2A 74 6F 74 61   .db "total: ", 0
1116   0C2E 6C 3A 20 00 
1117   0C32             
1118   0C32             s_int_en:
1119   0C32 69 72 71 73   .db "irqs enabled\n", 0
1119   0C36 20 65 6E 61 
1119   0C3A 62 6C 65 64 
1119   0C3E 0A 00 
1120   0C40             s_kernel_welcome:
1121   0C40 2A 2A 2A 2A   .db "************************************************\n"
1121   0C44 2A 2A 2A 2A 
1121   0C48 2A 2A 2A 2A 
1121   0C4C 2A 2A 2A 2A 
1121   0C50 2A 2A 2A 2A 
1121   0C54 2A 2A 2A 2A 
1121   0C58 2A 2A 2A 2A 
1121   0C5C 2A 2A 2A 2A 
1121   0C60 2A 2A 2A 2A 
1121   0C64 2A 2A 2A 2A 
1121   0C68 2A 2A 2A 2A 
1121   0C6C 2A 2A 2A 2A 
1121   0C70 0A 
1122   0C71 2A 2A 2A 20   .db "*** Welcome to Solarium OS - Kernel ver. 1.0 ***\n"
1122   0C75 57 65 6C 63 
1122   0C79 6F 6D 65 20 
1122   0C7D 74 6F 20 53 
1122   0C81 6F 6C 61 72 
1122   0C85 69 75 6D 20 
1122   0C89 4F 53 20 2D 
1122   0C8D 20 4B 65 72 
1122   0C91 6E 65 6C 20 
1122   0C95 76 65 72 2E 
1122   0C99 20 31 2E 30 
1122   0C9D 20 2A 2A 2A 
1122   0CA1 0A 
1123   0CA2 2A 2A 2A 20   .db "*** type help for more information           ***\n"
1123   0CA6 74 79 70 65 
1123   0CAA 20 68 65 6C 
1123   0CAE 70 20 66 6F 
1123   0CB2 72 20 6D 6F 
1123   0CB6 72 65 20 69 
1123   0CBA 6E 66 6F 72 
1123   0CBE 6D 61 74 69 
1123   0CC2 6F 6E 20 20 
1123   0CC6 20 20 20 20 
1123   0CCA 20 20 20 20 
1123   0CCE 20 2A 2A 2A 
1123   0CD2 0A 
1124   0CD3 2A 2A 2A 2A   .db "************************************************\n", 0
1124   0CD7 2A 2A 2A 2A 
1124   0CDB 2A 2A 2A 2A 
1124   0CDF 2A 2A 2A 2A 
1124   0CE3 2A 2A 2A 2A 
1124   0CE7 2A 2A 2A 2A 
1124   0CEB 2A 2A 2A 2A 
1124   0CEF 2A 2A 2A 2A 
1124   0CF3 2A 2A 2A 2A 
1124   0CF7 2A 2A 2A 2A 
1124   0CFB 2A 2A 2A 2A 
1124   0CFF 2A 2A 2A 2A 
1124   0D03 0A 00 
1125   0D05             s_prompt_init:
1126   0D05 73 74 61 72   .db "starting init\n", 0
1126   0D09 74 69 6E 67 
1126   0D0D 20 69 6E 69 
1126   0D11 74 0A 00 
1127   0D14             s_priviledge:
1128   0D14 0A 65 78 63   .db "\nexception: privilege\n", 0
1128   0D18 65 70 74 69 
1128   0D1C 6F 6E 3A 20 
1128   0D20 70 72 69 76 
1128   0D24 69 6C 65 67 
1128   0D28 65 0A 00 
1129   0D2B             s_divzero:
1130   0D2B 0A 65 78 63   .db "\nexception: zero division\n", 0
1130   0D2F 65 70 74 69 
1130   0D33 6F 6E 3A 20 
1130   0D37 7A 65 72 6F 
1130   0D3B 20 64 69 76 
1130   0D3F 69 73 69 6F 
1130   0D43 6E 0A 00 
1131   0D46             
1132   0D46             s_break1:  
1133   0D46 0A 64 65 62   .db "\ndebugger entry point.\n"
1133   0D4A 75 67 67 65 
1133   0D4E 72 20 65 6E 
1133   0D52 74 72 79 20 
1133   0D56 70 6F 69 6E 
1133   0D5A 74 2E 0A 
1134   0D5D 30 2E 20 73   .db "0. show registers\n"
1134   0D61 68 6F 77 20 
1134   0D65 72 65 67 69 
1134   0D69 73 74 65 72 
1134   0D6D 73 0A 
1135   0D6F 31 2E 20 73   .db "1. show 512b ram block\n"
1135   0D73 68 6F 77 20 
1135   0D77 35 31 32 62 
1135   0D7B 20 72 61 6D 
1135   0D7F 20 62 6C 6F 
1135   0D83 63 6B 0A 
1136   0D86 32 2E 20 63   .db "2. continue execution", 0
1136   0D8A 6F 6E 74 69 
1136   0D8E 6E 75 65 20 
1136   0D92 65 78 65 63 
1136   0D96 75 74 69 6F 
1136   0D9A 6E 00 
1137   0D9C             
1138   0D9C             s_set_year:
1139   0D9C 79 65 61 72   .db "year: ", 0
1139   0DA0 3A 20 00 
1140   0DA3             s_set_month:
1141   0DA3 6D 6F 6E 74   .db "month: ", 0
1141   0DA7 68 3A 20 00 
1142   0DAB             s_set_day:
1143   0DAB 64 61 79 3A   .db "day: ", 0
1143   0DAF 20 00 
1144   0DB1             s_set_week:
1145   0DB1 77 65 65 6B   .db "weekday: ", 0
1145   0DB5 64 61 79 3A 
1145   0DB9 20 00 
1146   0DBB             s_set_hours:
1147   0DBB 68 6F 75 72   .db "hours: ", 0
1147   0DBF 73 3A 20 00 
1148   0DC3             s_set_minutes:
1149   0DC3 6D 69 6E 75   .db "minutes: ", 0
1149   0DC7 74 65 73 3A 
1149   0DCB 20 00 
1150   0DCD             s_set_seconds:
1151   0DCD 73 65 63 6F   .db "seconds: ", 0
1151   0DD1 6E 64 73 3A 
1151   0DD5 20 00 
1152   0DD7             s_months:      
1153   0DD7 20 20 20 00   .db "   ", 0
1154   0DDB 6A 61 6E 00   .db "jan", 0
1155   0DDF 66 65 62 00   .db "feb", 0
1156   0DE3 6D 61 72 00   .db "mar", 0
1157   0DE7 61 70 72 00   .db "apr", 0
1158   0DEB 6D 61 79 00   .db "may", 0
1159   0DEF 6A 75 6E 00   .db "jun", 0
1160   0DF3 6A 75 6C 00   .db "jul", 0
1161   0DF7 61 75 67 00   .db "aug", 0
1162   0DFB 73 65 70 00   .db "sep", 0
1163   0DFF 6F 63 74 00   .db "oct", 0
1164   0E03 6E 6F 76 00   .db "nov", 0
1165   0E07 64 65 63 00   .db "dec", 0
1166   0E0B             
1167   0E0B             s_week:        
1168   0E0B 73 75 6E 00   .db "sun", 0 
1169   0E0F 6D 6F 6E 00   .db "mon", 0 
1170   0E13 74 75 65 00   .db "tue", 0 
1171   0E17 77 65 64 00   .db "wed", 0 
1172   0E1B 74 68 75 00   .db "thu", 0 
1173   0E1F 66 72 69 00   .db "fri", 0 
1174   0E23 73 61 74 00   .db "sat", 0
1175   0E27             
1176   0E27 0A 49 52 51 s_fdc_irq: .db "\nIRQ0 Executed.\n", 0
1176   0E2B 30 20 45 78 
1176   0E2F 65 63 75 74 
1176   0E33 65 64 2E 0A 
1176   0E37 00 
1177   0E38             s_fdc_config:
1178   0E38 73 65 6C 65   .db "selecting diskette drive 0, side 0, single density, head loaded\n", 0
1178   0E3C 63 74 69 6E 
1178   0E40 67 20 64 69 
1178   0E44 73 6B 65 74 
1178   0E48 74 65 20 64 
1178   0E4C 72 69 76 65 
1178   0E50 20 30 2C 20 
1178   0E54 73 69 64 65 
1178   0E58 20 30 2C 20 
1178   0E5C 73 69 6E 67 
1178   0E60 6C 65 20 64 
1178   0E64 65 6E 73 69 
1178   0E68 74 79 2C 20 
1178   0E6C 68 65 61 64 
1178   0E70 20 6C 6F 61 
1178   0E74 64 65 64 0A 
1178   0E78 00 
1179   0E79             
1180   0E79             fifo:
1181   0E79 FF FF FF FF   .fill _fifo_size
1181   0E7D FF FF FF FF 
1181   0E81 FF FF FF FF 
1181   0E85 FF FF FF FF 
1181   0E89 FF FF FF FF 
1181   0E8D FF FF FF FF 
1181   0E91 FF FF FF FF 
1181   0E95 FF FF FF FF 
1181   0E99 FF FF FF FF 
1181   0E9D FF FF FF FF 
1181   0EA1 FF FF FF FF 
1181   0EA5 FF FF FF FF 
1181   0EA9 FF FF FF FF 
1181   0EAD FF FF FF FF 
1181   0EB1 FF FF FF FF 
1181   0EB5 FF FF FF FF 
1181   0EB9 FF FF FF FF 
1181   0EBD FF FF FF FF 
1181   0EC1 FF FF FF FF 
1181   0EC5 FF FF FF FF 
1181   0EC9 FF FF FF FF 
1181   0ECD FF FF FF FF 
1181   0ED1 FF FF FF FF 
1181   0ED5 FF FF FF FF 
1181   0ED9 FF FF FF FF 
1181   0EDD FF FF FF FF 
1181   0EE1 FF FF FF FF 
1181   0EE5 FF FF FF FF 
1181   0EE9 FF FF FF FF 
1181   0EED FF FF FF FF 
1181   0EF1 FF FF FF FF 
1181   0EF5 FF FF FF FF 
1181   0EF9 FF FF FF FF 
1181   0EFD FF FF FF FF 
1181   0F01 FF FF FF FF 
1181   0F05 FF FF FF FF 
1181   0F09 FF FF FF FF 
1181   0F0D FF FF FF FF 
1181   0F11 FF FF FF FF 
1181   0F15 FF FF FF FF 
1181   0F19 FF FF FF FF 
1181   0F1D FF FF FF FF 
1181   0F21 FF FF FF FF 
1181   0F25 FF FF FF FF 
1181   0F29 FF FF FF FF 
1181   0F2D FF FF FF FF 
1181   0F31 FF FF FF FF 
1181   0F35 FF FF FF FF 
1181   0F39 FF FF FF FF 
1181   0F3D FF FF FF FF 
1181   0F41 FF FF FF FF 
1181   0F45 FF FF FF FF 
1181   0F49 FF FF FF FF 
1181   0F4D FF FF FF FF 
1181   0F51 FF FF FF FF 
1181   0F55 FF FF FF FF 
1181   0F59 FF FF FF FF 
1181   0F5D FF FF FF FF 
1181   0F61 FF FF FF FF 
1181   0F65 FF FF FF FF 
1181   0F69 FF FF FF FF 
1181   0F6D FF FF FF FF 
1181   0F71 FF FF FF FF 
1181   0F75 FF FF FF FF 
1181   0F79 FF FF FF FF 
1181   0F7D FF FF FF FF 
1181   0F81 FF FF FF FF 
1181   0F85 FF FF FF FF 
1181   0F89 FF FF FF FF 
1181   0F8D FF FF FF FF 
1181   0F91 FF FF FF FF 
1181   0F95 FF FF FF FF 
1181   0F99 FF FF FF FF 
1181   0F9D FF FF FF FF 
1181   0FA1 FF FF FF FF 
1181   0FA5 FF FF FF FF 
1181   0FA9 FF FF FF FF 
1181   0FAD FF FF FF FF 
1181   0FB1 FF FF FF FF 
1181   0FB5 FF FF FF FF 
1181   0FB9 FF FF FF FF 
1181   0FBD FF FF FF FF 
1181   0FC1 FF FF FF FF 
1181   0FC5 FF FF FF FF 
1181   0FC9 FF FF FF FF 
1181   0FCD FF FF FF FF 
1181   0FD1 FF FF FF FF 
1181   0FD5 FF FF FF FF 
1181   0FD9 FF FF FF FF 
1181   0FDD FF FF FF FF 
1181   0FE1 FF FF FF FF 
1181   0FE5 FF FF FF FF 
1181   0FE9 FF FF FF FF 
1181   0FED FF FF FF FF 
1181   0FF1 FF FF FF FF 
1181   0FF5 FF FF FF FF 
1181   0FF9 FF FF FF FF 
1181   0FFD FF FF FF FF 
1181   1001 FF FF FF FF 
1181   1005 FF FF FF FF 
1181   1009 FF FF FF FF 
1181   100D FF FF FF FF 
1181   1011 FF FF FF FF 
1181   1015 FF FF FF FF 
1181   1019 FF FF FF FF 
1181   101D FF FF FF FF 
1181   1021 FF FF FF FF 
1181   1025 FF FF FF FF 
1181   1029 FF FF FF FF 
1181   102D FF FF FF FF 
1181   1031 FF FF FF FF 
1181   1035 FF FF FF FF 
1181   1039 FF FF FF FF 
1181   103D FF FF FF FF 
1181   1041 FF FF FF FF 
1181   1045 FF FF FF FF 
1181   1049 FF FF FF FF 
1181   104D FF FF FF FF 
1181   1051 FF FF FF FF 
1181   1055 FF FF FF FF 
1181   1059 FF FF FF FF 
1181   105D FF FF FF FF 
1181   1061 FF FF FF FF 
1181   1065 FF FF FF FF 
1181   1069 FF FF FF FF 
1181   106D FF FF FF FF 
1181   1071 FF FF FF FF 
1181   1075 FF FF FF FF 
1181   1079 FF FF FF FF 
1181   107D FF FF FF FF 
1181   1081 FF FF FF FF 
1181   1085 FF FF FF FF 
1181   1089 FF FF FF FF 
1181   108D FF FF FF FF 
1181   1091 FF FF FF FF 
1181   1095 FF FF FF FF 
1181   1099 FF FF FF FF 
1181   109D FF FF FF FF 
1181   10A1 FF FF FF FF 
1181   10A5 FF FF FF FF 
1181   10A9 FF FF FF FF 
1181   10AD FF FF FF FF 
1181   10B1 FF FF FF FF 
1181   10B5 FF FF FF FF 
1181   10B9 FF FF FF FF 
1181   10BD FF FF FF FF 
1181   10C1 FF FF FF FF 
1181   10C5 FF FF FF FF 
1181   10C9 FF FF FF FF 
1181   10CD FF FF FF FF 
1181   10D1 FF FF FF FF 
1181   10D5 FF FF FF FF 
1181   10D9 FF FF FF FF 
1181   10DD FF FF FF FF 
1181   10E1 FF FF FF FF 
1181   10E5 FF FF FF FF 
1181   10E9 FF FF FF FF 
1181   10ED FF FF FF FF 
1181   10F1 FF FF FF FF 
1181   10F5 FF FF FF FF 
1181   10F9 FF FF FF FF 
1181   10FD FF FF FF FF 
1181   1101 FF FF FF FF 
1181   1105 FF FF FF FF 
1181   1109 FF FF FF FF 
1181   110D FF FF FF FF 
1181   1111 FF FF FF FF 
1181   1115 FF FF FF FF 
1181   1119 FF FF FF FF 
1181   111D FF FF FF FF 
1181   1121 FF FF FF FF 
1181   1125 FF FF FF FF 
1181   1129 FF FF FF FF 
1181   112D FF FF FF FF 
1181   1131 FF FF FF FF 
1181   1135 FF FF FF FF 
1181   1139 FF FF FF FF 
1181   113D FF FF FF FF 
1181   1141 FF FF FF FF 
1181   1145 FF FF FF FF 
1181   1149 FF FF FF FF 
1181   114D FF FF FF FF 
1181   1151 FF FF FF FF 
1181   1155 FF FF FF FF 
1181   1159 FF FF FF FF 
1181   115D FF FF FF FF 
1181   1161 FF FF FF FF 
1181   1165 FF FF FF FF 
1181   1169 FF FF FF FF 
1181   116D FF FF FF FF 
1181   1171 FF FF FF FF 
1181   1175 FF FF FF FF 
1181   1179 FF FF FF FF 
1181   117D FF FF FF FF 
1181   1181 FF FF FF FF 
1181   1185 FF FF FF FF 
1181   1189 FF FF FF FF 
1181   118D FF FF FF FF 
1181   1191 FF FF FF FF 
1181   1195 FF FF FF FF 
1181   1199 FF FF FF FF 
1181   119D FF FF FF FF 
1181   11A1 FF FF FF FF 
1181   11A5 FF FF FF FF 
1181   11A9 FF FF FF FF 
1181   11AD FF FF FF FF 
1181   11B1 FF FF FF FF 
1181   11B5 FF FF FF FF 
1181   11B9 FF FF FF FF 
1181   11BD FF FF FF FF 
1181   11C1 FF FF FF FF 
1181   11C5 FF FF FF FF 
1181   11C9 FF FF FF FF 
1181   11CD FF FF FF FF 
1181   11D1 FF FF FF FF 
1181   11D5 FF FF FF FF 
1181   11D9 FF FF FF FF 
1181   11DD FF FF FF FF 
1181   11E1 FF FF FF FF 
1181   11E5 FF FF FF FF 
1181   11E9 FF FF FF FF 
1181   11ED FF FF FF FF 
1181   11F1 FF FF FF FF 
1181   11F5 FF FF FF FF 
1181   11F9 FF FF FF FF 
1181   11FD FF FF FF FF 
1181   1201 FF FF FF FF 
1181   1205 FF FF FF FF 
1181   1209 FF FF FF FF 
1181   120D FF FF FF FF 
1181   1211 FF FF FF FF 
1181   1215 FF FF FF FF 
1181   1219 FF FF FF FF 
1181   121D FF FF FF FF 
1181   1221 FF FF FF FF 
1181   1225 FF FF FF FF 
1181   1229 FF FF FF FF 
1181   122D FF FF FF FF 
1181   1231 FF FF FF FF 
1181   1235 FF FF FF FF 
1181   1239 FF FF FF FF 
1181   123D FF FF FF FF 
1181   1241 FF FF FF FF 
1181   1245 FF FF FF FF 
1181   1249 FF FF FF FF 
1181   124D FF FF FF FF 
1181   1251 FF FF FF FF 
1181   1255 FF FF FF FF 
1181   1259 FF FF FF FF 
1181   125D FF FF FF FF 
1181   1261 FF FF FF FF 
1181   1265 FF FF FF FF 
1181   1269 FF FF FF FF 
1181   126D FF FF FF FF 
1181   1271 FF FF FF FF 
1181   1275 FF FF FF FF 
1181   1279 FF FF FF FF 
1181   127D FF FF FF FF 
1181   1281 FF FF FF FF 
1181   1285 FF FF FF FF 
1181   1289 FF FF FF FF 
1181   128D FF FF FF FF 
1181   1291 FF FF FF FF 
1181   1295 FF FF FF FF 
1181   1299 FF FF FF FF 
1181   129D FF FF FF FF 
1181   12A1 FF FF FF FF 
1181   12A5 FF FF FF FF 
1181   12A9 FF FF FF FF 
1181   12AD FF FF FF FF 
1181   12B1 FF FF FF FF 
1181   12B5 FF FF FF FF 
1181   12B9 FF FF FF FF 
1181   12BD FF FF FF FF 
1181   12C1 FF FF FF FF 
1181   12C5 FF FF FF FF 
1181   12C9 FF FF FF FF 
1181   12CD FF FF FF FF 
1181   12D1 FF FF FF FF 
1181   12D5 FF FF FF FF 
1181   12D9 FF FF FF FF 
1181   12DD FF FF FF FF 
1181   12E1 FF FF FF FF 
1181   12E5 FF FF FF FF 
1181   12E9 FF FF FF FF 
1181   12ED FF FF FF FF 
1181   12F1 FF FF FF FF 
1181   12F5 FF FF FF FF 
1181   12F9 FF FF FF FF 
1181   12FD FF FF FF FF 
1181   1301 FF FF FF FF 
1181   1305 FF FF FF FF 
1181   1309 FF FF FF FF 
1181   130D FF FF FF FF 
1181   1311 FF FF FF FF 
1181   1315 FF FF FF FF 
1181   1319 FF FF FF FF 
1181   131D FF FF FF FF 
1181   1321 FF FF FF FF 
1181   1325 FF FF FF FF 
1181   1329 FF FF FF FF 
1181   132D FF FF FF FF 
1181   1331 FF FF FF FF 
1181   1335 FF FF FF FF 
1181   1339 FF FF FF FF 
1181   133D FF FF FF FF 
1181   1341 FF FF FF FF 
1181   1345 FF FF FF FF 
1181   1349 FF FF FF FF 
1181   134D FF FF FF FF 
1181   1351 FF FF FF FF 
1181   1355 FF FF FF FF 
1181   1359 FF FF FF FF 
1181   135D FF FF FF FF 
1181   1361 FF FF FF FF 
1181   1365 FF FF FF FF 
1181   1369 FF FF FF FF 
1181   136D FF FF FF FF 
1181   1371 FF FF FF FF 
1181   1375 FF FF FF FF 
1181   1379 FF FF FF FF 
1181   137D FF FF FF FF 
1181   1381 FF FF FF FF 
1181   1385 FF FF FF FF 
1181   1389 FF FF FF FF 
1181   138D FF FF FF FF 
1181   1391 FF FF FF FF 
1181   1395 FF FF FF FF 
1181   1399 FF FF FF FF 
1181   139D FF FF FF FF 
1181   13A1 FF FF FF FF 
1181   13A5 FF FF FF FF 
1181   13A9 FF FF FF FF 
1181   13AD FF FF FF FF 
1181   13B1 FF FF FF FF 
1181   13B5 FF FF FF FF 
1181   13B9 FF FF FF FF 
1181   13BD FF FF FF FF 
1181   13C1 FF FF FF FF 
1181   13C5 FF FF FF FF 
1181   13C9 FF FF FF FF 
1181   13CD FF FF FF FF 
1181   13D1 FF FF FF FF 
1181   13D5 FF FF FF FF 
1181   13D9 FF FF FF FF 
1181   13DD FF FF FF FF 
1181   13E1 FF FF FF FF 
1181   13E5 FF FF FF FF 
1181   13E9 FF FF FF FF 
1181   13ED FF FF FF FF 
1181   13F1 FF FF FF FF 
1181   13F5 FF FF FF FF 
1181   13F9 FF FF FF FF 
1181   13FD FF FF FF FF 
1181   1401 FF FF FF FF 
1181   1405 FF FF FF FF 
1181   1409 FF FF FF FF 
1181   140D FF FF FF FF 
1181   1411 FF FF FF FF 
1181   1415 FF FF FF FF 
1181   1419 FF FF FF FF 
1181   141D FF FF FF FF 
1181   1421 FF FF FF FF 
1181   1425 FF FF FF FF 
1181   1429 FF FF FF FF 
1181   142D FF FF FF FF 
1181   1431 FF FF FF FF 
1181   1435 FF FF FF FF 
1181   1439 FF FF FF FF 
1181   143D FF FF FF FF 
1181   1441 FF FF FF FF 
1181   1445 FF FF FF FF 
1181   1449 FF FF FF FF 
1181   144D FF FF FF FF 
1181   1451 FF FF FF FF 
1181   1455 FF FF FF FF 
1181   1459 FF FF FF FF 
1181   145D FF FF FF FF 
1181   1461 FF FF FF FF 
1181   1465 FF FF FF FF 
1181   1469 FF FF FF FF 
1181   146D FF FF FF FF 
1181   1471 FF FF FF FF 
1181   1475 FF FF FF FF 
1181   1479 FF FF FF FF 
1181   147D FF FF FF FF 
1181   1481 FF FF FF FF 
1181   1485 FF FF FF FF 
1181   1489 FF FF FF FF 
1181   148D FF FF FF FF 
1181   1491 FF FF FF FF 
1181   1495 FF FF FF FF 
1181   1499 FF FF FF FF 
1181   149D FF FF FF FF 
1181   14A1 FF FF FF FF 
1181   14A5 FF FF FF FF 
1181   14A9 FF FF FF FF 
1181   14AD FF FF FF FF 
1181   14B1 FF FF FF FF 
1181   14B5 FF FF FF FF 
1181   14B9 FF FF FF FF 
1181   14BD FF FF FF FF 
1181   14C1 FF FF FF FF 
1181   14C5 FF FF FF FF 
1181   14C9 FF FF FF FF 
1181   14CD FF FF FF FF 
1181   14D1 FF FF FF FF 
1181   14D5 FF FF FF FF 
1181   14D9 FF FF FF FF 
1181   14DD FF FF FF FF 
1181   14E1 FF FF FF FF 
1181   14E5 FF FF FF FF 
1181   14E9 FF FF FF FF 
1181   14ED FF FF FF FF 
1181   14F1 FF FF FF FF 
1181   14F5 FF FF FF FF 
1181   14F9 FF FF FF FF 
1181   14FD FF FF FF FF 
1181   1501 FF FF FF FF 
1181   1505 FF FF FF FF 
1181   1509 FF FF FF FF 
1181   150D FF FF FF FF 
1181   1511 FF FF FF FF 
1181   1515 FF FF FF FF 
1181   1519 FF FF FF FF 
1181   151D FF FF FF FF 
1181   1521 FF FF FF FF 
1181   1525 FF FF FF FF 
1181   1529 FF FF FF FF 
1181   152D FF FF FF FF 
1181   1531 FF FF FF FF 
1181   1535 FF FF FF FF 
1181   1539 FF FF FF FF 
1181   153D FF FF FF FF 
1181   1541 FF FF FF FF 
1181   1545 FF FF FF FF 
1181   1549 FF FF FF FF 
1181   154D FF FF FF FF 
1181   1551 FF FF FF FF 
1181   1555 FF FF FF FF 
1181   1559 FF FF FF FF 
1181   155D FF FF FF FF 
1181   1561 FF FF FF FF 
1181   1565 FF FF FF FF 
1181   1569 FF FF FF FF 
1181   156D FF FF FF FF 
1181   1571 FF FF FF FF 
1181   1575 FF FF FF FF 
1181   1579 FF FF FF FF 
1181   157D FF FF FF FF 
1181   1581 FF FF FF FF 
1181   1585 FF FF FF FF 
1181   1589 FF FF FF FF 
1181   158D FF FF FF FF 
1181   1591 FF FF FF FF 
1181   1595 FF FF FF FF 
1181   1599 FF FF FF FF 
1181   159D FF FF FF FF 
1181   15A1 FF FF FF FF 
1181   15A5 FF FF FF FF 
1181   15A9 FF FF FF FF 
1181   15AD FF FF FF FF 
1181   15B1 FF FF FF FF 
1181   15B5 FF FF FF FF 
1181   15B9 FF FF FF FF 
1181   15BD FF FF FF FF 
1181   15C1 FF FF FF FF 
1181   15C5 FF FF FF FF 
1181   15C9 FF FF FF FF 
1181   15CD FF FF FF FF 
1181   15D1 FF FF FF FF 
1181   15D5 FF FF FF FF 
1181   15D9 FF FF FF FF 
1181   15DD FF FF FF FF 
1181   15E1 FF FF FF FF 
1181   15E5 FF FF FF FF 
1181   15E9 FF FF FF FF 
1181   15ED FF FF FF FF 
1181   15F1 FF FF FF FF 
1181   15F5 FF FF FF FF 
1181   15F9 FF FF FF FF 
1181   15FD FF FF FF FF 
1181   1601 FF FF FF FF 
1181   1605 FF FF FF FF 
1181   1609 FF FF FF FF 
1181   160D FF FF FF FF 
1181   1611 FF FF FF FF 
1181   1615 FF FF FF FF 
1181   1619 FF FF FF FF 
1181   161D FF FF FF FF 
1181   1621 FF FF FF FF 
1181   1625 FF FF FF FF 
1181   1629 FF FF FF FF 
1181   162D FF FF FF FF 
1181   1631 FF FF FF FF 
1181   1635 FF FF FF FF 
1181   1639 FF FF FF FF 
1181   163D FF FF FF FF 
1181   1641 FF FF FF FF 
1181   1645 FF FF FF FF 
1181   1649 FF FF FF FF 
1181   164D FF FF FF FF 
1181   1651 FF FF FF FF 
1181   1655 FF FF FF FF 
1181   1659 FF FF FF FF 
1181   165D FF FF FF FF 
1181   1661 FF FF FF FF 
1181   1665 FF FF FF FF 
1181   1669 FF FF FF FF 
1181   166D FF FF FF FF 
1181   1671 FF FF FF FF 
1181   1675 FF FF FF FF 
1181   1679 FF FF FF FF 
1181   167D FF FF FF FF 
1181   1681 FF FF FF FF 
1181   1685 FF FF FF FF 
1181   1689 FF FF FF FF 
1181   168D FF FF FF FF 
1181   1691 FF FF FF FF 
1181   1695 FF FF FF FF 
1181   1699 FF FF FF FF 
1181   169D FF FF FF FF 
1181   16A1 FF FF FF FF 
1181   16A5 FF FF FF FF 
1181   16A9 FF FF FF FF 
1181   16AD FF FF FF FF 
1181   16B1 FF FF FF FF 
1181   16B5 FF FF FF FF 
1181   16B9 FF FF FF FF 
1181   16BD FF FF FF FF 
1181   16C1 FF FF FF FF 
1181   16C5 FF FF FF FF 
1181   16C9 FF FF FF FF 
1181   16CD FF FF FF FF 
1181   16D1 FF FF FF FF 
1181   16D5 FF FF FF FF 
1181   16D9 FF FF FF FF 
1181   16DD FF FF FF FF 
1181   16E1 FF FF FF FF 
1181   16E5 FF FF FF FF 
1181   16E9 FF FF FF FF 
1181   16ED FF FF FF FF 
1181   16F1 FF FF FF FF 
1181   16F5 FF FF FF FF 
1181   16F9 FF FF FF FF 
1181   16FD FF FF FF FF 
1181   1701 FF FF FF FF 
1181   1705 FF FF FF FF 
1181   1709 FF FF FF FF 
1181   170D FF FF FF FF 
1181   1711 FF FF FF FF 
1181   1715 FF FF FF FF 
1181   1719 FF FF FF FF 
1181   171D FF FF FF FF 
1181   1721 FF FF FF FF 
1181   1725 FF FF FF FF 
1181   1729 FF FF FF FF 
1181   172D FF FF FF FF 
1181   1731 FF FF FF FF 
1181   1735 FF FF FF FF 
1181   1739 FF FF FF FF 
1181   173D FF FF FF FF 
1181   1741 FF FF FF FF 
1181   1745 FF FF FF FF 
1181   1749 FF FF FF FF 
1181   174D FF FF FF FF 
1181   1751 FF FF FF FF 
1181   1755 FF FF FF FF 
1181   1759 FF FF FF FF 
1181   175D FF FF FF FF 
1181   1761 FF FF FF FF 
1181   1765 FF FF FF FF 
1181   1769 FF FF FF FF 
1181   176D FF FF FF FF 
1181   1771 FF FF FF FF 
1181   1775 FF FF FF FF 
1181   1779 FF FF FF FF 
1181   177D FF FF FF FF 
1181   1781 FF FF FF FF 
1181   1785 FF FF FF FF 
1181   1789 FF FF FF FF 
1181   178D FF FF FF FF 
1181   1791 FF FF FF FF 
1181   1795 FF FF FF FF 
1181   1799 FF FF FF FF 
1181   179D FF FF FF FF 
1181   17A1 FF FF FF FF 
1181   17A5 FF FF FF FF 
1181   17A9 FF FF FF FF 
1181   17AD FF FF FF FF 
1181   17B1 FF FF FF FF 
1181   17B5 FF FF FF FF 
1181   17B9 FF FF FF FF 
1181   17BD FF FF FF FF 
1181   17C1 FF FF FF FF 
1181   17C5 FF FF FF FF 
1181   17C9 FF FF FF FF 
1181   17CD FF FF FF FF 
1181   17D1 FF FF FF FF 
1181   17D5 FF FF FF FF 
1181   17D9 FF FF FF FF 
1181   17DD FF FF FF FF 
1181   17E1 FF FF FF FF 
1181   17E5 FF FF FF FF 
1181   17E9 FF FF FF FF 
1181   17ED FF FF FF FF 
1181   17F1 FF FF FF FF 
1181   17F5 FF FF FF FF 
1181   17F9 FF FF FF FF 
1181   17FD FF FF FF FF 
1181   1801 FF FF FF FF 
1181   1805 FF FF FF FF 
1181   1809 FF FF FF FF 
1181   180D FF FF FF FF 
1181   1811 FF FF FF FF 
1181   1815 FF FF FF FF 
1181   1819 FF FF FF FF 
1181   181D FF FF FF FF 
1181   1821 FF FF FF FF 
1181   1825 FF FF FF FF 
1181   1829 FF FF FF FF 
1181   182D FF FF FF FF 
1181   1831 FF FF FF FF 
1181   1835 FF FF FF FF 
1181   1839 FF FF FF FF 
1181   183D FF FF FF FF 
1181   1841 FF FF FF FF 
1181   1845 FF FF FF FF 
1181   1849 FF FF FF FF 
1181   184D FF FF FF FF 
1181   1851 FF FF FF FF 
1181   1855 FF FF FF FF 
1181   1859 FF FF FF FF 
1181   185D FF FF FF FF 
1181   1861 FF FF FF FF 
1181   1865 FF FF FF FF 
1181   1869 FF FF FF FF 
1181   186D FF FF FF FF 
1181   1871 FF FF FF FF 
1181   1875 FF FF FF FF 
1181   1879 FF FF FF FF 
1181   187D FF FF FF FF 
1181   1881 FF FF FF FF 
1181   1885 FF FF FF FF 
1181   1889 FF FF FF FF 
1181   188D FF FF FF FF 
1181   1891 FF FF FF FF 
1181   1895 FF FF FF FF 
1181   1899 FF FF FF FF 
1181   189D FF FF FF FF 
1181   18A1 FF FF FF FF 
1181   18A5 FF FF FF FF 
1181   18A9 FF FF FF FF 
1181   18AD FF FF FF FF 
1181   18B1 FF FF FF FF 
1181   18B5 FF FF FF FF 
1181   18B9 FF FF FF FF 
1181   18BD FF FF FF FF 
1181   18C1 FF FF FF FF 
1181   18C5 FF FF FF FF 
1181   18C9 FF FF FF FF 
1181   18CD FF FF FF FF 
1181   18D1 FF FF FF FF 
1181   18D5 FF FF FF FF 
1181   18D9 FF FF FF FF 
1181   18DD FF FF FF FF 
1181   18E1 FF FF FF FF 
1181   18E5 FF FF FF FF 
1181   18E9 FF FF FF FF 
1181   18ED FF FF FF FF 
1181   18F1 FF FF FF FF 
1181   18F5 FF FF FF FF 
1181   18F9 FF FF FF FF 
1181   18FD FF FF FF FF 
1181   1901 FF FF FF FF 
1181   1905 FF FF FF FF 
1181   1909 FF FF FF FF 
1181   190D FF FF FF FF 
1181   1911 FF FF FF FF 
1181   1915 FF FF FF FF 
1181   1919 FF FF FF FF 
1181   191D FF FF FF FF 
1181   1921 FF FF FF FF 
1181   1925 FF FF FF FF 
1181   1929 FF FF FF FF 
1181   192D FF FF FF FF 
1181   1931 FF FF FF FF 
1181   1935 FF FF FF FF 
1181   1939 FF FF FF FF 
1181   193D FF FF FF FF 
1181   1941 FF FF FF FF 
1181   1945 FF FF FF FF 
1181   1949 FF FF FF FF 
1181   194D FF FF FF FF 
1181   1951 FF FF FF FF 
1181   1955 FF FF FF FF 
1181   1959 FF FF FF FF 
1181   195D FF FF FF FF 
1181   1961 FF FF FF FF 
1181   1965 FF FF FF FF 
1181   1969 FF FF FF FF 
1181   196D FF FF FF FF 
1181   1971 FF FF FF FF 
1181   1975 FF FF FF FF 
1181   1979 FF FF FF FF 
1181   197D FF FF FF FF 
1181   1981 FF FF FF FF 
1181   1985 FF FF FF FF 
1181   1989 FF FF FF FF 
1181   198D FF FF FF FF 
1181   1991 FF FF FF FF 
1181   1995 FF FF FF FF 
1181   1999 FF FF FF FF 
1181   199D FF FF FF FF 
1181   19A1 FF FF FF FF 
1181   19A5 FF FF FF FF 
1181   19A9 FF FF FF FF 
1181   19AD FF FF FF FF 
1181   19B1 FF FF FF FF 
1181   19B5 FF FF FF FF 
1181   19B9 FF FF FF FF 
1181   19BD FF FF FF FF 
1181   19C1 FF FF FF FF 
1181   19C5 FF FF FF FF 
1181   19C9 FF FF FF FF 
1181   19CD FF FF FF FF 
1181   19D1 FF FF FF FF 
1181   19D5 FF FF FF FF 
1181   19D9 FF FF FF FF 
1181   19DD FF FF FF FF 
1181   19E1 FF FF FF FF 
1181   19E5 FF FF FF FF 
1181   19E9 FF FF FF FF 
1181   19ED FF FF FF FF 
1181   19F1 FF FF FF FF 
1181   19F5 FF FF FF FF 
1181   19F9 FF FF FF FF 
1181   19FD FF FF FF FF 
1181   1A01 FF FF FF FF 
1181   1A05 FF FF FF FF 
1181   1A09 FF FF FF FF 
1181   1A0D FF FF FF FF 
1181   1A11 FF FF FF FF 
1181   1A15 FF FF FF FF 
1181   1A19 FF FF FF FF 
1181   1A1D FF FF FF FF 
1181   1A21 FF FF FF FF 
1181   1A25 FF FF FF FF 
1181   1A29 FF FF FF FF 
1181   1A2D FF FF FF FF 
1181   1A31 FF FF FF FF 
1181   1A35 FF FF FF FF 
1181   1A39 FF FF FF FF 
1181   1A3D FF FF FF FF 
1181   1A41 FF FF FF FF 
1181   1A45 FF FF FF FF 
1181   1A49 FF FF FF FF 
1181   1A4D FF FF FF FF 
1181   1A51 FF FF FF FF 
1181   1A55 FF FF FF FF 
1181   1A59 FF FF FF FF 
1181   1A5D FF FF FF FF 
1181   1A61 FF FF FF FF 
1181   1A65 FF FF FF FF 
1181   1A69 FF FF FF FF 
1181   1A6D FF FF FF FF 
1181   1A71 FF FF FF FF 
1181   1A75 FF FF FF FF 
1181   1A79 FF FF FF FF 
1181   1A7D FF FF FF FF 
1181   1A81 FF FF FF FF 
1181   1A85 FF FF FF FF 
1181   1A89 FF FF FF FF 
1181   1A8D FF FF FF FF 
1181   1A91 FF FF FF FF 
1181   1A95 FF FF FF FF 
1181   1A99 FF FF FF FF 
1181   1A9D FF FF FF FF 
1181   1AA1 FF FF FF FF 
1181   1AA5 FF FF FF FF 
1181   1AA9 FF FF FF FF 
1181   1AAD FF FF FF FF 
1181   1AB1 FF FF FF FF 
1181   1AB5 FF FF FF FF 
1181   1AB9 FF FF FF FF 
1181   1ABD FF FF FF FF 
1181   1AC1 FF FF FF FF 
1181   1AC5 FF FF FF FF 
1181   1AC9 FF FF FF FF 
1181   1ACD FF FF FF FF 
1181   1AD1 FF FF FF FF 
1181   1AD5 FF FF FF FF 
1181   1AD9 FF FF FF FF 
1181   1ADD FF FF FF FF 
1181   1AE1 FF FF FF FF 
1181   1AE5 FF FF FF FF 
1181   1AE9 FF FF FF FF 
1181   1AED FF FF FF FF 
1181   1AF1 FF FF FF FF 
1181   1AF5 FF FF FF FF 
1181   1AF9 FF FF FF FF 
1181   1AFD FF FF FF FF 
1181   1B01 FF FF FF FF 
1181   1B05 FF FF FF FF 
1181   1B09 FF FF FF FF 
1181   1B0D FF FF FF FF 
1181   1B11 FF FF FF FF 
1181   1B15 FF FF FF FF 
1181   1B19 FF FF FF FF 
1181   1B1D FF FF FF FF 
1181   1B21 FF FF FF FF 
1181   1B25 FF FF FF FF 
1181   1B29 FF FF FF FF 
1181   1B2D FF FF FF FF 
1181   1B31 FF FF FF FF 
1181   1B35 FF FF FF FF 
1181   1B39 FF FF FF FF 
1181   1B3D FF FF FF FF 
1181   1B41 FF FF FF FF 
1181   1B45 FF FF FF FF 
1181   1B49 FF FF FF FF 
1181   1B4D FF FF FF FF 
1181   1B51 FF FF FF FF 
1181   1B55 FF FF FF FF 
1181   1B59 FF FF FF FF 
1181   1B5D FF FF FF FF 
1181   1B61 FF FF FF FF 
1181   1B65 FF FF FF FF 
1181   1B69 FF FF FF FF 
1181   1B6D FF FF FF FF 
1181   1B71 FF FF FF FF 
1181   1B75 FF FF FF FF 
1181   1B79 FF FF FF FF 
1181   1B7D FF FF FF FF 
1181   1B81 FF FF FF FF 
1181   1B85 FF FF FF FF 
1181   1B89 FF FF FF FF 
1181   1B8D FF FF FF FF 
1181   1B91 FF FF FF FF 
1181   1B95 FF FF FF FF 
1181   1B99 FF FF FF FF 
1181   1B9D FF FF FF FF 
1181   1BA1 FF FF FF FF 
1181   1BA5 FF FF FF FF 
1181   1BA9 FF FF FF FF 
1181   1BAD FF FF FF FF 
1181   1BB1 FF FF FF FF 
1181   1BB5 FF FF FF FF 
1181   1BB9 FF FF FF FF 
1181   1BBD FF FF FF FF 
1181   1BC1 FF FF FF FF 
1181   1BC5 FF FF FF FF 
1181   1BC9 FF FF FF FF 
1181   1BCD FF FF FF FF 
1181   1BD1 FF FF FF FF 
1181   1BD5 FF FF FF FF 
1181   1BD9 FF FF FF FF 
1181   1BDD FF FF FF FF 
1181   1BE1 FF FF FF FF 
1181   1BE5 FF FF FF FF 
1181   1BE9 FF FF FF FF 
1181   1BED FF FF FF FF 
1181   1BF1 FF FF FF FF 
1181   1BF5 FF FF FF FF 
1181   1BF9 FF FF FF FF 
1181   1BFD FF FF FF FF 
1181   1C01 FF FF FF FF 
1181   1C05 FF FF FF FF 
1181   1C09 FF FF FF FF 
1181   1C0D FF FF FF FF 
1181   1C11 FF FF FF FF 
1181   1C15 FF FF FF FF 
1181   1C19 FF FF FF FF 
1181   1C1D FF FF FF FF 
1181   1C21 FF FF FF FF 
1181   1C25 FF FF FF FF 
1181   1C29 FF FF FF FF 
1181   1C2D FF FF FF FF 
1181   1C31 FF FF FF FF 
1181   1C35 FF FF FF FF 
1181   1C39 FF FF FF FF 
1181   1C3D FF FF FF FF 
1181   1C41 FF FF FF FF 
1181   1C45 FF FF FF FF 
1181   1C49 FF FF FF FF 
1181   1C4D FF FF FF FF 
1181   1C51 FF FF FF FF 
1181   1C55 FF FF FF FF 
1181   1C59 FF FF FF FF 
1181   1C5D FF FF FF FF 
1181   1C61 FF FF FF FF 
1181   1C65 FF FF FF FF 
1181   1C69 FF FF FF FF 
1181   1C6D FF FF FF FF 
1181   1C71 FF FF FF FF 
1181   1C75 FF FF FF FF 
1181   1C79 FF FF FF FF 
1181   1C7D FF FF FF FF 
1181   1C81 FF FF FF FF 
1181   1C85 FF FF FF FF 
1181   1C89 FF FF FF FF 
1181   1C8D FF FF FF FF 
1181   1C91 FF FF FF FF 
1181   1C95 FF FF FF FF 
1181   1C99 FF FF FF FF 
1181   1C9D FF FF FF FF 
1181   1CA1 FF FF FF FF 
1181   1CA5 FF FF FF FF 
1181   1CA9 FF FF FF FF 
1181   1CAD FF FF FF FF 
1181   1CB1 FF FF FF FF 
1181   1CB5 FF FF FF FF 
1181   1CB9 FF FF FF FF 
1181   1CBD FF FF FF FF 
1181   1CC1 FF FF FF FF 
1181   1CC5 FF FF FF FF 
1181   1CC9 FF FF FF FF 
1181   1CCD FF FF FF FF 
1181   1CD1 FF FF FF FF 
1181   1CD5 FF FF FF FF 
1181   1CD9 FF FF FF FF 
1181   1CDD FF FF FF FF 
1181   1CE1 FF FF FF FF 
1181   1CE5 FF FF FF FF 
1181   1CE9 FF FF FF FF 
1181   1CED FF FF FF FF 
1181   1CF1 FF FF FF FF 
1181   1CF5 FF FF FF FF 
1181   1CF9 FF FF FF FF 
1181   1CFD FF FF FF FF 
1181   1D01 FF FF FF FF 
1181   1D05 FF FF FF FF 
1181   1D09 FF FF FF FF 
1181   1D0D FF FF FF FF 
1181   1D11 FF FF FF FF 
1181   1D15 FF FF FF FF 
1181   1D19 FF FF FF FF 
1181   1D1D FF FF FF FF 
1181   1D21 FF FF FF FF 
1181   1D25 FF FF FF FF 
1181   1D29 FF FF FF FF 
1181   1D2D FF FF FF FF 
1181   1D31 FF FF FF FF 
1181   1D35 FF FF FF FF 
1181   1D39 FF FF FF FF 
1181   1D3D FF FF FF FF 
1181   1D41 FF FF FF FF 
1181   1D45 FF FF FF FF 
1181   1D49 FF FF FF FF 
1181   1D4D FF FF FF FF 
1181   1D51 FF FF FF FF 
1181   1D55 FF FF FF FF 
1181   1D59 FF FF FF FF 
1181   1D5D FF FF FF FF 
1181   1D61 FF FF FF FF 
1181   1D65 FF FF FF FF 
1181   1D69 FF FF FF FF 
1181   1D6D FF FF FF FF 
1181   1D71 FF FF FF FF 
1181   1D75 FF FF FF FF 
1181   1D79 FF FF FF FF 
1181   1D7D FF FF FF FF 
1181   1D81 FF FF FF FF 
1181   1D85 FF FF FF FF 
1181   1D89 FF FF FF FF 
1181   1D8D FF FF FF FF 
1181   1D91 FF FF FF FF 
1181   1D95 FF FF FF FF 
1181   1D99 FF FF FF FF 
1181   1D9D FF FF FF FF 
1181   1DA1 FF FF FF FF 
1181   1DA5 FF FF FF FF 
1181   1DA9 FF FF FF FF 
1181   1DAD FF FF FF FF 
1181   1DB1 FF FF FF FF 
1181   1DB5 FF FF FF FF 
1181   1DB9 FF FF FF FF 
1181   1DBD FF FF FF FF 
1181   1DC1 FF FF FF FF 
1181   1DC5 FF FF FF FF 
1181   1DC9 FF FF FF FF 
1181   1DCD FF FF FF FF 
1181   1DD1 FF FF FF FF 
1181   1DD5 FF FF FF FF 
1181   1DD9 FF FF FF FF 
1181   1DDD FF FF FF FF 
1181   1DE1 FF FF FF FF 
1181   1DE5 FF FF FF FF 
1181   1DE9 FF FF FF FF 
1181   1DED FF FF FF FF 
1181   1DF1 FF FF FF FF 
1181   1DF5 FF FF FF FF 
1181   1DF9 FF FF FF FF 
1181   1DFD FF FF FF FF 
1181   1E01 FF FF FF FF 
1181   1E05 FF FF FF FF 
1181   1E09 FF FF FF FF 
1181   1E0D FF FF FF FF 
1181   1E11 FF FF FF FF 
1181   1E15 FF FF FF FF 
1181   1E19 FF FF FF FF 
1181   1E1D FF FF FF FF 
1181   1E21 FF FF FF FF 
1181   1E25 FF FF FF FF 
1181   1E29 FF FF FF FF 
1181   1E2D FF FF FF FF 
1181   1E31 FF FF FF FF 
1181   1E35 FF FF FF FF 
1181   1E39 FF FF FF FF 
1181   1E3D FF FF FF FF 
1181   1E41 FF FF FF FF 
1181   1E45 FF FF FF FF 
1181   1E49 FF FF FF FF 
1181   1E4D FF FF FF FF 
1181   1E51 FF FF FF FF 
1181   1E55 FF FF FF FF 
1181   1E59 FF FF FF FF 
1181   1E5D FF FF FF FF 
1181   1E61 FF FF FF FF 
1181   1E65 FF FF FF FF 
1181   1E69 FF FF FF FF 
1181   1E6D FF FF FF FF 
1181   1E71 FF FF FF FF 
1181   1E75 FF FF FF FF 
1182   1E79             
1183   1E79             scrap_sector:
1184   1E79 FF FF FF FF   .fill 512         ; scrap sector
1184   1E7D FF FF FF FF 
1184   1E81 FF FF FF FF 
1184   1E85 FF FF FF FF 
1184   1E89 FF FF FF FF 
1184   1E8D FF FF FF FF 
1184   1E91 FF FF FF FF 
1184   1E95 FF FF FF FF 
1184   1E99 FF FF FF FF 
1184   1E9D FF FF FF FF 
1184   1EA1 FF FF FF FF 
1184   1EA5 FF FF FF FF 
1184   1EA9 FF FF FF FF 
1184   1EAD FF FF FF FF 
1184   1EB1 FF FF FF FF 
1184   1EB5 FF FF FF FF 
1184   1EB9 FF FF FF FF 
1184   1EBD FF FF FF FF 
1184   1EC1 FF FF FF FF 
1184   1EC5 FF FF FF FF 
1184   1EC9 FF FF FF FF 
1184   1ECD FF FF FF FF 
1184   1ED1 FF FF FF FF 
1184   1ED5 FF FF FF FF 
1184   1ED9 FF FF FF FF 
1184   1EDD FF FF FF FF 
1184   1EE1 FF FF FF FF 
1184   1EE5 FF FF FF FF 
1184   1EE9 FF FF FF FF 
1184   1EED FF FF FF FF 
1184   1EF1 FF FF FF FF 
1184   1EF5 FF FF FF FF 
1184   1EF9 FF FF FF FF 
1184   1EFD FF FF FF FF 
1184   1F01 FF FF FF FF 
1184   1F05 FF FF FF FF 
1184   1F09 FF FF FF FF 
1184   1F0D FF FF FF FF 
1184   1F11 FF FF FF FF 
1184   1F15 FF FF FF FF 
1184   1F19 FF FF FF FF 
1184   1F1D FF FF FF FF 
1184   1F21 FF FF FF FF 
1184   1F25 FF FF FF FF 
1184   1F29 FF FF FF FF 
1184   1F2D FF FF FF FF 
1184   1F31 FF FF FF FF 
1184   1F35 FF FF FF FF 
1184   1F39 FF FF FF FF 
1184   1F3D FF FF FF FF 
1184   1F41 FF FF FF FF 
1184   1F45 FF FF FF FF 
1184   1F49 FF FF FF FF 
1184   1F4D FF FF FF FF 
1184   1F51 FF FF FF FF 
1184   1F55 FF FF FF FF 
1184   1F59 FF FF FF FF 
1184   1F5D FF FF FF FF 
1184   1F61 FF FF FF FF 
1184   1F65 FF FF FF FF 
1184   1F69 FF FF FF FF 
1184   1F6D FF FF FF FF 
1184   1F71 FF FF FF FF 
1184   1F75 FF FF FF FF 
1184   1F79 FF FF FF FF 
1184   1F7D FF FF FF FF 
1184   1F81 FF FF FF FF 
1184   1F85 FF FF FF FF 
1184   1F89 FF FF FF FF 
1184   1F8D FF FF FF FF 
1184   1F91 FF FF FF FF 
1184   1F95 FF FF FF FF 
1184   1F99 FF FF FF FF 
1184   1F9D FF FF FF FF 
1184   1FA1 FF FF FF FF 
1184   1FA5 FF FF FF FF 
1184   1FA9 FF FF FF FF 
1184   1FAD FF FF FF FF 
1184   1FB1 FF FF FF FF 
1184   1FB5 FF FF FF FF 
1184   1FB9 FF FF FF FF 
1184   1FBD FF FF FF FF 
1184   1FC1 FF FF FF FF 
1184   1FC5 FF FF FF FF 
1184   1FC9 FF FF FF FF 
1184   1FCD FF FF FF FF 
1184   1FD1 FF FF FF FF 
1184   1FD5 FF FF FF FF 
1184   1FD9 FF FF FF FF 
1184   1FDD FF FF FF FF 
1184   1FE1 FF FF FF FF 
1184   1FE5 FF FF FF FF 
1184   1FE9 FF FF FF FF 
1184   1FED FF FF FF FF 
1184   1FF1 FF FF FF FF 
1184   1FF5 FF FF FF FF 
1184   1FF9 FF FF FF FF 
1184   1FFD FF FF FF FF 
1184   2001 FF FF FF FF 
1184   2005 FF FF FF FF 
1184   2009 FF FF FF FF 
1184   200D FF FF FF FF 
1184   2011 FF FF FF FF 
1184   2015 FF FF FF FF 
1184   2019 FF FF FF FF 
1184   201D FF FF FF FF 
1184   2021 FF FF FF FF 
1184   2025 FF FF FF FF 
1184   2029 FF FF FF FF 
1184   202D FF FF FF FF 
1184   2031 FF FF FF FF 
1184   2035 FF FF FF FF 
1184   2039 FF FF FF FF 
1184   203D FF FF FF FF 
1184   2041 FF FF FF FF 
1184   2045 FF FF FF FF 
1184   2049 FF FF FF FF 
1184   204D FF FF FF FF 
1184   2051 FF FF FF FF 
1184   2055 FF FF FF FF 
1184   2059 FF FF FF FF 
1184   205D FF FF FF FF 
1184   2061 FF FF FF FF 
1184   2065 FF FF FF FF 
1184   2069 FF FF FF FF 
1184   206D FF FF FF FF 
1184   2071 FF FF FF FF 
1184   2075 FF FF FF FF 
1185   2079             transient_area:
1186   2079 00            .db 0             ; beginning of the transient memory area. used for disk reads and other purposes    
1187   207A             
1188   207A             .end
tasm: Number of errors = 0
