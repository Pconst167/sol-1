0001   0000             ; ------------------------------------------------------------------------------------------------------------------;
0002   0000             ; Solarium - Sol-1 Homebrew Minicomputer Operating System Kernel.
0003   0000             ; ------------------------------------------------------------------------------------------------------------------;
0004   0000             
0005   0000             ; memory map
0006   0000             ; ------------------------------------------------------------------------------------------------------------------;
0007   0000             ; 0000 ... 7fff - rom space
0008   0000             ; 8000 ... f7ff - ram space
0009   0000             ; f7ff          - stack root
0010   0000             
0011   0000             ; i/o map
0012   0000             ; ------------------------------------------------------------------------------------------------------------------;
0013   0000             ; ff80 - uart 0 (16550)
0014   0000             ; ff88 - uart 1 (16550)
0015   0000             ; ffa0 - rtc    (m48t02)
0016   0000             ; ffb0 - pio 0  (8255)
0017   0000             ; ffc0 - fdd    (5.25" floppy drive block)
0018   0000             ;   - ffc0      output port (377 flip-flop)                  
0019   0000             ;   - ffc1      input port  (244 buffer)                     
0020   0000             ;   - ffc8      wd1770 status/command    
0021   0000             ;   - ffc9      wd1770 track register
0022   0000             ;   - ffca      wd1770 sector register
0023   0000             ;   - ffcb      wd1770 data register
0024   0000             ;      
0025   0000             ; ffd0 - ide    (compact flash / pata)
0026   0000             ; ffe0 - timer  (8253)
0027   0000             ; fff0 - bios configuration nv-ram store area
0028   0000             ; ------------------------------------------------------------------------------------------------------------------;
0029   0000             
0030   0000             ; ------------------------------------------------------------------------------------------------------------------;
0031   0000             ; system constants
0032   0000             ; ------------------------------------------------------------------------------------------------------------------;
0033   0000             _uart0_data       .equ $ff80         ; data
0034   0000             _uart0_dlab_0     .equ $ff80         ; divisor latch low byte
0035   0000             _uart0_dlab_1     .equ $ff81         ; divisor latch high byte
0036   0000             _uart0_ier        .equ $ff81         ; interrupt enable register
0037   0000             _uart0_fcr        .equ $ff82         ; fifo control register
0038   0000             _uart0_lcr        .equ $ff83         ; line control register
0039   0000             _uart0_lsr        .equ $ff85         ; line status register
0040   0000             
0041   0000             _uart1_data       .equ $ff88         ; data
0042   0000             _uart1_dlab_0     .equ $ff88         ; divisor latch low byte
0043   0000             _uart1_dlab_1     .equ $ff89         ; divisor latch high byte
0044   0000             _uart1_ier        .equ $ff89         ; interrupt enable register
0045   0000             _uart1_fcr        .equ $ff8A         ; fifo control register
0046   0000             _uart1_lcr        .equ $ff8B         ; line control register
0047   0000             _uart1_lsr        .equ $ff8D         ; line status register
0048   0000             
0049   0000             _ide_base         .equ $ffd0         ; ide base
0050   0000             _ide_r0           .equ _ide_base + 0 ; data port
0051   0000             _ide_r1           .equ _ide_base + 1 ; read: error code, write: feature
0052   0000             _ide_r2           .equ _ide_base + 2 ; number of sectors to transfer
0053   0000             _ide_r3           .equ _ide_base + 3 ; sector address lba 0 [0:7]
0054   0000             _ide_r4           .equ _ide_base + 4 ; sector address lba 1 [8:15]
0055   0000             _ide_r5           .equ _ide_base + 5 ; sector address lba 2 [16:23]
0056   0000             _ide_r6           .equ _ide_base + 6 ; sector address lba 3 [24:27 (lsb)]
0057   0000             _ide_r7           .equ _ide_base + 7 ; read: status, write: command       
0058   0000             
0059   0000             _til311_display   .equ $ffb0         ; bios post code hex display (2 digits) (connected to pio a)
0060   0000             _bios_post_ctrl   .equ $ffb3         ; bios post display control register, 80h = as output
0061   0000             _pio_a            .equ $ffb0    
0062   0000             _pio_b            .equ $ffb1
0063   0000             _pio_c            .equ $ffb2
0064   0000             _pio_control      .equ $ffb3         ; pio control port
0065   0000             
0066   0000             _fdc_config       .equ $ffc0         ; 0 = select_0, 1 = select_1, 2 = side_select, 3 = dden, 4 = in_use_or_head_load, 5 = wd1770_rst
0067   0000             _fdc_status_0     .equ $ffc1         ; 0 = drq, 1 = ready
0068   0000             _fdc_stat_cmd     .equ $ffc8         ; status / command register
0069   0000             _fdc_track        .equ $ffc9         ; track register
0070   0000             _fdc_sector       .equ $ffca         ; sector register
0071   0000             _fdc_data         .equ $ffcb         ; data register
0072   0000             
0073   0000             _timer_c_0        .equ $ffe0         ; timer counter 0
0074   0000             _timer_c_1        .equ $ffe1         ; timer counter 1
0075   0000             _timer_c_2        .equ $ffe2         ; timer counter 2
0076   0000             _timer_ctrl       .equ $ffe3         ; timer control register
0077   0000             
0078   0000             _stack_begin      .equ $f7ff         ; beginning of stack
0079   0000             _fifo_size        .equ 4096
0080   0000             
0081   0000             _mbr                    .equ 960
0082   0000             _superblock             .equ 1024
0083   0000             _block_group_descriptor .equ 2048
0084   0000             
0085   0000             text_org                .equ $400          ; code origin address for all user processes
0086   0000             
0087   0000             block_bitmap_start      .equ 2048 * 2
0088   0000             block_bitmap_sec_start  .equ 8
0089   0000             inode_bitmap_start      .equ 2048 * 6
0090   0000             inode_bitmap_sect_start .equ 24
0091   0000             inode_table_start       .equ 2048 * 7
0092   0000             inode_table_sect_start  .equ 28 ; inode table starts at sector 28
0093   0000             data_blocks_start       .equ 2111488
0094   0000             data_blocks_sect_start  .equ 4124
0095   0000             
0096   0000             ;  ------------------------------------------------------------------------------------------------------------------;
0097   0000             ;  DISK LAYOUT:
0098   0000             ;  Metadata               | Size (bytes)      | Blocks (2048 bytes)              |Start Block |  Comment
0099   0000             ;  ---------------------- | ----------------- | -------------------------------- |------------|-----------------------------------
0100   0000             ;  Bootloader/MBR         | 1024 bytes        | 0.5 (1 sector)                   |  0         |
0101   0000             ;  Superblock             | 1024 bytes        | 1 block (2048 bytes, must align) |  0         |
0102   0000             ;                         |                   | 1 block (2048 bytes)             |  1         | reserved
0103   0000             ;  Block Bitmap           | 8,192 bytes       | 4 blocks                         |  2         | 4*2048*8 = 4*16384 = 65536 raw data blocks.  65536*2048 bytes = 134217728 bytes of disk space = 128MB
0104   0000             ;  Inode Bitmap           | 2,048 bytes       | 1 block                          |  6         | 2048*8=16384. total of 16384 bits, meaning 16384 inodes, which is 1 inode per 8KB of disk space
0105   0000             ;  Inode Table            | 2,097,152 bytes   | 1024 blocks                      |  7         | 128bytes per inode entry. 2097152 / 128 = 16384 inodes
0106   0000             ;  Data Blocks            | 134,217,728 bytes | 65528 blocks                     | 1031       | 65528 blocks = 134,201,344 bytes
0107   0000             ;  
0108   0000             ;  first 1024 bytes: bootloader from 0 to 959, MBR partition table from 960 (64 bytes)
0109   0000             ;  up to 4 partitions, each 16 bytes long
0110   0000             ;  MBR:
0111   0000             ;  Byte | Description
0112   0000             ;  -----|----------------------------
0113   0000             ;  0    | Boot flag (0x80 active, 0x00 inactive)
0114   0000             ;  1-3  | Start CHS (head, sector, cylinder)
0115   0000             ;  4    | Partition type (filesystem ID)
0116   0000             ;    0x83 = Linux native (ext2/3/4)
0117   0000             ;    0x07 = NTFS/exFAT
0118   0000             ;    0x0B = FAT32 CHS
0119   0000             ;    0x0C = FAT32 LBA
0120   0000             ;    0x05 = Extended partition
0121   0000             ;    0x86 = Sol-1 partition
0122   0000             ;  5-7  | End CHS
0123   0000             ;  8-11 | Start LBA (little endian)
0124   0000             ;  12-15| Size in sectors (little endian)
0125   0000             ;  
0126   0000             ;  
0127   0000             ;  the superblock describers the filesystem as a whole such as inode count, free inode count, location of the raw data bitmap, inode table, etc.  
0128   0000             ;  SUPERBLOCK:
0129   0000             ;  | Field               | Description                               | Typical Size (bytes) | Notes                           |
0130   0000             ;  | ------------------- | ----------------------------------------- | -------------------- | ------------------------------- |
0131   0000             ;  | inodes_count        | Total number of inodes in the filesystem  | 2                    | 16-bit unsigned int             |
0132   0000             ;  | blocks_count        | Total number of data blocks               | 2                    | 16-bit unsigned int             |
0133   0000             ;  | free_inodes_count   | Number of free inodes                     | 2                    | 16-bit unsigned int             |
0134   0000             ;  | free_blocks_count   | Number of free blocks                     | 2                    | 16-bit unsigned int             |
0135   0000             ;  | block_bitmap        | Block ID of the **block bitmap**          | 2                    | 16-bit unsigned int
0136   0000             ;  | inode_bitmap        | Block ID of the **inode bitmap**          | 2                    | 16-bit unsigned int
0137   0000             ;  | inode_table         | Starting block of **inode table**         | 2                    | 16-bit unsigned int
0138   0000             ;  | first_data_block    | Block number of the first data block      | 2                    | 16-bit unsigned int             |
0139   0000             ;  | used_dirs_count     | Number of inodes allocated to directories | 2
0140   0000             ;  | log_block_size      | Block size = 1024 << `s_log_block_size    | 2                    | 16-bit unsigned int             |
0141   0000             ;  | mtime               | Last mount time                           | 4                    | 32-bit unsigned int (Unix time) |
0142   0000             ;  | wtime               | Last write time                           | 4                    | 32-bit unsigned int (Unix time) |
0143   0000             ;  | uuid                | Unique ID of the filesystem               | 16                   | 128-bit UUID                    |
0144   0000             ;  | volume_name         | Label of the filesystem                   | 16                   | Usually ASCII, padded           |
0145   0000             ;  | feature_flags       | Compatibility flags                       | 4                    | 32-bit unsigned int             |
0146   0000             ;  
0147   0000             ;  inode for root dir is #2, #0 and #1 not used
0148   0000             ;  raw data block #0 is not used. because 0 as a block ID means not used
0149   0000             ;  block size: 2048
0150   0000             ;  inode-table format:
0151   0000             ;  | Field         | Size (bytes) | Description                                                                                  |
0152   0000             ;  | ------------- | ------------ | -------------------------------------------------------------------------------------------- |
0153   0000             ;  | `mode`        | 2            | File type and permissions                                                                    |
0154   0000             ;  | `uid`         | 2            | Owner user ID                                                                                |
0155   0000             ;  | `size`        | 4            | Size of the file in bytes                                                                    |
0156   0000             ;  | `atime`       | 4            | Last access time (timestamp)                                                                 |
0157   0000             ;  | `ctime`       | 4            | Creation time (timestamp)                                                                    |
0158   0000             ;  | `mtime`       | 4            | Last modification time (timestamp)                                                           |
0159   0000             ;  | `dtime`       | 4            | Deletion time (timestamp)                                                                    |
0160   0000             ;  | `gid`         | 2            | Group ID                                                                                     |
0161   0000             ;  | `links_count` | 2            | Number of hard links                                                                         |
0162   0000             ;  | `blocks`      | 2            | Number of 2048-byte blocks allocated                                                         |
0163   0000             ;  | `flags`       | 4            | File flags                                                                                   |
0164   0000             ;  | `block`       | 47 * 2 = 94  | Pointers to data blocks (47 direct only) 
0165   0000             ;
0166   0000             ;
0167   0000             ;  DIRECTORY ENTRY
0168   0000             ;  this is the structure for file entries inside a directory.
0169   0000             ;  2048 / 64 = 32 entries
0170   0000             ;
0171   0000             ;  each entry is 64 bytes wide
0172   0000             ;  uint16_t inode;      // Inode number (0 if entry is unused)
0173   0000             ;  char     name[62];   // File name (null terminated)
0174   0000             
0175   0000             
0176   0000             
0177   0000             ; ------------------------------------------------------------------------------------------------------------------;
0178   0000             ; global system variables
0179   0000             ; ------------------------------------------------------------------------------------------------------------------;
0180   0000             
0181   0000             ; ------------------------------------------------------------------------------------------------------------------;
0182   0000             ; irq table
0183   0000             ; highest priority at lowest address
0184   0000             ; ------------------------------------------------------------------------------------------------------------------;
0185   0000 30 00       .dw int_0_fdc
0186   0002 37 00       .dw int_1
0187   0004 38 00       .dw int_2
0188   0006 39 00       .dw int_3
0189   0008 3A 00       .dw int_4
0190   000A 3B 00       .dw int_5_uart1
0191   000C 5D 00       .dw int_6_timer
0192   000E 5E 00       .dw int_7_uart0
0193   0010             
0194   0010             ; ------------------------------------------------------------------------------------------------------------------;
0195   0010             ; kernel reset vector
0196   0010             ; ------------------------------------------------------------------------------------------------------------------;
0197   0010 6D 04       .dw kernel_reset_vector
0198   0012             
0199   0012             ; ------------------------------------------------------------------------------------------------------------------;
0200   0012             ; exception vector table
0201   0012             ; total of 7 entries, starting at address $0012
0202   0012             ; ------------------------------------------------------------------------------------------------------------------;
0203   0012 CB 00       .dw trap_privilege
0204   0014 92 01       .dw trap_div_zero
0205   0016 9F 01       .dw trap_undef_opcode
0206   0018 00 00       .dw 0
0207   001A 00 00       .dw 0
0208   001C 00 00       .dw 0
0209   001E 00 00       .dw 0
0210   0020             
0211   0020             ; ------------------------------------------------------------------------------------------------------------------;
0212   0020             ; system call vector table
0213   0020             ; starts at address $0020
0214   0020             ; ------------------------------------------------------------------------------------------------------------------;
0215   0020 D7 00       .dw syscall_break
0216   0022 A0 01       .dw syscall_rtc
0217   0024 C3 02       .dw syscall_ide
0218   0026 83 03       .dw syscall_io
0219   0028 3A 04       .dw syscall_file_system
0220   002A D2 01       .dw syscall_datetime
0221   002C BF 00       .dw syscall_reboot
0222   002E 8B 00       .dw syscall_system
0223   0030             
0224   0030             ; ------------------------------------------------------------------------------------------------------------------;
0225   0030             ; system call aliases
0226   0030             ; ------------------------------------------------------------------------------------------------------------------;
0227   0030             sys_break            .equ 0
0228   0030             sys_rtc              .equ 1
0229   0030             sys_ide              .equ 2
0230   0030             sys_io               .equ 3
0231   0030             sys_filesystem       .equ 4
0232   0030             sys_datetime         .equ 5
0233   0030             sys_reboot           .equ 6
0234   0030             sys_system           .equ 7
0235   0030             sys_fdc              .equ 8
0236   0030             
0237   0030             ; ------------------------------------------------------------------------------------------------------------------;
0238   0030             ; alias exports
0239   0030             ; ------------------------------------------------------------------------------------------------------------------;
0240   0030             .export text_org
0241   0030             .export sys_break
0242   0030             .export sys_rtc
0243   0030             .export sys_ide
0244   0030             .export sys_io
0245   0030             .export sys_filesystem
0246   0030             .export sys_datetime
0247   0030             .export sys_reboot
0248   0030             .export sys_system
0249   0030             .export sys_fdc
0250   0030             
0251   0030             .export _til311_display
0252   0030             
0253   0030             .export _fdc_config        
0254   0030             .export _fdc_status_0      
0255   0030             .export _fdc_stat_cmd     
0256   0030             
0257   0030             ; ------------------------------------------------------------------------------------------------------------------;
0258   0030             ; irqs' code block
0259   0030             ; ------------------------------------------------------------------------------------------------------------------;
0260   0030             ; 5.25" floppy drive controller irq
0261   0030             int_0_fdc:
0262   0030 3B 28 0E      mov d, s_fdc_irq
0263   0033 07 BA 06      call _puts
0264   0036 06            sysret
0265   0037             int_1:
0266   0037 06            sysret
0267   0038             int_2:
0268   0038 06            sysret
0269   0039             int_3:
0270   0039 06            sysret
0271   003A             int_4:
0272   003A 06            sysret
0273   003B             
0274   003B             ; ------------------------------------------------------------------------------------------------------------------;
0275   003B             ; uart1 interrupt
0276   003B             ; ------------------------------------------------------------------------------------------------------------------;
0277   003B             int_5_uart1:
0278   003B D7            push a
0279   003C DA            push d
0280   003D E1            pushf
0281   003E 1D 88 FF      mov al, [_uart1_data]       ; get character
0282   0041               ;mov [[d]], al              ; TODO: implement this double indirection instruction
0283   0041 3B ED 0B      mov d, fifo_in
0284   0044 FD 2A         mov d, [d]
0285   0046 3E            mov [d], al                 ; add to fifo
0286   0047 13            mov a, d
0287   0048 77            inc a
0288   0049 AF 80 1E      cmp a, fifo + _fifo_size     ; check if pointer reached the end of the fifo
0289   004C C7 52 00      jne int_5_continue
0290   004F 10 80 0E      mov a, fifo  
0291   0052             int_5_continue:  
0292   0052 42 ED 0B      mov [fifo_in], a            ; update fifo pointer
0293   0055 1A            mov al, ah
0294   0056 3D B0 FF      mov [_til311_display], al
0295   0059 EE            popf
0296   005A E7            pop d
0297   005B E4            pop a  
0298   005C 06            sysret
0299   005D             
0300   005D             ; ------------------------------------------------------------------------------------------------------------------;
0301   005D             ; timer irq
0302   005D             ; ------------------------------------------------------------------------------------------------------------------;
0303   005D             int_6_timer:  
0304   005D 06            sysret
0305   005E             
0306   005E             ; ------------------------------------------------------------------------------------------------------------------;
0307   005E             ; uart0 interrupt
0308   005E             ; ------------------------------------------------------------------------------------------------------------------;
0309   005E             int_7_uart0:
0310   005E D7            push a
0311   005F DA            push d
0312   0060 E1            pushf
0313   0061 1D 80 FF      mov al, [_uart0_data]       ; get character
0314   0064               ;mov [[d]], al              ; TODO: implement this double indirection instruction
0315   0064 3B ED 0B      mov d, fifo_in
0316   0067 FD 2A         mov d, [d]
0317   0069 3E            mov [d], al                 ; add to fifo
0318   006A 13            mov a, d
0319   006B 77            inc a
0320   006C AF 80 1E      cmp a, fifo + _fifo_size     ; check if pointer reached the end of the fifo
0321   006F C7 75 00      jne int_7_continue
0322   0072 10 80 0E      mov a, fifo  
0323   0075             int_7_continue:  
0324   0075 42 ED 0B      mov [fifo_in], a            ; update fifo pointer
0325   0078 1A            mov al, ah
0326   0079 3D B0 FF      mov [_til311_display], al
0327   007C EE            popf
0328   007D E7            pop d
0329   007E E4            pop a  
0330   007F 06            sysret
0331   0080             
0332   0080             sys_mkfs:
0333   0080 06            sysret
0334   0081             
0335   0081             ; ------------------------------------------------------------------------------------------------------------------;
0336   0081             ; system syscalls
0337   0081             ; ------------------------------------------------------------------------------------------------------------------;
0338   0081             system_jmptbl:
0339   0081 B7 00         .dw system_uname
0340   0083 BE 00         .dw system_whoami
0341   0085 91 00         .dw system_poke
0342   0087 94 00         .dw system_bootloader_install
0343   0089 8F 00         .dw system_peek
0344   008B             syscall_system:
0345   008B FD 0A 81 00   jmp [system_jmptbl + al]
0346   008F             
0347   008F             ; param register address in register d
0348   008F             ; param value in register bl
0349   008F             system_peek:
0350   008F 32            mov bl, [d]
0351   0090 06            sysret
0352   0091             
0353   0091             ; param register address in register d
0354   0091             ; param value in register bl
0355   0091             system_poke:
0356   0091 FD 3E         mov [d], bl
0357   0093 06            sysret
0358   0094             
0359   0094             ; kernel LBA address in 'b'
0360   0094             system_bootloader_install:
0361   0094 D8            push b
0362   0095 26 00 00      mov b, 0
0363   0098 38 00 00      mov c, 0
0364   009B 22 01         mov ah, $01                 ; 1 sector
0365   009D 3B 80 20      mov d, transient_area
0366   00A0 07 F2 02      call ide_read_sect          ; read sector
0367   00A3 E5            pop b
0368   00A4 FD 44 FE 01   mov [d + 510], b            ; update LBA address
0369   00A8 26 00 00      mov b, 0
0370   00AB 38 00 00      mov c, 0
0371   00AE 22 01         mov ah, $01                 ; 1 sector
0372   00B0 3B 80 20      mov d, transient_area
0373   00B3 07 18 03      call ide_write_sect         ; write sector
0374   00B6 06            sysret
0375   00B7             
0376   00B7             system_uname:
0377   00B7 3B FE 0B      mov d, s_uname
0378   00BA 07 BA 06      call _puts
0379   00BD 06            sysret
0380   00BE             
0381   00BE             system_whoami:
0382   00BE 06            sysret
0383   00BF             
0384   00BF             ; reboot system
0385   00BF             syscall_reboot:
0386   00BF FD D7 FF FF   push word $ffff 
0387   00C3 FD DB 00      push byte %00000000             ; dma_ack = 0, interrupts disabled, mode = supervisor, paging = off, halt=0, display_reg_load=0, dir=0
0388   00C6 FD D7 90 01   push word bios_reset_vector     ; and then push reset vector of the shell to the stack
0389   00CA 06            sysret
0390   00CB             
0391   00CB             
0392   00CB             ; ------------------------------------------------------------------------------------------------------------------;
0393   00CB             ; exceptions code block
0394   00CB             ; ------------------------------------------------------------------------------------------------------------------;
0395   00CB             ; privilege exception
0396   00CB             ; ------------------------------------------------------------------------------------------------------------------;
0397   00CB             trap_privilege:
0398   00CB 0A BF 00      jmp syscall_reboot
0399   00CE DA            push d
0400   00CF 3B 15 0D      mov d, s_priviledge
0401   00D2 07 BA 06      call _puts
0402   00D5 E7            pop d
0403   00D6 06            sysret
0404   00D7             
0405   00D7             ; ------------------------------------------------------------------------------------------------------------------;
0406   00D7             ; breakpoint
0407   00D7             ; important: values in the stack are being pushed in big endian. i.e.: msb at low address
0408   00D7             ; and lsb at high address. *** need to correct this in the microcode and make it little endian again ***
0409   00D7             ; ------------------------------------------------------------------------------------------------------------------;
0410   00D7             syscall_break:
0411   00D7 4B            pusha
0412   00D8             syscall_break_prompt:
0413   00D8 3B 47 0D      mov d, s_break1
0414   00DB 07 BA 06      call _puts
0415   00DE 07 67 06      call printnl
0416   00E1 07 BC 07      call scan_u16d
0417   00E4 AF 00 00      cmp a, 0
0418   00E7 C6 F2 00      je syscall_break_regs
0419   00EA AF 01 00      cmp a, 1
0420   00ED C6 15 01      je syscall_break_mem
0421   00F0             syscall_break_end:  
0422   00F0 4C            popa
0423   00F1 06            sysret
0424   00F2             syscall_break_regs:
0425   00F2 48            mov a, sp
0426   00F3 53 0E 00      add a, 14               ; back-track 7 registers
0427   00F6 3C            mov d, a
0428   00F7 3A 07         mov cl, 7
0429   00F9             syscall_regs_l0:
0430   00F9 2A            mov b, [d]
0431   00FA FD AB         swp b
0432   00FC 07 16 07      call print_u16x         ; print register value
0433   00FF 07 67 06      call printnl
0434   0102 63 02 00      sub d, 2
0435   0105 71 01         sub cl, 1
0436   0107 C3 00         cmp cl, 0
0437   0109 C7 F9 00      jne syscall_regs_l0
0438   010C 0A D8 00      jmp syscall_break_prompt
0439   010F 07 67 06      call printnl
0440   0112 0A D8 00      jmp syscall_break_prompt
0441   0115             syscall_break_mem:
0442   0115 07 67 06      call printnl
0443   0118 07 38 07      call scan_u16x
0444   011B 4D            mov si, a               ; data source from user space
0445   011C FD 4F 80 1E   mov di, scrap_sector    ; destination in kernel space
0446   0120 38 00 02      mov c, 512
0447   0123 04            load                    ; transfer data to kernel space!
0448   0124 3B 80 1E      mov d, scrap_sector     ; dump pointer in d
0449   0127 38 00 00      mov c, 0
0450   012A             dump_loop:
0451   012A 84            mov al, cl
0452   012B 87 0F         and al, $0f
0453   012D C6 7B 01      jz print_base
0454   0130             back:
0455   0130 1E            mov al, [d]             ; read byte
0456   0131 2F            mov bl, al
0457   0132 07 5A 07      call print_u8x
0458   0135 10 00 20      mov a, $2000
0459   0138 05 03         syscall sys_io          ; space
0460   013A 84            mov al, cl
0461   013B 87 0F         and al, $0f
0462   013D B9 0F         cmp al, $0f
0463   013F C6 50 01      je print_ascii
0464   0142             back1:
0465   0142 79            inc d
0466   0143 78            inc c
0467   0144 C2 00 02      cmp c, 512
0468   0147 C7 2A 01      jne dump_loop
0469   014A 07 67 06      call printnl
0470   014D 0A D8 00      jmp syscall_break_prompt  ; go to syscall_break return point
0471   0150             print_ascii:
0472   0150 10 00 20      mov a, $2000
0473   0153 05 03         syscall sys_io
0474   0155 63 10 00      sub d, 16
0475   0158 26 10 00      mov b, 16
0476   015B             print_ascii_l:
0477   015B 79            inc d
0478   015C 1E            mov al, [d]               ; read byte
0479   015D B9 20         cmp al, $20
0480   015F C8 67 01      jlu dot
0481   0162 B9 7E         cmp al, $7e
0482   0164 D0 6F 01      jleu ascii
0483   0167             dot:
0484   0167 10 00 2E      mov a, $2e00
0485   016A 05 03         syscall sys_io
0486   016C 0A 74 01      jmp ascii_continue
0487   016F             ascii:
0488   016F 23            mov ah, al
0489   0170 19 00         mov al, 0
0490   0172 05 03         syscall sys_io
0491   0174             ascii_continue:
0492   0174 FD A9 5B 01   loopb print_ascii_l
0493   0178 0A 42 01      jmp back1
0494   017B             print_base:
0495   017B 07 67 06      call printnl
0496   017E 2D            mov b, d
0497   017F 61 80 1E      sub b, scrap_sector      ; remove this later and fix address bases which display incorrectly
0498   0182 07 16 07      call print_u16x          ; display row
0499   0185 10 00 3A      mov a, $3a00
0500   0188 05 03         syscall sys_io
0501   018A 10 00 20      mov a, $2000
0502   018D 05 03         syscall sys_io
0503   018F 0A 30 01      jmp back
0504   0192             
0505   0192             ; ------------------------------------------------------------------------------------------------------------------;
0506   0192             ; divide by zero exception
0507   0192             ; ------------------------------------------------------------------------------------------------------------------;
0508   0192             trap_div_zero:
0509   0192 D7            push a
0510   0193 DA            push d
0511   0194 E1            pushf
0512   0195 3B 2C 0D      mov d, s_divzero
0513   0198 07 BA 06      call _puts
0514   019B EE            popf
0515   019C E7            pop d
0516   019D E4            pop a
0517   019E 06            sysret ; enable interrupts
0518   019F             
0519   019F             ; ------------------------------------------------------------------------------------------------------------------;
0520   019F             ; undefined opcode exception
0521   019F             ; ------------------------------------------------------------------------------------------------------------------;
0522   019F             trap_undef_opcode:
0523   019F 06            sysret
0524   01A0             
0525   01A0             ; ------------------------------------------------------------------------------------------------------------------;
0526   01A0             ; real-time clock services syscall
0527   01A0             ; rtc i/o bank = ffa0 to ffaf
0528   01A0             ; ffa0 to ffa7 is scratch ram
0529   01A0             ; control register at $ffa8 [ w | r | s | cal4..cal0 ]
0530   01A0             ; al = 0..6 -> get
0531   01A0             ; al = 7..d -> set
0532   01A0             ; ------------------------------------------------------------------------------------------------------------------;
0533   01A0             syscall_rtc:
0534   01A0 DB            push al
0535   01A1 DA            push d
0536   01A2 B9 06         cmp al, 6
0537   01A4 D1 B9 01      jgu syscall_rtc_set
0538   01A7             syscall_rtc_get:
0539   01A7 6A A9         add al, $a9             ; generate rtc address to get to address a9 of clock
0540   01A9 22 FF         mov ah, $ff    
0541   01AB 3C            mov d, a                ; get to ffa9 + offset
0542   01AC F2 A8 FF 40   mov byte[$ffa8], $40    ; set r bit to 1
0543   01B0 1E            mov al, [d]             ; get data
0544   01B1 F2 A8 FF 00   mov byte[$ffa8], 0      ; reset r bit
0545   01B5 23            mov ah, al
0546   01B6 E7            pop d
0547   01B7 E8            pop al
0548   01B8 06            sysret
0549   01B9             syscall_rtc_set:
0550   01B9 DD            push bl
0551   01BA 99            mov bl, ah              ; set data aside
0552   01BB 6A A2         add al, $a2             ; generate rtc address to get to address a9 of clock
0553   01BD 22 FF         mov ah, $ff    
0554   01BF 3C            mov d, a                ; get to ffa9 + offset
0555   01C0 1B            mov al, bl              ; get data back
0556   01C1 F2 A8 FF 80   mov byte[$ffa8], $80    ; set w bit to 1
0557   01C5 3E            mov [d], al             ; set data
0558   01C6 F2 A8 FF 00   mov byte[$ffa8], 0      ; reset write bit
0559   01CA EA            pop bl
0560   01CB E7            pop d
0561   01CC E8            pop al
0562   01CD 06            sysret
0563   01CE             
0564   01CE             datetime_serv_tbl:
0565   01CE D6 01         .dw print_date
0566   01D0 4A 02         .dw set_date
0567   01D2             syscall_datetime:
0568   01D2 FD 0A CE 01   jmp [datetime_serv_tbl + al]      
0569   01D6             print_date:
0570   01D6 10 00 0D      mov a, $0d00           ; print carriage return char
0571   01D9 19 03         mov al, 3
0572   01DB 05 01         syscall sys_rtc        ; get week
0573   01DD 1A            mov al, ah
0574   01DE 22 00         mov ah, 0
0575   01E0 FD 9D 02      shl a, 2          
0576   01E3 3B 0C 0E      mov d, s_week
0577   01E6 59            add d, a
0578   01E7 07 BA 06      call _puts
0579   01EA 10 00 20      mov a, $2000
0580   01ED 05 03         syscall sys_io         ; display ' '
0581   01EF 19 04         mov al, 4
0582   01F1 05 01         syscall sys_rtc        ; get day
0583   01F3 99            mov bl, ah
0584   01F4 07 5A 07      call print_u8x
0585   01F7 10 00 20      mov a, $2000
0586   01FA 05 03         syscall sys_io         ; display ' '
0587   01FC             ; there is a problem with the month displaying
0588   01FC             ; the month is stored as bcd. so when retrieving the month, the value will be in binary
0589   01FC             ; even though it is to be understood as bcd.
0590   01FC             ; when retrieving the value and adding the string table address offset the value will go overboard!  
0591   01FC 19 05         mov al, 05
0592   01FE 05 01         syscall sys_rtc        ; get month
0593   0200 1A            mov al, ah
0594   0201 22 00         mov ah, 0
0595   0203 FD 9D 02      shl a, 2          
0596   0206 3B D8 0D      mov d, s_months
0597   0209 59            add d, a
0598   020A 07 BA 06      call _puts
0599   020D 10 00 20      mov a, $2000
0600   0210 05 03         syscall sys_io         ; display ' '
0601   0212 2E 20         mov bl, $20
0602   0214 07 5A 07      call print_u8x         ; print 20 for year prefix
0603   0217 19 06         mov al, 06
0604   0219 05 01         syscall sys_rtc        ; get year
0605   021B 99            mov bl, ah
0606   021C 07 5A 07      call print_u8x
0607   021F 10 00 20      mov a, $2000  
0608   0222 05 03         syscall sys_io         ; display ' '
0609   0224 19 02         mov al, 2
0610   0226 05 01         syscall sys_rtc        ; get hours
0611   0228 99            mov bl, ah
0612   0229 07 5A 07      call print_u8x
0613   022C 10 00 3A      mov a, $3a00    
0614   022F 05 03         syscall sys_io         ; display ':'
0615   0231 19 01         mov al, 01
0616   0233 05 01         syscall sys_rtc        ; get minutes
0617   0235 99            mov bl, ah
0618   0236 07 5A 07      call print_u8x
0619   0239 10 00 3A      mov a, $3a00  
0620   023C 05 03         syscall sys_io         ; display ':'
0621   023E 19 00         mov al, 0
0622   0240 05 01         syscall sys_rtc        ; get seconds
0623   0242 99            mov bl, ah
0624   0243 07 5A 07      call print_u8x
0625   0246 07 67 06      call printnl
0626   0249 06            sysret
0627   024A             set_date:
0628   024A 3B 9D 0D      mov d, s_set_year
0629   024D 07 BA 06      call _puts
0630   0250 07 A5 07      call scan_u8x          ; read integer into a
0631   0253 FD 9D 08      shl a, 8               ; only al used, move to ah
0632   0256 19 0D         mov al, 0dh            ; set rtc year
0633   0258 05 01         syscall sys_rtc        ; set rtc
0634   025A 3B A4 0D      mov d, s_set_month
0635   025D 07 BA 06      call _puts
0636   0260 07 A5 07      call scan_u8x          ; read integer into a
0637   0263 FD 9D 08      shl a, 8               ; only al used, move to ah
0638   0266 19 0C         mov al, 0ch            ; set rtc month
0639   0268 05 01         syscall sys_rtc        ; set rtc
0640   026A 3B AC 0D      mov d, s_set_day
0641   026D 07 BA 06      call _puts
0642   0270 07 A5 07      call scan_u8x          ; read integer into a
0643   0273 FD 9D 08      shl a, 8               ; only al used, move to ah
0644   0276 19 0B         mov al, 0bh            ; set rtc month
0645   0278 05 01         syscall sys_rtc        ; set rtc
0646   027A 3B B2 0D      mov d, s_set_week
0647   027D 07 BA 06      call _puts
0648   0280 07 A5 07      call scan_u8x          ; read integer into a
0649   0283 FD 9D 08      shl a, 8               ; only al used, move to ah
0650   0286 19 0A         mov al, 0ah            ; set rtc month
0651   0288 05 01         syscall sys_rtc        ; set rtc
0652   028A 3B BC 0D      mov d, s_set_hours
0653   028D 07 BA 06      call _puts
0654   0290 07 A5 07      call scan_u8x          ; read integer into a
0655   0293 FD 9D 08      shl a, 8               ; only al used, move to ah
0656   0296 19 09         mov al, 09h            ; set rtc month
0657   0298 05 01         syscall sys_rtc        ; set rtc
0658   029A 3B C4 0D      mov d, s_set_minutes
0659   029D 07 BA 06      call _puts
0660   02A0 07 A5 07      call scan_u8x          ; read integer into a
0661   02A3 FD 9D 08      shl a, 8               ; only al used, move to ah
0662   02A6 19 08         mov al, 08h            ; set rtc month
0663   02A8 05 01         syscall sys_rtc        ; set rtc
0664   02AA 3B CE 0D      mov d, s_set_seconds
0665   02AD 07 BA 06      call _puts
0666   02B0 07 A5 07      call scan_u8x          ; read integer into a
0667   02B3 FD 9D 08      shl a, 8               ; only al used, move to ah
0668   02B6 19 07         mov al, 07h            ; set rtc month
0669   02B8 05 01         syscall sys_rtc        ; set rtc
0670   02BA 06            sysret
0671   02BB             
0672   02BB             ; ------------------------------------------------------------------------------------------------------------------;
0673   02BB             ; ide services syscall
0674   02BB             ; al = option
0675   02BB             ; 0 = ide reset, 1 = ide sleep, 2 = read sector, 3 = write sector
0676   02BB             ; ide read/write sector
0677   02BB             ; 512 bytes
0678   02BB             ; user buffer pointer in d
0679   02BB             ; ah = number of sectors
0680   02BB             ; cb = lba bytes 3..0
0681   02BB             ; ------------------------------------------------------------------------------------------------------------------;
0682   02BB             ide_serv_tbl:
0683   02BB C7 02         .dw ide_reset
0684   02BD DB 02         .dw ide_sleep
0685   02BF EA 02         .dw ide_read_sect_wrapper
0686   02C1 EE 02         .dw ide_write_sect_wrapper
0687   02C3             syscall_ide:
0688   02C3 FD 0A BB 02   jmp [ide_serv_tbl + al]    
0689   02C7             
0690   02C7             ide_reset:      
0691   02C7 F2 D7 FF 04   mov byte[_ide_r7], 4            ; reset ide
0692   02CB 07 74 03      call ide_wait                   ; wait for ide ready             
0693   02CE F2 D6 FF E0   mov byte[_ide_r6], $e0          ; lba3= 0, master, mode= lba        
0694   02D2 F2 D1 FF 01   mov byte[_ide_r1], 1            ; 8-bit transfers      
0695   02D6 F2 D7 FF EF   mov byte[_ide_r7], $ef          ; set feature command
0696   02DA 06            sysret
0697   02DB             ide_sleep:
0698   02DB 07 74 03      call ide_wait                   ; wait for ide ready             
0699   02DE F2 D6 FF 40   mov byte [_ide_r6], %01000000   ; lba[3:0](reserved), bit 6=1
0700   02E2 F2 D7 FF E6   mov byte [_ide_r7], $e6         ; sleep command
0701   02E6 07 74 03      call ide_wait                   ; wait for ide ready
0702   02E9 06            sysret
0703   02EA             ide_read_sect_wrapper:
0704   02EA 07 F2 02      call ide_read_sect
0705   02ED 06            sysret
0706   02EE             ide_write_sect_wrapper:
0707   02EE 07 18 03      call ide_write_sect
0708   02F1 06            sysret
0709   02F2             ide_read_sect:
0710   02F2 1A            mov al, ah
0711   02F3 24            mov ah, bl
0712   02F4 42 D2 FF      mov [_ide_r2], a                ; number of sectors (0..255)
0713   02F7 1C            mov al, bh
0714   02F8 3D D4 FF      mov [_ide_r4], al
0715   02FB 12            mov a, c
0716   02FC 3D D5 FF      mov [_ide_r5], al
0717   02FF 1A            mov al, ah
0718   0300 87 0F         and al, %00001111
0719   0302 8B E0         or al, %11100000                ; mode lba, master
0720   0304 3D D6 FF      mov [_ide_r6], al
0721   0307             ide_read_sect_wait:
0722   0307 1D D7 FF      mov al, [_ide_r7]  
0723   030A 87 80         and al, $80                     ; busy flag
0724   030C C7 07 03      jnz ide_read_sect_wait
0725   030F 19 20         mov al, $20
0726   0311 3D D7 FF      mov [_ide_r7], al               ; read sector cmd
0727   0314 07 3E 03      call ide_read  
0728   0317 09            ret
0729   0318             ide_write_sect:
0730   0318 1A            mov al, ah
0731   0319 24            mov ah, bl
0732   031A 42 D2 FF      mov [_ide_r2], a                ; number of sectors (0..255)
0733   031D 1C            mov al, bh
0734   031E 3D D4 FF      mov [_ide_r4], al
0735   0321 12            mov a, c
0736   0322 3D D5 FF      mov [_ide_r5], al
0737   0325 1A            mov al, ah
0738   0326 87 0F         and al, %00001111
0739   0328 8B E0         or al, %11100000                ; mode lba, master
0740   032A 3D D6 FF      mov [_ide_r6], al
0741   032D             ide_write_sect_wait:
0742   032D 1D D7 FF      mov al, [_ide_r7]  
0743   0330 87 80         and al, $80                     ; busy flag
0744   0332 C7 2D 03      jnz ide_write_sect_wait
0745   0335 19 30         mov al, $30
0746   0337 3D D7 FF      mov [_ide_r7], al               ; write sector cmd
0747   033A 07 59 03      call ide_write      
0748   033D 09            ret
0749   033E             
0750   033E             ;----------------------------------------------------------------------------------------------------;
0751   033E             ; read ide data
0752   033E             ; pointer in d
0753   033E             ;----------------------------------------------------------------------------------------------------;
0754   033E             ide_read:
0755   033E DA            push d
0756   033F             ide_read_loop:
0757   033F 1D D7 FF      mov al, [_ide_r7]  
0758   0342 87 80         and al, 80h                     ; busy flag
0759   0344 C7 3F 03      jnz ide_read_loop               ; wait loop
0760   0347 1D D7 FF      mov al, [_ide_r7]
0761   034A 87 08         and al, %00001000               ; drq flag
0762   034C C6 57 03      jz ide_read_end
0763   034F 1D D0 FF      mov al, [_ide_r0]
0764   0352 3E            mov [d], al
0765   0353 79            inc d
0766   0354 0A 3F 03      jmp ide_read_loop
0767   0357             ide_read_end:
0768   0357 E7            pop d
0769   0358 09            ret
0770   0359             
0771   0359             ;----------------------------------------------------------------------------------------------------;
0772   0359             ; write ide data
0773   0359             ; data pointer in d
0774   0359             ;----------------------------------------------------------------------------------------------------;
0775   0359             ide_write:
0776   0359 DA            push d
0777   035A             ide_write_loop:
0778   035A 1D D7 FF      mov al, [_ide_r7]  
0779   035D 87 80         and al, 80h             ; busy flag
0780   035F C7 5A 03      jnz ide_write_loop      ; wait loop
0781   0362 1D D7 FF      mov al, [_ide_r7]
0782   0365 87 08         and al, %00001000       ; drq flag
0783   0367 C6 72 03      jz ide_write_end
0784   036A 1E            mov al, [d]
0785   036B 3D D0 FF      mov [_ide_r0], al
0786   036E 79            inc d 
0787   036F 0A 5A 03      jmp ide_write_loop
0788   0372             ide_write_end:
0789   0372 E7            pop d
0790   0373 09            ret
0791   0374             
0792   0374             ;----------------------------------------------------------------------------------------------------;
0793   0374             ; wait for ide to be ready
0794   0374             ;----------------------------------------------------------------------------------------------------;
0795   0374             ide_wait:
0796   0374 1D D7 FF      mov al, [_ide_r7]  
0797   0377 87 80         and al, 80h        ; busy flag
0798   0379 C7 74 03      jnz ide_wait
0799   037C 09            ret
0800   037D             
0801   037D             ;----------------------------------------------------------------------------------------------------;
0802   037D             ; io syscall
0803   037D             ;----------------------------------------------------------------------------------------------------;
0804   037D             ; baud  divisor
0805   037D             ; 50    2304
0806   037D             ; 110   1047
0807   037D             ; 300    384
0808   037D             ; 600    192
0809   037D             ; 1200    96
0810   037D             ; 9600    12
0811   037D             ; 19200    6
0812   037D             ; 38400    3
0813   037D             syscall_io_jmp:
0814   037D D8 03         .dw syscall_io_putchar
0815   037F F1 03         .dw syscall_io_getch
0816   0381 87 03         .dw syscall_io_uart_setup
0817   0383             syscall_io:
0818   0383 FD 0A 7D 03   jmp [syscall_io_jmp + al]
0819   0387             ; bit7 is the divisor latch access bit (dlab). it must be set high (logic 1) to access the divisor latches
0820   0387             ; of the baud generator during a read or write operation. it must be set low (logic 0) to access the receiver
0821   0387             ; buffer, the transmitter holding register, or the interrupt enable register.
0822   0387             syscall_io_uart_setup:
0823   0387 1D E3 0B      mov al, [sys_uart0_lcr]
0824   038A 8B 80         or al, $80                ; set dlab access bit
0825   038C 3D 83 FF      mov [_uart0_lcr], al      ; 8 data, 2 stop, no parity by default
0826   038F 1D E6 0B      mov al, [sys_uart0_div0]
0827   0392 3D 80 FF      mov [_uart0_dlab_0], al   ; divisor latch byte 0
0828   0395 1D E7 0B      mov al, [sys_uart0_div1]
0829   0398 3D 81 FF      mov [_uart0_dlab_1], al   ; divisor latch byte 1      
0830   039B 1D E3 0B      mov al, [sys_uart0_lcr]
0831   039E 87 7F         and al, $7f               ; clear dlab access bit 
0832   03A0 3D 83 FF      mov [_uart0_lcr], al
0833   03A3 1D E4 0B      mov al, [sys_uart0_inten]
0834   03A6 3D 81 FF      mov [_uart0_ier], al      ; interrupts
0835   03A9 1D E5 0B      mov al, [sys_uart0_fifoen]
0836   03AC 3D 82 FF      mov [_uart0_fcr], al      ; fifo control
0837   03AF             ; uart1:
0838   03AF 1D E8 0B      mov al, [sys_uart1_lcr]
0839   03B2 8B 80         or al, $80                ; set dlab access bit
0840   03B4 3D 8B FF      mov [_uart1_lcr], al      ; 8 data, 2 stop, no parity by default
0841   03B7 1D EB 0B      mov al, [sys_uart1_div0]
0842   03BA 3D 88 FF      mov [_uart1_dlab_0], al   ; divisor latch byte 0
0843   03BD 1D EC 0B      mov al, [sys_uart1_div1]
0844   03C0 3D 89 FF      mov [_uart1_dlab_1], al   ; divisor latch byte 1      
0845   03C3 1D E8 0B      mov al, [sys_uart1_lcr]
0846   03C6 87 7F         and al, $7f               ; clear dlab access bit 
0847   03C8 3D 8B FF      mov [_uart1_lcr], al
0848   03CB 1D E9 0B      mov al, [sys_uart1_inten]
0849   03CE 3D 89 FF      mov [_uart1_ier], al      ; interrupts
0850   03D1 1D EA 0B      mov al, [sys_uart1_fifoen]
0851   03D4 3D 8A FF      mov [_uart1_fcr], al      ; fifo control
0852   03D7 06            sysret
0853   03D8             
0854   03D8             ; char in ah
0855   03D8             syscall_io_putchar:
0856   03D8             syscall_io_putchar_l0:
0857   03D8 1D 85 FF      mov al, [_uart0_lsr]         ; read line status register
0858   03DB 87 20         and al, $20
0859   03DD C6 D8 03      jz syscall_io_putchar_l0    
0860   03E0 1A            mov al, ah
0861   03E1 3D 80 FF      mov [_uart0_data], al        ; write char to transmitter holding register
0862   03E4             ; write to uart1
0863   03E4             syscall_io_putchar_l1:
0864   03E4 1D 8D FF      mov al, [_uart1_lsr]         ; read line status register
0865   03E7 87 20         and al, $20
0866   03E9 C6 E4 03      jz syscall_io_putchar_l1
0867   03EC 1A            mov al, ah
0868   03ED 3D 88 FF      mov [_uart1_data], al        ; write char to transmitter holding register
0869   03F0 06            sysret
0870   03F1             
0871   03F1             ; char in ah
0872   03F1             ; al = sucess code
0873   03F1             syscall_io_getch:
0874   03F1 D8            push b
0875   03F2 DA            push d
0876   03F3 FD 0C         sti
0877   03F5             syscall_io_getch_l0:  
0878   03F5 14 EF 0B      mov a, [fifo_out]
0879   03F8 29 ED 0B      mov b, [fifo_in]
0880   03FB B0            cmp a, b
0881   03FC C6 F5 03      je syscall_io_getch_l0
0882   03FF 3C            mov d, a
0883   0400 77            inc a
0884   0401 AF 80 1E      cmp a, fifo + _fifo_size      ; check if pointer reached the end of the fifo
0885   0404 C7 0A 04      jne syscall_io_getch_cont
0886   0407 10 80 0E      mov a, fifo  
0887   040A             syscall_io_getch_cont:  
0888   040A 42 EF 0B      mov [fifo_out], a             ; update fifo pointer
0889   040D 1E            mov al, [d]                   ; get char
0890   040E 23            mov ah, al
0891   040F             ; here we just echo the char back to the console
0892   040F             syscall_io_getch_echo_l0:
0893   040F 1D 85 FF      mov al, [_uart0_lsr]         ; read line status register
0894   0412 87 20         and al, $20                 ; isolate transmitter empty
0895   0414 C6 0F 04      jz syscall_io_getch_echo_l0
0896   0417 1A            mov al, ah
0897   0418 3D 80 FF      mov [_uart0_data], al        ; write char to transmitter holding register
0898   041B             syscall_io_getch_echo_l1:
0899   041B 1D 8D FF      mov al, [_uart1_lsr]         ; read line status register
0900   041E 87 20         and al, $20                 ; isolate transmitter empty
0901   0420 C6 1B 04      jz syscall_io_getch_echo_l1
0902   0423 1A            mov al, ah
0903   0424 3D 88 FF      mov [_uart1_data], al        ; write char to transmitter holding register
0904   0427             syscall_io_getch_noecho:
0905   0427 19 01         mov al, 1                    ; al = 1 means a char successfully received
0906   0429 E7            pop d
0907   042A E5            pop b
0908   042B 06            sysret
0909   042C             
0910   042C             ;------------------------------------------------------------------------------------------------------;
0911   042C             ; file system data
0912   042C             ;------------------------------------------------------------------------------------------------------;
0913   042C             ; infor for : ide services interrupt
0914   042C             ; ide read/write 512-byte sector
0915   042C             ; al = option
0916   042C             ; user buffer pointer in d
0917   042C             ; ah = number of sectors
0918   042C             ; cb = lba bytes 3..0  
0919   042C             ;------------------------------------------------------------------------------------------------------;
0920   042C             ; file system data structure
0921   042C             ;------------------------------------------------------------------------------------------------------;
0922   042C             ; first directory on disk is the root directory '/'
0923   042C             file_system_jmptbl:
0924   042C 3F 04         .dw fs_cd                     
0925   042E 40 04         .dw fs_ls                     
0926   0430 44 04         .dw fs_pwd                    
0927   0432 45 04         .dw fs_rmdir                  
0928   0434 3E 04         .dw fs_mkdir
0929   0436 46 04         .dw fs_rm                     
0930   0438 47 04         .dw fs_mv                     
0931   043A             
0932   043A             syscall_file_system:
0933   043A FD 0A 2C 04   jmp [file_system_jmptbl + al]
0934   043E             
0935   043E             ;------------------------------------------------------------------------------------------------------;
0936   043E             ; create new directory
0937   043E             ;------------------------------------------------------------------------------------------------------;
0938   043E             ; search list for null name entry. add new directory to list
0939   043E             fs_mkdir:
0940   043E 06            sysret
0941   043F             
0942   043F             ;------------------------------------------------------------------------------------------------------;
0943   043F             ; cd
0944   043F             ;------------------------------------------------------------------------------------------------------;
0945   043F             fs_cd:
0946   043F 06            sysret  
0947   0440             
0948   0440             ;------------------------------------------------------------------------------------------------------;
0949   0440             ; ls
0950   0440             ;------------------------------------------------------------------------------------------------------;
0951   0440             ; inode in a
0952   0440             fs_ls:
0953   0440 3B 1C 00      mov d, inode_table_sect_start
0954   0443             
0955   0443 06            sysret
0956   0444             
0957   0444             ;------------------------------------------------------------------------------------------------------;
0958   0444             ; pwd - print working directory
0959   0444             ;------------------------------------------------------------------------------------------------------;    
0960   0444             fs_pwd:
0961   0444 06            sysret
0962   0445             
0963   0445             ;------------------------------------------------------------------------------------------------------;
0964   0445             ; rmdir - remove dir by dirid
0965   0445             ;------------------------------------------------------------------------------------------------------;
0966   0445             fs_rmdir:
0967   0445 06            sysret
0968   0446             
0969   0446             ;------------------------------------------------------------------------------------------------------;
0970   0446             ; rm - remove file
0971   0446             ;------------------------------------------------------------------------------------------------------;
0972   0446             fs_rm:
0973   0446 06            sysret  
0974   0447             
0975   0447             ;------------------------------------------------------------------------------------------------------;
0976   0447             ; mv - move / change file name
0977   0447             ;------------------------------------------------------------------------------------------------------;
0978   0447             fs_mv:
0979   0447 06            sysret
0980   0448             
0981   0448             
0982   0448             ;----------------------------------------------------------------------------------------------;
0983   0448             ; get hex file
0984   0448             ; di = destination address
0985   0448             ; return length in bytes in c
0986   0448             ;----------------------------------------------------------------------------------------------;
0987   0448             _load_hex:
0988   0448 D7            push a
0989   0449 D8            push b
0990   044A DA            push d
0991   044B E2            push si
0992   044C E3            push di
0993   044D 38 00 00      mov c, 0
0994   0450 50            mov a, di
0995   0451 3C            mov d, a          ; start of string data block
0996   0452 07 95 05      call _gets        ; get program string
0997   0455 4D            mov si, a
0998   0456             __load_hex_loop:
0999   0456 F6            lodsb             ; load from [si] to al
1000   0457 B9 00         cmp al, 0         ; check if ascii 0
1001   0459 C6 67 04      jz __load_hex_ret
1002   045C 36            mov bh, al
1003   045D F6            lodsb
1004   045E 2F            mov bl, al
1005   045F 07 4B 05      call _atoi        ; convert ascii byte in b to int (to al)
1006   0462 F7            stosb             ; store al to [di]
1007   0463 78            inc c
1008   0464 0A 56 04      jmp __load_hex_loop
1009   0467             __load_hex_ret:
1010   0467 F0            pop di
1011   0468 EF            pop si
1012   0469 E7            pop d
1013   046A E5            pop b
1014   046B E4            pop a
1015   046C 09            ret
1016   046D             
1017   046D             ; ---------------------------------------------------------------------
1018   046D             ; kernel reset vector
1019   046D             ; ---------------------------------------------------------------------
1020   046D             kernel_reset_vector:  
1021   046D FD 49 FF F7   mov bp, _stack_begin
1022   0471 FD 47 FF F7   mov sp, _stack_begin
1023   0475               
1024   0475 19 A1         mov al, %10100001             ; mask out timer interrupt for now - enable uarts and fdc irqs 
1025   0477 FD 0F         stomsk                        
1026   0479 FD 0C         sti  
1027   047B             
1028   047B 0C            lodstat
1029   047C 87 DF         and al, %11011111             ; disable display register loading
1030   047E 0D            stostat
1031   047F               
1032   047F             ; reset fifo pointers
1033   047F 10 80 0E      mov a, fifo
1034   0482 3B ED 0B      mov d, fifo_in
1035   0485 43            mov [d], a
1036   0486 3B EF 0B      mov d, fifo_out
1037   0489 43            mov [d], a  
1038   048A 19 02         mov al, 2
1039   048C 05 03         syscall sys_io                ; enable uart in interrupt mode
1040   048E             
1041   048E 3B 42 0C      mov d, s_kernel_welcome
1042   0491 07 BA 06      call _puts
1043   0494             
1044   0494 3B 39 0E      mov d, s_fdc_config
1045   0497 07 BA 06      call _puts
1046   049A F2 C0 FF 0D   mov byte [_fdc_config], %00001101  ; %00001001 : turn led on / head load, disable double density, select side 0, select drive 0, do not select drive 1
1047   049E F2 C8 FF 0B   mov byte [_fdc_stat_cmd], %00001011     ; leave this restore command in order to clear BUSY flag
1048   04A2 F2 C9 FF 00   mov byte [_fdc_track], $00 ; reset track
1049   04A6             
1050   04A6               ;syscall sys_create_proc       ; launch init as a new process
1051   04A6             
1052   04A6             ; file includes
1053   04A6             .include "bios.exp"         ; to obtain the bios_reset_vector location (for reboots)
0001+  04A6             boot_origin      .EQU  $8004
0002+  04A6             bios_uart        .EQU  $0002
0003+  04A6             bios_ide         .EQU  $0003
0004+  04A6             bios_reset_vector .EQU  $0190
0005+  04A6             ide_buffer       .EQU  $8404
0006+  04A6             inode_buffer     .EQU  $8c04
0007+  04A6             noname.__print_u16x .EQU  $01f6
0008+  04A6             noname.__xput_u8 .EQU  $023e
0009+  04A6             noname.__puts    .EQU  $0252
0010+  04A6             noname.__print_u16d .EQU  $0379
1054   04A6             .include "lib/stdio.asm"
0001+  04A6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002+  04A6             ; stdio.s
0003+  04A6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004+  04A6             .include "lib/string.asm"
0001++ 04A6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002++ 04A6             ; string.s
0003++ 04A6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004++ 04A6             
0005++ 04A6             
0006++ 04A6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0007++ 04A6             ; _strrev
0008++ 04A6             ; reverse a string
0009++ 04A6             ; d = string address
0010++ 04A6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0011++ 04A6             ; 01234
0012++ 04A6             _strrev:
0013++ 04A6 4B          	pusha
0014++ 04A7 07 ED 04    	call _strlen	; length in c
0015++ 04AA 12          	mov a, c
0016++ 04AB AF 01 00    	cmp a, 1
0017++ 04AE D0 C8 04    	jleu _strrev_end	; check string length. string len must be > 1
0018++ 04B1 7D          	dec a
0019++ 04B2 FD 4E       	mov si, d	; beginning of string
0020++ 04B4 FD 50       	mov di, d	; beginning of string (for destinations)
0021++ 04B6 59          	add d, a	; end of string
0022++ 04B7 12          	mov a, c
0023++ 04B8 FD 9B       	shr a		; divide by 2
0024++ 04BA 39          	mov c, a	; c now counts the steps
0025++ 04BB             _strrev_l0:
0026++ 04BB 32          	mov bl, [d]	; save load right-side char into bl
0027++ 04BC F6          	lodsb		; load left-side char into al; increase si
0028++ 04BD 3E          	mov [d], al	; store left char into right side
0029++ 04BE 1B          	mov al, bl
0030++ 04BF F7          	stosb		; store right-side char into left-side; increase di
0031++ 04C0 7E          	dec c
0032++ 04C1 7F          	dec d
0033++ 04C2 C2 00 00    	cmp c, 0
0034++ 04C5 C7 BB 04    	jne _strrev_l0
0035++ 04C8             _strrev_end:
0036++ 04C8 4C          	popa
0037++ 04C9 09          	ret
0038++ 04CA             	
0039++ 04CA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0040++ 04CA             ; _strchr
0041++ 04CA             ; search string in d for char in al
0042++ 04CA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0043++ 04CA             _strchr:
0044++ 04CA             _strchr_l0:
0045++ 04CA 32          	mov bl, [d]
0046++ 04CB C1 00       	cmp bl, 0
0047++ 04CD C6 D8 04    	je _strchr_end
0048++ 04D0 BA          	cmp al, bl
0049++ 04D1 C6 D8 04    	je _strchr_end
0050++ 04D4 79          	inc d
0051++ 04D5 0A CA 04    	jmp _strchr_l0
0052++ 04D8             _strchr_end:
0053++ 04D8 1B          	mov al, bl
0054++ 04D9 09          	ret
0055++ 04DA             
0056++ 04DA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0057++ 04DA             ; _strstr
0058++ 04DA             ; find sub-string
0059++ 04DA             ; str1 in si
0060++ 04DA             ; str2 in di
0061++ 04DA             ; si points to end of source string
0062++ 04DA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0063++ 04DA             _strstr:
0064++ 04DA DB          	push al
0065++ 04DB DA          	push d
0066++ 04DC E3          	push di
0067++ 04DD             _strstr_loop:
0068++ 04DD F3          	cmpsb					; compare a byte of the strings
0069++ 04DE C7 E9 04    	jne _strstr_ret
0070++ 04E1 FC 00 00    	lea d, [di + 0]
0071++ 04E4 BD 00       	cmp byte[d], 0				; check if at end of string (null)
0072++ 04E6 C7 DD 04    	jne _strstr_loop				; equal chars but not at end
0073++ 04E9             _strstr_ret:
0074++ 04E9 F0          	pop di
0075++ 04EA E7          	pop d
0076++ 04EB E8          	pop al
0077++ 04EC 09          	ret
0078++ 04ED             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0079++ 04ED             ; length of null terminated string
0080++ 04ED             ; result in c
0081++ 04ED             ; pointer in d
0082++ 04ED             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0083++ 04ED             _strlen:
0084++ 04ED DA          	push d
0085++ 04EE 38 00 00    	mov c, 0
0086++ 04F1             _strlen_l1:
0087++ 04F1 BD 00       	cmp byte [d], 0
0088++ 04F3 C6 FB 04    	je _strlen_ret
0089++ 04F6 79          	inc d
0090++ 04F7 78          	inc c
0091++ 04F8 0A F1 04    	jmp _strlen_l1
0092++ 04FB             _strlen_ret:
0093++ 04FB E7          	pop d
0094++ 04FC 09          	ret
0095++ 04FD             
0096++ 04FD             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0097++ 04FD             ; strcmp
0098++ 04FD             ; compare two strings
0099++ 04FD             ; str1 in si
0100++ 04FD             ; str2 in di
0101++ 04FD             ; create a string compairon instrucion ?????
0102++ 04FD             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0103++ 04FD             _strcmp:
0104++ 04FD DB          	push al
0105++ 04FE DA          	push d
0106++ 04FF E3          	push di
0107++ 0500 E2          	push si
0108++ 0501             _strcmp_loop:
0109++ 0501 F3          	cmpsb					; compare a byte of the strings
0110++ 0502 C7 0D 05    	jne _strcmp_ret
0111++ 0505 FB FF FF    	lea d, [si +- 1]
0112++ 0508 BD 00       	cmp byte[d], 0				; check if at end of string (null)
0113++ 050A C7 01 05    	jne _strcmp_loop				; equal chars but not at end
0114++ 050D             _strcmp_ret:
0115++ 050D EF          	pop si
0116++ 050E F0          	pop di
0117++ 050F E7          	pop d
0118++ 0510 E8          	pop al
0119++ 0511 09          	ret
0120++ 0512             
0121++ 0512             
0122++ 0512             ; strcpy
0123++ 0512             ; copy null terminated string from si to di
0124++ 0512             ; source in si
0125++ 0512             ; destination in di
0126++ 0512             _strcpy:
0127++ 0512 E2          	push si
0128++ 0513 E3          	push di
0129++ 0514 DB          	push al
0130++ 0515             _strcpy_l1:
0131++ 0515 F6          	lodsb
0132++ 0516 F7          	stosb
0133++ 0517 B9 00       	cmp al, 0
0134++ 0519 C7 15 05    	jne _strcpy_l1
0135++ 051C             _strcpy_end:
0136++ 051C E8          	pop al
0137++ 051D F0          	pop di
0138++ 051E EF          	pop si
0139++ 051F 09          	ret
0140++ 0520             
0141++ 0520             ; strcat
0142++ 0520             ; concatenate a null terminated string into string at di, from string at si
0143++ 0520             ; source in si
0144++ 0520             ; destination in di
0145++ 0520             _strcat:
0146++ 0520 E2          	push si
0147++ 0521 E3          	push di
0148++ 0522 D7          	push a
0149++ 0523 DA          	push d
0150++ 0524 50          	mov a, di
0151++ 0525 3C          	mov d, a
0152++ 0526             _strcat_goto_end_l1:
0153++ 0526 BD 00       	cmp byte[d], 0
0154++ 0528 C6 2F 05    	je _strcat_start
0155++ 052B 79          	inc d
0156++ 052C 0A 26 05    	jmp _strcat_goto_end_l1
0157++ 052F             _strcat_start:
0158++ 052F FD 50       	mov di, d
0159++ 0531             _strcat_l1:
0160++ 0531 F6          	lodsb
0161++ 0532 F7          	stosb
0162++ 0533 B9 00       	cmp al, 0
0163++ 0535 C7 31 05    	jne _strcat_l1
0164++ 0538             _strcat_end:
0165++ 0538 E7          	pop d
0166++ 0539 E4          	pop a
0167++ 053A F0          	pop di
0168++ 053B EF          	pop si
0169++ 053C 09          	ret
0170++ 053D             
0171++ 053D             
0005+  053D             
0006+  053D             
0007+  053D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0008+  053D             ; convert ascii 'o'..'f' to integer 0..15
0009+  053D             ; ascii in bl
0010+  053D             ; result in al
0011+  053D             ; ascii for f = 0100 0110
0012+  053D             ; ascii for 9 = 0011 1001
0013+  053D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0014+  053D             hex_ascii_encode:
0015+  053D 1B            mov al, bl
0016+  053E 93 40         test al, $40        ; test if letter or number
0017+  0540 C7 46 05      jnz hex_letter
0018+  0543 87 0F         and al, $0f        ; get number
0019+  0545 09            ret
0020+  0546             hex_letter:
0021+  0546 87 0F         and al, $0f        ; get letter
0022+  0548 6A 09         add al, 9
0023+  054A 09            ret
0024+  054B             
0025+  054B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0026+  054B             ; atoi
0027+  054B             ; 2 letter hex string in b
0028+  054B             ; 8bit integer returned in al
0029+  054B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0030+  054B             _atoi:
0031+  054B D8            push b
0032+  054C 07 3D 05      call hex_ascii_encode      ; convert bl to 4bit code in al
0033+  054F 30            mov bl, bh
0034+  0550 DB            push al          ; save a
0035+  0551 07 3D 05      call hex_ascii_encode
0036+  0554 EA            pop bl  
0037+  0555 FD 9E 04      shl al, 4
0038+  0558 8C            or al, bl
0039+  0559 E5            pop b
0040+  055A 09            ret  
0041+  055B             
0042+  055B             
0043+  055B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0044+  055B             ; scanf
0045+  055B             ; no need for explanations!
0046+  055B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0047+  055B             scanf:
0048+  055B 09            ret
0049+  055C             
0050+  055C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0051+  055C             ; itoa
0052+  055C             ; 8bit value in bl
0053+  055C             ; 2 byte ascii result in a
0054+  055C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0055+  055C             _itoa:
0056+  055C DA            push d
0057+  055D D8            push b
0058+  055E A7 00         mov bh, 0
0059+  0560 FD A4 04      shr bl, 4  
0060+  0563 74            mov d, b
0061+  0564 1F F6 07      mov al, [d + s_hex_digits]
0062+  0567 23            mov ah, al
0063+  0568               
0064+  0568 E5            pop b
0065+  0569 D8            push b
0066+  056A A7 00         mov bh, 0
0067+  056C FD 87 0F      and bl, $0f
0068+  056F 74            mov d, b
0069+  0570 1F F6 07      mov al, [d + s_hex_digits]
0070+  0573 E5            pop b
0071+  0574 E7            pop d
0072+  0575 09            ret
0073+  0576             
0074+  0576             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0075+  0576             ; hex string to binary
0076+  0576             ; di = destination address
0077+  0576             ; si = source
0078+  0576             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0079+  0576             _hex_to_int:
0080+  0576             _hex_to_int_l1:
0081+  0576 F6            lodsb          ; load from [si] to al
0082+  0577 B9 00         cmp al, 0        ; check if ascii 0
0083+  0579 C6 86 05      jz _hex_to_int_ret
0084+  057C 36            mov bh, al
0085+  057D F6            lodsb
0086+  057E 2F            mov bl, al
0087+  057F 07 4B 05      call _atoi        ; convert ascii byte in b to int (to al)
0088+  0582 F7            stosb          ; store al to [di]
0089+  0583 0A 76 05      jmp _hex_to_int_l1
0090+  0586             _hex_to_int_ret:
0091+  0586 09            ret    
0092+  0587             
0093+  0587             
0094+  0587             
0095+  0587             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0096+  0587             ; getchar
0097+  0587             ; char in ah
0098+  0587             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0099+  0587             getch:
0100+  0587 DB            push al
0101+  0588             getch_retry:
0102+  0588 19 01         mov al, 1
0103+  058A 05 03         syscall sys_io      ; receive in ah
0104+  058C E8            pop al
0105+  058D 09            ret
0106+  058E             
0107+  058E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0108+  058E             ; putchar
0109+  058E             ; char in ah
0110+  058E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0111+  058E             _putchar:
0112+  058E DB            push al
0113+  058F 19 00         mov al, 0
0114+  0591 05 03         syscall sys_io      ; char in ah
0115+  0593 E8            pop al
0116+  0594 09            ret
0117+  0595             
0118+  0595             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0119+  0595             ;; input a string
0120+  0595             ;; terminates with null
0121+  0595             ;; pointer in d
0122+  0595             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0123+  0595             _gets:
0124+  0595 D7            push a
0125+  0596 DA            push d
0126+  0597             _gets_loop:
0127+  0597 19 01         mov al, 1
0128+  0599 05 03         syscall sys_io      ; receive in ah
0129+  059B 76 1B         cmp ah, 27
0130+  059D C6 BE 05      je _gets_ansi_esc
0131+  05A0 76 0A         cmp ah, $0a        ; lf
0132+  05A2 C6 1A 06      je _gets_end
0133+  05A5 76 0D         cmp ah, $0d        ; cr
0134+  05A7 C6 1A 06      je _gets_end
0135+  05AA 76 5C         cmp ah, $5c        ; '\\'
0136+  05AC C6 E0 05      je _gets_escape
0137+  05AF 76 08         cmp ah, $08      ; check for backspace
0138+  05B1 C6 BA 05      je _gets_backspace
0139+  05B4 1A            mov al, ah
0140+  05B5 3E            mov [d], al
0141+  05B6 79            inc d
0142+  05B7 0A 97 05      jmp _gets_loop
0143+  05BA             _gets_backspace:
0144+  05BA 7F            dec d
0145+  05BB 0A 97 05      jmp _gets_loop
0146+  05BE             _gets_ansi_esc:
0147+  05BE 19 01         mov al, 1
0148+  05C0 05 03         syscall sys_io        ; receive in ah without echo
0149+  05C2 76 5B         cmp ah, '['
0150+  05C4 C7 97 05      jne _gets_loop
0151+  05C7 19 01         mov al, 1
0152+  05C9 05 03         syscall sys_io          ; receive in ah without echo
0153+  05CB 76 64         cmp ah, 'd'
0154+  05CD C6 D8 05      je _gets_left_arrow
0155+  05D0 76 63         cmp ah, 'c'
0156+  05D2 C6 DC 05      je _gets_right_arrow
0157+  05D5 0A 97 05      jmp _gets_loop
0158+  05D8             _gets_left_arrow:
0159+  05D8 7F            dec d
0160+  05D9 0A 97 05      jmp _gets_loop
0161+  05DC             _gets_right_arrow:
0162+  05DC 79            inc d
0163+  05DD 0A 97 05      jmp _gets_loop
0164+  05E0             _gets_escape:
0165+  05E0 19 01         mov al, 1
0166+  05E2 05 03         syscall sys_io      ; receive in ah
0167+  05E4 76 6E         cmp ah, 'n'
0168+  05E6 C6 05 06      je _gets_lf
0169+  05E9 76 72         cmp ah, 'r'
0170+  05EB C6 0C 06      je _gets_cr
0171+  05EE 76 30         cmp ah, '0'
0172+  05F0 C6 13 06      je _gets_null
0173+  05F3 76 5C         cmp ah, $5c  ; '\'
0174+  05F5 C6 FE 05      je _gets_slash
0175+  05F8 1A            mov al, ah        ; if not a known escape, it is just a normal letter
0176+  05F9 3E            mov [d], al
0177+  05FA 79            inc d
0178+  05FB 0A 97 05      jmp _gets_loop
0179+  05FE             _gets_slash:
0180+  05FE 19 5C         mov al, $5c
0181+  0600 3E            mov [d], al
0182+  0601 79            inc d
0183+  0602 0A 97 05      jmp _gets_loop
0184+  0605             _gets_lf:
0185+  0605 19 0A         mov al, $0a
0186+  0607 3E            mov [d], al
0187+  0608 79            inc d
0188+  0609 0A 97 05      jmp _gets_loop
0189+  060C             _gets_cr:
0190+  060C 19 0D         mov al, $0d
0191+  060E 3E            mov [d], al
0192+  060F 79            inc d
0193+  0610 0A 97 05      jmp _gets_loop
0194+  0613             _gets_null:
0195+  0613 19 00         mov al, $00
0196+  0615 3E            mov [d], al
0197+  0616 79            inc d
0198+  0617 0A 97 05      jmp _gets_loop
0199+  061A             _gets_end:
0200+  061A 19 00         mov al, 0
0201+  061C 3E            mov [d], al        ; terminate string
0202+  061D E7            pop d
0203+  061E E4            pop a
0204+  061F 09            ret
0205+  0620             
0206+  0620             
0207+  0620             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0208+  0620             ;; input text
0209+  0620             ;; terminated with ctrl+d
0210+  0620             ;; pointer in d
0211+  0620             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0212+  0620             _gettxt:
0213+  0620 D7            push a
0214+  0621 DA            push d
0215+  0622             _gettxt_loop:
0216+  0622 19 01         mov al, 1
0217+  0624 05 03         syscall sys_io      ; receive in ah
0218+  0626 76 04         cmp ah, 4      ; eot
0219+  0628 C6 61 06      je _gettxt_end
0220+  062B 76 08         cmp ah, $08      ; check for backspace
0221+  062D C6 5D 06      je _gettxt_backspace
0222+  0630 76 5C         cmp ah, $5c        ; '\'
0223+  0632 C6 3B 06      je _gettxt_escape
0224+  0635 1A            mov al, ah
0225+  0636 3E            mov [d], al
0226+  0637 79            inc d
0227+  0638 0A 22 06      jmp _gettxt_loop
0228+  063B             _gettxt_escape:
0229+  063B 19 01         mov al, 1
0230+  063D 05 03         syscall sys_io      ; receive in ah
0231+  063F 76 6E         cmp ah, 'n'
0232+  0641 C6 4F 06      je _gettxt_lf
0233+  0644 76 72         cmp ah, 'r'
0234+  0646 C6 56 06      je _gettxt_cr
0235+  0649 1A            mov al, ah        ; if not a known escape, it is just a normal letter
0236+  064A 3E            mov [d], al
0237+  064B 79            inc d
0238+  064C 0A 22 06      jmp _gettxt_loop
0239+  064F             _gettxt_lf:
0240+  064F 19 0A         mov al, $0a
0241+  0651 3E            mov [d], al
0242+  0652 79            inc d
0243+  0653 0A 22 06      jmp _gettxt_loop
0244+  0656             _gettxt_cr:
0245+  0656 19 0D         mov al, $0d
0246+  0658 3E            mov [d], al
0247+  0659 79            inc d
0248+  065A 0A 22 06      jmp _gettxt_loop
0249+  065D             _gettxt_backspace:
0250+  065D 7F            dec d
0251+  065E 0A 22 06      jmp _gettxt_loop
0252+  0661             _gettxt_end:
0253+  0661 19 00         mov al, 0
0254+  0663 3E            mov [d], al        ; terminate string
0255+  0664 E7            pop d
0256+  0665 E4            pop a
0257+  0666 09            ret
0258+  0667             
0259+  0667             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0260+  0667             ; print new line
0261+  0667             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0262+  0667             printnl:
0263+  0667 D7            push a
0264+  0668 10 00 0A      mov a, $0a00
0265+  066B 05 03         syscall sys_io
0266+  066D 10 00 0D      mov a, $0d00
0267+  0670 05 03         syscall sys_io
0268+  0672 E4            pop a
0269+  0673 09            ret
0270+  0674             
0271+  0674             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0272+  0674             ; _strtoint
0273+  0674             ; 4 digit hex string number in d
0274+  0674             ; integer returned in a
0275+  0674             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0276+  0674             _strtointx:
0277+  0674 D8            push b
0278+  0675 32            mov bl, [d]
0279+  0676 37            mov bh, bl
0280+  0677 33 01 00      mov bl, [d + 1]
0281+  067A 07 4B 05      call _atoi        ; convert to int in al
0282+  067D 23            mov ah, al        ; move to ah
0283+  067E 33 02 00      mov bl, [d + 2]
0284+  0681 37            mov bh, bl
0285+  0682 33 03 00      mov bl, [d + 3]
0286+  0685 07 4B 05      call _atoi        ; convert to int in al
0287+  0688 E5            pop b
0288+  0689 09            ret
0289+  068A             
0290+  068A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0291+  068A             ; _strtoint
0292+  068A             ; 5 digit base10 string number in d
0293+  068A             ; integer returned in a
0294+  068A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0295+  068A             _strtoint:
0296+  068A E2            push si
0297+  068B D8            push b
0298+  068C D9            push c
0299+  068D DA            push d
0300+  068E 07 ED 04      call _strlen      ; get string length in c
0301+  0691 7E            dec c
0302+  0692 FD 4E         mov si, d
0303+  0694 12            mov a, c
0304+  0695 FD 99         shl a
0305+  0697 3B 0E 08      mov d, table_power
0306+  069A 59            add d, a
0307+  069B 38 00 00      mov c, 0
0308+  069E             _strtoint_l0:
0309+  069E F6            lodsb      ; load ascii to al
0310+  069F B9 00         cmp al, 0
0311+  06A1 C6 B4 06      je _strtoint_end
0312+  06A4 6F 30         sub al, $30    ; make into integer
0313+  06A6 22 00         mov ah, 0
0314+  06A8 2A            mov b, [d]
0315+  06A9 AC            mul a, b      ; result in b since it fits in 16bits
0316+  06AA 11            mov a, b
0317+  06AB 28            mov b, c
0318+  06AC 54            add a, b
0319+  06AD 39            mov c, a
0320+  06AE 63 02 00      sub d, 2
0321+  06B1 0A 9E 06      jmp _strtoint_l0
0322+  06B4             _strtoint_end:
0323+  06B4 12            mov a, c
0324+  06B5 E7            pop d
0325+  06B6 E6            pop c
0326+  06B7 E5            pop b
0327+  06B8 EF            pop si
0328+  06B9 09            ret
0329+  06BA             
0330+  06BA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0331+  06BA             ; print null terminated string
0332+  06BA             ; pointer in d
0333+  06BA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0334+  06BA             _puts:
0335+  06BA D7            push a
0336+  06BB DA            push d
0337+  06BC             _puts_l1:
0338+  06BC 1E            mov al, [d]
0339+  06BD B9 00         cmp al, 0
0340+  06BF C6 CB 06      jz _puts_end
0341+  06C2 23            mov ah, al
0342+  06C3 19 00         mov al, 0
0343+  06C5 05 03         syscall sys_io
0344+  06C7 79            inc d
0345+  06C8 0A BC 06      jmp _puts_l1
0346+  06CB             _puts_end:
0347+  06CB E7            pop d
0348+  06CC E4            pop a
0349+  06CD 09            ret
0350+  06CE             
0351+  06CE             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0352+  06CE             ; print n size string
0353+  06CE             ; pointer in d
0354+  06CE             ; size in c
0355+  06CE             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0356+  06CE             _putsn:
0357+  06CE DB            push al
0358+  06CF DA            push d
0359+  06D0 D9            push c
0360+  06D1             _putsn_l0:
0361+  06D1 1E            mov al, [d]
0362+  06D2 23            mov ah, al
0363+  06D3 19 00         mov al, 0
0364+  06D5 05 03         syscall sys_io
0365+  06D7 79            inc d
0366+  06D8 7E            dec c  
0367+  06D9 C2 00 00      cmp c, 0
0368+  06DC C7 D1 06      jne _putsn_l0
0369+  06DF             _putsn_end:
0370+  06DF E6            pop c
0371+  06E0 E7            pop d
0372+  06E1 E8            pop al
0373+  06E2 09            ret
0374+  06E3             
0375+  06E3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0376+  06E3             ; print 16bit decimal number
0377+  06E3             ; input number in a
0378+  06E3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0379+  06E3             print_u16d:
0380+  06E3 D7            push a
0381+  06E4 D8            push b
0382+  06E5 FD D8         push g
0383+  06E7 26 10 27      mov b, 10000
0384+  06EA AE            div a, b      ; get 10000's coeff.
0385+  06EB 07 0F 07      call print_number
0386+  06EE 11            mov a, b
0387+  06EF 26 E8 03      mov b, 1000
0388+  06F2 AE            div a, b      ; get 1000's coeff.
0389+  06F3 07 0F 07      call print_number
0390+  06F6 11            mov a, b
0391+  06F7 26 64 00      mov b, 100
0392+  06FA AE            div a, b
0393+  06FB 07 0F 07      call print_number
0394+  06FE 11            mov a, b
0395+  06FF 26 0A 00      mov b, 10
0396+  0702 AE            div a, b
0397+  0703 07 0F 07      call print_number
0398+  0706 1B            mov al, bl      ; 1's coeff in bl
0399+  0707 07 0F 07      call print_number
0400+  070A FD F1         pop g
0401+  070C E5            pop b
0402+  070D E4            pop a
0403+  070E 09            ret
0404+  070F             
0405+  070F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0406+  070F             ; print al
0407+  070F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0408+  070F             print_number:
0409+  070F 6A 30         add al, $30
0410+  0711 23            mov ah, al
0411+  0712 07 8E 05      call _putchar
0412+  0715 09            ret
0413+  0716             
0414+  0716             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0415+  0716             ; print 16bit hex integer
0416+  0716             ; integer value in reg b
0417+  0716             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0418+  0716             print_u16x:
0419+  0716 D7            push a
0420+  0717 D8            push b
0421+  0718 DD            push bl
0422+  0719 30            mov bl, bh
0423+  071A 07 5C 05      call _itoa        ; convert bh to char in a
0424+  071D 2F            mov bl, al        ; save al
0425+  071E 19 00         mov al, 0
0426+  0720 05 03         syscall sys_io        ; display ah
0427+  0722 24            mov ah, bl        ; retrieve al
0428+  0723 19 00         mov al, 0
0429+  0725 05 03         syscall sys_io        ; display al
0430+  0727             
0431+  0727 EA            pop bl
0432+  0728 07 5C 05      call _itoa        ; convert bh to char in a
0433+  072B 2F            mov bl, al        ; save al
0434+  072C 19 00         mov al, 0
0435+  072E 05 03         syscall sys_io        ; display ah
0436+  0730 24            mov ah, bl        ; retrieve al
0437+  0731 19 00         mov al, 0
0438+  0733 05 03         syscall sys_io        ; display al
0439+  0735             
0440+  0735 E5            pop b
0441+  0736 E4            pop a
0442+  0737 09            ret
0443+  0738             
0444+  0738             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0445+  0738             ; input 16bit hex integer
0446+  0738             ; read 16bit integer into a
0447+  0738             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0448+  0738             scan_u16x:
0449+  0738 F8 10 00      enter 16
0450+  073B D8            push b
0451+  073C DA            push d
0452+  073D             
0453+  073D FA F1 FF      lea d, [bp + -15]
0454+  0740 07 95 05      call _gets        ; get number
0455+  0743             
0456+  0743 32            mov bl, [d]
0457+  0744 37            mov bh, bl
0458+  0745 33 01 00      mov bl, [d + 1]
0459+  0748 07 4B 05      call _atoi        ; convert to int in al
0460+  074B 23            mov ah, al        ; move to ah
0461+  074C             
0462+  074C 33 02 00      mov bl, [d + 2]
0463+  074F 37            mov bh, bl
0464+  0750 33 03 00      mov bl, [d + 3]
0465+  0753 07 4B 05      call _atoi        ; convert to int in al
0466+  0756             
0467+  0756 E7            pop d
0468+  0757 E5            pop b
0469+  0758 F9            leave
0470+  0759 09            ret
0471+  075A             
0472+  075A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0473+  075A             ; print 8bit hex integer
0474+  075A             ; integer value in reg bl
0475+  075A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0476+  075A             print_u8x:
0477+  075A D7            push a
0478+  075B DD            push bl
0479+  075C             
0480+  075C 07 5C 05      call _itoa        ; convert bl to char in a
0481+  075F 2F            mov bl, al        ; save al
0482+  0760 19 00         mov al, 0
0483+  0762 05 03         syscall sys_io        ; display ah
0484+  0764 24            mov ah, bl        ; retrieve al
0485+  0765 19 00         mov al, 0
0486+  0767 05 03         syscall sys_io        ; display al
0487+  0769             
0488+  0769 EA            pop bl
0489+  076A E4            pop a
0490+  076B 09            ret
0491+  076C             
0492+  076C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0493+  076C             ; print 8bit decimal unsigned number
0494+  076C             ; input number in al
0495+  076C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0496+  076C             print_u8d:
0497+  076C D7            push a
0498+  076D D8            push b
0499+  076E FD D8         push g
0500+  0770 22 00         mov ah, 0
0501+  0772 26 64 00      mov b, 100
0502+  0775 AE            div a, b
0503+  0776 D8            push b      ; save remainder
0504+  0777 B9 00         cmp al, 0
0505+  0779 C6 83 07      je skip100
0506+  077C 6A 30         add al, $30
0507+  077E 23            mov ah, al
0508+  077F 19 00         mov al, 0
0509+  0781 05 03         syscall sys_io  ; print coeff
0510+  0783             skip100:
0511+  0783 E4            pop a
0512+  0784 22 00         mov ah, 0
0513+  0786 26 0A 00      mov b, 10
0514+  0789 AE            div a, b
0515+  078A D8            push b      ; save remainder
0516+  078B B9 00         cmp al, 0
0517+  078D C6 97 07      je skip10
0518+  0790 6A 30         add al, $30
0519+  0792 23            mov ah, al
0520+  0793 19 00         mov al, 0
0521+  0795 05 03         syscall sys_io  ; print coeff
0522+  0797             skip10:
0523+  0797 E4            pop a
0524+  0798 1B            mov al, bl
0525+  0799 6A 30         add al, $30
0526+  079B 23            mov ah, al
0527+  079C 19 00         mov al, 0
0528+  079E 05 03         syscall sys_io  ; print coeff
0529+  07A0 FD F1         pop g
0530+  07A2 E5            pop b
0531+  07A3 E4            pop a
0532+  07A4 09            ret
0533+  07A5             
0534+  07A5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0535+  07A5             ; input 8bit hex integer
0536+  07A5             ; read 8bit integer into al
0537+  07A5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0538+  07A5             scan_u8x:
0539+  07A5 F8 04 00      enter 4
0540+  07A8 D8            push b
0541+  07A9 DA            push d
0542+  07AA             
0543+  07AA FA FD FF      lea d, [bp + -3]
0544+  07AD 07 95 05      call _gets        ; get number
0545+  07B0             
0546+  07B0 32            mov bl, [d]
0547+  07B1 37            mov bh, bl
0548+  07B2 33 01 00      mov bl, [d + 1]
0549+  07B5 07 4B 05      call _atoi        ; convert to int in al
0550+  07B8             
0551+  07B8 E7            pop d
0552+  07B9 E5            pop b
0553+  07BA F9            leave
0554+  07BB 09            ret
0555+  07BC             
0556+  07BC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0557+  07BC             ; input decimal number
0558+  07BC             ; result in a
0559+  07BC             ; 655'\0'
0560+  07BC             ; low--------high
0561+  07BC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0562+  07BC             scan_u16d:
0563+  07BC F8 08 00      enter 8
0564+  07BF E2            push si
0565+  07C0 D8            push b
0566+  07C1 D9            push c
0567+  07C2 DA            push d
0568+  07C3 FA F9 FF      lea d, [bp +- 7]
0569+  07C6 07 95 05      call _gets
0570+  07C9 07 ED 04      call _strlen      ; get string length in c
0571+  07CC 7E            dec c
0572+  07CD FD 4E         mov si, d
0573+  07CF 12            mov a, c
0574+  07D0 FD 99         shl a
0575+  07D2 3B 0E 08      mov d, table_power
0576+  07D5 59            add d, a
0577+  07D6 38 00 00      mov c, 0
0578+  07D9             mul_loop:
0579+  07D9 F6            lodsb      ; load ascii to al
0580+  07DA B9 00         cmp al, 0
0581+  07DC C6 EF 07      je mul_exit
0582+  07DF 6F 30         sub al, $30    ; make into integer
0583+  07E1 22 00         mov ah, 0
0584+  07E3 2A            mov b, [d]
0585+  07E4 AC            mul a, b      ; result in b since it fits in 16bits
0586+  07E5 11            mov a, b
0587+  07E6 28            mov b, c
0588+  07E7 54            add a, b
0589+  07E8 39            mov c, a
0590+  07E9 63 02 00      sub d, 2
0591+  07EC 0A D9 07      jmp mul_loop
0592+  07EF             mul_exit:
0593+  07EF 12            mov a, c
0594+  07F0 E7            pop d
0595+  07F1 E6            pop c
0596+  07F2 E5            pop b
0597+  07F3 EF            pop si
0598+  07F4 F9            leave
0599+  07F5 09            ret
0600+  07F6             
0601+  07F6             
0602+  07F6 30 31 32 33 s_hex_digits:    .db "0123456789abcdef"  
0602+  07FA 34 35 36 37 
0602+  07FE 38 39 61 62 
0602+  0802 63 64 65 66 
0603+  0806 1B 5B 32 6A s_telnet_clear:  .db "\033[2j\033[h", 0
0603+  080A 1B 5B 68 00 
0604+  080E             
0605+  080E             table_power:
0606+  080E 01 00         .dw 1
0607+  0810 0A 00         .dw 10
0608+  0812 64 00         .dw 100
0609+  0814 E8 03         .dw 1000
0610+  0816 10 27         .dw 100001055   0818             .include "lib/ctype.asm"
0001+  0818             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002+  0818             ; ctype.s
0003+  0818             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004+  0818             
0005+  0818             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0006+  0818             ;; c character classification is an operation provided by a group of functions in the ansi c standard library
0007+  0818             ;; for the c programming language. these functions are used to test characters for membership in a particular
0008+  0818             ;; class of characters, such as alphabetic characters, control characters, etc. both single-byte, and wide
0009+  0818             ;; characters are supported.
0010+  0818             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0011+  0818             ;; _isalnum 
0012+  0818             ;; _isalpha 
0013+  0818             ;; islower 
0014+  0818             ;; isupper 
0015+  0818             ;; _isdigit 
0016+  0818             ;; isxdigit
0017+  0818             ;; iscntrl 
0018+  0818             ;; isgraph 
0019+  0818             ;; _isspace 
0020+  0818             ;; isblank 
0021+  0818             ;; isprint 
0022+  0818             ;; ispunct 
0023+  0818             ;; tolower 
0024+  0818             ;; toupper
0025+  0818             
0026+  0818             
0027+  0818             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0028+  0818             ;; is alphanumeric
0029+  0818             ;; sets zf according with result
0030+  0818             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0031+  0818             _isalnum:
0032+  0818 07 35 08    	call _isalpha
0033+  081B C6 21 08    	je _isalnum_exit
0034+  081E 07 22 08    	call _isdigit
0035+  0821             _isalnum_exit:
0036+  0821 09          	ret	
0037+  0822             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0038+  0822             ;; is digit
0039+  0822             ;; sets zf according with result
0040+  0822             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0041+  0822             _isdigit:
0042+  0822 DB          	push al
0043+  0823 B9 30       	cmp al, '0'
0044+  0825 C8 31 08    	jlu _isdigit_false
0045+  0828 B9 39       	cmp al, '9'
0046+  082A D1 31 08    	jgu _isdigit_false
0047+  082D 87 00       	and al, 0	; set zf
0048+  082F E8          	pop al
0049+  0830 09          	ret
0050+  0831             _isdigit_false:
0051+  0831 8B 01       	or al, 1	; clear zf
0052+  0833 E8          	pop al
0053+  0834 09          	ret	
0054+  0835             	
0055+  0835             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0056+  0835             ;; is alpha
0057+  0835             ;; sets zf according with result
0058+  0835             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0059+  0835             _isalpha:
0060+  0835 DB          	push al
0061+  0836 B9 5F       	cmp al, '_'
0062+  0838 C6 58 08    	je _isalpha_true
0063+  083B B9 2E       	cmp al, '.'
0064+  083D C6 58 08    	je _isalpha_true
0065+  0840 B9 61       	cmp al, 'a'
0066+  0842 C8 54 08    	jlu _isalpha_false
0067+  0845 B9 7A       	cmp al, 'z'
0068+  0847 D1 54 08    	jgu _isalpha_false
0069+  084A B9 7A       	cmp al, 'z'
0070+  084C D0 58 08    	jleu _isalpha_true
0071+  084F B9 61       	cmp al, 'a'
0072+  0851 C9 58 08    	jgeu _isalpha_true
0073+  0854             _isalpha_false:
0074+  0854 8B 01       	or al, 1	; clear zf
0075+  0856 E8          	pop al
0076+  0857 09          	ret
0077+  0858             _isalpha_true:
0078+  0858 87 00       	and al, 0	; set zf
0079+  085A E8          	pop al
0080+  085B 09          	ret
0081+  085C             
0082+  085C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0083+  085C             ;; is path-alpha
0084+  085C             ;; sets zf according with result
0085+  085C             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0086+  085C             ispath:
0087+  085C DB          	push al
0088+  085D 07 22 08    	call _isdigit
0089+  0860 C6 8A 08    	je ispath_true
0090+  0863 B9 5F       	cmp al, '_'
0091+  0865 C6 8A 08    	je ispath_true
0092+  0868 B9 2F       	cmp al, '/'
0093+  086A C6 8A 08    	je ispath_true
0094+  086D B9 2E       	cmp al, '.'
0095+  086F C6 8A 08    	je ispath_true
0096+  0872 B9 61       	cmp al, 'a'
0097+  0874 C8 86 08    	jlu ispath_false
0098+  0877 B9 7A       	cmp al, 'z'
0099+  0879 D1 86 08    	jgu ispath_false
0100+  087C B9 7A       	cmp al, 'z'
0101+  087E D0 8A 08    	jleu ispath_true
0102+  0881 B9 61       	cmp al, 'a'
0103+  0883 C9 8A 08    	jgeu ispath_true
0104+  0886             ispath_false:
0105+  0886 8B 01       	or al, 1	; clear zf
0106+  0888 E8          	pop al
0107+  0889 09          	ret
0108+  088A             ispath_true:
0109+  088A 87 00       	and al, 0	; set zf
0110+  088C E8          	pop al
0111+  088D 09          	ret
0112+  088E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0113+  088E             ;; is space
0114+  088E             ;; sets zf according with result
0115+  088E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0116+  088E             _isspace:
0117+  088E B9 20       	cmp al, $20		; ' '
0118+  0890 C6 A4 08    	je _isspace_exit
0119+  0893 B9 09       	cmp al, $09		; '\t'
0120+  0895 C6 A4 08    	je _isspace_exit
0121+  0898 B9 0A       	cmp al, $0a		; '\n'
0122+  089A C6 A4 08    	je _isspace_exit
0123+  089D B9 0D       	cmp al, $0d		; '\r'
0124+  089F C6 A4 08    	je _isspace_exit
0125+  08A2 B9 0B       	cmp al, $0b		; '\v'
0126+  08A4             _isspace_exit:
0127+  08A4 09          	ret	
0128+  08A5             
0129+  08A5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0130+  08A5             ; to lower
0131+  08A5             ; input in al
0132+  08A5             ; output in al
0133+  08A5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0134+  08A5             _to_lower:
0135+  08A5 B9 7A       	cmp al, 'z'
0136+  08A7 D1 AC 08    	jgu _to_lower_ret
0137+  08AA 6A 20       	add al, $20				; convert to lower case
0138+  08AC             _to_lower_ret:
0139+  08AC 09          	ret
0140+  08AD             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0141+  08AD             ; to upper
0142+  08AD             ; input in al
0143+  08AD             ; output in al
0144+  08AD             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0145+  08AD             _to_upper:
0146+  08AD B9 61       	cmp al, 'a'
0147+  08AF C8 B4 08    	jlu _to_upper_ret
0148+  08B2 6F 20       	sub al, $20			; convert to upper case
0149+  08B4             _to_upper_ret:
0150+  08B4 09          	ret
0151+  08B5             
1056   08B5             .include "lib/token.asm"
0001+  08B5             toktyp_identifier  .equ 0
0002+  08B5             toktyp_keyword     .equ 1
0003+  08B5             toktyp_delimiter   .equ 2
0004+  08B5             toktyp_string      .equ 3
0005+  08B5             toktyp_char        .equ 4
0006+  08B5             toktyp_numeric     .equ 5
0007+  08B5             toktyp_end         .equ 6
0008+  08B5             
0009+  08B5             tok_null           .equ 0
0010+  08B5             tok_fslash         .equ 1
0011+  08B5             tok_times          .equ 2
0012+  08B5             tok_plus           .equ 3
0013+  08B5             tok_minus          .equ 4
0014+  08B5             tok_dot            .equ 5
0015+  08B5             tok_semi           .equ 6
0016+  08B5             tok_angle          .equ 7
0017+  08B5             tok_tilde          .equ 8
0018+  08B5             tok_equal          .equ 9
0019+  08B5             tok_colon          .equ 10
0020+  08B5             tok_comma          .equ 11
0021+  08B5             
0022+  08B5             tok_end            .equ 20
0023+  08B5             
0024+  08B5             
0025+  08B5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0026+  08B5             ;; read a full command argment from shell input buffer
0027+  08B5             ;; argument is written into tokstr
0028+  08B5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0029+  08B5             get_arg:
0030+  08B5 D7            push a
0031+  08B6 E2            push si
0032+  08B7 E3            push di
0033+  08B8 19 00         mov al, 0
0034+  08BA 3D E3 0A      mov [tokstr], al      ; nullify tokstr string
0035+  08BD 14 DF 0A      mov a, [prog]
0036+  08C0 4D            mov si, a
0037+  08C1 FD 4F E3 0A   mov di, tokstr
0038+  08C5             get_arg_skip_spaces:
0039+  08C5 F6            lodsb
0040+  08C6 07 8E 08      call _isspace
0041+  08C9 C6 C5 08      je get_arg_skip_spaces
0042+  08CC             get_arg_l0:
0043+  08CC B9 3B         cmp al, $3b        ; check if is ';'
0044+  08CE C6 DB 08      je get_arg_end
0045+  08D1 B9 00         cmp al, 0
0046+  08D3 C6 DB 08      je get_arg_end      ; check if end of input
0047+  08D6 F7            stosb
0048+  08D7 F6            lodsb
0049+  08D8 0A CC 08      jmp get_arg_l0
0050+  08DB             get_arg_end:
0051+  08DB 19 00         mov al, 0
0052+  08DD F7            stosb
0053+  08DE D5 01 00      sub si, 1
0054+  08E1 4E            mov a, si
0055+  08E2 42 DF 0A      mov [prog], a    ; update pointer
0056+  08E5 F0            pop di
0057+  08E6 EF            pop si
0058+  08E7 E4            pop a
0059+  08E8 09            ret
0060+  08E9             
0061+  08E9             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0062+  08E9             ;; read a path formation from shell input buffer
0063+  08E9             ;; path is written into tokstr
0064+  08E9             ;; /usr/bin
0065+  08E9             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0066+  08E9             get_path:
0067+  08E9 D7            push a
0068+  08EA E2            push si
0069+  08EB E3            push di
0070+  08EC 19 00         mov al, 0
0071+  08EE 3D E3 0A      mov [tokstr], al      ; nullify tokstr string
0072+  08F1 14 DF 0A      mov a, [prog]
0073+  08F4 4D            mov si, a
0074+  08F5 FD 4F E3 0A   mov di, tokstr
0075+  08F9             get_path_skip_spaces:
0076+  08F9 F6            lodsb
0077+  08FA 07 8E 08      call _isspace
0078+  08FD C6 F9 08      je get_path_skip_spaces
0079+  0900             get_path_is_pathchar:
0080+  0900 F7            stosb
0081+  0901 F6            lodsb
0082+  0902 07 18 08      call _isalnum      ;check if is alphanumeric
0083+  0905 C6 00 09      je get_path_is_pathchar
0084+  0908 B9 2F         cmp al, '/'        ; check if is '/'
0085+  090A C6 00 09      je get_path_is_pathchar
0086+  090D 19 00         mov al, 0
0087+  090F F7            stosb
0088+  0910 D5 01 00      sub si, 1
0089+  0913 4E            mov a, si
0090+  0914 42 DF 0A      mov [prog], a    ; update pointer
0091+  0917             get_path_end:
0092+  0917 F0            pop di
0093+  0918 EF            pop si
0094+  0919 E4            pop a
0095+  091A 09            ret
0096+  091B             
0097+  091B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0098+  091B             ;; read a line
0099+  091B             ;; line is written into tokstr
0100+  091B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0101+  091B             get_line:
0102+  091B D7            push a
0103+  091C E2            push si
0104+  091D E3            push di
0105+  091E 19 00         mov al, 0
0106+  0920 3D E3 0A      mov [tokstr], al      ; nullify tokstr string
0107+  0923 14 DF 0A      mov a, [prog]
0108+  0926 4D            mov si, a
0109+  0927 FD 4F E3 0A   mov di, tokstr
0110+  092B             get_line_l0:
0111+  092B F6            lodsb
0112+  092C B9 0A         cmp al, $0a    ; check for new line
0113+  092E C6 35 09      je get_line_exit
0114+  0931 F7            stosb
0115+  0932 0A 2B 09      jmp get_line_l0
0116+  0935             get_line_exit:
0117+  0935 19 00         mov al, 0
0118+  0937 F7            stosb
0119+  0938 4E            mov a, si
0120+  0939 42 DF 0A      mov [prog], a    ; update pointer
0121+  093C F0            pop di
0122+  093D EF            pop si
0123+  093E E4            pop a
0124+  093F 09            ret
0125+  0940             
0126+  0940             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0127+  0940             ;; token parser
0128+  0940             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0129+  0940             get_token:
0130+  0940 D7            push a
0131+  0941 DA            push d
0132+  0942 E2            push si
0133+  0943 E3            push di
0134+  0944 19 00         mov al, 0
0135+  0946 3D E3 0A      mov [tokstr], al      ; nullify tokstr string
0136+  0949 19 00         mov al, tok_null
0137+  094B 3D E2 0A      mov [tok], al        ; nullify token
0138+  094E 14 DF 0A      mov a, [prog]
0139+  0951 4D            mov si, a
0140+  0952 FD 4F E3 0A   mov di, tokstr
0141+  0956             get_tok_skip_spaces:
0142+  0956 F6            lodsb
0143+  0957 07 8E 08      call _isspace
0144+  095A C6 56 09      je get_tok_skip_spaces
0145+  095D B9 00         cmp al, 0      ; check for end of input (null)
0146+  095F C6 44 0A      je get_token_end
0147+  0962 B9 23         cmp al, '#'      ; comments!
0148+  0964 C6 72 0A      je get_tok_comment
0149+  0967 07 18 08      call _isalnum
0150+  096A C6 51 0A      jz is_alphanumeric
0151+  096D             ; other token types
0152+  096D             get_token_slash:
0153+  096D B9 2F         cmp al, '/'        ; check if '/'
0154+  096F C7 87 09      jne get_token_minus
0155+  0972 F7            stosb          ; store '/' into token string
0156+  0973 19 00         mov al, 0
0157+  0975 F7            stosb          ; terminate token string
0158+  0976 19 01         mov al, tok_fslash
0159+  0978 3D E2 0A      mov [tok], al      
0160+  097B 19 02         mov al, toktyp_delimiter
0161+  097D 3D E1 0A      mov [toktyp], al
0162+  0980 4E            mov a, si
0163+  0981 42 DF 0A      mov [prog], a    ; update pointer
0164+  0984 0A 6D 0A      jmp get_token_return
0165+  0987             get_token_minus:
0166+  0987 B9 2D         cmp al, '-'        ; check if '-'
0167+  0989 C7 A1 09      jne get_token_comma
0168+  098C F7            stosb          ; store '-' into token string
0169+  098D 19 00         mov al, 0
0170+  098F F7            stosb          ; terminate token string
0171+  0990 19 04         mov al, tok_minus
0172+  0992 3D E2 0A      mov [tok], al      
0173+  0995 19 02         mov al, toktyp_delimiter
0174+  0997 3D E1 0A      mov [toktyp], al
0175+  099A 4E            mov a, si
0176+  099B 42 DF 0A      mov [prog], a    ; update pointer
0177+  099E 0A 6D 0A      jmp get_token_return
0178+  09A1             get_token_comma:
0179+  09A1 B9 2C         cmp al, ','        ; check if ','
0180+  09A3 C7 BB 09      jne get_token_semi
0181+  09A6 F7            stosb          ; store ',' into token string
0182+  09A7 19 00         mov al, 0
0183+  09A9 F7            stosb          ; terminate token string
0184+  09AA 19 0B         mov al, tok_comma
0185+  09AC 3D E2 0A      mov [tok], al      
0186+  09AF 19 02         mov al, toktyp_delimiter
0187+  09B1 3D E1 0A      mov [toktyp], al
0188+  09B4 4E            mov a, si
0189+  09B5 42 DF 0A      mov [prog], a    ; update pointer
0190+  09B8 0A 6D 0A      jmp get_token_return
0191+  09BB             get_token_semi:
0192+  09BB B9 3B         cmp al, $3b        ; check if ';'
0193+  09BD C7 D5 09      jne get_token_colon
0194+  09C0 F7            stosb          ; store ';' into token string
0195+  09C1 19 00         mov al, 0
0196+  09C3 F7            stosb          ; terminate token string
0197+  09C4 19 06         mov al, tok_semi
0198+  09C6 3D E2 0A      mov [tok], al      
0199+  09C9 19 02         mov al, toktyp_delimiter
0200+  09CB 3D E1 0A      mov [toktyp], al
0201+  09CE 4E            mov a, si
0202+  09CF 42 DF 0A      mov [prog], a    ; update pointer
0203+  09D2 0A 6D 0A      jmp get_token_return
0204+  09D5             get_token_colon:
0205+  09D5 B9 3A         cmp al, $3a        ; check if ':'
0206+  09D7 C7 EF 09      jne get_token_angle
0207+  09DA F7            stosb          ; store ':' into token string
0208+  09DB 19 00         mov al, 0
0209+  09DD F7            stosb          ; terminate token string
0210+  09DE 19 0A         mov al, tok_colon
0211+  09E0 3D E2 0A      mov [tok], al      
0212+  09E3 19 02         mov al, toktyp_delimiter
0213+  09E5 3D E1 0A      mov [toktyp], al
0214+  09E8 4E            mov a, si
0215+  09E9 42 DF 0A      mov [prog], a    ; update pointer
0216+  09EC 0A 6D 0A      jmp get_token_return
0217+  09EF             get_token_angle:
0218+  09EF B9 3E         cmp al, $3e        ; check if '>'
0219+  09F1 C7 09 0A      jne get_token_tilde
0220+  09F4 F7            stosb          ; store '>' into token string
0221+  09F5 19 00         mov al, 0
0222+  09F7 F7            stosb          ; terminate token string
0223+  09F8 19 07         mov al, tok_angle
0224+  09FA 3D E2 0A      mov [tok], al      
0225+  09FD 19 02         mov al, toktyp_delimiter
0226+  09FF 3D E1 0A      mov [toktyp], al
0227+  0A02 4E            mov a, si
0228+  0A03 42 DF 0A      mov [prog], a    ; update pointer
0229+  0A06 0A 6D 0A      jmp get_token_return
0230+  0A09             get_token_tilde:
0231+  0A09 B9 7E         cmp al, '~'        ; check if '~'
0232+  0A0B C7 23 0A      jne get_token_equal
0233+  0A0E F7            stosb          ; store '~' into token string
0234+  0A0F 19 00         mov al, 0
0235+  0A11 F7            stosb          ; terminate token string
0236+  0A12 19 08         mov al, tok_tilde
0237+  0A14 3D E2 0A      mov [tok], al      
0238+  0A17 19 02         mov al, toktyp_delimiter
0239+  0A19 3D E1 0A      mov [toktyp], al
0240+  0A1C 4E            mov a, si
0241+  0A1D 42 DF 0A      mov [prog], a    ; update pointer
0242+  0A20 0A 6D 0A      jmp get_token_return
0243+  0A23             get_token_equal:
0244+  0A23 B9 3D         cmp al, '='        ; check if '='
0245+  0A25 C7 3D 0A      jne get_token_skip
0246+  0A28 F7            stosb          ; store '=' into token string
0247+  0A29 19 00         mov al, 0
0248+  0A2B F7            stosb          ; terminate token string
0249+  0A2C 19 09         mov al, tok_equal
0250+  0A2E 3D E2 0A      mov [tok], al      
0251+  0A31 19 02         mov al, toktyp_delimiter
0252+  0A33 3D E1 0A      mov [toktyp], al
0253+  0A36 4E            mov a, si
0254+  0A37 42 DF 0A      mov [prog], a    ; update pointer
0255+  0A3A 0A 6D 0A      jmp get_token_return
0256+  0A3D             get_token_skip:
0257+  0A3D 4E            mov a, si
0258+  0A3E 42 DF 0A      mov [prog], a    ; update pointer
0259+  0A41 0A 6D 0A      jmp get_token_return
0260+  0A44             get_token_end:        ; end of file token
0261+  0A44 19 14         mov al, tok_end
0262+  0A46 3D E2 0A      mov [tok], al
0263+  0A49 19 06         mov al, toktyp_end
0264+  0A4B 3D E1 0A      mov [toktyp], al
0265+  0A4E 0A 6D 0A      jmp get_token_return
0266+  0A51             is_alphanumeric:
0267+  0A51 F7            stosb
0268+  0A52 F6            lodsb
0269+  0A53 07 18 08      call _isalnum      ;check if is alphanumeric
0270+  0A56 C6 51 0A      jz is_alphanumeric
0271+  0A59 B9 2E         cmp al, $2e        ; check if is '.'
0272+  0A5B C6 51 0A      je is_alphanumeric
0273+  0A5E 19 00         mov al, 0
0274+  0A60 F7            stosb
0275+  0A61 19 00         mov al, toktyp_identifier
0276+  0A63 3D E1 0A      mov [toktyp], al
0277+  0A66 D5 01 00      sub si, 1
0278+  0A69 4E            mov a, si
0279+  0A6A 42 DF 0A      mov [prog], a    ; update pointer
0280+  0A6D             get_token_return:
0281+  0A6D F0            pop di
0282+  0A6E EF            pop si
0283+  0A6F E7            pop d
0284+  0A70 E4            pop a
0285+  0A71 09            ret
0286+  0A72             get_tok_comment:
0287+  0A72 F6            lodsb
0288+  0A73 B9 0A         cmp al, $0a      ; new line
0289+  0A75 C7 72 0A      jne get_tok_comment
0290+  0A78 0A 56 09      jmp get_tok_skip_spaces
0291+  0A7B             
0292+  0A7B             
0293+  0A7B             get_number:
0294+  0A7B D7            push a
0295+  0A7C DA            push d
0296+  0A7D E2            push si
0297+  0A7E E3            push di
0298+  0A7F 19 00         mov al, 0
0299+  0A81 3D E3 0A      mov [tokstr], al      ; nullify tokstr string
0300+  0A84 19 00         mov al, tok_null
0301+  0A86 3D E2 0A      mov [tok], al        ; nullify token
0302+  0A89 14 DF 0A      mov a, [prog]
0303+  0A8C 4D            mov si, a
0304+  0A8D FD 4F E3 0A   mov di, tokstr
0305+  0A91             get_number_skip_spaces:
0306+  0A91 F6            lodsb
0307+  0A92 07 8E 08      call _isspace
0308+  0A95 C6 91 0A      je get_number_skip_spaces
0309+  0A98 B9 00         cmp al, 0      ; check for end of input (null)
0310+  0A9A C7 AA 0A      jne get_number_l0
0311+  0A9D 19 14         mov al, tok_end
0312+  0A9F 3D E2 0A      mov [tok], al
0313+  0AA2 19 06         mov al, toktyp_end
0314+  0AA4 3D E1 0A      mov [toktyp], al
0315+  0AA7 0A C1 0A      jmp get_number_return
0316+  0AAA             get_number_l0:
0317+  0AAA F7            stosb
0318+  0AAB F6            lodsb
0319+  0AAC 07 22 08      call _isdigit      ;check if is numeric
0320+  0AAF C6 AA 0A      jz get_number_l0
0321+  0AB2 19 00         mov al, 0
0322+  0AB4 F7            stosb
0323+  0AB5 19 05         mov al, toktyp_numeric
0324+  0AB7 3D E1 0A      mov [toktyp], al
0325+  0ABA D5 01 00      sub si, 1
0326+  0ABD 4E            mov a, si
0327+  0ABE 42 DF 0A      mov [prog], a    ; update pointer
0328+  0AC1             get_number_return:
0329+  0AC1 F0            pop di
0330+  0AC2 EF            pop si
0331+  0AC3 E7            pop d
0332+  0AC4 E4            pop a
0333+  0AC5 09            ret
0334+  0AC6             
0335+  0AC6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0336+  0AC6             ;; put back token
0337+  0AC6             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  
0338+  0AC6             _putback:
0339+  0AC6 D7            push a
0340+  0AC7 E2            push si
0341+  0AC8 FD 4D E3 0A   mov si, tokstr  
0342+  0ACC             _putback_loop:
0343+  0ACC F6            lodsb
0344+  0ACD B9 00         cmp al, 0
0345+  0ACF C6 DC 0A      je _putback_end
0346+  0AD2 14 DF 0A      mov a, [prog]
0347+  0AD5 7D            dec a
0348+  0AD6 42 DF 0A      mov [prog], a      ; update pointer
0349+  0AD9 0A CC 0A      jmp _putback_loop
0350+  0ADC             _putback_end:
0351+  0ADC EF            pop si
0352+  0ADD E4            pop a
0353+  0ADE 09            ret
0354+  0ADF             
0355+  0ADF             
0356+  0ADF             
0357+  0ADF             
0358+  0ADF 00 00       prog:      .dw 0          ; pointer to current position in buffer
0359+  0AE1             
0360+  0AE1 00          toktyp:    .db 0          ; token type symbol
0361+  0AE2 00          tok:       .db 0          ; current token symbol
0362+  0AE3 00 00 00 00 tokstr:    .fill 256, 0   ; token as a string
0362+  0AE7 00 00 00 00 
0362+  0AEB 00 00 00 00 
0362+  0AEF 00 00 00 00 
0362+  0AF3 00 00 00 00 
0362+  0AF7 00 00 00 00 
0362+  0AFB 00 00 00 00 
0362+  0AFF 00 00 00 00 
0362+  0B03 00 00 00 00 
0362+  0B07 00 00 00 00 
0362+  0B0B 00 00 00 00 
0362+  0B0F 00 00 00 00 
0362+  0B13 00 00 00 00 
0362+  0B17 00 00 00 00 
0362+  0B1B 00 00 00 00 
0362+  0B1F 00 00 00 00 
0362+  0B23 00 00 00 00 
0362+  0B27 00 00 00 00 
0362+  0B2B 00 00 00 00 
0362+  0B2F 00 00 00 00 
0362+  0B33 00 00 00 00 
0362+  0B37 00 00 00 00 
0362+  0B3B 00 00 00 00 
0362+  0B3F 00 00 00 00 
0362+  0B43 00 00 00 00 
0362+  0B47 00 00 00 00 
0362+  0B4B 00 00 00 00 
0362+  0B4F 00 00 00 00 
0362+  0B53 00 00 00 00 
0362+  0B57 00 00 00 00 
0362+  0B5B 00 00 00 00 
0362+  0B5F 00 00 00 00 
0362+  0B63 00 00 00 00 
0362+  0B67 00 00 00 00 
0362+  0B6B 00 00 00 00 
0362+  0B6F 00 00 00 00 
0362+  0B73 00 00 00 00 
0362+  0B77 00 00 00 00 
0362+  0B7B 00 00 00 00 
0362+  0B7F 00 00 00 00 
0362+  0B83 00 00 00 00 
0362+  0B87 00 00 00 00 
0362+  0B8B 00 00 00 00 
0362+  0B8F 00 00 00 00 
0362+  0B93 00 00 00 00 
0362+  0B97 00 00 00 00 
0362+  0B9B 00 00 00 00 
0362+  0B9F 00 00 00 00 
0362+  0BA3 00 00 00 00 
0362+  0BA7 00 00 00 00 
0362+  0BAB 00 00 00 00 
0362+  0BAF 00 00 00 00 
0362+  0BB3 00 00 00 00 
0362+  0BB7 00 00 00 00 
0362+  0BBB 00 00 00 00 
0362+  0BBF 00 00 00 00 
0362+  0BC3 00 00 00 00 
0362+  0BC7 00 00 00 00 
0362+  0BCB 00 00 00 00 
0362+  0BCF 00 00 00 00 
0362+  0BD3 00 00 00 00 
0362+  0BD7 00 00 00 00 
0362+  0BDB 00 00 00 00 
0362+  0BDF 00 00 00 00 
1057   0BE3             
1058   0BE3             ; kernel parameters
1059   0BE3             sys_uart0_lcr:
1060   0BE3 0F            .db %00001111 ; 8 data bits, 2 stop bits, enable parity, odd parity
1061   0BE4             sys_uart0_inten:
1062   0BE4 01            .db 1
1063   0BE5             sys_uart0_fifoen:
1064   0BE5 00            .db 0
1065   0BE6             sys_uart0_div0:
1066   0BE6 03            .db 3
1067   0BE7             sys_uart0_div1:
1068   0BE7 00            .db 0   ; default baud = 38400
1069   0BE8             ; baud  divisor
1070   0BE8             ; 50    2304
1071   0BE8             ; 110   1047
1072   0BE8             ; 300    384
1073   0BE8             ; 600    192
1074   0BE8             ; 1200    96
1075   0BE8             ; 9600    12
1076   0BE8             ; 19200    6
1077   0BE8             ; 38400    3
1078   0BE8             sys_uart1_lcr:
1079   0BE8 0F            .db %00001111 ; 8 data bits, 2 stop bits, enable parity, odd parity
1080   0BE9             sys_uart1_inten:
1081   0BE9 01            .db 1
1082   0BEA             sys_uart1_fifoen:
1083   0BEA 00            .db 0
1084   0BEB             sys_uart1_div0:
1085   0BEB 03            .db 3
1086   0BEC             sys_uart1_div1:
1087   0BEC 00            .db 0   ; default baud = 38400
1088   0BED             
1089   0BED             fifo_in:
1090   0BED 80 0E         .dw fifo
1091   0BEF             fifo_out:
1092   0BEF 80 0E         .dw fifo
1093   0BF1             
1094   0BF1             ; file system variables
1095   0BF1             current_dir_id:
1096   0BF1 00 00         .dw 0     ; keep dirid of current directory
1097   0BF3             s_init_path:
1098   0BF3 2F 73 62 69   .db "/sbin/init", 0
1098   0BF7 6E 2F 69 6E 
1098   0BFB 69 74 00 
1099   0BFE             
1100   0BFE             s_uname:
1101   0BFE 73 6F 6C 61   .db "solarium v.1.0", 0
1101   0C02 72 69 75 6D 
1101   0C06 20 76 2E 31 
1101   0C0A 2E 30 00 
1102   0C0D             s_dataentry:
1103   0C0D 3E 20 00      .db "> ", 0
1104   0C10             s_parent_dir:
1105   0C10 2E 2E 00      .db "..", 0
1106   0C13             s_current_dir:
1107   0C13 2E 00         .db ".", 0
1108   0C15             s_fslash:
1109   0C15 2F 00         .db "/", 0
1110   0C17             file_attrib:
1111   0C17 2D 72 77 20   .db "-rw x"      ; chars at powers of 2
1111   0C1B 78 
1112   0C1C             file_type:
1113   0C1C 2D 64 63      .db "-dc"
1114   0C1F             s_ps_header:
1115   0C1F 70 69 64 20   .db "pid command\n", 0
1115   0C23 63 6F 6D 6D 
1115   0C27 61 6E 64 0A 
1115   0C2B 00 
1116   0C2C             s_ls_total:
1117   0C2C 74 6F 74 61   .db "total: ", 0
1117   0C30 6C 3A 20 00 
1118   0C34             
1119   0C34             s_int_en:
1120   0C34 69 72 71 73   .db "irqs enabled\n", 0
1120   0C38 20 65 6E 61 
1120   0C3C 62 6C 65 64 
1120   0C40 0A 00 
1121   0C42             s_kernel_welcome:
1122   0C42 2A 2A 2A 2A   .db "************************************************\n"
1122   0C46 2A 2A 2A 2A 
1122   0C4A 2A 2A 2A 2A 
1122   0C4E 2A 2A 2A 2A 
1122   0C52 2A 2A 2A 2A 
1122   0C56 2A 2A 2A 2A 
1122   0C5A 2A 2A 2A 2A 
1122   0C5E 2A 2A 2A 2A 
1122   0C62 2A 2A 2A 2A 
1122   0C66 2A 2A 2A 2A 
1122   0C6A 2A 2A 2A 2A 
1122   0C6E 2A 2A 2A 2A 
1122   0C72 0A 
1123   0C73 2A 2A 2A 20   .db "*** Welcome to Solarium OS - Kernel ver. 1.0 ***\n"
1123   0C77 57 65 6C 63 
1123   0C7B 6F 6D 65 20 
1123   0C7F 74 6F 20 53 
1123   0C83 6F 6C 61 72 
1123   0C87 69 75 6D 20 
1123   0C8B 4F 53 20 2D 
1123   0C8F 20 4B 65 72 
1123   0C93 6E 65 6C 20 
1123   0C97 76 65 72 2E 
1123   0C9B 20 31 2E 30 
1123   0C9F 20 2A 2A 2A 
1123   0CA3 0A 
1124   0CA4 2A 2A 2A 20   .db "*** type help for more information           ***\n"
1124   0CA8 74 79 70 65 
1124   0CAC 20 68 65 6C 
1124   0CB0 70 20 66 6F 
1124   0CB4 72 20 6D 6F 
1124   0CB8 72 65 20 69 
1124   0CBC 6E 66 6F 72 
1124   0CC0 6D 61 74 69 
1124   0CC4 6F 6E 20 20 
1124   0CC8 20 20 20 20 
1124   0CCC 20 20 20 20 
1124   0CD0 20 2A 2A 2A 
1124   0CD4 0A 
1125   0CD5 2A 2A 2A 2A   .db "************************************************\n"
1125   0CD9 2A 2A 2A 2A 
1125   0CDD 2A 2A 2A 2A 
1125   0CE1 2A 2A 2A 2A 
1125   0CE5 2A 2A 2A 2A 
1125   0CE9 2A 2A 2A 2A 
1125   0CED 2A 2A 2A 2A 
1125   0CF1 2A 2A 2A 2A 
1125   0CF5 2A 2A 2A 2A 
1125   0CF9 2A 2A 2A 2A 
1125   0CFD 2A 2A 2A 2A 
1125   0D01 2A 2A 2A 2A 
1125   0D05 0A 
1126   0D06             s_prompt_init:
1127   0D06 73 74 61 72   .db "starting init\n", 0
1127   0D0A 74 69 6E 67 
1127   0D0E 20 69 6E 69 
1127   0D12 74 0A 00 
1128   0D15             s_priviledge:
1129   0D15 0A 65 78 63   .db "\nexception: privilege\n", 0
1129   0D19 65 70 74 69 
1129   0D1D 6F 6E 3A 20 
1129   0D21 70 72 69 76 
1129   0D25 69 6C 65 67 
1129   0D29 65 0A 00 
1130   0D2C             s_divzero:
1131   0D2C 0A 65 78 63   .db "\nexception: zero division\n", 0
1131   0D30 65 70 74 69 
1131   0D34 6F 6E 3A 20 
1131   0D38 7A 65 72 6F 
1131   0D3C 20 64 69 76 
1131   0D40 69 73 69 6F 
1131   0D44 6E 0A 00 
1132   0D47             
1133   0D47             s_break1:  
1134   0D47 0A 64 65 62   .db "\ndebugger entry point.\n"
1134   0D4B 75 67 67 65 
1134   0D4F 72 20 65 6E 
1134   0D53 74 72 79 20 
1134   0D57 70 6F 69 6E 
1134   0D5B 74 2E 0A 
1135   0D5E 30 2E 20 73   .db "0. show registers\n"
1135   0D62 68 6F 77 20 
1135   0D66 72 65 67 69 
1135   0D6A 73 74 65 72 
1135   0D6E 73 0A 
1136   0D70 31 2E 20 73   .db "1. show 512b ram block\n"
1136   0D74 68 6F 77 20 
1136   0D78 35 31 32 62 
1136   0D7C 20 72 61 6D 
1136   0D80 20 62 6C 6F 
1136   0D84 63 6B 0A 
1137   0D87 32 2E 20 63   .db "2. continue execution", 0
1137   0D8B 6F 6E 74 69 
1137   0D8F 6E 75 65 20 
1137   0D93 65 78 65 63 
1137   0D97 75 74 69 6F 
1137   0D9B 6E 00 
1138   0D9D             
1139   0D9D             s_set_year:
1140   0D9D 79 65 61 72   .db "year: ", 0
1140   0DA1 3A 20 00 
1141   0DA4             s_set_month:
1142   0DA4 6D 6F 6E 74   .db "month: ", 0
1142   0DA8 68 3A 20 00 
1143   0DAC             s_set_day:
1144   0DAC 64 61 79 3A   .db "day: ", 0
1144   0DB0 20 00 
1145   0DB2             s_set_week:
1146   0DB2 77 65 65 6B   .db "weekday: ", 0
1146   0DB6 64 61 79 3A 
1146   0DBA 20 00 
1147   0DBC             s_set_hours:
1148   0DBC 68 6F 75 72   .db "hours: ", 0
1148   0DC0 73 3A 20 00 
1149   0DC4             s_set_minutes:
1150   0DC4 6D 69 6E 75   .db "minutes: ", 0
1150   0DC8 74 65 73 3A 
1150   0DCC 20 00 
1151   0DCE             s_set_seconds:
1152   0DCE 73 65 63 6F   .db "seconds: ", 0
1152   0DD2 6E 64 73 3A 
1152   0DD6 20 00 
1153   0DD8             s_months:      
1154   0DD8 20 20 20 00   .db "   ", 0
1155   0DDC 6A 61 6E 00   .db "jan", 0
1156   0DE0 66 65 62 00   .db "feb", 0
1157   0DE4 6D 61 72 00   .db "mar", 0
1158   0DE8 61 70 72 00   .db "apr", 0
1159   0DEC 6D 61 79 00   .db "may", 0
1160   0DF0 6A 75 6E 00   .db "jun", 0
1161   0DF4 6A 75 6C 00   .db "jul", 0
1162   0DF8 61 75 67 00   .db "aug", 0
1163   0DFC 73 65 70 00   .db "sep", 0
1164   0E00 6F 63 74 00   .db "oct", 0
1165   0E04 6E 6F 76 00   .db "nov", 0
1166   0E08 64 65 63 00   .db "dec", 0
1167   0E0C             
1168   0E0C             s_week:        
1169   0E0C 73 75 6E 00   .db "sun", 0 
1170   0E10 6D 6F 6E 00   .db "mon", 0 
1171   0E14 74 75 65 00   .db "tue", 0 
1172   0E18 77 65 64 00   .db "wed", 0 
1173   0E1C 74 68 75 00   .db "thu", 0 
1174   0E20 66 72 69 00   .db "fri", 0 
1175   0E24 73 61 74 00   .db "sat", 0
1176   0E28             
1177   0E28 0A 49 52 51 s_fdc_irq: .db "\nIRQ0 Executed.\n", 0
1177   0E2C 30 20 45 78 
1177   0E30 65 63 75 74 
1177   0E34 65 64 2E 0A 
1177   0E38 00 
1178   0E39             s_fdc_config:
1179   0E39 73 65 6C 65   .db "selecting diskette drive 0, side 0, single density, head loaded\n", 0
1179   0E3D 63 74 69 6E 
1179   0E41 67 20 64 69 
1179   0E45 73 6B 65 74 
1179   0E49 74 65 20 64 
1179   0E4D 72 69 76 65 
1179   0E51 20 30 2C 20 
1179   0E55 73 69 64 65 
1179   0E59 20 30 2C 20 
1179   0E5D 73 69 6E 67 
1179   0E61 6C 65 20 64 
1179   0E65 65 6E 73 69 
1179   0E69 74 79 2C 20 
1179   0E6D 68 65 61 64 
1179   0E71 20 6C 6F 61 
1179   0E75 64 65 64 0A 
1179   0E79 00 
1180   0E7A             
1181   0E7A             ; indices used to navigate the inode table in disk
1182   0E7A 00 00       inode_table_index_0: .dw 0
1183   0E7C 00 00       inode_table_index_1: .dw 0
1184   0E7E 00 00       inode_table_index_2: .dw 0
1185   0E80             
1186   0E80             fifo:
1187   0E80 FF FF FF FF   .fill _fifo_size
1187   0E84 FF FF FF FF 
1187   0E88 FF FF FF FF 
1187   0E8C FF FF FF FF 
1187   0E90 FF FF FF FF 
1187   0E94 FF FF FF FF 
1187   0E98 FF FF FF FF 
1187   0E9C FF FF FF FF 
1187   0EA0 FF FF FF FF 
1187   0EA4 FF FF FF FF 
1187   0EA8 FF FF FF FF 
1187   0EAC FF FF FF FF 
1187   0EB0 FF FF FF FF 
1187   0EB4 FF FF FF FF 
1187   0EB8 FF FF FF FF 
1187   0EBC FF FF FF FF 
1187   0EC0 FF FF FF FF 
1187   0EC4 FF FF FF FF 
1187   0EC8 FF FF FF FF 
1187   0ECC FF FF FF FF 
1187   0ED0 FF FF FF FF 
1187   0ED4 FF FF FF FF 
1187   0ED8 FF FF FF FF 
1187   0EDC FF FF FF FF 
1187   0EE0 FF FF FF FF 
1187   0EE4 FF FF FF FF 
1187   0EE8 FF FF FF FF 
1187   0EEC FF FF FF FF 
1187   0EF0 FF FF FF FF 
1187   0EF4 FF FF FF FF 
1187   0EF8 FF FF FF FF 
1187   0EFC FF FF FF FF 
1187   0F00 FF FF FF FF 
1187   0F04 FF FF FF FF 
1187   0F08 FF FF FF FF 
1187   0F0C FF FF FF FF 
1187   0F10 FF FF FF FF 
1187   0F14 FF FF FF FF 
1187   0F18 FF FF FF FF 
1187   0F1C FF FF FF FF 
1187   0F20 FF FF FF FF 
1187   0F24 FF FF FF FF 
1187   0F28 FF FF FF FF 
1187   0F2C FF FF FF FF 
1187   0F30 FF FF FF FF 
1187   0F34 FF FF FF FF 
1187   0F38 FF FF FF FF 
1187   0F3C FF FF FF FF 
1187   0F40 FF FF FF FF 
1187   0F44 FF FF FF FF 
1187   0F48 FF FF FF FF 
1187   0F4C FF FF FF FF 
1187   0F50 FF FF FF FF 
1187   0F54 FF FF FF FF 
1187   0F58 FF FF FF FF 
1187   0F5C FF FF FF FF 
1187   0F60 FF FF FF FF 
1187   0F64 FF FF FF FF 
1187   0F68 FF FF FF FF 
1187   0F6C FF FF FF FF 
1187   0F70 FF FF FF FF 
1187   0F74 FF FF FF FF 
1187   0F78 FF FF FF FF 
1187   0F7C FF FF FF FF 
1187   0F80 FF FF FF FF 
1187   0F84 FF FF FF FF 
1187   0F88 FF FF FF FF 
1187   0F8C FF FF FF FF 
1187   0F90 FF FF FF FF 
1187   0F94 FF FF FF FF 
1187   0F98 FF FF FF FF 
1187   0F9C FF FF FF FF 
1187   0FA0 FF FF FF FF 
1187   0FA4 FF FF FF FF 
1187   0FA8 FF FF FF FF 
1187   0FAC FF FF FF FF 
1187   0FB0 FF FF FF FF 
1187   0FB4 FF FF FF FF 
1187   0FB8 FF FF FF FF 
1187   0FBC FF FF FF FF 
1187   0FC0 FF FF FF FF 
1187   0FC4 FF FF FF FF 
1187   0FC8 FF FF FF FF 
1187   0FCC FF FF FF FF 
1187   0FD0 FF FF FF FF 
1187   0FD4 FF FF FF FF 
1187   0FD8 FF FF FF FF 
1187   0FDC FF FF FF FF 
1187   0FE0 FF FF FF FF 
1187   0FE4 FF FF FF FF 
1187   0FE8 FF FF FF FF 
1187   0FEC FF FF FF FF 
1187   0FF0 FF FF FF FF 
1187   0FF4 FF FF FF FF 
1187   0FF8 FF FF FF FF 
1187   0FFC FF FF FF FF 
1187   1000 FF FF FF FF 
1187   1004 FF FF FF FF 
1187   1008 FF FF FF FF 
1187   100C FF FF FF FF 
1187   1010 FF FF FF FF 
1187   1014 FF FF FF FF 
1187   1018 FF FF FF FF 
1187   101C FF FF FF FF 
1187   1020 FF FF FF FF 
1187   1024 FF FF FF FF 
1187   1028 FF FF FF FF 
1187   102C FF FF FF FF 
1187   1030 FF FF FF FF 
1187   1034 FF FF FF FF 
1187   1038 FF FF FF FF 
1187   103C FF FF FF FF 
1187   1040 FF FF FF FF 
1187   1044 FF FF FF FF 
1187   1048 FF FF FF FF 
1187   104C FF FF FF FF 
1187   1050 FF FF FF FF 
1187   1054 FF FF FF FF 
1187   1058 FF FF FF FF 
1187   105C FF FF FF FF 
1187   1060 FF FF FF FF 
1187   1064 FF FF FF FF 
1187   1068 FF FF FF FF 
1187   106C FF FF FF FF 
1187   1070 FF FF FF FF 
1187   1074 FF FF FF FF 
1187   1078 FF FF FF FF 
1187   107C FF FF FF FF 
1187   1080 FF FF FF FF 
1187   1084 FF FF FF FF 
1187   1088 FF FF FF FF 
1187   108C FF FF FF FF 
1187   1090 FF FF FF FF 
1187   1094 FF FF FF FF 
1187   1098 FF FF FF FF 
1187   109C FF FF FF FF 
1187   10A0 FF FF FF FF 
1187   10A4 FF FF FF FF 
1187   10A8 FF FF FF FF 
1187   10AC FF FF FF FF 
1187   10B0 FF FF FF FF 
1187   10B4 FF FF FF FF 
1187   10B8 FF FF FF FF 
1187   10BC FF FF FF FF 
1187   10C0 FF FF FF FF 
1187   10C4 FF FF FF FF 
1187   10C8 FF FF FF FF 
1187   10CC FF FF FF FF 
1187   10D0 FF FF FF FF 
1187   10D4 FF FF FF FF 
1187   10D8 FF FF FF FF 
1187   10DC FF FF FF FF 
1187   10E0 FF FF FF FF 
1187   10E4 FF FF FF FF 
1187   10E8 FF FF FF FF 
1187   10EC FF FF FF FF 
1187   10F0 FF FF FF FF 
1187   10F4 FF FF FF FF 
1187   10F8 FF FF FF FF 
1187   10FC FF FF FF FF 
1187   1100 FF FF FF FF 
1187   1104 FF FF FF FF 
1187   1108 FF FF FF FF 
1187   110C FF FF FF FF 
1187   1110 FF FF FF FF 
1187   1114 FF FF FF FF 
1187   1118 FF FF FF FF 
1187   111C FF FF FF FF 
1187   1120 FF FF FF FF 
1187   1124 FF FF FF FF 
1187   1128 FF FF FF FF 
1187   112C FF FF FF FF 
1187   1130 FF FF FF FF 
1187   1134 FF FF FF FF 
1187   1138 FF FF FF FF 
1187   113C FF FF FF FF 
1187   1140 FF FF FF FF 
1187   1144 FF FF FF FF 
1187   1148 FF FF FF FF 
1187   114C FF FF FF FF 
1187   1150 FF FF FF FF 
1187   1154 FF FF FF FF 
1187   1158 FF FF FF FF 
1187   115C FF FF FF FF 
1187   1160 FF FF FF FF 
1187   1164 FF FF FF FF 
1187   1168 FF FF FF FF 
1187   116C FF FF FF FF 
1187   1170 FF FF FF FF 
1187   1174 FF FF FF FF 
1187   1178 FF FF FF FF 
1187   117C FF FF FF FF 
1187   1180 FF FF FF FF 
1187   1184 FF FF FF FF 
1187   1188 FF FF FF FF 
1187   118C FF FF FF FF 
1187   1190 FF FF FF FF 
1187   1194 FF FF FF FF 
1187   1198 FF FF FF FF 
1187   119C FF FF FF FF 
1187   11A0 FF FF FF FF 
1187   11A4 FF FF FF FF 
1187   11A8 FF FF FF FF 
1187   11AC FF FF FF FF 
1187   11B0 FF FF FF FF 
1187   11B4 FF FF FF FF 
1187   11B8 FF FF FF FF 
1187   11BC FF FF FF FF 
1187   11C0 FF FF FF FF 
1187   11C4 FF FF FF FF 
1187   11C8 FF FF FF FF 
1187   11CC FF FF FF FF 
1187   11D0 FF FF FF FF 
1187   11D4 FF FF FF FF 
1187   11D8 FF FF FF FF 
1187   11DC FF FF FF FF 
1187   11E0 FF FF FF FF 
1187   11E4 FF FF FF FF 
1187   11E8 FF FF FF FF 
1187   11EC FF FF FF FF 
1187   11F0 FF FF FF FF 
1187   11F4 FF FF FF FF 
1187   11F8 FF FF FF FF 
1187   11FC FF FF FF FF 
1187   1200 FF FF FF FF 
1187   1204 FF FF FF FF 
1187   1208 FF FF FF FF 
1187   120C FF FF FF FF 
1187   1210 FF FF FF FF 
1187   1214 FF FF FF FF 
1187   1218 FF FF FF FF 
1187   121C FF FF FF FF 
1187   1220 FF FF FF FF 
1187   1224 FF FF FF FF 
1187   1228 FF FF FF FF 
1187   122C FF FF FF FF 
1187   1230 FF FF FF FF 
1187   1234 FF FF FF FF 
1187   1238 FF FF FF FF 
1187   123C FF FF FF FF 
1187   1240 FF FF FF FF 
1187   1244 FF FF FF FF 
1187   1248 FF FF FF FF 
1187   124C FF FF FF FF 
1187   1250 FF FF FF FF 
1187   1254 FF FF FF FF 
1187   1258 FF FF FF FF 
1187   125C FF FF FF FF 
1187   1260 FF FF FF FF 
1187   1264 FF FF FF FF 
1187   1268 FF FF FF FF 
1187   126C FF FF FF FF 
1187   1270 FF FF FF FF 
1187   1274 FF FF FF FF 
1187   1278 FF FF FF FF 
1187   127C FF FF FF FF 
1187   1280 FF FF FF FF 
1187   1284 FF FF FF FF 
1187   1288 FF FF FF FF 
1187   128C FF FF FF FF 
1187   1290 FF FF FF FF 
1187   1294 FF FF FF FF 
1187   1298 FF FF FF FF 
1187   129C FF FF FF FF 
1187   12A0 FF FF FF FF 
1187   12A4 FF FF FF FF 
1187   12A8 FF FF FF FF 
1187   12AC FF FF FF FF 
1187   12B0 FF FF FF FF 
1187   12B4 FF FF FF FF 
1187   12B8 FF FF FF FF 
1187   12BC FF FF FF FF 
1187   12C0 FF FF FF FF 
1187   12C4 FF FF FF FF 
1187   12C8 FF FF FF FF 
1187   12CC FF FF FF FF 
1187   12D0 FF FF FF FF 
1187   12D4 FF FF FF FF 
1187   12D8 FF FF FF FF 
1187   12DC FF FF FF FF 
1187   12E0 FF FF FF FF 
1187   12E4 FF FF FF FF 
1187   12E8 FF FF FF FF 
1187   12EC FF FF FF FF 
1187   12F0 FF FF FF FF 
1187   12F4 FF FF FF FF 
1187   12F8 FF FF FF FF 
1187   12FC FF FF FF FF 
1187   1300 FF FF FF FF 
1187   1304 FF FF FF FF 
1187   1308 FF FF FF FF 
1187   130C FF FF FF FF 
1187   1310 FF FF FF FF 
1187   1314 FF FF FF FF 
1187   1318 FF FF FF FF 
1187   131C FF FF FF FF 
1187   1320 FF FF FF FF 
1187   1324 FF FF FF FF 
1187   1328 FF FF FF FF 
1187   132C FF FF FF FF 
1187   1330 FF FF FF FF 
1187   1334 FF FF FF FF 
1187   1338 FF FF FF FF 
1187   133C FF FF FF FF 
1187   1340 FF FF FF FF 
1187   1344 FF FF FF FF 
1187   1348 FF FF FF FF 
1187   134C FF FF FF FF 
1187   1350 FF FF FF FF 
1187   1354 FF FF FF FF 
1187   1358 FF FF FF FF 
1187   135C FF FF FF FF 
1187   1360 FF FF FF FF 
1187   1364 FF FF FF FF 
1187   1368 FF FF FF FF 
1187   136C FF FF FF FF 
1187   1370 FF FF FF FF 
1187   1374 FF FF FF FF 
1187   1378 FF FF FF FF 
1187   137C FF FF FF FF 
1187   1380 FF FF FF FF 
1187   1384 FF FF FF FF 
1187   1388 FF FF FF FF 
1187   138C FF FF FF FF 
1187   1390 FF FF FF FF 
1187   1394 FF FF FF FF 
1187   1398 FF FF FF FF 
1187   139C FF FF FF FF 
1187   13A0 FF FF FF FF 
1187   13A4 FF FF FF FF 
1187   13A8 FF FF FF FF 
1187   13AC FF FF FF FF 
1187   13B0 FF FF FF FF 
1187   13B4 FF FF FF FF 
1187   13B8 FF FF FF FF 
1187   13BC FF FF FF FF 
1187   13C0 FF FF FF FF 
1187   13C4 FF FF FF FF 
1187   13C8 FF FF FF FF 
1187   13CC FF FF FF FF 
1187   13D0 FF FF FF FF 
1187   13D4 FF FF FF FF 
1187   13D8 FF FF FF FF 
1187   13DC FF FF FF FF 
1187   13E0 FF FF FF FF 
1187   13E4 FF FF FF FF 
1187   13E8 FF FF FF FF 
1187   13EC FF FF FF FF 
1187   13F0 FF FF FF FF 
1187   13F4 FF FF FF FF 
1187   13F8 FF FF FF FF 
1187   13FC FF FF FF FF 
1187   1400 FF FF FF FF 
1187   1404 FF FF FF FF 
1187   1408 FF FF FF FF 
1187   140C FF FF FF FF 
1187   1410 FF FF FF FF 
1187   1414 FF FF FF FF 
1187   1418 FF FF FF FF 
1187   141C FF FF FF FF 
1187   1420 FF FF FF FF 
1187   1424 FF FF FF FF 
1187   1428 FF FF FF FF 
1187   142C FF FF FF FF 
1187   1430 FF FF FF FF 
1187   1434 FF FF FF FF 
1187   1438 FF FF FF FF 
1187   143C FF FF FF FF 
1187   1440 FF FF FF FF 
1187   1444 FF FF FF FF 
1187   1448 FF FF FF FF 
1187   144C FF FF FF FF 
1187   1450 FF FF FF FF 
1187   1454 FF FF FF FF 
1187   1458 FF FF FF FF 
1187   145C FF FF FF FF 
1187   1460 FF FF FF FF 
1187   1464 FF FF FF FF 
1187   1468 FF FF FF FF 
1187   146C FF FF FF FF 
1187   1470 FF FF FF FF 
1187   1474 FF FF FF FF 
1187   1478 FF FF FF FF 
1187   147C FF FF FF FF 
1187   1480 FF FF FF FF 
1187   1484 FF FF FF FF 
1187   1488 FF FF FF FF 
1187   148C FF FF FF FF 
1187   1490 FF FF FF FF 
1187   1494 FF FF FF FF 
1187   1498 FF FF FF FF 
1187   149C FF FF FF FF 
1187   14A0 FF FF FF FF 
1187   14A4 FF FF FF FF 
1187   14A8 FF FF FF FF 
1187   14AC FF FF FF FF 
1187   14B0 FF FF FF FF 
1187   14B4 FF FF FF FF 
1187   14B8 FF FF FF FF 
1187   14BC FF FF FF FF 
1187   14C0 FF FF FF FF 
1187   14C4 FF FF FF FF 
1187   14C8 FF FF FF FF 
1187   14CC FF FF FF FF 
1187   14D0 FF FF FF FF 
1187   14D4 FF FF FF FF 
1187   14D8 FF FF FF FF 
1187   14DC FF FF FF FF 
1187   14E0 FF FF FF FF 
1187   14E4 FF FF FF FF 
1187   14E8 FF FF FF FF 
1187   14EC FF FF FF FF 
1187   14F0 FF FF FF FF 
1187   14F4 FF FF FF FF 
1187   14F8 FF FF FF FF 
1187   14FC FF FF FF FF 
1187   1500 FF FF FF FF 
1187   1504 FF FF FF FF 
1187   1508 FF FF FF FF 
1187   150C FF FF FF FF 
1187   1510 FF FF FF FF 
1187   1514 FF FF FF FF 
1187   1518 FF FF FF FF 
1187   151C FF FF FF FF 
1187   1520 FF FF FF FF 
1187   1524 FF FF FF FF 
1187   1528 FF FF FF FF 
1187   152C FF FF FF FF 
1187   1530 FF FF FF FF 
1187   1534 FF FF FF FF 
1187   1538 FF FF FF FF 
1187   153C FF FF FF FF 
1187   1540 FF FF FF FF 
1187   1544 FF FF FF FF 
1187   1548 FF FF FF FF 
1187   154C FF FF FF FF 
1187   1550 FF FF FF FF 
1187   1554 FF FF FF FF 
1187   1558 FF FF FF FF 
1187   155C FF FF FF FF 
1187   1560 FF FF FF FF 
1187   1564 FF FF FF FF 
1187   1568 FF FF FF FF 
1187   156C FF FF FF FF 
1187   1570 FF FF FF FF 
1187   1574 FF FF FF FF 
1187   1578 FF FF FF FF 
1187   157C FF FF FF FF 
1187   1580 FF FF FF FF 
1187   1584 FF FF FF FF 
1187   1588 FF FF FF FF 
1187   158C FF FF FF FF 
1187   1590 FF FF FF FF 
1187   1594 FF FF FF FF 
1187   1598 FF FF FF FF 
1187   159C FF FF FF FF 
1187   15A0 FF FF FF FF 
1187   15A4 FF FF FF FF 
1187   15A8 FF FF FF FF 
1187   15AC FF FF FF FF 
1187   15B0 FF FF FF FF 
1187   15B4 FF FF FF FF 
1187   15B8 FF FF FF FF 
1187   15BC FF FF FF FF 
1187   15C0 FF FF FF FF 
1187   15C4 FF FF FF FF 
1187   15C8 FF FF FF FF 
1187   15CC FF FF FF FF 
1187   15D0 FF FF FF FF 
1187   15D4 FF FF FF FF 
1187   15D8 FF FF FF FF 
1187   15DC FF FF FF FF 
1187   15E0 FF FF FF FF 
1187   15E4 FF FF FF FF 
1187   15E8 FF FF FF FF 
1187   15EC FF FF FF FF 
1187   15F0 FF FF FF FF 
1187   15F4 FF FF FF FF 
1187   15F8 FF FF FF FF 
1187   15FC FF FF FF FF 
1187   1600 FF FF FF FF 
1187   1604 FF FF FF FF 
1187   1608 FF FF FF FF 
1187   160C FF FF FF FF 
1187   1610 FF FF FF FF 
1187   1614 FF FF FF FF 
1187   1618 FF FF FF FF 
1187   161C FF FF FF FF 
1187   1620 FF FF FF FF 
1187   1624 FF FF FF FF 
1187   1628 FF FF FF FF 
1187   162C FF FF FF FF 
1187   1630 FF FF FF FF 
1187   1634 FF FF FF FF 
1187   1638 FF FF FF FF 
1187   163C FF FF FF FF 
1187   1640 FF FF FF FF 
1187   1644 FF FF FF FF 
1187   1648 FF FF FF FF 
1187   164C FF FF FF FF 
1187   1650 FF FF FF FF 
1187   1654 FF FF FF FF 
1187   1658 FF FF FF FF 
1187   165C FF FF FF FF 
1187   1660 FF FF FF FF 
1187   1664 FF FF FF FF 
1187   1668 FF FF FF FF 
1187   166C FF FF FF FF 
1187   1670 FF FF FF FF 
1187   1674 FF FF FF FF 
1187   1678 FF FF FF FF 
1187   167C FF FF FF FF 
1187   1680 FF FF FF FF 
1187   1684 FF FF FF FF 
1187   1688 FF FF FF FF 
1187   168C FF FF FF FF 
1187   1690 FF FF FF FF 
1187   1694 FF FF FF FF 
1187   1698 FF FF FF FF 
1187   169C FF FF FF FF 
1187   16A0 FF FF FF FF 
1187   16A4 FF FF FF FF 
1187   16A8 FF FF FF FF 
1187   16AC FF FF FF FF 
1187   16B0 FF FF FF FF 
1187   16B4 FF FF FF FF 
1187   16B8 FF FF FF FF 
1187   16BC FF FF FF FF 
1187   16C0 FF FF FF FF 
1187   16C4 FF FF FF FF 
1187   16C8 FF FF FF FF 
1187   16CC FF FF FF FF 
1187   16D0 FF FF FF FF 
1187   16D4 FF FF FF FF 
1187   16D8 FF FF FF FF 
1187   16DC FF FF FF FF 
1187   16E0 FF FF FF FF 
1187   16E4 FF FF FF FF 
1187   16E8 FF FF FF FF 
1187   16EC FF FF FF FF 
1187   16F0 FF FF FF FF 
1187   16F4 FF FF FF FF 
1187   16F8 FF FF FF FF 
1187   16FC FF FF FF FF 
1187   1700 FF FF FF FF 
1187   1704 FF FF FF FF 
1187   1708 FF FF FF FF 
1187   170C FF FF FF FF 
1187   1710 FF FF FF FF 
1187   1714 FF FF FF FF 
1187   1718 FF FF FF FF 
1187   171C FF FF FF FF 
1187   1720 FF FF FF FF 
1187   1724 FF FF FF FF 
1187   1728 FF FF FF FF 
1187   172C FF FF FF FF 
1187   1730 FF FF FF FF 
1187   1734 FF FF FF FF 
1187   1738 FF FF FF FF 
1187   173C FF FF FF FF 
1187   1740 FF FF FF FF 
1187   1744 FF FF FF FF 
1187   1748 FF FF FF FF 
1187   174C FF FF FF FF 
1187   1750 FF FF FF FF 
1187   1754 FF FF FF FF 
1187   1758 FF FF FF FF 
1187   175C FF FF FF FF 
1187   1760 FF FF FF FF 
1187   1764 FF FF FF FF 
1187   1768 FF FF FF FF 
1187   176C FF FF FF FF 
1187   1770 FF FF FF FF 
1187   1774 FF FF FF FF 
1187   1778 FF FF FF FF 
1187   177C FF FF FF FF 
1187   1780 FF FF FF FF 
1187   1784 FF FF FF FF 
1187   1788 FF FF FF FF 
1187   178C FF FF FF FF 
1187   1790 FF FF FF FF 
1187   1794 FF FF FF FF 
1187   1798 FF FF FF FF 
1187   179C FF FF FF FF 
1187   17A0 FF FF FF FF 
1187   17A4 FF FF FF FF 
1187   17A8 FF FF FF FF 
1187   17AC FF FF FF FF 
1187   17B0 FF FF FF FF 
1187   17B4 FF FF FF FF 
1187   17B8 FF FF FF FF 
1187   17BC FF FF FF FF 
1187   17C0 FF FF FF FF 
1187   17C4 FF FF FF FF 
1187   17C8 FF FF FF FF 
1187   17CC FF FF FF FF 
1187   17D0 FF FF FF FF 
1187   17D4 FF FF FF FF 
1187   17D8 FF FF FF FF 
1187   17DC FF FF FF FF 
1187   17E0 FF FF FF FF 
1187   17E4 FF FF FF FF 
1187   17E8 FF FF FF FF 
1187   17EC FF FF FF FF 
1187   17F0 FF FF FF FF 
1187   17F4 FF FF FF FF 
1187   17F8 FF FF FF FF 
1187   17FC FF FF FF FF 
1187   1800 FF FF FF FF 
1187   1804 FF FF FF FF 
1187   1808 FF FF FF FF 
1187   180C FF FF FF FF 
1187   1810 FF FF FF FF 
1187   1814 FF FF FF FF 
1187   1818 FF FF FF FF 
1187   181C FF FF FF FF 
1187   1820 FF FF FF FF 
1187   1824 FF FF FF FF 
1187   1828 FF FF FF FF 
1187   182C FF FF FF FF 
1187   1830 FF FF FF FF 
1187   1834 FF FF FF FF 
1187   1838 FF FF FF FF 
1187   183C FF FF FF FF 
1187   1840 FF FF FF FF 
1187   1844 FF FF FF FF 
1187   1848 FF FF FF FF 
1187   184C FF FF FF FF 
1187   1850 FF FF FF FF 
1187   1854 FF FF FF FF 
1187   1858 FF FF FF FF 
1187   185C FF FF FF FF 
1187   1860 FF FF FF FF 
1187   1864 FF FF FF FF 
1187   1868 FF FF FF FF 
1187   186C FF FF FF FF 
1187   1870 FF FF FF FF 
1187   1874 FF FF FF FF 
1187   1878 FF FF FF FF 
1187   187C FF FF FF FF 
1187   1880 FF FF FF FF 
1187   1884 FF FF FF FF 
1187   1888 FF FF FF FF 
1187   188C FF FF FF FF 
1187   1890 FF FF FF FF 
1187   1894 FF FF FF FF 
1187   1898 FF FF FF FF 
1187   189C FF FF FF FF 
1187   18A0 FF FF FF FF 
1187   18A4 FF FF FF FF 
1187   18A8 FF FF FF FF 
1187   18AC FF FF FF FF 
1187   18B0 FF FF FF FF 
1187   18B4 FF FF FF FF 
1187   18B8 FF FF FF FF 
1187   18BC FF FF FF FF 
1187   18C0 FF FF FF FF 
1187   18C4 FF FF FF FF 
1187   18C8 FF FF FF FF 
1187   18CC FF FF FF FF 
1187   18D0 FF FF FF FF 
1187   18D4 FF FF FF FF 
1187   18D8 FF FF FF FF 
1187   18DC FF FF FF FF 
1187   18E0 FF FF FF FF 
1187   18E4 FF FF FF FF 
1187   18E8 FF FF FF FF 
1187   18EC FF FF FF FF 
1187   18F0 FF FF FF FF 
1187   18F4 FF FF FF FF 
1187   18F8 FF FF FF FF 
1187   18FC FF FF FF FF 
1187   1900 FF FF FF FF 
1187   1904 FF FF FF FF 
1187   1908 FF FF FF FF 
1187   190C FF FF FF FF 
1187   1910 FF FF FF FF 
1187   1914 FF FF FF FF 
1187   1918 FF FF FF FF 
1187   191C FF FF FF FF 
1187   1920 FF FF FF FF 
1187   1924 FF FF FF FF 
1187   1928 FF FF FF FF 
1187   192C FF FF FF FF 
1187   1930 FF FF FF FF 
1187   1934 FF FF FF FF 
1187   1938 FF FF FF FF 
1187   193C FF FF FF FF 
1187   1940 FF FF FF FF 
1187   1944 FF FF FF FF 
1187   1948 FF FF FF FF 
1187   194C FF FF FF FF 
1187   1950 FF FF FF FF 
1187   1954 FF FF FF FF 
1187   1958 FF FF FF FF 
1187   195C FF FF FF FF 
1187   1960 FF FF FF FF 
1187   1964 FF FF FF FF 
1187   1968 FF FF FF FF 
1187   196C FF FF FF FF 
1187   1970 FF FF FF FF 
1187   1974 FF FF FF FF 
1187   1978 FF FF FF FF 
1187   197C FF FF FF FF 
1187   1980 FF FF FF FF 
1187   1984 FF FF FF FF 
1187   1988 FF FF FF FF 
1187   198C FF FF FF FF 
1187   1990 FF FF FF FF 
1187   1994 FF FF FF FF 
1187   1998 FF FF FF FF 
1187   199C FF FF FF FF 
1187   19A0 FF FF FF FF 
1187   19A4 FF FF FF FF 
1187   19A8 FF FF FF FF 
1187   19AC FF FF FF FF 
1187   19B0 FF FF FF FF 
1187   19B4 FF FF FF FF 
1187   19B8 FF FF FF FF 
1187   19BC FF FF FF FF 
1187   19C0 FF FF FF FF 
1187   19C4 FF FF FF FF 
1187   19C8 FF FF FF FF 
1187   19CC FF FF FF FF 
1187   19D0 FF FF FF FF 
1187   19D4 FF FF FF FF 
1187   19D8 FF FF FF FF 
1187   19DC FF FF FF FF 
1187   19E0 FF FF FF FF 
1187   19E4 FF FF FF FF 
1187   19E8 FF FF FF FF 
1187   19EC FF FF FF FF 
1187   19F0 FF FF FF FF 
1187   19F4 FF FF FF FF 
1187   19F8 FF FF FF FF 
1187   19FC FF FF FF FF 
1187   1A00 FF FF FF FF 
1187   1A04 FF FF FF FF 
1187   1A08 FF FF FF FF 
1187   1A0C FF FF FF FF 
1187   1A10 FF FF FF FF 
1187   1A14 FF FF FF FF 
1187   1A18 FF FF FF FF 
1187   1A1C FF FF FF FF 
1187   1A20 FF FF FF FF 
1187   1A24 FF FF FF FF 
1187   1A28 FF FF FF FF 
1187   1A2C FF FF FF FF 
1187   1A30 FF FF FF FF 
1187   1A34 FF FF FF FF 
1187   1A38 FF FF FF FF 
1187   1A3C FF FF FF FF 
1187   1A40 FF FF FF FF 
1187   1A44 FF FF FF FF 
1187   1A48 FF FF FF FF 
1187   1A4C FF FF FF FF 
1187   1A50 FF FF FF FF 
1187   1A54 FF FF FF FF 
1187   1A58 FF FF FF FF 
1187   1A5C FF FF FF FF 
1187   1A60 FF FF FF FF 
1187   1A64 FF FF FF FF 
1187   1A68 FF FF FF FF 
1187   1A6C FF FF FF FF 
1187   1A70 FF FF FF FF 
1187   1A74 FF FF FF FF 
1187   1A78 FF FF FF FF 
1187   1A7C FF FF FF FF 
1187   1A80 FF FF FF FF 
1187   1A84 FF FF FF FF 
1187   1A88 FF FF FF FF 
1187   1A8C FF FF FF FF 
1187   1A90 FF FF FF FF 
1187   1A94 FF FF FF FF 
1187   1A98 FF FF FF FF 
1187   1A9C FF FF FF FF 
1187   1AA0 FF FF FF FF 
1187   1AA4 FF FF FF FF 
1187   1AA8 FF FF FF FF 
1187   1AAC FF FF FF FF 
1187   1AB0 FF FF FF FF 
1187   1AB4 FF FF FF FF 
1187   1AB8 FF FF FF FF 
1187   1ABC FF FF FF FF 
1187   1AC0 FF FF FF FF 
1187   1AC4 FF FF FF FF 
1187   1AC8 FF FF FF FF 
1187   1ACC FF FF FF FF 
1187   1AD0 FF FF FF FF 
1187   1AD4 FF FF FF FF 
1187   1AD8 FF FF FF FF 
1187   1ADC FF FF FF FF 
1187   1AE0 FF FF FF FF 
1187   1AE4 FF FF FF FF 
1187   1AE8 FF FF FF FF 
1187   1AEC FF FF FF FF 
1187   1AF0 FF FF FF FF 
1187   1AF4 FF FF FF FF 
1187   1AF8 FF FF FF FF 
1187   1AFC FF FF FF FF 
1187   1B00 FF FF FF FF 
1187   1B04 FF FF FF FF 
1187   1B08 FF FF FF FF 
1187   1B0C FF FF FF FF 
1187   1B10 FF FF FF FF 
1187   1B14 FF FF FF FF 
1187   1B18 FF FF FF FF 
1187   1B1C FF FF FF FF 
1187   1B20 FF FF FF FF 
1187   1B24 FF FF FF FF 
1187   1B28 FF FF FF FF 
1187   1B2C FF FF FF FF 
1187   1B30 FF FF FF FF 
1187   1B34 FF FF FF FF 
1187   1B38 FF FF FF FF 
1187   1B3C FF FF FF FF 
1187   1B40 FF FF FF FF 
1187   1B44 FF FF FF FF 
1187   1B48 FF FF FF FF 
1187   1B4C FF FF FF FF 
1187   1B50 FF FF FF FF 
1187   1B54 FF FF FF FF 
1187   1B58 FF FF FF FF 
1187   1B5C FF FF FF FF 
1187   1B60 FF FF FF FF 
1187   1B64 FF FF FF FF 
1187   1B68 FF FF FF FF 
1187   1B6C FF FF FF FF 
1187   1B70 FF FF FF FF 
1187   1B74 FF FF FF FF 
1187   1B78 FF FF FF FF 
1187   1B7C FF FF FF FF 
1187   1B80 FF FF FF FF 
1187   1B84 FF FF FF FF 
1187   1B88 FF FF FF FF 
1187   1B8C FF FF FF FF 
1187   1B90 FF FF FF FF 
1187   1B94 FF FF FF FF 
1187   1B98 FF FF FF FF 
1187   1B9C FF FF FF FF 
1187   1BA0 FF FF FF FF 
1187   1BA4 FF FF FF FF 
1187   1BA8 FF FF FF FF 
1187   1BAC FF FF FF FF 
1187   1BB0 FF FF FF FF 
1187   1BB4 FF FF FF FF 
1187   1BB8 FF FF FF FF 
1187   1BBC FF FF FF FF 
1187   1BC0 FF FF FF FF 
1187   1BC4 FF FF FF FF 
1187   1BC8 FF FF FF FF 
1187   1BCC FF FF FF FF 
1187   1BD0 FF FF FF FF 
1187   1BD4 FF FF FF FF 
1187   1BD8 FF FF FF FF 
1187   1BDC FF FF FF FF 
1187   1BE0 FF FF FF FF 
1187   1BE4 FF FF FF FF 
1187   1BE8 FF FF FF FF 
1187   1BEC FF FF FF FF 
1187   1BF0 FF FF FF FF 
1187   1BF4 FF FF FF FF 
1187   1BF8 FF FF FF FF 
1187   1BFC FF FF FF FF 
1187   1C00 FF FF FF FF 
1187   1C04 FF FF FF FF 
1187   1C08 FF FF FF FF 
1187   1C0C FF FF FF FF 
1187   1C10 FF FF FF FF 
1187   1C14 FF FF FF FF 
1187   1C18 FF FF FF FF 
1187   1C1C FF FF FF FF 
1187   1C20 FF FF FF FF 
1187   1C24 FF FF FF FF 
1187   1C28 FF FF FF FF 
1187   1C2C FF FF FF FF 
1187   1C30 FF FF FF FF 
1187   1C34 FF FF FF FF 
1187   1C38 FF FF FF FF 
1187   1C3C FF FF FF FF 
1187   1C40 FF FF FF FF 
1187   1C44 FF FF FF FF 
1187   1C48 FF FF FF FF 
1187   1C4C FF FF FF FF 
1187   1C50 FF FF FF FF 
1187   1C54 FF FF FF FF 
1187   1C58 FF FF FF FF 
1187   1C5C FF FF FF FF 
1187   1C60 FF FF FF FF 
1187   1C64 FF FF FF FF 
1187   1C68 FF FF FF FF 
1187   1C6C FF FF FF FF 
1187   1C70 FF FF FF FF 
1187   1C74 FF FF FF FF 
1187   1C78 FF FF FF FF 
1187   1C7C FF FF FF FF 
1187   1C80 FF FF FF FF 
1187   1C84 FF FF FF FF 
1187   1C88 FF FF FF FF 
1187   1C8C FF FF FF FF 
1187   1C90 FF FF FF FF 
1187   1C94 FF FF FF FF 
1187   1C98 FF FF FF FF 
1187   1C9C FF FF FF FF 
1187   1CA0 FF FF FF FF 
1187   1CA4 FF FF FF FF 
1187   1CA8 FF FF FF FF 
1187   1CAC FF FF FF FF 
1187   1CB0 FF FF FF FF 
1187   1CB4 FF FF FF FF 
1187   1CB8 FF FF FF FF 
1187   1CBC FF FF FF FF 
1187   1CC0 FF FF FF FF 
1187   1CC4 FF FF FF FF 
1187   1CC8 FF FF FF FF 
1187   1CCC FF FF FF FF 
1187   1CD0 FF FF FF FF 
1187   1CD4 FF FF FF FF 
1187   1CD8 FF FF FF FF 
1187   1CDC FF FF FF FF 
1187   1CE0 FF FF FF FF 
1187   1CE4 FF FF FF FF 
1187   1CE8 FF FF FF FF 
1187   1CEC FF FF FF FF 
1187   1CF0 FF FF FF FF 
1187   1CF4 FF FF FF FF 
1187   1CF8 FF FF FF FF 
1187   1CFC FF FF FF FF 
1187   1D00 FF FF FF FF 
1187   1D04 FF FF FF FF 
1187   1D08 FF FF FF FF 
1187   1D0C FF FF FF FF 
1187   1D10 FF FF FF FF 
1187   1D14 FF FF FF FF 
1187   1D18 FF FF FF FF 
1187   1D1C FF FF FF FF 
1187   1D20 FF FF FF FF 
1187   1D24 FF FF FF FF 
1187   1D28 FF FF FF FF 
1187   1D2C FF FF FF FF 
1187   1D30 FF FF FF FF 
1187   1D34 FF FF FF FF 
1187   1D38 FF FF FF FF 
1187   1D3C FF FF FF FF 
1187   1D40 FF FF FF FF 
1187   1D44 FF FF FF FF 
1187   1D48 FF FF FF FF 
1187   1D4C FF FF FF FF 
1187   1D50 FF FF FF FF 
1187   1D54 FF FF FF FF 
1187   1D58 FF FF FF FF 
1187   1D5C FF FF FF FF 
1187   1D60 FF FF FF FF 
1187   1D64 FF FF FF FF 
1187   1D68 FF FF FF FF 
1187   1D6C FF FF FF FF 
1187   1D70 FF FF FF FF 
1187   1D74 FF FF FF FF 
1187   1D78 FF FF FF FF 
1187   1D7C FF FF FF FF 
1187   1D80 FF FF FF FF 
1187   1D84 FF FF FF FF 
1187   1D88 FF FF FF FF 
1187   1D8C FF FF FF FF 
1187   1D90 FF FF FF FF 
1187   1D94 FF FF FF FF 
1187   1D98 FF FF FF FF 
1187   1D9C FF FF FF FF 
1187   1DA0 FF FF FF FF 
1187   1DA4 FF FF FF FF 
1187   1DA8 FF FF FF FF 
1187   1DAC FF FF FF FF 
1187   1DB0 FF FF FF FF 
1187   1DB4 FF FF FF FF 
1187   1DB8 FF FF FF FF 
1187   1DBC FF FF FF FF 
1187   1DC0 FF FF FF FF 
1187   1DC4 FF FF FF FF 
1187   1DC8 FF FF FF FF 
1187   1DCC FF FF FF FF 
1187   1DD0 FF FF FF FF 
1187   1DD4 FF FF FF FF 
1187   1DD8 FF FF FF FF 
1187   1DDC FF FF FF FF 
1187   1DE0 FF FF FF FF 
1187   1DE4 FF FF FF FF 
1187   1DE8 FF FF FF FF 
1187   1DEC FF FF FF FF 
1187   1DF0 FF FF FF FF 
1187   1DF4 FF FF FF FF 
1187   1DF8 FF FF FF FF 
1187   1DFC FF FF FF FF 
1187   1E00 FF FF FF FF 
1187   1E04 FF FF FF FF 
1187   1E08 FF FF FF FF 
1187   1E0C FF FF FF FF 
1187   1E10 FF FF FF FF 
1187   1E14 FF FF FF FF 
1187   1E18 FF FF FF FF 
1187   1E1C FF FF FF FF 
1187   1E20 FF FF FF FF 
1187   1E24 FF FF FF FF 
1187   1E28 FF FF FF FF 
1187   1E2C FF FF FF FF 
1187   1E30 FF FF FF FF 
1187   1E34 FF FF FF FF 
1187   1E38 FF FF FF FF 
1187   1E3C FF FF FF FF 
1187   1E40 FF FF FF FF 
1187   1E44 FF FF FF FF 
1187   1E48 FF FF FF FF 
1187   1E4C FF FF FF FF 
1187   1E50 FF FF FF FF 
1187   1E54 FF FF FF FF 
1187   1E58 FF FF FF FF 
1187   1E5C FF FF FF FF 
1187   1E60 FF FF FF FF 
1187   1E64 FF FF FF FF 
1187   1E68 FF FF FF FF 
1187   1E6C FF FF FF FF 
1187   1E70 FF FF FF FF 
1187   1E74 FF FF FF FF 
1187   1E78 FF FF FF FF 
1187   1E7C FF FF FF FF 
1188   1E80             
1189   1E80             scrap_sector:
1190   1E80 FF FF FF FF   .fill 512         ; scrap sector
1190   1E84 FF FF FF FF 
1190   1E88 FF FF FF FF 
1190   1E8C FF FF FF FF 
1190   1E90 FF FF FF FF 
1190   1E94 FF FF FF FF 
1190   1E98 FF FF FF FF 
1190   1E9C FF FF FF FF 
1190   1EA0 FF FF FF FF 
1190   1EA4 FF FF FF FF 
1190   1EA8 FF FF FF FF 
1190   1EAC FF FF FF FF 
1190   1EB0 FF FF FF FF 
1190   1EB4 FF FF FF FF 
1190   1EB8 FF FF FF FF 
1190   1EBC FF FF FF FF 
1190   1EC0 FF FF FF FF 
1190   1EC4 FF FF FF FF 
1190   1EC8 FF FF FF FF 
1190   1ECC FF FF FF FF 
1190   1ED0 FF FF FF FF 
1190   1ED4 FF FF FF FF 
1190   1ED8 FF FF FF FF 
1190   1EDC FF FF FF FF 
1190   1EE0 FF FF FF FF 
1190   1EE4 FF FF FF FF 
1190   1EE8 FF FF FF FF 
1190   1EEC FF FF FF FF 
1190   1EF0 FF FF FF FF 
1190   1EF4 FF FF FF FF 
1190   1EF8 FF FF FF FF 
1190   1EFC FF FF FF FF 
1190   1F00 FF FF FF FF 
1190   1F04 FF FF FF FF 
1190   1F08 FF FF FF FF 
1190   1F0C FF FF FF FF 
1190   1F10 FF FF FF FF 
1190   1F14 FF FF FF FF 
1190   1F18 FF FF FF FF 
1190   1F1C FF FF FF FF 
1190   1F20 FF FF FF FF 
1190   1F24 FF FF FF FF 
1190   1F28 FF FF FF FF 
1190   1F2C FF FF FF FF 
1190   1F30 FF FF FF FF 
1190   1F34 FF FF FF FF 
1190   1F38 FF FF FF FF 
1190   1F3C FF FF FF FF 
1190   1F40 FF FF FF FF 
1190   1F44 FF FF FF FF 
1190   1F48 FF FF FF FF 
1190   1F4C FF FF FF FF 
1190   1F50 FF FF FF FF 
1190   1F54 FF FF FF FF 
1190   1F58 FF FF FF FF 
1190   1F5C FF FF FF FF 
1190   1F60 FF FF FF FF 
1190   1F64 FF FF FF FF 
1190   1F68 FF FF FF FF 
1190   1F6C FF FF FF FF 
1190   1F70 FF FF FF FF 
1190   1F74 FF FF FF FF 
1190   1F78 FF FF FF FF 
1190   1F7C FF FF FF FF 
1190   1F80 FF FF FF FF 
1190   1F84 FF FF FF FF 
1190   1F88 FF FF FF FF 
1190   1F8C FF FF FF FF 
1190   1F90 FF FF FF FF 
1190   1F94 FF FF FF FF 
1190   1F98 FF FF FF FF 
1190   1F9C FF FF FF FF 
1190   1FA0 FF FF FF FF 
1190   1FA4 FF FF FF FF 
1190   1FA8 FF FF FF FF 
1190   1FAC FF FF FF FF 
1190   1FB0 FF FF FF FF 
1190   1FB4 FF FF FF FF 
1190   1FB8 FF FF FF FF 
1190   1FBC FF FF FF FF 
1190   1FC0 FF FF FF FF 
1190   1FC4 FF FF FF FF 
1190   1FC8 FF FF FF FF 
1190   1FCC FF FF FF FF 
1190   1FD0 FF FF FF FF 
1190   1FD4 FF FF FF FF 
1190   1FD8 FF FF FF FF 
1190   1FDC FF FF FF FF 
1190   1FE0 FF FF FF FF 
1190   1FE4 FF FF FF FF 
1190   1FE8 FF FF FF FF 
1190   1FEC FF FF FF FF 
1190   1FF0 FF FF FF FF 
1190   1FF4 FF FF FF FF 
1190   1FF8 FF FF FF FF 
1190   1FFC FF FF FF FF 
1190   2000 FF FF FF FF 
1190   2004 FF FF FF FF 
1190   2008 FF FF FF FF 
1190   200C FF FF FF FF 
1190   2010 FF FF FF FF 
1190   2014 FF FF FF FF 
1190   2018 FF FF FF FF 
1190   201C FF FF FF FF 
1190   2020 FF FF FF FF 
1190   2024 FF FF FF FF 
1190   2028 FF FF FF FF 
1190   202C FF FF FF FF 
1190   2030 FF FF FF FF 
1190   2034 FF FF FF FF 
1190   2038 FF FF FF FF 
1190   203C FF FF FF FF 
1190   2040 FF FF FF FF 
1190   2044 FF FF FF FF 
1190   2048 FF FF FF FF 
1190   204C FF FF FF FF 
1190   2050 FF FF FF FF 
1190   2054 FF FF FF FF 
1190   2058 FF FF FF FF 
1190   205C FF FF FF FF 
1190   2060 FF FF FF FF 
1190   2064 FF FF FF FF 
1190   2068 FF FF FF FF 
1190   206C FF FF FF FF 
1190   2070 FF FF FF FF 
1190   2074 FF FF FF FF 
1190   2078 FF FF FF FF 
1190   207C FF FF FF FF 
1191   2080             transient_area:
1192   2080 00            .db 0             ; beginning of the transient memory area. used for disk reads and other purposes    
1193   2081             
1194   2081             .end
tasm: Number of errors = 0
