lib/stdio.asm line 0334: Duplicate label: (noname._puts)
0001   0000             ; ------------------------------------------------------------------------------------------------------------------;
0002   0000             ; Solarium - Sol-1 Homebrew Minicomputer Operating System Kernel.
0003   0000             ; ------------------------------------------------------------------------------------------------------------------;
0004   0000             
0005   0000             ; memory map
0006   0000             ; ------------------------------------------------------------------------------------------------------------------;
0007   0000             ; 0000 ... 7fff - rom space
0008   0000             ; 8000 ... f7ff - ram space
0009   0000             ; f7ff          - stack root
0010   0000             
0011   0000             ; i/o map
0012   0000             ; ------------------------------------------------------------------------------------------------------------------;
0013   0000             ; ff80 - uart 0 (16550)
0014   0000             ; ff88 - uart 1 (16550)
0015   0000             ; ffa0 - rtc    (m48t02)
0016   0000             ; ffb0 - pio 0  (8255)
0017   0000             ; ffc0 - fdd    (5.25" floppy drive block)
0018   0000             ;   - ffc0      output port (377 flip-flop)                  
0019   0000             ;   - ffc1      input port  (244 buffer)                     
0020   0000             ;   - ffc8      wd1770 status/command    
0021   0000             ;   - ffc9      wd1770 track register
0022   0000             ;   - ffca      wd1770 sector register
0023   0000             ;   - ffcb      wd1770 data register
0024   0000             ;      
0025   0000             ; ffd0 - ide    (compact flash / pata)
0026   0000             ; ffe0 - timer  (8253)
0027   0000             ; fff0 - bios configuration nv-ram store area
0028   0000             ; ------------------------------------------------------------------------------------------------------------------;
0029   0000             
0030   0000             ; ------------------------------------------------------------------------------------------------------------------;
0031   0000             ; system constants
0032   0000             ; ------------------------------------------------------------------------------------------------------------------;
0033   0000             _uart0_data       .equ $ff80         ; data
0034   0000             _uart0_dlab_0     .equ $ff80         ; divisor latch low byte
0035   0000             _uart0_dlab_1     .equ $ff81         ; divisor latch high byte
0036   0000             _uart0_ier        .equ $ff81         ; interrupt enable register
0037   0000             _uart0_fcr        .equ $ff82         ; fifo control register
0038   0000             _uart0_lcr        .equ $ff83         ; line control register
0039   0000             _uart0_lsr        .equ $ff85         ; line status register
0040   0000             
0041   0000             _uart1_data       .equ $ff88         ; data
0042   0000             _uart1_dlab_0     .equ $ff88         ; divisor latch low byte
0043   0000             _uart1_dlab_1     .equ $ff89         ; divisor latch high byte
0044   0000             _uart1_ier        .equ $ff89         ; interrupt enable register
0045   0000             _uart1_fcr        .equ $ff8A         ; fifo control register
0046   0000             _uart1_lcr        .equ $ff8B         ; line control register
0047   0000             _uart1_lsr        .equ $ff8D         ; line status register
0048   0000             
0049   0000             _ide_base         .equ $ffd0         ; ide base
0050   0000             _ide_r0           .equ _ide_base + 0 ; data port
0051   0000             _ide_r1           .equ _ide_base + 1 ; read: error code, write: feature
0052   0000             _ide_r2           .equ _ide_base + 2 ; number of sectors to transfer
0053   0000             _ide_r3           .equ _ide_base + 3 ; sector address lba 0 [0:7]
0054   0000             _ide_r4           .equ _ide_base + 4 ; sector address lba 1 [8:15]
0055   0000             _ide_r5           .equ _ide_base + 5 ; sector address lba 2 [16:23]
0056   0000             _ide_r6           .equ _ide_base + 6 ; sector address lba 3 [24:27 (lsb)]
0057   0000             _ide_r7           .equ _ide_base + 7 ; read: status, write: command       
0058   0000             
0059   0000             _til311_display   .equ $ffb0         ; bios post code hex display (2 digits) (connected to pio a)
0060   0000             _bios_post_ctrl   .equ $ffb3         ; bios post display control register, 80h = as output
0061   0000             _pio_a            .equ $ffb0    
0062   0000             _pio_b            .equ $ffb1
0063   0000             _pio_c            .equ $ffb2
0064   0000             _pio_control      .equ $ffb3         ; pio control port
0065   0000             
0066   0000             _fdc_config       .equ $ffc0         ; 0 = select_0, 1 = select_1, 2 = side_select, 3 = dden, 4 = in_use_or_head_load, 5 = wd1770_rst
0067   0000             _fdc_status_0     .equ $ffc1         ; 0 = drq, 1 = ready
0068   0000             _fdc_stat_cmd     .equ $ffc8         ; status / command register
0069   0000             _fdc_track        .equ $ffc9         ; track register
0070   0000             _fdc_sector       .equ $ffca         ; sector register
0071   0000             _fdc_data         .equ $ffcb         ; data register
0072   0000             
0073   0000             _timer_c_0        .equ $ffe0         ; timer counter 0
0074   0000             _timer_c_1        .equ $ffe1         ; timer counter 1
0075   0000             _timer_c_2        .equ $ffe2         ; timer counter 2
0076   0000             _timer_ctrl       .equ $ffe3         ; timer control register
0077   0000             
0078   0000             _stack_begin      .equ $f7ff         ; beginning of stack
0079   0000             _fifo_size        .equ 4096
0080   0000             
0081   0000             _mbr                     .equ 446
0082   0000             _superblock              .equ 1024
0083   0000             _block_group_descriptor  .equ 2048
0084   0000             
0085   0000             text_org          .equ $400          ; code origin address for all user processes
0086   0000             
0087   0000             
0088   0000             ;  ------------------------------------------------------------------------------------------------------------------;
0089   0000             ;  DISK LAYOUT:
0090   0000             ;  Metadata               | Size (bytes)      | Blocks (2048 bytes)              |Start Block |  Comment
0091   0000             ;  ---------------------- | ----------------- | -------------------------------- |------------|-----------------------------------
0092   0000             ;  Bootloader/MBR         | 512 bytes         | 0.25 (1 sector)                  |  0         |
0093   0000             ;  Superblock             | 1024 bytes        | 1 block (2048 bytes, must align) |  0         |
0094   0000             ;                         |                   | 1 block (2048 bytes)             |  1         | reserved
0095   0000             ;  Block Bitmap           | 8,192 bytes       | 4 blocks                         |  2         | 4*2048*8 = 4*16384 = 65536 raw data blocks.  65536*2048 bytes = 134217728 bytes of disk space = 128MB
0096   0000             ;  Inode Bitmap           | 2,048 bytes       | 1 block                          |  6         | 2048*8=16384. total of 16384 bits, meaning 16384 inodes, which is 1 inode per 8KB of disk space
0097   0000             ;  Inode Table            | 2,097,152 bytes   | 1024 blocks                      |  7         | 128bytes per inode entry. 2097152 / 128 = 16384 inodes
0098   0000             ;  Data Blocks            | 134,217,728 bytes | 65528 blocks                     | 1031       | 65528 blocks = 134,201,344 bytes
0099   0000             ;  
0100   0000             ;  first 512 bytes: bootloader from 0 to 445, MBR partition table from 446 to 511 (64 bytes)
0101   0000             ;  up to 4 partitions, each 16 bytes long
0102   0000             ;  MBR:
0103   0000             ;  Byte | Description
0104   0000             ;  -----|----------------------------
0105   0000             ;  0    | Boot flag (0x80 active, 0x00 inactive)
0106   0000             ;  1-3  | Start CHS (head, sector, cylinder)
0107   0000             ;  4    | Partition type (filesystem ID)
0108   0000             ;    0x83 = Linux native (ext2/3/4)
0109   0000             ;    0x07 = NTFS/exFAT
0110   0000             ;    0x0B = FAT32 CHS
0111   0000             ;    0x0C = FAT32 LBA
0112   0000             ;    0x05 = Extended partition
0113   0000             ;    0x86 = Sol-1 partition
0114   0000             ;  5-7  | End CHS
0115   0000             ;  8-11 | Start LBA (little endian)
0116   0000             ;  12-15| Size in sectors (little endian)
0117   0000             ;  
0118   0000             ;  
0119   0000             ;  the superblock describers the filesystem as a whole such as inode count, free inode count, location of the raw data bitmap, inode table, etc.  
0120   0000             ;  SUPERBLOCK:
0121   0000             ;  | Field               | Description                               | Typical Size (bytes) | Notes                           |
0122   0000             ;  | ------------------- | ----------------------------------------- | -------------------- | ------------------------------- |
0123   0000             ;  | inodes_count        | Total number of inodes in the filesystem  | 2                    | 16-bit unsigned int             |
0124   0000             ;  | blocks_count        | Total number of data blocks               | 2                    | 16-bit unsigned int             |
0125   0000             ;  | free_inodes_count   | Number of free inodes                     | 2                    | 16-bit unsigned int             |
0126   0000             ;  | free_blocks_count   | Number of free blocks                     | 2                    | 16-bit unsigned int             |
0127   0000             ;  | block_bitmap        | Block ID of the **block bitmap**          | 2                    | 16-bit unsigned int
0128   0000             ;  | inode_bitmap        | Block ID of the **inode bitmap**          | 2                    | 16-bit unsigned int
0129   0000             ;  | inode_table         | Starting block of **inode table**         | 2                    | 16-bit unsigned int
0130   0000             ;  | first_data_block    | Block number of the first data block      | 2                    | 16-bit unsigned int             |
0131   0000             ;  | used_dirs_count     | Number of inodes allocated to directories | 2
0132   0000             ;  | log_block_size      | Block size = 1024 << `s_log_block_size    | 2                    | 16-bit unsigned int             |
0133   0000             ;  | mtime               | Last mount time                           | 4                    | 32-bit unsigned int (Unix time) |
0134   0000             ;  | wtime               | Last write time                           | 4                    | 32-bit unsigned int (Unix time) |
0135   0000             ;  | uuid                | Unique ID of the filesystem               | 16                   | 128-bit UUID                    |
0136   0000             ;  | volume_name         | Label of the filesystem                   | 16                   | Usually ASCII, padded           |
0137   0000             ;  | feature_flags       | Compatibility flags                       | 4                    | 32-bit unsigned int             |
0138   0000             ;  
0139   0000             ;  inode for root dir is #2, #0 and #1 not used
0140   0000             ;  raw data block #0 is not used. because 0 as a block ID means not used
0141   0000             ;  block size: 2048
0142   0000             ;  inode-table format:
0143   0000             ;  | Field         | Size (bytes) | Description                                                                                  |
0144   0000             ;  | ------------- | ------------ | -------------------------------------------------------------------------------------------- |
0145   0000             ;  | `mode`        | 2            | File type and permissions                                                                    |
0146   0000             ;  | `uid`         | 2            | Owner user ID                                                                                |
0147   0000             ;  | `size`        | 4            | Size of the file in bytes                                                                    |
0148   0000             ;  | `atime`       | 4            | Last access time (timestamp)                                                                 |
0149   0000             ;  | `ctime`       | 4            | Creation time (timestamp)                                                                    |
0150   0000             ;  | `mtime`       | 4            | Last modification time (timestamp)                                                           |
0151   0000             ;  | `dtime`       | 4            | Deletion time (timestamp)                                                                    |
0152   0000             ;  | `gid`         | 2            | Group ID                                                                                     |
0153   0000             ;  | `links_count` | 2            | Number of hard links                                                                         |
0154   0000             ;  | `blocks`      | 2            | Number of 2048-byte blocks allocated                                                         |
0155   0000             ;  | `flags`       | 4            | File flags                                                                                   |
0156   0000             ;  | `block`       | 47 * 2 = 94  | Pointers to data blocks (47 direct only) 
0157   0000             ;
0158   0000             ;
0159   0000             ;  DIRECTORY ENTRY
0160   0000             ;  this is the structure for file entries inside a directory.
0161   0000             ;  2048 / 64 = 32 entries
0162   0000             ;
0163   0000             ;  each entry is 64 bytes wide
0164   0000             ;  uint16_t inode;      // Inode number (0 if entry is unused)
0165   0000             ;  char     name[62];   // File name (null terminated)
0166   0000             
0167   0000             
0168   0000             ; file entry attributes
0169   0000             ; filename (24)
0170   0000             ; attributes (1)       :|0|0|file_type(3bits)|x|w|r|
0171   0000             ; lba (2)              : location of raw data for file entry, or dirid for directory entry
0172   0000             ; size (2)             : filesize
0173   0000             ; day (1)           
0174   0000             ; month (1)
0175   0000             ; year (1)
0176   0000             ; packet size = 32 bytes  : total packet size in bytes
0177   0000             
0178   0000             fst_entry_size      .equ 32  ; bytes
0179   0000             fst_files_per_sect  .equ (512 / fst_entry_size)
0180   0000             fst_files_per_dir   .equ (512 / fst_entry_size)
0181   0000             fst_nbr_directories .equ 64
0182   0000                                 ; 1 sector for header, the rest is for the list of files/dirs
0183   0000             fst_sectors_per_dir .equ (1 + (fst_entry_size * fst_files_per_dir / 512))    
0184   0000             fst_total_sectors   .equ (fst_sectors_per_dir * fst_nbr_directories)
0185   0000             fst_lba_start       .equ 32
0186   0000             fst_lba_end         .equ (fst_lba_start + fst_total_sectors - 1)
0187   0000             
0188   0000             fs_nbr_files        .equ (fst_nbr_directories * fst_files_per_dir)
0189   0000             fs_sectors_per_file .equ 32 ; the first sector is always a header with a null parameter (first byte)
0190   0000                                         ; so that we know which blocks are free or taken
0191   0000             fs_file_size        .equ (fs_sectors_per_file * 512)                  
0192   0000             fs_total_sectors    .equ (fs_nbr_files * fs_sectors_per_file)
0193   0000             fs_lba_start        .equ (fst_lba_end + 1)
0194   0000             fs_lba_end          .equ (fs_lba_start + fs_total_sectors - 1)
0195   0000             
0196   0000             root_id:            .equ fst_lba_start
0197   0000             
0198   0000             ; ------------------------------------------------------------------------------------------------------------------;
0199   0000             ; global system variables
0200   0000             ; ------------------------------------------------------------------------------------------------------------------;
0201   0000             
0202   0000             ; ------------------------------------------------------------------------------------------------------------------;
0203   0000             ; irq table
0204   0000             ; highest priority at lowest address
0205   0000             ; ------------------------------------------------------------------------------------------------------------------;
0206   0000 3C 00       .dw int_0_fdc
0207   0002 43 00       .dw int_1
0208   0004 44 00       .dw int_2
0209   0006 45 00       .dw int_3
0210   0008 46 00       .dw int_4
0211   000A 47 00       .dw int_5_uart1
0212   000C 73 00       .dw int_6_timer
0213   000E 74 00       .dw int_7_uart0
0214   0010             
0215   0010             ; ------------------------------------------------------------------------------------------------------------------;
0216   0010             ; kernel reset vector
0217   0010             ; ------------------------------------------------------------------------------------------------------------------;
0218   0010 C3 11       .dw kernel_reset_vector
0219   0012             
0220   0012             ; ------------------------------------------------------------------------------------------------------------------;
0221   0012             ; exception vector table
0222   0012             ; total of 7 entries, starting at address $0012
0223   0012             ; ------------------------------------------------------------------------------------------------------------------;
0224   0012 41 04       .dw trap_privilege
0225   0014 5E 05       .dw trap_div_zero
0226   0016 6B 05       .dw trap_undef_opcode
0227   0018 00 00       .dw 0
0228   001A 00 00       .dw 0
0229   001C 00 00       .dw 0
0230   001E 00 00       .dw 0
0231   0020             
0232   0020             ; ------------------------------------------------------------------------------------------------------------------;
0233   0020             ; system call vector table
0234   0020             ; starts at address $0020
0235   0020             ; ------------------------------------------------------------------------------------------------------------------;
0236   0020 4D 04       .dw syscall_break
0237   0022 6C 05       .dw syscall_rtc
0238   0024 8F 06       .dw syscall_ide
0239   0026 4F 07       .dw syscall_io
0240   0028 44 08       .dw syscall_file_system
0241   002A 10 11       .dw syscall_create_proc
0242   002C 06 04       .dw syscall_list_procs
0243   002E 9E 05       .dw syscall_datetime
0244   0030 C2 03       .dw syscall_reboot
0245   0032 DA 10       .dw syscall_pause_proc
0246   0034 CE 03       .dw syscall_resume_proc
0247   0036 97 10       .dw syscall_terminate_proc
0248   0038 8E 03       .dw syscall_system
0249   003A CD 00       .dw syscall_fdc
0250   003C             
0251   003C             ; ------------------------------------------------------------------------------------------------------------------;
0252   003C             ; system call aliases
0253   003C             ; ------------------------------------------------------------------------------------------------------------------;
0254   003C             sys_break            .equ 0
0255   003C             sys_rtc              .equ 1
0256   003C             sys_ide              .equ 2
0257   003C             sys_io               .equ 3
0258   003C             sys_filesystem       .equ 4
0259   003C             sys_create_proc      .equ 5
0260   003C             sys_list_proc        .equ 6
0261   003C             sys_datetime         .equ 7
0262   003C             sys_reboot           .equ 8
0263   003C             sys_pause_proc       .equ 9
0264   003C             sys_resume_proc      .equ 10
0265   003C             sys_terminate_proc   .equ 11
0266   003C             sys_system           .equ 12
0267   003C             sys_fdc              .equ 13
0268   003C             
0269   003C             ; aliases for individual 'al' options for FDC system calls
0270   003C             fdc_al_restore      .equ 0
0271   003C             fdc_al_step         .equ 1
0272   003C             fdc_al_step_in      .equ 2
0273   003C             fdc_al_step_out     .equ 3
0274   003C             fdc_al_seek         .equ 4
0275   003C             fdc_al_format_128   .equ 5
0276   003C             fdc_al_formatdisk_128   .equ 6
0277   003C             fdc_al_format_512   .equ 7
0278   003C             fdc_al_formatdisk_512   .equ 8
0279   003C             fdc_al_read_addr    .equ 9
0280   003C             fdc_al_read_track   .equ 10
0281   003C             fdc_al_read_sect    .equ 11
0282   003C             fdc_al_write_sect   .equ 12
0283   003C             fdc_al_force_int    .equ 13
0284   003C             fdc_al_status0      .equ 14
0285   003C             fdc_al_status1      .equ 15
0286   003C             
0287   003C             ; ------------------------------------------------------------------------------------------------------------------;
0288   003C             ; alias exports
0289   003C             ; ------------------------------------------------------------------------------------------------------------------;
0290   003C             .export text_org
0291   003C             .export sys_break
0292   003C             .export sys_rtc
0293   003C             .export sys_ide
0294   003C             .export sys_io
0295   003C             .export sys_filesystem
0296   003C             .export sys_create_proc
0297   003C             .export sys_list_proc
0298   003C             .export sys_datetime
0299   003C             .export sys_reboot
0300   003C             .export sys_pause_proc
0301   003C             .export sys_resume_proc
0302   003C             .export sys_terminate_proc
0303   003C             .export sys_system
0304   003C             .export sys_fdc
0305   003C             
0306   003C             .export _til311_display
0307   003C             
0308   003C             .export _fdc_config        
0309   003C             .export _fdc_status_0      
0310   003C             .export _fdc_stat_cmd     
0311   003C             
0312   003C             ; exports of aliases for individual 'al' options for FDC system calls
0313   003C             .export fdc_al_restore
0314   003C             .export fdc_al_step
0315   003C             .export fdc_al_step_in
0316   003C             .export fdc_al_step_out
0317   003C             .export fdc_al_seek
0318   003C             .export fdc_al_format_128
0319   003C             .export fdc_al_formatdisk_128
0320   003C             .export fdc_al_format_512
0321   003C             .export fdc_al_formatdisk_512
0322   003C             .export fdc_al_read_addr
0323   003C             .export fdc_al_read_track
0324   003C             .export fdc_al_read_sect
0325   003C             .export fdc_al_write_sect
0326   003C             .export fdc_al_force_int
0327   003C             .export fdc_al_status0
0328   003C             .export fdc_al_status1
0329   003C             
0330   003C             ; ------------------------------------------------------------------------------------------------------------------;
0331   003C             ; irqs' code block
0332   003C             ; ------------------------------------------------------------------------------------------------------------------;
0333   003C             ; 5.25" floppy drive controller irq
0334   003C             int_0_fdc:
0335   003C 3B 3F 1B      mov d, s_fdc_irq
0336   003F 07 82 02      call _puts
0337   0042 06            sysret
0338   0043             int_1:
0339   0043 06            sysret
0340   0044             int_2:
0341   0044 06            sysret
0342   0045             int_3:
0343   0045 06            sysret
0344   0046             int_4:
0345   0046 06            sysret
0346   0047             
0347   0047             ; ------------------------------------------------------------------------------------------------------------------;
0348   0047             ; uart1 interrupt
0349   0047             ; ------------------------------------------------------------------------------------------------------------------;
0350   0047             int_5_uart1:
0351   0047 D7            push a
0352   0048 DA            push d
0353   0049 E1            pushf
0354   004A 1D 88 FF      mov al, [_uart1_data]       ; get character
0355   004D B9 03         cmp al, $03                 ; ctrl-c
0356   004F C6 A0 00      je ctrlc
0357   0052 B9 1A         cmp al, $1a                 ; ctrl-z
0358   0054 C6 A6 00      je ctrlz
0359   0057               ;mov [[d]], al              ; TODO: implement this double indirection instruction
0360   0057 3B 5A 19      mov d, fifo_in
0361   005A FD 2A         mov d, [d]
0362   005C 3E            mov [d], al                 ; add to fifo
0363   005D 13            mov a, d
0364   005E 77            inc a
0365   005F AF 61 31      cmp a, fifo + _fifo_size     ; check if pointer reached the end of the fifo
0366   0062 C7 68 00      jne int_5_continue
0367   0065 10 61 21      mov a, fifo  
0368   0068             int_5_continue:  
0369   0068 42 5A 19      mov [fifo_in], a            ; update fifo pointer
0370   006B 1A            mov al, ah
0371   006C 3D B0 FF      mov [_til311_display], al
0372   006F EE            popf
0373   0070 E7            pop d
0374   0071 E4            pop a  
0375   0072 06            sysret
0376   0073             
0377   0073             ; ------------------------------------------------------------------------------------------------------------------;
0378   0073             ; timer irq
0379   0073             ; ------------------------------------------------------------------------------------------------------------------;
0380   0073             int_6_timer:  
0381   0073 06            sysret
0382   0074             
0383   0074             ; ------------------------------------------------------------------------------------------------------------------;
0384   0074             ; uart0 interrupt
0385   0074             ; ------------------------------------------------------------------------------------------------------------------;
0386   0074             int_7_uart0:
0387   0074 D7            push a
0388   0075 DA            push d
0389   0076 E1            pushf
0390   0077 1D 80 FF      mov al, [_uart0_data]       ; get character
0391   007A B9 03         cmp al, $03                 ; ctrl-c
0392   007C C6 A0 00      je ctrlc
0393   007F B9 1A         cmp al, $1a                 ; ctrl-z
0394   0081 C6 A6 00      je ctrlz
0395   0084               ;mov [[d]], al              ; TODO: implement this double indirection instruction
0396   0084 3B 5A 19      mov d, fifo_in
0397   0087 FD 2A         mov d, [d]
0398   0089 3E            mov [d], al                 ; add to fifo
0399   008A 13            mov a, d
0400   008B 77            inc a
0401   008C AF 61 31      cmp a, fifo + _fifo_size     ; check if pointer reached the end of the fifo
0402   008F C7 95 00      jne int_7_continue
0403   0092 10 61 21      mov a, fifo  
0404   0095             int_7_continue:  
0405   0095 42 5A 19      mov [fifo_in], a            ; update fifo pointer
0406   0098 1A            mov al, ah
0407   0099 3D B0 FF      mov [_til311_display], al
0408   009C EE            popf
0409   009D E7            pop d
0410   009E E4            pop a  
0411   009F 06            sysret
0412   00A0             
0413   00A0             ctrlc:
0414   00A0 51 05 00      add sp, 5
0415   00A3 0A 97 10      jmp syscall_terminate_proc
0416   00A6             ctrlz:
0417   00A6 51 05 00      add sp, 5
0418   00A9 0A DA 10      jmp syscall_pause_proc      ; pause current process and go back to the shell
0419   00AC             
0420   00AC             sys_mkfs:
0421   00AC 06            sysret
0422   00AD             
0423   00AD             ; ------------------------------------------------------------------------------------------------------------------;
0424   00AD             ; floppy drive syscalls
0425   00AD             ; ------------------------------------------------------------------------------------------------------------------;
0426   00AD             ; data for formatting a floppy drive in single density mode (128 bytes per sector):
0427   00AD             ; fdc_40_ff:
0428   00AD             ;   .fill 40,  $ff    ; or 00                                                                                
0429   00AD             ; fdc_128_format_inner:
0430   00AD             ;   .fill 6,   $00    ;                                                                            <--|        
0431   00AD             ;   .fill 1,   $fe    ; id address mark                                                               |        
0432   00AD             ;   .fill 1,   $00    ; track number  0 thru 39                                                       |                    
0433   00AD             ;   .fill 1,   $00    ; side number 00 or 01                                                          |                
0434   00AD             ;   .fill 1,   $01    ; sector number  0x01 through 0x10                                              |                              
0435   00AD             ;   .fill 1,   $00    ; sector length                                                                 |                        
0436   00AD             ;   .fill 1,   $f7    ; 2 crc's written                                                               | write 16 times                 
0437   00AD             ;   .fill 11,  $ff    ; or 00                                                                         |                      
0438   00AD             ;   .fill 6,   $00    ;                                                                               |                        
0439   00AD             ;   .fill 1,   $fb    ; data address mark                                                             |                                  
0440   00AD             ;   .fill 128, $e5    ; data (ibm uses e5)                                                            |                                      
0441   00AD             ;   .fill 1,   $f7    ; 2 crc's written                                                               |                                                        
0442   00AD             ;   .fill 10,  $ff    ; or 00                                                                      <--|                                                  
0443   00AD             ; fdc_128_format_end:
0444   00AD             ;   .fill 369, $ff    ; or 00. continue writing until wd1770 interrupts out. approx 369 bytes.                                                                
0445   00AD             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0446   00AD             fdc_jmptbl:
0447   00AD D9 00         .dw syscall_fdc_restore
0448   00AF E5 00         .dw syscall_fdc_step
0449   00B1 ED 00         .dw syscall_fdc_step_in
0450   00B3 F5 00         .dw syscall_fdc_step_out
0451   00B5 FD 00         .dw syscall_fdc_seek
0452   00B7 0B 01         .dw syscall_fdc_format_128
0453   00B9 5F 01         .dw syscall_fdc_formatdisk_128
0454   00BB 35 01         .dw syscall_fdc_format_512
0455   00BD A1 01         .dw syscall_fdc_formatdisk_512
0456   00BF 09 01         .dw syscall_fdc_read_addr
0457   00C1 E3 01         .dw syscall_fdc_read_track
0458   00C3 12 02         .dw syscall_fdc_read_sect
0459   00C5 4A 02         .dw syscall_fdc_write_sect
0460   00C7 0A 01         .dw syscall_fdc_force_int
0461   00C9 D1 00         .dw syscall_fdc_status0
0462   00CB D5 00         .dw syscall_fdc_status1
0463   00CD             syscall_fdc:
0464   00CD FD 0A AD 00   jmp [fdc_jmptbl + al]
0465   00D1             
0466   00D1             syscall_fdc_status0:
0467   00D1 1D C1 FF      mov al, [_fdc_status_0]
0468   00D4 06            sysret
0469   00D5             
0470   00D5             syscall_fdc_status1:
0471   00D5 1D C8 FF      mov al, [_fdc_stat_cmd]
0472   00D8 06            sysret
0473   00D9             
0474   00D9             syscall_fdc_restore:
0475   00D9 07 7B 02      call fdc_wait_not_busy
0476   00DC F2 C8 FF 0B   mov byte [_fdc_stat_cmd], %00001011
0477   00E0 F2 C9 FF 00   mov byte [_fdc_track], $00 ; reset track
0478   00E4 06            sysret
0479   00E5             
0480   00E5             syscall_fdc_step:
0481   00E5 07 7B 02      call fdc_wait_not_busy
0482   00E8 F2 C8 FF 3B   mov byte [_fdc_stat_cmd], %00111011
0483   00EC 06            sysret
0484   00ED             
0485   00ED             syscall_fdc_step_in:
0486   00ED 07 7B 02      call fdc_wait_not_busy
0487   00F0 F2 C8 FF 53   mov byte [_fdc_stat_cmd], %01010011
0488   00F4 06            sysret
0489   00F5             
0490   00F5             syscall_fdc_step_out:
0491   00F5 07 7B 02      call fdc_wait_not_busy
0492   00F8 F2 C8 FF 7B   mov byte [_fdc_stat_cmd], %01111011
0493   00FC 06            sysret
0494   00FD             
0495   00FD             ; bl: desired track
0496   00FD             syscall_fdc_seek:
0497   00FD 07 7B 02      call fdc_wait_not_busy
0498   0100 FD 3D CB FF   mov [_fdc_data], bl ; set desired track to bl
0499   0104 F2 C8 FF 1B   mov byte [_fdc_stat_cmd], %00011011 ; seek command
0500   0108 06            sysret
0501   0109             
0502   0109             syscall_fdc_read_addr:
0503   0109 06            sysret
0504   010A             
0505   010A             syscall_fdc_force_int:
0506   010A 06            sysret
0507   010B             
0508   010B             ; when writing the actual code for formatting multiple tracks, remember to change the track number byte
0509   010B             ; in the ram formatting block because they are all set as 00 right now
0510   010B             ; bl: track number
0511   010B             syscall_fdc_format_128:
0512   010B 07 86 02      call fdc_format_mem_128
0513   010E 07 7B 02      call fdc_wait_not_busy
0514   0111 FD 3D C9 FF   mov [_fdc_track], bl
0515   0115 FD 4D 61 33   mov si, transient_area
0516   0119 F2 C8 FF FA   mov byte [_fdc_stat_cmd], %11111010 ; write track command: {1111, 0: enable spin-up seq, 1: settling delay, 1: no write precompensation, 0}
0517   011D 07 5C 03      call fdc_wait_64us
0518   0120             fdc_format_drq_128:
0519   0120 1D C8 FF      mov al, [_fdc_stat_cmd]     ; 10
0520   0123 93 01         test al, $01                ; 4
0521   0125 C6 34 01      jz fdc_format_end_128           ; 8
0522   0128 93 02         test al, $02                ; 4
0523   012A C6 20 01      jz fdc_format_drq_128           ; 8
0524   012D F6            lodsb                       ; 7
0525   012E 3D CB FF      mov [_fdc_data], al         ; 10   
0526   0131 0A 20 01      jmp fdc_format_drq_128
0527   0134             fdc_format_end_128:
0528   0134 06            sysret
0529   0135             
0530   0135             ; when writing the actual code for formatting multiple tracks, remember to change the track number byte
0531   0135             ; in the ram formatting block because they are all set as 00 right now
0532   0135             ; bl: track number
0533   0135             syscall_fdc_format_512:
0534   0135 07 F1 02      call fdc_format_mem_512
0535   0138 07 7B 02      call fdc_wait_not_busy
0536   013B FD 3D C9 FF   mov [_fdc_track], bl
0537   013F FD 4D 61 33   mov si, transient_area
0538   0143 F2 C8 FF FA   mov byte [_fdc_stat_cmd], %11111010 ; write track command: {1111, 0: enable spin-up seq, 1: settling delay, 1: no write precompensation, 0}
0539   0147 07 5C 03      call fdc_wait_64us
0540   014A             fdc_format_drq_512:
0541   014A 1D C8 FF      mov al, [_fdc_stat_cmd]     ; 10
0542   014D 93 01         test al, $01                ; 4
0543   014F C6 5E 01      jz fdc_format_end_512           ; 8
0544   0152 93 02         test al, $02                ; 4
0545   0154 C6 4A 01      jz fdc_format_drq_512           ; 8
0546   0157 F6            lodsb                       ; 7
0547   0158 3D CB FF      mov [_fdc_data], al         ; 10   
0548   015B 0A 4A 01      jmp fdc_format_drq_512
0549   015E             fdc_format_end_512:
0550   015E 06            sysret
0551   015F             
0552   015F             syscall_fdc_formatdisk_128:
0553   015F 2E 00         mov bl, 0
0554   0161             fdc_formatdisk128_l0:
0555   0161 07 86 02      call fdc_format_mem_128
0556   0164 07 7B 02      call fdc_wait_not_busy
0557   0167 FD 3D C9 FF   mov [_fdc_track], bl
0558   016B FD 4D 61 33   mov si, transient_area
0559   016F F2 C8 FF FA   mov byte [_fdc_stat_cmd], %11111010 ; write track command
0560   0173 07 5C 03      call fdc_wait_64us
0561   0176             fdc_formatdisk_drq_128:
0562   0176 1D C8 FF      mov al, [_fdc_stat_cmd]     ; 10
0563   0179 93 01         test al, $01                ; 4
0564   017B C6 8A 01      jz fdc_formatdisk_end_128           ; 8
0565   017E 93 02         test al, $02                ; 4
0566   0180 C6 76 01      jz fdc_formatdisk_drq_128           ; 8
0567   0183 F6            lodsb                       ; 7
0568   0184 3D CB FF      mov [_fdc_data], al         ; 10   
0569   0187 0A 76 01      jmp fdc_formatdisk_drq_128
0570   018A             fdc_formatdisk_end_128:
0571   018A 07 7B 02      call fdc_wait_not_busy
0572   018D D8            push b
0573   018E 26 08 00      mov b, 8
0574   0191 07 63 03      call wait_xs
0575   0194 F2 C8 FF 53   mov byte [_fdc_stat_cmd], %01010011  ; step in
0576   0198 E5            pop b
0577   0199 6C 01         add bl, 1
0578   019B C1 28         cmp bl, 40
0579   019D C7 61 01      jne fdc_formatdisk128_l0
0580   01A0 06            sysret
0581   01A1             
0582   01A1             syscall_fdc_formatdisk_512:
0583   01A1 2E 00         mov bl, 0
0584   01A3             fdc_formatdisk512_l0:
0585   01A3 07 F1 02      call fdc_format_mem_512
0586   01A6 07 7B 02      call fdc_wait_not_busy
0587   01A9 FD 3D C9 FF   mov [_fdc_track], bl
0588   01AD FD 4D 61 33   mov si, transient_area
0589   01B1 F2 C8 FF F2   mov byte [_fdc_stat_cmd], %11110010 ; write track command
0590   01B5 07 5C 03      call fdc_wait_64us
0591   01B8             fdc_formatdisk_drq_512:
0592   01B8 1D C8 FF      mov al, [_fdc_stat_cmd]     ; 10
0593   01BB 93 01         test al, $01                ; 4
0594   01BD C6 CC 01      jz fdc_formatdisk_end_512           ; 8
0595   01C0 93 02         test al, $02                ; 4
0596   01C2 C6 B8 01      jz fdc_formatdisk_drq_512           ; 8
0597   01C5 F6            lodsb                       ; 7
0598   01C6 3D CB FF      mov [_fdc_data], al         ; 10   
0599   01C9 0A B8 01      jmp fdc_formatdisk_drq_512
0600   01CC             fdc_formatdisk_end_512:
0601   01CC 07 7B 02      call fdc_wait_not_busy
0602   01CF D8            push b
0603   01D0 26 08 00      mov b, 8
0604   01D3 07 63 03      call wait_xs
0605   01D6 F2 C8 FF 53   mov byte [_fdc_stat_cmd], %01010011   ; step in
0606   01DA E5            pop b
0607   01DB 6C 01         add bl, 1
0608   01DD C1 28         cmp bl, 40
0609   01DF C7 A3 01      jne fdc_formatdisk512_l0
0610   01E2 06            sysret
0611   01E3             
0612   01E3             ; di : destination in user space
0613   01E3             ; a  : returns number of read bytes
0614   01E3             syscall_fdc_read_track:
0615   01E3 07 7B 02      call fdc_wait_not_busy
0616   01E6 E3            push di
0617   01E7 FD 4F 61 33   mov di, transient_area
0618   01EB F2 C8 FF E8   mov byte [_fdc_stat_cmd], %11101000
0619   01EF 07 5C 03      call fdc_wait_64us
0620   01F2             fdc_read_track_l0: ; for each byte, we need to wait for drq to be high
0621   01F2 1D C8 FF      mov al, [_fdc_stat_cmd]      ; 
0622   01F5 93 01         test al, $01                ; check busy bit
0623   01F7 C6 06 02      jz fdc_read_track_end
0624   01FA 93 02         test al, $02                ; check drq bit
0625   01FC C6 F2 01      jz fdc_read_track_l0
0626   01FF 1D CB FF      mov al, [_fdc_data]     ; 
0627   0202 F7            stosb
0628   0203 0A F2 01      jmp fdc_read_track_l0
0629   0206             ;we need to check if writing to data reg causes a spurious read. so lets check inside the writing loop, how many times we actually write the bytes
0630   0206             ;say the 40 byte loop. if we find that we only write ~20 times, then this indcates this problem.
0631   0206             ;because for every write, if it also reads, then that clears drq, so we need to wait for next drq.
0632   0206             fdc_read_track_end:
0633   0206 50            mov a, di
0634   0207 5F 61 33      sub a, transient_area
0635   020A F0            pop di
0636   020B FD 4D 61 33   mov si, transient_area
0637   020F 39            mov c, a  ; copy track over to user space
0638   0210 03            store
0639   0211 06            sysret
0640   0212             
0641   0212             ; sector in bl
0642   0212             ; track in bh
0643   0212             ; di = user space destination
0644   0212             syscall_fdc_read_sect:
0645   0212 07 7B 02      call fdc_wait_not_busy
0646   0215 E3            push di
0647   0216 FD 3D CA FF   mov [_fdc_sector], bl
0648   021A 30            mov bl, bh
0649   021B FD 3D C9 FF   mov [_fdc_track], bl
0650   021F F2 C8 FF 88   mov byte [_fdc_stat_cmd], %10001000
0651   0223 07 5C 03      call fdc_wait_64us
0652   0226 FD 4F 61 33   mov di, transient_area
0653   022A             fdc_read_sect_l0: ; for each byte, we need to wait for drq to be high
0654   022A 1D C8 FF      mov al, [_fdc_stat_cmd]      ; read lost data flag 10+3+5+8+5+8
0655   022D 93 01         test al, $01                ; check drq bit
0656   022F C6 3E 02      jz fdc_read_sect_end
0657   0232 93 02         test al, $02                ; check drq bit
0658   0234 C6 2A 02      jz fdc_read_sect_l0
0659   0237 1D CB FF      mov al, [_fdc_data]     ; 
0660   023A F7            stosb
0661   023B 0A 2A 02      jmp fdc_read_sect_l0
0662   023E             fdc_read_sect_end:
0663   023E 50            mov a, di
0664   023F 5F 61 33      sub a, transient_area
0665   0242 F0            pop di
0666   0243 FD 4D 61 33   mov si, transient_area
0667   0247 39            mov c, a  ; copy sector over to user space
0668   0248 03            store
0669   0249 06            sysret
0670   024A             
0671   024A             ; sector size in c
0672   024A             ; sector in bl
0673   024A             ; track in bh
0674   024A             ; data pointer in si
0675   024A             syscall_fdc_write_sect:
0676   024A 07 7B 02      call fdc_wait_not_busy
0677   024D FD 3D CA FF   mov [_fdc_sector], bl
0678   0251 30            mov bl, bh
0679   0252 FD 3D C9 FF   mov [_fdc_track], bl
0680   0256 FD 4F 61 33   mov di, transient_area    ; si = data source, di = destination 
0681   025A 04            load                    ; transfer data to kernel space!
0682   025B FD 4D 61 33   mov si, transient_area
0683   025F F2 C8 FF AA   mov byte [_fdc_stat_cmd], %10101010            ; 101, 0:single sector, 1: disable spinup, 0: no delay, 1: no precomp, 0: normal data mark
0684   0263 07 5C 03      call fdc_wait_64us
0685   0266             fdc_write_sect_l0: ; for each byte, we need to wait for drq to be high
0686   0266 1D C8 FF      mov al, [_fdc_stat_cmd]         ; 10
0687   0269 93 01         test al, $01                    ; 4
0688   026B C6 7A 02      jz fdc_write_sect_end           ; 8
0689   026E 93 02         test al, $02                    ; 4
0690   0270 C6 66 02      jz fdc_write_sect_l0            ; 8
0691   0273 F6            lodsb                           ; 7
0692   0274 3D CB FF      mov [_fdc_data], al             ; 10   
0693   0277 0A 66 02      jmp fdc_write_sect_l0
0694   027A             fdc_write_sect_end:
0695   027A 06            sysret
0696   027B             
0697   027B             fdc_wait_not_busy:
0698   027B DB            push al
0699   027C             fdc_wait_not_busy_l0:
0700   027C 1D C8 FF      mov al, [_fdc_stat_cmd]   
0701   027F 93 01         test al, $01               
0702   0281 C7 7C 02      jnz fdc_wait_not_busy_l0          
0703   0284 E8            pop al
0704   0285 09            ret
0705   0286             
0706   0286             ; track number in bl
0707   0286             fdc_format_mem_128:
0708   0286 3B 01 00      mov d, 1
0709   0289 FD 4F 61 33   mov di, transient_area
0710   028D             ; 40 * FF
0711   028D 38 28 00      mov c, 40
0712   0290 19 FF         mov al, $ff
0713   0292             fdc_l0: 
0714   0292 F7            stosb
0715   0293 7E            dec c
0716   0294 C7 92 02      jnz fdc_l0
0717   0297             ; 6 * 00
0718   0297             fdc_inner_loop:
0719   0297 38 06 00      mov c, 6
0720   029A 19 00         mov al, $00
0721   029C             fdc_l1:
0722   029C F7            stosb
0723   029D 7E            dec c
0724   029E C7 9C 02      jnz fdc_l1
0725   02A1             ; FE address mark
0726   02A1             fdc_l2:
0727   02A1 19 FE         mov al, $fe
0728   02A3 F7            stosb
0729   02A4             ; track number
0730   02A4             fdc_l3:
0731   02A4 1B            mov al, bl  ; track number in bl
0732   02A5 F7            stosb
0733   02A6             ; side number
0734   02A6             fdc_l4:
0735   02A6 19 00         mov al, $00
0736   02A8 F7            stosb
0737   02A9             ; sector number
0738   02A9             fdc_l5:
0739   02A9 13            mov a, d
0740   02AA F7            stosb
0741   02AB             ; sector length 128 bytes
0742   02AB             fdc_l6:
0743   02AB 19 00         mov al, $00
0744   02AD F7            stosb
0745   02AE             ; 2 crc's
0746   02AE             fdc_l7:
0747   02AE 19 F7         mov al, $f7
0748   02B0 F7            stosb
0749   02B1             ; 11 times $ff
0750   02B1 38 0B 00      mov c, 11
0751   02B4 19 FF         mov al, $ff
0752   02B6             fdc_l8:
0753   02B6 F7            stosb
0754   02B7 7E            dec c
0755   02B8 C7 B6 02      jnz fdc_l8
0756   02BB             ; 6 times 00
0757   02BB 38 06 00      mov c, 6
0758   02BE 19 00         mov al, $00
0759   02C0             fdc_l9:
0760   02C0 F7            stosb
0761   02C1 7E            dec c
0762   02C2 C7 C0 02      jnz fdc_l9
0763   02C5             ; FB data address mark
0764   02C5 19 FB         mov al, $fb
0765   02C7             fdc_l10:
0766   02C7 F7            stosb
0767   02C8             ; 128 bytes sector data
0768   02C8 38 80 00      mov c, 128
0769   02CB 19 E5         mov al, $E5
0770   02CD             fdc_l11:
0771   02CD F7            stosb
0772   02CE 7E            dec c
0773   02CF C7 CD 02      jnz fdc_l11
0774   02D2             ; 2 crc's
0775   02D2             fdc_l12:
0776   02D2 19 F7         mov al, $f7
0777   02D4 F7            stosb
0778   02D5             ; 10 * $FF
0779   02D5 38 0A 00      mov c, 10
0780   02D8 19 FF         mov al, $ff
0781   02DA             fdc_l13:
0782   02DA F7            stosb
0783   02DB 7E            dec c
0784   02DC C7 DA 02      jnz fdc_l13
0785   02DF             ; check whether we did this 16 times
0786   02DF 79            inc d
0787   02E0 C5 11 00      cmp d, 17
0788   02E3 C7 97 02      jne fdc_inner_loop
0789   02E6             ; 500 bytes of FF for end filler. wd1770 writes these until it finishes, so the number varies. usually it writes ~450 bytes
0790   02E6 38 F4 01      mov c, 500
0791   02E9 19 FF         mov al, $ff
0792   02EB             fdc_format_footer:
0793   02EB             fdc_footer_drq_loop:
0794   02EB F7            stosb
0795   02EC 7E            dec c
0796   02ED C7 EB 02      jnz fdc_footer_drq_loop
0797   02F0 09            ret
0798   02F1             
0799   02F1             ; track number in bl
0800   02F1             fdc_format_mem_512:
0801   02F1 3B 01 00      mov d, 1
0802   02F4 FD 4F 61 33   mov di, transient_area
0803   02F8             ; 40 * FF
0804   02F8 38 28 00      mov c, 40
0805   02FB 19 FF         mov al, $ff
0806   02FD             fdc_512_l0: 
0807   02FD F7            stosb
0808   02FE 7E            dec c
0809   02FF C7 FD 02      jnz fdc_512_l0
0810   0302             ; 6 * 00
0811   0302             fdc_512_inner_loop:
0812   0302 38 06 00      mov c, 6
0813   0305 19 00         mov al, $00
0814   0307             fdc_512_l1:
0815   0307 F7            stosb
0816   0308 7E            dec c
0817   0309 C7 07 03      jnz fdc_512_l1
0818   030C             ; FE address mark
0819   030C             fdc_512_l2:
0820   030C 19 FE         mov al, $fe
0821   030E F7            stosb
0822   030F             ; track number
0823   030F             fdc_512_l3:
0824   030F 1B            mov al, bl ; track number was in bl
0825   0310 F7            stosb
0826   0311             ; side number
0827   0311             fdc_512_l4:
0828   0311 19 00         mov al, $00
0829   0313 F7            stosb
0830   0314             ; sector number
0831   0314             fdc_512_l5:
0832   0314 13            mov a, d
0833   0315 F7            stosb
0834   0316             ; sector length 512 bytes
0835   0316             fdc_512_l6:
0836   0316 19 02         mov al, $02
0837   0318 F7            stosb
0838   0319             ; 2 crc's
0839   0319             fdc_512_l7:
0840   0319 19 F7         mov al, $f7
0841   031B F7            stosb
0842   031C             ; 11 times $ff
0843   031C 38 0B 00      mov c, 11
0844   031F 19 FF         mov al, $ff
0845   0321             fdc_512_l8:
0846   0321 F7            stosb
0847   0322 7E            dec c
0848   0323 C7 21 03      jnz fdc_512_l8
0849   0326             ; 6 times 00
0850   0326 38 06 00      mov c, 6
0851   0329 19 00         mov al, $00
0852   032B             fdc_512_l9:
0853   032B F7            stosb
0854   032C 7E            dec c
0855   032D C7 2B 03      jnz fdc_512_l9
0856   0330             ; FB data address mark
0857   0330 19 FB         mov al, $fb
0858   0332             fdc_512_l10:
0859   0332 F7            stosb
0860   0333             ; 128 bytes sector data
0861   0333 38 00 02      mov c, 512
0862   0336 19 E5         mov al, $E5
0863   0338             fdc_512_l11:
0864   0338 F7            stosb
0865   0339 7E            dec c
0866   033A C7 38 03      jnz fdc_512_l11
0867   033D             ; 2 crc's
0868   033D             fdc_512_l12:
0869   033D 19 F7         mov al, $f7
0870   033F F7            stosb
0871   0340             ; 10 * $FF
0872   0340 38 0A 00      mov c, 10
0873   0343 19 FF         mov al, $ff
0874   0345             fdc_512_l13:
0875   0345 F7            stosb
0876   0346 7E            dec c
0877   0347 C7 45 03      jnz fdc_512_l13
0878   034A             ; check whether we did this 16 times
0879   034A 79            inc d
0880   034B C5 06 00      cmp d, 6
0881   034E C7 02 03      jne fdc_512_inner_loop
0882   0351             ; 500 bytes of FF for end filler. wd1770 writes these until it finishes, so the number varies. usually it writes ~450 bytes
0883   0351 38 F4 01      mov c, 500
0884   0354 19 FF         mov al, $ff
0885   0356             fdc_512_format_footer:
0886   0356             fdc_512_footer_drq_loop:
0887   0356 F7            stosb
0888   0357 7E            dec c
0889   0358 C7 56 03      jnz fdc_512_footer_drq_loop
0890   035B 09            ret
0891   035C             
0892   035C             ; fetch is 2 cycles long when 'display_reg_load' is false.
0893   035C             ; 64us amounts to 160 cycles of the 2.5mhz clock
0894   035C             ; call u16 is 14 cycles long
0895   035C             ; 160 - 5 - 14 = 
0896   035C             fdc_wait_64us:
0897   035C 3A 0D         mov cl, 13                       ; 5 cycles
0898   035E             fdc_wait_64_loop:
0899   035E 81            dec cl                           ; 3 cycles
0900   035F C7 5E 03      jnz fdc_wait_64_loop             ; 8 cycles
0901   0362 09            ret
0902   0363             
0903   0363             ; number of seconds in b
0904   0363             wait_xs:
0905   0363 C0 00 00      cmp b, 0
0906   0366 C6 71 03      je wait_xs_end
0907   0369 07 72 03      call wait_1s
0908   036C FD 7D         dec b
0909   036E 0A 63 03      jmp wait_xs
0910   0371             wait_xs_end:
0911   0371 09            ret
0912   0372             
0913   0372             wait_1s:
0914   0372 DB            push al
0915   0373 D9            push c
0916   0374 19 03         mov al, 3
0917   0376             wait_1s_l0:
0918   0376 38 FF FF      mov c, 65535                       
0919   0379             wait_1s_l1:
0920   0379 7E            dec c        ; 4
0921   037A C7 79 03      jnz wait_1s_l1   ; 8
0922   037D 80            dec al
0923   037E C7 76 03      jnz wait_1s_l0
0924   0381 E6            pop c
0925   0382 E8            pop al
0926   0383 09            ret
0927   0384             
0928   0384             ; ------------------------------------------------------------------------------------------------------------------;
0929   0384             ; system syscalls
0930   0384             ; ------------------------------------------------------------------------------------------------------------------;
0931   0384             system_jmptbl:
0932   0384 BA 03         .dw system_uname
0933   0386 C1 03         .dw system_whoami
0934   0388 94 03         .dw system_poke
0935   038A 97 03         .dw system_bootloader_install
0936   038C 92 03         .dw system_peek
0937   038E             syscall_system:
0938   038E FD 0A 84 03   jmp [system_jmptbl + al]
0939   0392             
0940   0392             ; param register address in register d
0941   0392             ; param value in register bl
0942   0392             system_peek:
0943   0392 32            mov bl, [d]
0944   0393 06            sysret
0945   0394             
0946   0394             ; param register address in register d
0947   0394             ; param value in register bl
0948   0394             system_poke:
0949   0394 FD 3E         mov [d], bl
0950   0396 06            sysret
0951   0397             
0952   0397             ; kernel LBA address in 'b'
0953   0397             system_bootloader_install:
0954   0397 D8            push b
0955   0398 26 00 00      mov b, 0
0956   039B 38 00 00      mov c, 0
0957   039E 22 01         mov ah, $01                 ; 1 sector
0958   03A0 3B 61 33      mov d, transient_area
0959   03A3 07 BE 06      call ide_read_sect          ; read sector
0960   03A6 E5            pop b
0961   03A7 FD 44 FE 01   mov [d + 510], b            ; update LBA address
0962   03AB 26 00 00      mov b, 0
0963   03AE 38 00 00      mov c, 0
0964   03B1 22 01         mov ah, $01                 ; 1 sector
0965   03B3 3B 61 33      mov d, transient_area
0966   03B6 07 E4 06      call ide_write_sect         ; write sector
0967   03B9 06            sysret
0968   03BA             
0969   03BA             system_uname:
0970   03BA 3B 6B 19      mov d, s_uname
0971   03BD 07 82 02      call _puts
0972   03C0 06            sysret
0973   03C1             
0974   03C1             system_whoami:
0975   03C1 06            sysret
0976   03C2             
0977   03C2             ; reboot system
0978   03C2             syscall_reboot:
0979   03C2 FD D7 FF FF   push word $ffff 
0980   03C6 FD DB 00      push byte %00000000             ; dma_ack = 0, interrupts disabled, mode = supervisor, paging = off, halt=0, display_reg_load=0, dir=0
0981   03C9 FD D7 C0 01   push word bios_reset_vector     ; and then push reset vector of the shell to the stack
0982   03CD 06            sysret
0983   03CE             
0984   03CE             ;------------------------------------------------------------------------------------------------------;;
0985   03CE             ; switch to another process
0986   03CE             ; inputs:
0987   03CE             ; al = new process number
0988   03CE             ;------------------------------------------------------------------------------------------------------;;
0989   03CE             syscall_resume_proc:
0990   03CE FD 78         mov g, a                            ; save the process number
0991   03D0 4B            pusha                               ; save all registers into kernel stack
0992   03D1 22 00         mov ah, 0
0993   03D3 1D 55 19      mov al, [active_proc_index]
0994   03D6 FD 99         shl a              ; x2
0995   03D8 B7 8D 11      mov a, [proc_table_convert + a]     ; get process state start index
0996   03DB 4F            mov di, a
0997   03DC 48            mov a, sp
0998   03DD 77            inc a
0999   03DE 4D            mov si, a
1000   03DF 38 14 00      mov c, 20
1001   03E2 FD F5         rep movsb                           ; save process state!
1002   03E4             ; restore kernel stack position to point before interrupt arrived
1003   03E4 51 14 00      add sp, 20
1004   03E7             ; now load the new process number!
1005   03E7 FD 12         mov a, g                            ; retrieve the process number argument that was saved in the beginning
1006   03E9 3D 55 19      mov [active_proc_index], al         ; set new active proc
1007   03EC             ; calculate lut entry for next process
1008   03EC 22 00         mov ah, 0
1009   03EE FD 99         shl a                               ; x2
1010   03F0 B7 8D 11      mov a, [proc_table_convert + a]     ; get process state start index  
1011   03F3 4D            mov si, a                           ; source is proc state block
1012   03F4 48            mov a, sp
1013   03F5 5F 13 00      sub a, 19
1014   03F8 4F            mov di, a                           ; destination is kernel stack
1015   03F9             ; restore sp
1016   03F9 7D            dec a
1017   03FA 47            mov sp, a
1018   03FB 38 14 00      mov c, 20
1019   03FE FD F5         rep movsb
1020   0400             ; set vm process
1021   0400 1D 55 19      mov al, [active_proc_index]
1022   0403 01            setptb
1023   0404 4C            popa
1024   0405 06            sysret
1025   0406             
1026   0406             ;------------------------------------------------------------------------------------------------------;;
1027   0406             ; list processes
1028   0406             ;------------------------------------------------------------------------------------------------------;;
1029   0406             syscall_list_procs:
1030   0406 3B 8C 19      mov d, s_ps_header
1031   0409 07 82 02      call _puts
1032   040C 3B D2 1C      mov d, proc_availab_table + 1
1033   040F 38 01 00      mov c, 1
1034   0412             list_procs_l0:  
1035   0412 BD 01         cmp byte[d], 1
1036   0414 C7 38 04      jne list_procs_next
1037   0417 2D            mov b, d
1038   0418 61 D1 1C      sub b, proc_availab_table
1039   041B FD 9F 05      shl b, 5
1040   041E DA            push d
1041   041F D8            push b
1042   0420 28            mov b, c
1043   0421 07 BF 14      call print_u8x
1044   0424 22 20         mov ah, ' '
1045   0426 07 F3 12      call _putchar
1046   0429 07 F3 12      call _putchar
1047   042C E5            pop b
1048   042D 74            mov d, b
1049   042E 58 E1 1C      add d, proc_names
1050   0431 07 82 02      call _puts
1051   0434 07 CC 13      call printnl
1052   0437 E7            pop d
1053   0438             list_procs_next:
1054   0438 79            inc d
1055   0439 78            inc c
1056   043A C2 09 00      cmp c, 9
1057   043D C7 12 04      jne list_procs_l0
1058   0440             list_procs_end:
1059   0440 06            sysret
1060   0441             
1061   0441             ; ------------------------------------------------------------------------------------------------------------------;
1062   0441             ; exceptions code block
1063   0441             ; ------------------------------------------------------------------------------------------------------------------;
1064   0441             ; privilege exception
1065   0441             ; ------------------------------------------------------------------------------------------------------------------;
1066   0441             trap_privilege:
1067   0441 0A C2 03      jmp syscall_reboot
1068   0444 DA            push d
1069   0445 3B 82 1A      mov d, s_priviledge
1070   0448 07 82 02      call _puts
1071   044B E7            pop d
1072   044C 06            sysret
1073   044D             
1074   044D             ; ------------------------------------------------------------------------------------------------------------------;
1075   044D             ; breakpoint
1076   044D             ; important: values in the stack are being pushed in big endian. i.e.: msb at low address
1077   044D             ; and lsb at high address. *** need to correct this in the microcode and make it little endian again ***
1078   044D             ; ------------------------------------------------------------------------------------------------------------------;
1079   044D             syscall_break:
1080   044D 4B            pusha
1081   044E             syscall_break_prompt:
1082   044E 3B 08 05      mov d, s_break1
1083   0451 07 82 02      call _puts
1084   0454 07 CC 13      call printnl
1085   0457 07 21 15      call scan_u16d
1086   045A AF 00 00      cmp a, 0
1087   045D C6 68 04      je syscall_break_regs
1088   0460 AF 01 00      cmp a, 1
1089   0463 C6 8B 04      je syscall_break_mem
1090   0466             syscall_break_end:  
1091   0466 4C            popa
1092   0467 06            sysret
1093   0468             syscall_break_regs:
1094   0468 48            mov a, sp
1095   0469 53 0E 00      add a, 14               ; back-track 7 registers
1096   046C 3C            mov d, a
1097   046D 3A 07         mov cl, 7
1098   046F             syscall_regs_l0:
1099   046F 2A            mov b, [d]
1100   0470 FD AB         swp b
1101   0472 07 7B 14      call print_u16x         ; print register value
1102   0475 07 CC 13      call printnl
1103   0478 63 02 00      sub d, 2
1104   047B 71 01         sub cl, 1
1105   047D C3 00         cmp cl, 0
1106   047F C7 6F 04      jne syscall_regs_l0
1107   0482 0A 4E 04      jmp syscall_break_prompt
1108   0485 07 CC 13      call printnl
1109   0488 0A 4E 04      jmp syscall_break_prompt
1110   048B             syscall_break_mem:
1111   048B 07 CC 13      call printnl
1112   048E 07 9D 14      call scan_u16x
1113   0491 4D            mov si, a               ; data source from user space
1114   0492 FD 4F 61 31   mov di, scrap_sector    ; destination in kernel space
1115   0496 38 00 02      mov c, 512
1116   0499 04            load                    ; transfer data to kernel space!
1117   049A 3B 61 31      mov d, scrap_sector     ; dump pointer in d
1118   049D 38 00 00      mov c, 0
1119   04A0             dump_loop:
1120   04A0 84            mov al, cl
1121   04A1 87 0F         and al, $0f
1122   04A3 C6 F1 04      jz print_base
1123   04A6             back:
1124   04A6 1E            mov al, [d]             ; read byte
1125   04A7 2F            mov bl, al
1126   04A8 07 BF 14      call print_u8x
1127   04AB 10 00 20      mov a, $2000
1128   04AE 05 03         syscall sys_io          ; space
1129   04B0 84            mov al, cl
1130   04B1 87 0F         and al, $0f
1131   04B3 B9 0F         cmp al, $0f
1132   04B5 C6 C6 04      je print_ascii
1133   04B8             back1:
1134   04B8 79            inc d
1135   04B9 78            inc c
1136   04BA C2 00 02      cmp c, 512
1137   04BD C7 A0 04      jne dump_loop
1138   04C0 07 CC 13      call printnl
1139   04C3 0A 4E 04      jmp syscall_break_prompt  ; go to syscall_break return point
1140   04C6             print_ascii:
1141   04C6 10 00 20      mov a, $2000
1142   04C9 05 03         syscall sys_io
1143   04CB 63 10 00      sub d, 16
1144   04CE 26 10 00      mov b, 16
1145   04D1             print_ascii_l:
1146   04D1 79            inc d
1147   04D2 1E            mov al, [d]               ; read byte
1148   04D3 B9 20         cmp al, $20
1149   04D5 C8 DD 04      jlu dot
1150   04D8 B9 7E         cmp al, $7e
1151   04DA D0 E5 04      jleu ascii
1152   04DD             dot:
1153   04DD 10 00 2E      mov a, $2e00
1154   04E0 05 03         syscall sys_io
1155   04E2 0A EA 04      jmp ascii_continue
1156   04E5             ascii:
1157   04E5 23            mov ah, al
1158   04E6 19 00         mov al, 0
1159   04E8 05 03         syscall sys_io
1160   04EA             ascii_continue:
1161   04EA FD A9 D1 04   loopb print_ascii_l
1162   04EE 0A B8 04      jmp back1
1163   04F1             print_base:
1164   04F1 07 CC 13      call printnl
1165   04F4 2D            mov b, d
1166   04F5 61 61 31      sub b, scrap_sector      ; remove this later and fix address bases which display incorrectly
1167   04F8 07 7B 14      call print_u16x          ; display row
1168   04FB 10 00 3A      mov a, $3a00
1169   04FE 05 03         syscall sys_io
1170   0500 10 00 20      mov a, $2000
1171   0503 05 03         syscall sys_io
1172   0505 0A A6 04      jmp back
1173   0508             
1174   0508             s_break1:  
1175   0508 0A 64 65 62   .db "\ndebugger entry point.\n"
1175   050C 75 67 67 65 
1175   0510 72 20 65 6E 
1175   0514 74 72 79 20 
1175   0518 70 6F 69 6E 
1175   051C 74 2E 0A 
1176   051F 30 2E 20 73   .db "0. show registers\n"
1176   0523 68 6F 77 20 
1176   0527 72 65 67 69 
1176   052B 73 74 65 72 
1176   052F 73 0A 
1177   0531 31 2E 20 73   .db "1. show 512b ram block\n"
1177   0535 68 6F 77 20 
1177   0539 35 31 32 62 
1177   053D 20 72 61 6D 
1177   0541 20 62 6C 6F 
1177   0545 63 6B 0A 
1178   0548 32 2E 20 63   .db "2. continue execution", 0
1178   054C 6F 6E 74 69 
1178   0550 6E 75 65 20 
1178   0554 65 78 65 63 
1178   0558 75 74 69 6F 
1178   055C 6E 00 
1179   055E             
1180   055E             ; ------------------------------------------------------------------------------------------------------------------;
1181   055E             ; divide by zero exception
1182   055E             ; ------------------------------------------------------------------------------------------------------------------;
1183   055E             trap_div_zero:
1184   055E D7            push a
1185   055F DA            push d
1186   0560 E1            pushf
1187   0561 3B 99 1A      mov d, s_divzero
1188   0564 07 82 02      call _puts
1189   0567 EE            popf
1190   0568 E7            pop d
1191   0569 E4            pop a
1192   056A 06            sysret ; enable interrupts
1193   056B             
1194   056B             ; ------------------------------------------------------------------------------------------------------------------;
1195   056B             ; undefined opcode exception
1196   056B             ; ------------------------------------------------------------------------------------------------------------------;
1197   056B             trap_undef_opcode:
1198   056B 06            sysret
1199   056C             
1200   056C             ; ------------------------------------------------------------------------------------------------------------------;
1201   056C             ; real-time clock services syscall
1202   056C             ; rtc i/o bank = ffa0 to ffaf
1203   056C             ; ffa0 to ffa7 is scratch ram
1204   056C             ; control register at $ffa8 [ w | r | s | cal4..cal0 ]
1205   056C             ; al = 0..6 -> get
1206   056C             ; al = 7..d -> set
1207   056C             ; ------------------------------------------------------------------------------------------------------------------;
1208   056C             syscall_rtc:
1209   056C DB            push al
1210   056D DA            push d
1211   056E B9 06         cmp al, 6
1212   0570 D1 85 05      jgu syscall_rtc_set
1213   0573             syscall_rtc_get:
1214   0573 6A A9         add al, $a9             ; generate rtc address to get to address a9 of clock
1215   0575 22 FF         mov ah, $ff    
1216   0577 3C            mov d, a                ; get to ffa9 + offset
1217   0578 F2 A8 FF 40   mov byte[$ffa8], $40    ; set r bit to 1
1218   057C 1E            mov al, [d]             ; get data
1219   057D F2 A8 FF 00   mov byte[$ffa8], 0      ; reset r bit
1220   0581 23            mov ah, al
1221   0582 E7            pop d
1222   0583 E8            pop al
1223   0584 06            sysret
1224   0585             syscall_rtc_set:
1225   0585 DD            push bl
1226   0586 99            mov bl, ah              ; set data aside
1227   0587 6A A2         add al, $a2             ; generate rtc address to get to address a9 of clock
1228   0589 22 FF         mov ah, $ff    
1229   058B 3C            mov d, a                ; get to ffa9 + offset
1230   058C 1B            mov al, bl              ; get data back
1231   058D F2 A8 FF 80   mov byte[$ffa8], $80    ; set w bit to 1
1232   0591 3E            mov [d], al             ; set data
1233   0592 F2 A8 FF 00   mov byte[$ffa8], 0      ; reset write bit
1234   0596 EA            pop bl
1235   0597 E7            pop d
1236   0598 E8            pop al
1237   0599 06            sysret
1238   059A             
1239   059A             datetime_serv_tbl:
1240   059A A2 05         .dw print_date
1241   059C 16 06         .dw set_date
1242   059E             syscall_datetime:
1243   059E FD 0A 9A 05   jmp [datetime_serv_tbl + al]      
1244   05A2             print_date:
1245   05A2 10 00 0D      mov a, $0d00           ; print carriage return char
1246   05A5 19 03         mov al, 3
1247   05A7 05 01         syscall sys_rtc        ; get week
1248   05A9 1A            mov al, ah
1249   05AA 22 00         mov ah, 0
1250   05AC FD 9D 02      shl a, 2          
1251   05AF 3B 23 1B      mov d, s_week
1252   05B2 59            add d, a
1253   05B3 07 82 02      call _puts
1254   05B6 10 00 20      mov a, $2000
1255   05B9 05 03         syscall sys_io         ; display ' '
1256   05BB 19 04         mov al, 4
1257   05BD 05 01         syscall sys_rtc        ; get day
1258   05BF 99            mov bl, ah
1259   05C0 07 BF 14      call print_u8x
1260   05C3 10 00 20      mov a, $2000
1261   05C6 05 03         syscall sys_io         ; display ' '
1262   05C8             ; there is a problem with the month displaying
1263   05C8             ; the month is stored as bcd. so when retrieving the month, the value will be in binary
1264   05C8             ; even though it is to be understood as bcd.
1265   05C8             ; when retrieving the value and adding the string table address offset the value will go overboard!  
1266   05C8 19 05         mov al, 05
1267   05CA 05 01         syscall sys_rtc        ; get month
1268   05CC 1A            mov al, ah
1269   05CD 22 00         mov ah, 0
1270   05CF FD 9D 02      shl a, 2          
1271   05D2 3B EF 1A      mov d, s_months
1272   05D5 59            add d, a
1273   05D6 07 82 02      call _puts
1274   05D9 10 00 20      mov a, $2000
1275   05DC 05 03         syscall sys_io         ; display ' '
1276   05DE 2E 20         mov bl, $20
1277   05E0 07 BF 14      call print_u8x         ; print 20 for year prefix
1278   05E3 19 06         mov al, 06
1279   05E5 05 01         syscall sys_rtc        ; get year
1280   05E7 99            mov bl, ah
1281   05E8 07 BF 14      call print_u8x
1282   05EB 10 00 20      mov a, $2000  
1283   05EE 05 03         syscall sys_io         ; display ' '
1284   05F0 19 02         mov al, 2
1285   05F2 05 01         syscall sys_rtc        ; get hours
1286   05F4 99            mov bl, ah
1287   05F5 07 BF 14      call print_u8x
1288   05F8 10 00 3A      mov a, $3a00    
1289   05FB 05 03         syscall sys_io         ; display ':'
1290   05FD 19 01         mov al, 01
1291   05FF 05 01         syscall sys_rtc        ; get minutes
1292   0601 99            mov bl, ah
1293   0602 07 BF 14      call print_u8x
1294   0605 10 00 3A      mov a, $3a00  
1295   0608 05 03         syscall sys_io         ; display ':'
1296   060A 19 00         mov al, 0
1297   060C 05 01         syscall sys_rtc        ; get seconds
1298   060E 99            mov bl, ah
1299   060F 07 BF 14      call print_u8x
1300   0612 07 CC 13      call printnl
1301   0615 06            sysret
1302   0616             set_date:
1303   0616 3B B4 1A      mov d, s_set_year
1304   0619 07 82 02      call _puts
1305   061C 07 0A 15      call scan_u8x          ; read integer into a
1306   061F FD 9D 08      shl a, 8               ; only al used, move to ah
1307   0622 19 0D         mov al, 0dh            ; set rtc year
1308   0624 05 01         syscall sys_rtc        ; set rtc
1309   0626 3B BB 1A      mov d, s_set_month
1310   0629 07 82 02      call _puts
1311   062C 07 0A 15      call scan_u8x          ; read integer into a
1312   062F FD 9D 08      shl a, 8               ; only al used, move to ah
1313   0632 19 0C         mov al, 0ch            ; set rtc month
1314   0634 05 01         syscall sys_rtc        ; set rtc
1315   0636 3B C3 1A      mov d, s_set_day
1316   0639 07 82 02      call _puts
1317   063C 07 0A 15      call scan_u8x          ; read integer into a
1318   063F FD 9D 08      shl a, 8               ; only al used, move to ah
1319   0642 19 0B         mov al, 0bh            ; set rtc month
1320   0644 05 01         syscall sys_rtc        ; set rtc
1321   0646 3B C9 1A      mov d, s_set_week
1322   0649 07 82 02      call _puts
1323   064C 07 0A 15      call scan_u8x          ; read integer into a
1324   064F FD 9D 08      shl a, 8               ; only al used, move to ah
1325   0652 19 0A         mov al, 0ah            ; set rtc month
1326   0654 05 01         syscall sys_rtc        ; set rtc
1327   0656 3B D3 1A      mov d, s_set_hours
1328   0659 07 82 02      call _puts
1329   065C 07 0A 15      call scan_u8x          ; read integer into a
1330   065F FD 9D 08      shl a, 8               ; only al used, move to ah
1331   0662 19 09         mov al, 09h            ; set rtc month
1332   0664 05 01         syscall sys_rtc        ; set rtc
1333   0666 3B DB 1A      mov d, s_set_minutes
1334   0669 07 82 02      call _puts
1335   066C 07 0A 15      call scan_u8x          ; read integer into a
1336   066F FD 9D 08      shl a, 8               ; only al used, move to ah
1337   0672 19 08         mov al, 08h            ; set rtc month
1338   0674 05 01         syscall sys_rtc        ; set rtc
1339   0676 3B E5 1A      mov d, s_set_seconds
1340   0679 07 82 02      call _puts
1341   067C 07 0A 15      call scan_u8x          ; read integer into a
1342   067F FD 9D 08      shl a, 8               ; only al used, move to ah
1343   0682 19 07         mov al, 07h            ; set rtc month
1344   0684 05 01         syscall sys_rtc        ; set rtc
1345   0686 06            sysret
1346   0687             
1347   0687             ; ------------------------------------------------------------------------------------------------------------------;
1348   0687             ; ide services syscall
1349   0687             ; al = option
1350   0687             ; 0 = ide reset, 1 = ide sleep, 2 = read sector, 3 = write sector
1351   0687             ; ide read/write sector
1352   0687             ; 512 bytes
1353   0687             ; user buffer pointer in d
1354   0687             ; ah = number of sectors
1355   0687             ; cb = lba bytes 3..0
1356   0687             ; ------------------------------------------------------------------------------------------------------------------;
1357   0687             ide_serv_tbl:
1358   0687 93 06         .dw ide_reset
1359   0689 A7 06         .dw ide_sleep
1360   068B B6 06         .dw ide_read_sect_wrapper
1361   068D BA 06         .dw ide_write_sect_wrapper
1362   068F             syscall_ide:
1363   068F FD 0A 87 06   jmp [ide_serv_tbl + al]    
1364   0693             
1365   0693             ide_reset:      
1366   0693 F2 D7 FF 04   mov byte[_ide_r7], 4            ; reset ide
1367   0697 07 40 07      call ide_wait                   ; wait for ide ready             
1368   069A F2 D6 FF E0   mov byte[_ide_r6], $e0          ; lba3= 0, master, mode= lba        
1369   069E F2 D1 FF 01   mov byte[_ide_r1], 1            ; 8-bit transfers      
1370   06A2 F2 D7 FF EF   mov byte[_ide_r7], $ef          ; set feature command
1371   06A6 06            sysret
1372   06A7             ide_sleep:
1373   06A7 07 40 07      call ide_wait                   ; wait for ide ready             
1374   06AA F2 D6 FF 40   mov byte [_ide_r6], %01000000   ; lba[3:0](reserved), bit 6=1
1375   06AE F2 D7 FF E6   mov byte [_ide_r7], $e6         ; sleep command
1376   06B2 07 40 07      call ide_wait                   ; wait for ide ready
1377   06B5 06            sysret
1378   06B6             ide_read_sect_wrapper:
1379   06B6 07 BE 06      call ide_read_sect
1380   06B9 06            sysret
1381   06BA             ide_write_sect_wrapper:
1382   06BA 07 E4 06      call ide_write_sect
1383   06BD 06            sysret
1384   06BE             ide_read_sect:
1385   06BE 1A            mov al, ah
1386   06BF 24            mov ah, bl
1387   06C0 42 D2 FF      mov [_ide_r2], a                ; number of sectors (0..255)
1388   06C3 1C            mov al, bh
1389   06C4 3D D4 FF      mov [_ide_r4], al
1390   06C7 12            mov a, c
1391   06C8 3D D5 FF      mov [_ide_r5], al
1392   06CB 1A            mov al, ah
1393   06CC 87 0F         and al, %00001111
1394   06CE 8B E0         or al, %11100000                ; mode lba, master
1395   06D0 3D D6 FF      mov [_ide_r6], al
1396   06D3             ide_read_sect_wait:
1397   06D3 1D D7 FF      mov al, [_ide_r7]  
1398   06D6 87 80         and al, $80                     ; busy flag
1399   06D8 C7 D3 06      jnz ide_read_sect_wait
1400   06DB 19 20         mov al, $20
1401   06DD 3D D7 FF      mov [_ide_r7], al               ; read sector cmd
1402   06E0 07 0A 07      call ide_read  
1403   06E3 09            ret
1404   06E4             ide_write_sect:
1405   06E4 1A            mov al, ah
1406   06E5 24            mov ah, bl
1407   06E6 42 D2 FF      mov [_ide_r2], a                ; number of sectors (0..255)
1408   06E9 1C            mov al, bh
1409   06EA 3D D4 FF      mov [_ide_r4], al
1410   06ED 12            mov a, c
1411   06EE 3D D5 FF      mov [_ide_r5], al
1412   06F1 1A            mov al, ah
1413   06F2 87 0F         and al, %00001111
1414   06F4 8B E0         or al, %11100000                ; mode lba, master
1415   06F6 3D D6 FF      mov [_ide_r6], al
1416   06F9             ide_write_sect_wait:
1417   06F9 1D D7 FF      mov al, [_ide_r7]  
1418   06FC 87 80         and al, $80                     ; busy flag
1419   06FE C7 F9 06      jnz ide_write_sect_wait
1420   0701 19 30         mov al, $30
1421   0703 3D D7 FF      mov [_ide_r7], al               ; write sector cmd
1422   0706 07 25 07      call ide_write      
1423   0709 09            ret
1424   070A             
1425   070A             ;----------------------------------------------------------------------------------------------------;
1426   070A             ; read ide data
1427   070A             ; pointer in d
1428   070A             ;----------------------------------------------------------------------------------------------------;
1429   070A             ide_read:
1430   070A DA            push d
1431   070B             ide_read_loop:
1432   070B 1D D7 FF      mov al, [_ide_r7]  
1433   070E 87 80         and al, 80h                     ; busy flag
1434   0710 C7 0B 07      jnz ide_read_loop               ; wait loop
1435   0713 1D D7 FF      mov al, [_ide_r7]
1436   0716 87 08         and al, %00001000               ; drq flag
1437   0718 C6 23 07      jz ide_read_end
1438   071B 1D D0 FF      mov al, [_ide_r0]
1439   071E 3E            mov [d], al
1440   071F 79            inc d
1441   0720 0A 0B 07      jmp ide_read_loop
1442   0723             ide_read_end:
1443   0723 E7            pop d
1444   0724 09            ret
1445   0725             
1446   0725             ;----------------------------------------------------------------------------------------------------;
1447   0725             ; write ide data
1448   0725             ; data pointer in d
1449   0725             ;----------------------------------------------------------------------------------------------------;
1450   0725             ide_write:
1451   0725 DA            push d
1452   0726             ide_write_loop:
1453   0726 1D D7 FF      mov al, [_ide_r7]  
1454   0729 87 80         and al, 80h             ; busy flag
1455   072B C7 26 07      jnz ide_write_loop      ; wait loop
1456   072E 1D D7 FF      mov al, [_ide_r7]
1457   0731 87 08         and al, %00001000       ; drq flag
1458   0733 C6 3E 07      jz ide_write_end
1459   0736 1E            mov al, [d]
1460   0737 3D D0 FF      mov [_ide_r0], al
1461   073A 79            inc d 
1462   073B 0A 26 07      jmp ide_write_loop
1463   073E             ide_write_end:
1464   073E E7            pop d
1465   073F 09            ret
1466   0740             
1467   0740             ;----------------------------------------------------------------------------------------------------;
1468   0740             ; wait for ide to be ready
1469   0740             ;----------------------------------------------------------------------------------------------------;
1470   0740             ide_wait:
1471   0740 1D D7 FF      mov al, [_ide_r7]  
1472   0743 87 80         and al, 80h        ; busy flag
1473   0745 C7 40 07      jnz ide_wait
1474   0748 09            ret
1475   0749             
1476   0749             ;----------------------------------------------------------------------------------------------------;
1477   0749             ; io syscall
1478   0749             ;----------------------------------------------------------------------------------------------------;
1479   0749             ; baud  divisor
1480   0749             ; 50    2304
1481   0749             ; 110   1047
1482   0749             ; 300    384
1483   0749             ; 600    192
1484   0749             ; 1200    96
1485   0749             ; 9600    12
1486   0749             ; 19200    6
1487   0749             ; 38400    3
1488   0749             syscall_io_jmp:
1489   0749 A4 07         .dw syscall_io_putchar
1490   074B BD 07         .dw syscall_io_getch
1491   074D 53 07         .dw syscall_io_uart_setup
1492   074F             syscall_io:
1493   074F FD 0A 49 07   jmp [syscall_io_jmp + al]
1494   0753             ; bit7 is the divisor latch access bit (dlab). it must be set high (logic 1) to access the divisor latches
1495   0753             ; of the baud generator during a read or write operation. it must be set low (logic 0) to access the receiver
1496   0753             ; buffer, the transmitter holding register, or the interrupt enable register.
1497   0753             syscall_io_uart_setup:
1498   0753 1D 4A 19      mov al, [sys_uart0_lcr]
1499   0756 8B 80         or al, $80                ; set dlab access bit
1500   0758 3D 83 FF      mov [_uart0_lcr], al      ; 8 data, 2 stop, no parity by default
1501   075B 1D 4D 19      mov al, [sys_uart0_div0]
1502   075E 3D 80 FF      mov [_uart0_dlab_0], al   ; divisor latch byte 0
1503   0761 1D 4E 19      mov al, [sys_uart0_div1]
1504   0764 3D 81 FF      mov [_uart0_dlab_1], al   ; divisor latch byte 1      
1505   0767 1D 4A 19      mov al, [sys_uart0_lcr]
1506   076A 87 7F         and al, $7f               ; clear dlab access bit 
1507   076C 3D 83 FF      mov [_uart0_lcr], al
1508   076F 1D 4B 19      mov al, [sys_uart0_inten]
1509   0772 3D 81 FF      mov [_uart0_ier], al      ; interrupts
1510   0775 1D 4C 19      mov al, [sys_uart0_fifoen]
1511   0778 3D 82 FF      mov [_uart0_fcr], al      ; fifo control
1512   077B             ; uart1:
1513   077B 1D 4F 19      mov al, [sys_uart1_lcr]
1514   077E 8B 80         or al, $80                ; set dlab access bit
1515   0780 3D 8B FF      mov [_uart1_lcr], al      ; 8 data, 2 stop, no parity by default
1516   0783 1D 52 19      mov al, [sys_uart1_div0]
1517   0786 3D 88 FF      mov [_uart1_dlab_0], al   ; divisor latch byte 0
1518   0789 1D 53 19      mov al, [sys_uart1_div1]
1519   078C 3D 89 FF      mov [_uart1_dlab_1], al   ; divisor latch byte 1      
1520   078F 1D 4F 19      mov al, [sys_uart1_lcr]
1521   0792 87 7F         and al, $7f               ; clear dlab access bit 
1522   0794 3D 8B FF      mov [_uart1_lcr], al
1523   0797 1D 50 19      mov al, [sys_uart1_inten]
1524   079A 3D 89 FF      mov [_uart1_ier], al      ; interrupts
1525   079D 1D 51 19      mov al, [sys_uart1_fifoen]
1526   07A0 3D 8A FF      mov [_uart1_fcr], al      ; fifo control
1527   07A3 06            sysret
1528   07A4             
1529   07A4             ; char in ah
1530   07A4             syscall_io_putchar:
1531   07A4             syscall_io_putchar_l0:
1532   07A4 1D 85 FF      mov al, [_uart0_lsr]         ; read line status register
1533   07A7 87 20         and al, $20
1534   07A9 C6 A4 07      jz syscall_io_putchar_l0    
1535   07AC 1A            mov al, ah
1536   07AD 3D 80 FF      mov [_uart0_data], al        ; write char to transmitter holding register
1537   07B0             ; write to uart1
1538   07B0             syscall_io_putchar_l1:
1539   07B0 1D 8D FF      mov al, [_uart1_lsr]         ; read line status register
1540   07B3 87 20         and al, $20
1541   07B5 C6 B0 07      jz syscall_io_putchar_l1
1542   07B8 1A            mov al, ah
1543   07B9 3D 88 FF      mov [_uart1_data], al        ; write char to transmitter holding register
1544   07BC 06            sysret
1545   07BD             
1546   07BD             ; char in ah
1547   07BD             ; al = sucess code
1548   07BD             syscall_io_getch:
1549   07BD D8            push b
1550   07BE DA            push d
1551   07BF FD 0C         sti
1552   07C1             syscall_io_getch_l0:  
1553   07C1 14 5C 19      mov a, [fifo_out]
1554   07C4 29 5A 19      mov b, [fifo_in]
1555   07C7 B0            cmp a, b
1556   07C8 C6 C1 07      je syscall_io_getch_l0
1557   07CB 3C            mov d, a
1558   07CC 77            inc a
1559   07CD AF 61 31      cmp a, fifo + _fifo_size      ; check if pointer reached the end of the fifo
1560   07D0 C7 D6 07      jne syscall_io_getch_cont
1561   07D3 10 61 21      mov a, fifo  
1562   07D6             syscall_io_getch_cont:  
1563   07D6 42 5C 19      mov [fifo_out], a             ; update fifo pointer
1564   07D9 1E            mov al, [d]                   ; get char
1565   07DA 23            mov ah, al
1566   07DB             ; here we just echo the char back to the console
1567   07DB             syscall_io_getch_echo_l0:
1568   07DB 1D 85 FF      mov al, [_uart0_lsr]         ; read line status register
1569   07DE 87 20         and al, $20                 ; isolate transmitter empty
1570   07E0 C6 DB 07      jz syscall_io_getch_echo_l0
1571   07E3 1A            mov al, ah
1572   07E4 3D 80 FF      mov [_uart0_data], al        ; write char to transmitter holding register
1573   07E7             syscall_io_getch_echo_l1:
1574   07E7 1D 8D FF      mov al, [_uart1_lsr]         ; read line status register
1575   07EA 87 20         and al, $20                 ; isolate transmitter empty
1576   07EC C6 E7 07      jz syscall_io_getch_echo_l1
1577   07EF 1A            mov al, ah
1578   07F0 3D 88 FF      mov [_uart1_data], al        ; write char to transmitter holding register
1579   07F3             syscall_io_getch_noecho:
1580   07F3 19 01         mov al, 1                    ; al = 1 means a char successfully received
1581   07F5 E7            pop d
1582   07F6 E5            pop b
1583   07F7 06            sysret
1584   07F8             
1585   07F8             ;------------------------------------------------------------------------------------------------------;
1586   07F8             ; file system data
1587   07F8             ;------------------------------------------------------------------------------------------------------;
1588   07F8             ; infor for : ide services interrupt
1589   07F8             ; ide read/write 512-byte sector
1590   07F8             ; al = option
1591   07F8             ; user buffer pointer in d
1592   07F8             ; ah = number of sectors
1593   07F8             ; cb = lba bytes 3..0  
1594   07F8             ;------------------------------------------------------------------------------------------------------;
1595   07F8             ; file system data structure
1596   07F8             ;------------------------------------------------------------------------------------------------------;
1597   07F8             ; for a directory we have the header first, followed by metadata
1598   07F8             ; header 1 sector (512 bytes)
1599   07F8             ; metadata 1 sector (512 bytes)
1600   07F8             ; header entries:
1601   07F8             ; filename (64)
1602   07F8             ; parent dir lba (2) -  to be used for faster backwards navigation...
1603   07F8             ;
1604   07F8             ; metadata entries:
1605   07F8             ; filename (24)
1606   07F8             ; attributes (1)  |_|_|file_type(3bits)|x|w|r| types: file, directory, character device
1607   07F8             ; lba (2)
1608   07F8             ; size (2)
1609   07F8             ; day (1)
1610   07F8             ; month (1)
1611   07F8             ; year (1)
1612   07F8             ; packet size = 32 bytes
1613   07F8             ;
1614   07F8             ; first directory on disk is the root directory '/'
1615   07F8             file_system_jmptbl:
1616   07F8 00 00         .dw 0                         ; 0
1617   07FA 00 00         .dw 0                         ; 1
1618   07FC C4 08         .dw fs_mkdir                  ; 2
1619   07FE 3D 0C         .dw fs_cd                     ; 3
1620   0800 44 0C         .dw fs_ls                     ; 4
1621   0802 2F 0D         .dw fs_mktxt                  ; 5
1622   0804 FA 0D         .dw fs_mkbin                  ; 6
1623   0806 C1 0E         .dw fs_pwd                    ; 7
1624   0808 DE 0E         .dw fs_cat                    ; 8
1625   080A 3A 0F         .dw fs_rmdir                  ; 9
1626   080C 96 0F         .dw fs_rm                     ; 10
1627   080E 00 00         .dw 0                         ; 11
1628   0810 00 00         .dw 0                         ; 12
1629   0812 00 00         .dw 0                         ; 13
1630   0814 6A 08         .dw fs_chmod                  ; 14
1631   0816 FE 0F         .dw fs_mv                     ; 15
1632   0818 63 08         .dw fs_cd_root                ; 16
1633   081A 39 0C         .dw fs_get_curr_dirid         ; 17
1634   081C 15 0A         .dw fs_dir_id_to_path         ; 18
1635   081E 7B 0A         .dw fs_path_to_dir_id_user    ; 19
1636   0820 95 0B         .dw fs_load_from_path_user    ; 20  
1637   0822 05 0B         .dw fs_filepath_exists_user   ; 21
1638   0824             
1639   0824 0A 3E 20 73 s_syscall_fs_dbg0: .db "\n> syscall_file_system called: ", 0
1639   0828 79 73 63 61 
1639   082C 6C 6C 5F 66 
1639   0830 69 6C 65 5F 
1639   0834 73 79 73 74 
1639   0838 65 6D 20 63 
1639   083C 61 6C 6C 65 
1639   0840 64 3A 20 00 
1640   0844             syscall_file_system:
1641   0844 DD            push bl
1642   0845 31 48 19      mov bl, [sys_debug_mode]
1643   0848               ; debug block
1644   0848 C1 00         cmp bl, 0
1645   084A EA            pop bl
1646   084B C6 5F 08      je syscall_filesystem_jmp
1647   084E DA            push d
1648   084F DD            push bl
1649   0850 3B 24 08      mov d, s_syscall_fs_dbg0
1650   0853 07 82 02      call _puts
1651   0856 2F            mov bl, al
1652   0857 07 BF 14      call print_u8x
1653   085A 07 CC 13      call printnl
1654   085D EA            pop bl
1655   085E E7            pop d
1656   085F             syscall_filesystem_jmp:
1657   085F FD 0A F8 07   jmp [file_system_jmptbl + al]
1658   0863               
1659   0863             fs_cd_root:
1660   0863 10 20 00      mov a, root_id
1661   0866 42 5E 19      mov [current_dir_id], a      ; set current directory lba to root
1662   0869 06            sysret  
1663   086A             
1664   086A             ; filename in d (userspace data)
1665   086A             ; permission in bl
1666   086A             fs_chmod:
1667   086A DD            push bl
1668   086B FD 4E         mov si, d
1669   086D FD 4F 61 1F   mov di, user_data
1670   0871 38 80 00      mov c, 128
1671   0874 04            load                        ; load filename from user-space
1672   0875 14 5E 19      mov a, [current_dir_id]
1673   0878 77            inc a                       ; metadata sector
1674   0879 27            mov b, a
1675   087A 38 00 00      mov c, 0                    ; upper lba = 0
1676   087D 22 01         mov ah, $01                  ; 1 sector
1677   087F 3B 61 33      mov d, transient_area
1678   0882 07 BE 06      call ide_read_sect          ; read directory
1679   0885 FD 10         cla
1680   0887 42 56 19      mov [index], a              ; reset file counter
1681   088A             fs_chmod_l1:
1682   088A FD 4E         mov si, d
1683   088C FD 4F 61 1F   mov di, user_data
1684   0890 07 62 12      call _strcmp
1685   0893 C6 AA 08      je fs_chmod_found_entry
1686   0896 58 20 00      add d, 32
1687   0899 14 56 19      mov a, [index]
1688   089C 77            inc a
1689   089D 42 56 19      mov [index], a
1690   08A0 AF 10 00      cmp a, fst_files_per_dir
1691   08A3 C7 8A 08      jne fs_chmod_l1
1692   08A6 EA            pop bl
1693   08A7 0A C3 08      jmp fs_chmod_not_found
1694   08AA             fs_chmod_found_entry:  
1695   08AA FD 79         mov g, b                    ; save lba
1696   08AC EA            pop bl                      ; retrieve saved permission value
1697   08AD 1F 18 00      mov al, [d + 24]            ; read file permissions
1698   08B0 87 F8         and al, %11111000           ; remove all permissions, keep other flags
1699   08B2 8C            or al, bl                   ; set new permissions
1700   08B3 3F 18 00      mov [d + 24], al            ; write new permissions
1701   08B6 38 00 00      mov c, 0
1702   08B9 3B 61 33      mov d, transient_area
1703   08BC 22 01         mov ah, $01                 ; disk write 1 sect
1704   08BE FD 27         mov b, g                    ; retrieve lba
1705   08C0 07 E4 06      call ide_write_sect         ; write sector
1706   08C3             fs_chmod_not_found:
1707   08C3 06            sysret
1708   08C4             
1709   08C4             ;------------------------------------------------------------------------------------------------------;
1710   08C4             ; create new directory
1711   08C4             ;------------------------------------------------------------------------------------------------------;
1712   08C4             ; search list for null name entry. add new directory to list
1713   08C4             fs_mkdir:
1714   08C4 FD 4E         mov si, d
1715   08C6 FD 4F 61 1F   mov di, user_data
1716   08CA 38 00 02      mov c, 512
1717   08CD 04            load                        ; load data from user-space
1718   08CE 26 22 00      mov b, fst_lba_start + 2    ; start at 2 because lba  0 is root (this would also cause issues                 
1719   08D1                                           ; when checking for null name, since root has a null name)
1720   08D1 38 00 00      mov c, 0                    ; upper lba = 0
1721   08D4             fs_mkdir_l1:  
1722   08D4 22 01         mov ah, $01                  ; 1 sector
1723   08D6 3B 61 33      mov d, transient_area
1724   08D9 07 BE 06      call ide_read_sect          ; read sector
1725   08DC BD 00         cmp byte[d], 0              ; check for null
1726   08DE C6 E7 08      je fs_mkdir_found_null
1727   08E1 55 02 00      add b, fst_sectors_per_dir  ; skip directory
1728   08E4 0A D4 08      jmp fs_mkdir_l1
1729   08E7             fs_mkdir_found_null:
1730   08E7             ;create header file by grabbing dir name from parameter
1731   08E7 D8            push b                      ; save new directory's lba
1732   08E8 38 40 00      mov c, 64
1733   08EB FD 4D 61 1F   mov si, user_data
1734   08EF FD 4F 61 33   mov di, transient_area
1735   08F3 FD F5         rep movsb                   ; copy dirname from user_data to transient_area
1736   08F5 14 5E 19      mov a, [current_dir_id]
1737   08F8 42 A1 33      mov [transient_area + 64], a    ; store parent directory lba
1738   08FB 19 00         mov al, 0
1739   08FD FD 4F 61 35   mov di, transient_area + 512
1740   0901 38 00 02      mov c, 512
1741   0904 FD F7         rep stosb                       ; clean buffer
1742   0906 38 00 00      mov c, 0                        ; reset lba(c) to 0
1743   0909             ; write directory entry sectors
1744   0909 3B 61 33      mov d, transient_area
1745   090C 22 02         mov ah, $02                     ; disk write, 2 sectors
1746   090E 07 E4 06      call ide_write_sect             ; write sector
1747   0911             ; now we need to add the new directory to the list, inside the current directory
1748   0911 14 5E 19      mov a, [current_dir_id]
1749   0914 53 01 00      add a, 1
1750   0917 27            mov b, a                        ; metadata sector
1751   0918 38 00 00      mov c, 0
1752   091B FD 79         mov g, b                        ; save lba
1753   091D 3B 61 33      mov d, transient_area
1754   0920 22 01         mov ah, $01                  ; 1 sector
1755   0922 07 BE 06      call ide_read_sect              ; read metadata sector
1756   0925             fs_mkdir_l2:
1757   0925 BD 00         cmp byte[d], 0
1758   0927 C6 30 09      je fs_mkdir_found_null2
1759   092A 58 20 00      add d, fst_entry_size
1760   092D 0A 25 09      jmp fs_mkdir_l2                ; we look for a null entry here but dont check for limits. care needed when adding too many files to a directory
1761   0930             fs_mkdir_found_null2:
1762   0930 FD 4D 61 1F   mov si, user_data
1763   0934 FD 50         mov di, d
1764   0936 07 77 12      call _strcpy                    ; copy directory name
1765   0939 58 18 00      add d, 24                       ; goto attributes
1766   093C 19 0B         mov al, %00001011               ; directory, no execute, write, read
1767   093E 3E            mov [d], al      
1768   093F 79            inc d
1769   0940 E5            pop b
1770   0941 D8            push b                          ; push lba back
1771   0942 FD 43         mov [d], b                      ; save lba
1772   0944             ; set file creation date  
1773   0944 58 04 00      add d, 4
1774   0947 19 04         mov al, 4
1775   0949 05 01         syscall sys_rtc
1776   094B 1A            mov al, ah
1777   094C 3E            mov [d], al                     ; set day
1778   094D 79            inc d
1779   094E 19 05         mov al, 5
1780   0950 05 01         syscall sys_rtc
1781   0952 1A            mov al, ah
1782   0953 3E            mov [d], al                     ; set month
1783   0954 79            inc d
1784   0955 19 06         mov al, 6
1785   0957 05 01         syscall sys_rtc
1786   0959 1A            mov al, ah
1787   095A 3E            mov [d], al                     ; set year
1788   095B             ; write sector into disk for new directory entry
1789   095B FD 27         mov b, g
1790   095D 38 00 00      mov c, 0
1791   0960 3B 61 33      mov d, transient_area
1792   0963 22 01         mov ah, $01                     ; disk write, 1 sector
1793   0965 07 E4 06      call ide_write_sect             ; write sector
1794   0968             
1795   0968             ; after adding the new directory's information to its parent directory's list
1796   0968             ; we need to now enter the new directory, and to it add two new directories!
1797   0968             ; which directories do we need to add ? '..' and '.' are the directories needed.
1798   0968             ; importantly, note that these two new directories are only entries in the list
1799   0968             ; and do not have actual physical entries in the disk as real directories.
1800   0968             ; i.e. they only exist as list entries in the new directory created so that
1801   0968             ; the new directory can reference its parent and itself.
1802   0968             ; we need to add both '..' and '.'
1803   0968             ; this first section is for '..' and on the section below we do the same for '.'
1804   0968 E4            pop a                         ; retrieve the new directory's lba  
1805   0969 D7            push a                        ; and save again
1806   096A 53 01 00      add a, 1
1807   096D 27            mov b, a                      ; metadata sector
1808   096E 38 00 00      mov c, 0
1809   0971 FD 79         mov g, b                      ; save lba
1810   0973 3B 61 33      mov d, transient_area
1811   0976 22 01         mov ah, $01                  ; 1 sector
1812   0978 07 BE 06      call ide_read_sect            ; read metadata sector
1813   097B             fs_mkdir_l3:
1814   097B BD 00         cmp byte[d], 0
1815   097D C6 86 09      je fs_mkdir_found_null3
1816   0980 58 20 00      add d, fst_entry_size
1817   0983 0A 7B 09      jmp fs_mkdir_l3              ; we look for a null entry here but dont check for limits. care needed when adding too many files to a directory
1818   0986             fs_mkdir_found_null3:
1819   0986 FD 4D 7D 19   mov si, s_parent_dir
1820   098A FD 50         mov di, d
1821   098C 07 77 12      call _strcpy                  ; copy directory name
1822   098F 58 18 00      add d, 24                     ; goto attributes
1823   0992 19 0B         mov al, %00001011             ; directory, no execute, write, read, 
1824   0994 3E            mov [d], al      
1825   0995 79            inc d
1826   0996 29 5E 19      mov b, [current_dir_id]        ; retrieve the parent directorys lba
1827   0999 FD 43         mov [d], b                    ; save lba
1828   099B             ; set file creation date  
1829   099B 58 04 00      add d, 4
1830   099E 19 04         mov al, 4
1831   09A0 05 01         syscall sys_rtc
1832   09A2 1A            mov al, ah
1833   09A3 3E            mov [d], al                   ; set day
1834   09A4 79            inc d
1835   09A5 19 05         mov al, 5
1836   09A7 05 01         syscall sys_rtc
1837   09A9 1A            mov al, ah
1838   09AA 3E            mov [d], al                   ; set month
1839   09AB 79            inc d
1840   09AC 19 06         mov al, 6
1841   09AE 05 01         syscall sys_rtc
1842   09B0 1A            mov al, ah
1843   09B1 3E            mov [d], al                   ; set year
1844   09B2             ; write sector into disk for new directory entry
1845   09B2 FD 27         mov b, g
1846   09B4 38 00 00      mov c, 0
1847   09B7 3B 61 33      mov d, transient_area
1848   09BA 22 01         mov ah, $01                   ; disk write, 1 sector
1849   09BC 07 E4 06      call ide_write_sect           ; write sector
1850   09BF             ;;;;;;;;;;;;;
1851   09BF             ; like we did above for '..', we need to now add the '.' directory to the list.
1852   09BF             ;------------------------------------------------------------------------------------------------------;
1853   09BF E4            pop a                         ; retrieve the new directory's lba  
1854   09C0 D7            push a
1855   09C1 53 01 00      add a, 1
1856   09C4 27            mov b, a                      ; metadata sector
1857   09C5 38 00 00      mov c, 0
1858   09C8 FD 79         mov g, b                      ; save lba
1859   09CA 3B 61 33      mov d, transient_area
1860   09CD 22 01         mov ah, $01                  ; 1 sector
1861   09CF 07 BE 06      call ide_read_sect            ; read metadata sector
1862   09D2             fs_mkdir_l4:
1863   09D2 BD 00         cmp byte[d], 0
1864   09D4 C6 DD 09      je fs_mkdir_found_null4
1865   09D7 58 20 00      add d, fst_entry_size
1866   09DA 0A D2 09      jmp fs_mkdir_l4              ; we look for a null entry here but dont check for limits. care needed when adding too many files to a directory
1867   09DD             fs_mkdir_found_null4:
1868   09DD FD 4D 80 19   mov si, s_current_dir
1869   09E1 FD 50         mov di, d
1870   09E3 07 77 12      call _strcpy                  ; copy directory name
1871   09E6 58 18 00      add d, 24                     ; goto attributes
1872   09E9 19 0B         mov al, %00001011             ; directory, no execute, write, read, 
1873   09EB 3E            mov [d], al      
1874   09EC 79            inc d
1875   09ED E5            pop b                         ; new directory's lba itself. for self-referential directory entry '.'
1876   09EE FD 43         mov [d], b                    ; save lba
1877   09F0             ; set file creation date  
1878   09F0 58 04 00      add d, 4
1879   09F3 19 04         mov al, 4
1880   09F5 05 01         syscall sys_rtc
1881   09F7 1A            mov al, ah
1882   09F8 3E            mov [d], al                   ; set day
1883   09F9 79            inc d
1884   09FA 19 05         mov al, 5
1885   09FC 05 01         syscall sys_rtc
1886   09FE 1A            mov al, ah
1887   09FF 3E            mov [d], al                   ; set month
1888   0A00 79            inc d
1889   0A01 19 06         mov al, 6
1890   0A03 05 01         syscall sys_rtc
1891   0A05 1A            mov al, ah
1892   0A06 3E            mov [d], al                   ; set year
1893   0A07             ; write sector into disk for new directory entry
1894   0A07 FD 27         mov b, g
1895   0A09 38 00 00      mov c, 0
1896   0A0C 3B 61 33      mov d, transient_area
1897   0A0F 22 01         mov ah, $01                   ; disk write, 1 sector
1898   0A11 07 E4 06      call ide_write_sect           ; write sector
1899   0A14             fs_mkdir_end:
1900   0A14 06            sysret
1901   0A15             
1902   0A15             ;------------------------------------------------------------------------------------------------------;
1903   0A15             ; get path from a given directory dirid
1904   0A15             ; pseudo code:
1905   0A15             ;  fs_dir_id_to_path(int dirid, char *d){
1906   0A15             ;    if(dirid == 0){
1907   0A15             ;      reverse path in d;
1908   0A15             ;      return;
1909   0A15             ;    }
1910   0A15             ;    else{
1911   0A15             ;      copy directory name to end of d;
1912   0A15             ;      add '/' to end of d;
1913   0A15             ;      parentid = get parent directory id;
1914   0A15             ;      fs_dir_id_to_path(parentid, d);
1915   0A15             ;    }
1916   0A15             ;  }
1917   0A15             ; a = dirid
1918   0A15             ; d = generated path string pointer
1919   0A15             ;------------------------------------------------------------------------------------------------------;
1920   0A15             ; sample path: /usr/bin
1921   0A15             fs_dir_id_to_path:
1922   0A15 3B E1 1E      mov d, filename
1923   0A18 19 00         mov al, 0
1924   0A1A 3E            mov [d], al                     ; initialize path string 
1925   0A1B 14 5E 19      mov a, [current_dir_id]
1926   0A1E 07 2B 0A      call fs_dir_id_to_path_e0
1927   0A21 3B E1 1E      mov d, filename
1928   0A24 07 0B 12      call _strrev
1929   0A27 07 82 02      call _puts
1930   0A2A 06            sysret
1931   0A2B             fs_dir_id_to_path_e0:
1932   0A2B 07 4A 0A      call get_dirname_from_dirid
1933   0A2E FD 4D 82 19   mov si, s_fslash
1934   0A32 FD 50         mov di, d
1935   0A34 07 85 12      call _strcat                    ; add '/' to end of path
1936   0A37 AF 20 00      cmp a, root_id               ; check if we are at the root directory
1937   0A3A C6 49 0A      je fs_dir_id_to_path_root
1938   0A3D 07 67 0A      call get_parentid_from_dirid    ; use current id (a) to find parentid (into a)
1939   0A40 AF 20 00      cmp a, root_id               ; check if we are at the root directory
1940   0A43 C6 49 0A      je fs_dir_id_to_path_root
1941   0A46 07 2B 0A      call fs_dir_id_to_path_e0     ; recursively call itself
1942   0A49             fs_dir_id_to_path_root:
1943   0A49 09            ret
1944   0A4A             
1945   0A4A             ;------------------------------------------------------------------------------------------------------;
1946   0A4A             ; in_puts:
1947   0A4A             ; a = directory id
1948   0A4A             ; out_puts:
1949   0A4A             ; d = pointer to directory name string
1950   0A4A             ;------------------------------------------------------------------------------------------------------;
1951   0A4A             get_dirname_from_dirid:
1952   0A4A D7            push a
1953   0A4B D8            push b
1954   0A4C DA            push d
1955   0A4D 27            mov b, a
1956   0A4E 38 00 00      mov c, 0                      ; upper lba = 0
1957   0A51 22 01         mov ah, $01                  ; 1 sector
1958   0A53 3B 61 31      mov d, transient_area - 512
1959   0A56 07 BE 06      call ide_read_sect            ; read directory
1960   0A59 07 0B 12      call _strrev                  ; reverse dir name before copying
1961   0A5C FD 4E         mov si, d
1962   0A5E E7            pop d                         ; destination address = d value pushed at beginning
1963   0A5F FD 50         mov di, d
1964   0A61 07 85 12      call _strcat                  ; copy filename to d
1965   0A64 E5            pop b
1966   0A65 E4            pop a
1967   0A66 09            ret
1968   0A67             
1969   0A67             ;------------------------------------------------------------------------------------------------------;
1970   0A67             ; in_puts:
1971   0A67             ; a = directory id
1972   0A67             ; out_puts:
1973   0A67             ; a = parent directory id
1974   0A67             ;------------------------------------------------------------------------------------------------------;
1975   0A67             get_parentid_from_dirid:
1976   0A67 D8            push b
1977   0A68 DA            push d
1978   0A69 27            mov b, a
1979   0A6A 38 00 00      mov c, 0                      ; upper lba = 0
1980   0A6D 22 01         mov ah, $01                  ; 1 sector
1981   0A6F 3B 61 31      mov d, transient_area - 512
1982   0A72 07 BE 06      call ide_read_sect            ; read directory
1983   0A75 16 40 00      mov a, [d + 64]               ; copy parent id value to a
1984   0A78 E7            pop d
1985   0A79 E5            pop b
1986   0A7A 09            ret
1987   0A7B             
1988   0A7B             ;------------------------------------------------------------------------------------------------------;
1989   0A7B             ; get dirid from a given path string
1990   0A7B             ; in_puts:
1991   0A7B             ; d = path pointer 
1992   0A7B             ; out_puts:
1993   0A7B             ; a = dirid
1994   0A7B             ; if dir non existent, a = ffff (fail code)
1995   0A7B             ; /usr/local/bin    - absolute
1996   0A7B             ; local/bin/games    - relative
1997   0A7B             ;------------------------------------------------------------------------------------------------------;
1998   0A7B             fs_path_to_dir_id_user:
1999   0A7B FD 4E         mov si, d
2000   0A7D FD 4F 61 1F   mov di, user_data
2001   0A81 38 00 02      mov c, 512
2002   0A84 04            load
2003   0A85 07 89 0A      call get_dirid_from_path
2004   0A88 06            sysret
2005   0A89             get_dirid_from_path:
2006   0A89 26 61 1F      mov b, user_data
2007   0A8C FD 42 44 18   mov [prog], b                  ; token pointer set to path string
2008   0A90 07 A5 16      call get_token
2009   0A93 31 47 18      mov bl, [tok]
2010   0A96 C1 01         cmp bl, tok_fslash
2011   0A98 C6 A4 0A      je get_dirid_from_path_abs 
2012   0A9B 14 5E 19      mov a, [current_dir_id]
2013   0A9E 07 2B 18      call _putback
2014   0AA1 0A A7 0A      jmp get_dirid_from_path_e0
2015   0AA4             get_dirid_from_path_abs:
2016   0AA4 10 20 00      mov a, root_id
2017   0AA7             get_dirid_from_path_e0:
2018   0AA7 07 A5 16      call get_token
2019   0AAA 31 46 18      mov bl, [toktyp]
2020   0AAD C1 00         cmp bl, toktyp_identifier
2021   0AAF C7 00 0B      jne get_dirid_from_path_end   ; check if there are tokens after '/'. i.e. is this a 'cd /' command?
2022   0AB2             
2023   0AB2 FD 4D 48 18   mov si, tokstr
2024   0AB6 FD 4F E1 1E   mov di, filename
2025   0ABA 07 77 12      call _strcpy        
2026   0ABD 77            inc a                         ; metadata sector
2027   0ABE 27            mov b, a
2028   0ABF 38 00 00      mov c, 0                      ; upper lba = 0
2029   0AC2 22 01         mov ah, $01                  ; 1 sector
2030   0AC4 3B 61 33      mov d, transient_area
2031   0AC7 07 BE 06      call ide_read_sect            ; read directory
2032   0ACA FD 10         cla
2033   0ACC 42 56 19      mov [index], a
2034   0ACF             get_dirid_from_path_l1:
2035   0ACF FD 4E         mov si, d
2036   0AD1 FD 4F E1 1E   mov di, filename
2037   0AD5 07 62 12      call _strcmp
2038   0AD8 C6 EE 0A      je get_dirid_from_path_name_equal  
2039   0ADB 58 20 00      add d, 32
2040   0ADE 14 56 19      mov a, [index]
2041   0AE1 77            inc a
2042   0AE2 42 56 19      mov [index], a
2043   0AE5 AF 10 00      cmp a, fst_files_per_dir
2044   0AE8 C6 01 0B      je get_dirid_from_path_fail
2045   0AEB 0A CF 0A      jmp get_dirid_from_path_l1
2046   0AEE             get_dirid_from_path_name_equal:
2047   0AEE 58 19 00      add d, 25           
2048   0AF1 15            mov a, [d]                    ; set result register a = dirid
2049   0AF2 07 A5 16      call get_token
2050   0AF5 31 47 18      mov bl, [tok]
2051   0AF8 C1 01         cmp bl, tok_fslash            ; check if there are more elements in the path
2052   0AFA C6 A7 0A      je get_dirid_from_path_e0
2053   0AFD 07 2B 18      call _putback
2054   0B00             get_dirid_from_path_end:
2055   0B00 09            ret
2056   0B01             get_dirid_from_path_fail:
2057   0B01 10 FF FF      mov a, $ffff
2058   0B04 09            ret
2059   0B05             
2060   0B05             
2061   0B05             ;------------------------------------------------------------------------------------------------------;
2062   0B05             ; check if file exists by a given path string
2063   0B05             ; in_puts:
2064   0B05             ; d = path pointer 
2065   0B05             ; outputs:
2066   0B05             ; a = success code, if file exists gives lba, else, give 0
2067   0B05             ; /usr/local/bin/ed
2068   0B05             ;------------------------------------------------------------------------------------------------------;
2069   0B05             fs_filepath_exists_user:
2070   0B05 FD 4E         mov si, d
2071   0B07 FD 4F 61 1F   mov di, user_data
2072   0B0B 38 00 02      mov c, 512
2073   0B0E 04            load
2074   0B0F 07 13 0B      call file_exists_by_path
2075   0B12 06            sysret
2076   0B13             file_exists_by_path:
2077   0B13 26 61 1F      mov b, user_data
2078   0B16 FD 42 44 18   mov [prog], b                   ; token pointer set to path string
2079   0B1A 07 A5 16      call get_token
2080   0B1D 31 47 18      mov bl, [tok]
2081   0B20 C1 01         cmp bl, tok_fslash
2082   0B22 C6 2E 0B      je  file_exists_by_path_abs
2083   0B25 14 5E 19      mov a, [current_dir_id]
2084   0B28 07 2B 18      call _putback
2085   0B2B 0A 31 0B      jmp file_exists_by_path_e0
2086   0B2E             file_exists_by_path_abs:
2087   0B2E 10 20 00      mov a, root_id
2088   0B31             file_exists_by_path_e0:
2089   0B31 07 A5 16      call get_token
2090   0B34 31 46 18      mov bl, [toktyp]
2091   0B37 C1 00         cmp bl, toktyp_identifier
2092   0B39 C7 91 0B      jne file_exists_by_path_end     ; check if there are tokens after '/'
2093   0B3C FD 4D 48 18   mov si, tokstr
2094   0B40 FD 4F E1 1E   mov di, filename
2095   0B44 07 77 12      call _strcpy        
2096   0B47 77            inc a                           ; metadata sector
2097   0B48 27            mov b, a
2098   0B49 38 00 00      mov c, 0                        ; upper lba = 0
2099   0B4C 22 01         mov ah, $01                  ; 1 sector
2100   0B4E 3B 61 33      mov d, transient_area
2101   0B51 07 BE 06      call ide_read_sect              ; read directory
2102   0B54 FD 10         cla
2103   0B56 42 56 19      mov [index], a
2104   0B59             file_exists_by_path_l1:
2105   0B59 FD 4E         mov si, d
2106   0B5B FD 4F E1 1E   mov di, filename
2107   0B5F 07 62 12      call _strcmp
2108   0B62 C6 78 0B      je   file_exists_by_path_name_equal
2109   0B65 58 20 00      add d, 32
2110   0B68 14 56 19      mov a, [index]
2111   0B6B 77            inc a
2112   0B6C 42 56 19      mov [index], a
2113   0B6F AF 10 00      cmp a, fst_files_per_dir
2114   0B72 C6 91 0B      je file_exists_by_path_end
2115   0B75 0A 59 0B      jmp file_exists_by_path_l1
2116   0B78             file_exists_by_path_name_equal:
2117   0B78 33 18 00      mov bl, [d + 24]
2118   0B7B FD 87 38      and bl, %00111000               ; directory flag
2119   0B7E C1 08         cmp bl, %00001000               ; is dir?
2120   0B80 C6 87 0B      je file_exists_by_path_isdir;
2121   0B83             ; entry is a file
2122   0B83 16 19 00      mov a, [d + 25]                 ; get and return lba of file
2123   0B86 09            ret
2124   0B87             file_exists_by_path_isdir:
2125   0B87 58 19 00      add d, 25           
2126   0B8A 15            mov a, [d]                      ; set result register a = dirid
2127   0B8B 07 A5 16      call get_token
2128   0B8E 0A 31 0B      jmp file_exists_by_path_e0
2129   0B91             file_exists_by_path_end:
2130   0B91 10 00 00      mov a, 0                        ; return 0 because file was not found
2131   0B94 09            ret
2132   0B95             
2133   0B95             ;------------------------------------------------------------------------------------------------------;
2134   0B95             ; load file data from a given path string
2135   0B95             ; inputs:
2136   0B95             ; d = path pointer 
2137   0B95             ; di = userspace program data destination
2138   0B95             ; /usr/local/bin/ed
2139   0B95             ; ./ed
2140   0B95             ;------------------------------------------------------------------------------------------------------;
2141   0B95             fs_load_from_path_user:
2142   0B95 E3            push di
2143   0B96 FD 4E         mov si, d
2144   0B98 FD 4F 61 1F   mov di, user_data
2145   0B9C 38 00 02      mov c, 512
2146   0B9F 04            load
2147   0BA0 07 AD 0B      call loadfile_from_path
2148   0BA3 F0            pop di
2149   0BA4 FD 4D 61 33   mov si, transient_area
2150   0BA8 38 00 3E      mov c, 512 * (fs_sectors_per_file-1)
2151   0BAB 03            store
2152   0BAC 06            sysret
2153   0BAD             loadfile_from_path:
2154   0BAD 26 61 1F      mov b, user_data
2155   0BB0 FD 42 44 18   mov [prog], b                 ; token pointer set to path string
2156   0BB4 07 A5 16      call get_token
2157   0BB7 31 47 18      mov bl, [tok]
2158   0BBA C1 01         cmp bl, tok_fslash
2159   0BBC C6 C8 0B      je loadfile_from_path_abs 
2160   0BBF 14 5E 19      mov a, [current_dir_id]
2161   0BC2 07 2B 18      call _putback
2162   0BC5 0A CB 0B      jmp loadfile_from_path_e0
2163   0BC8             loadfile_from_path_abs:
2164   0BC8 10 20 00      mov a, root_id
2165   0BCB             loadfile_from_path_e0:
2166   0BCB 07 A5 16      call get_token
2167   0BCE 31 46 18      mov bl, [toktyp]
2168   0BD1 C1 00         cmp bl, toktyp_identifier
2169   0BD3 C7 38 0C      jne loadfile_from_path_end    ; check if there are tokens after '/'. i.e. is this a 'cd /' command?
2170   0BD6 FD 4D 48 18   mov si, tokstr
2171   0BDA FD 4F E1 1E   mov di, filename
2172   0BDE 07 77 12      call _strcpy        
2173   0BE1 77            inc a                         ; metadata sector
2174   0BE2 27            mov b, a
2175   0BE3 38 00 00      mov c, 0                      ; upper lba = 0
2176   0BE6 22 01         mov ah, $01                  ; 1 sector
2177   0BE8 3B 61 33      mov d, transient_area
2178   0BEB 07 BE 06      call ide_read_sect            ; read directory
2179   0BEE FD 10         cla
2180   0BF0 42 56 19      mov [index], a
2181   0BF3             loadfile_from_path_l1:
2182   0BF3 FD 4E         mov si, d
2183   0BF5 FD 4F E1 1E   mov di, filename
2184   0BF9 07 62 12      call _strcmp
2185   0BFC C6 12 0C      je loadfile_from_path_name_equal  
2186   0BFF 58 20 00      add d, 32
2187   0C02 14 56 19      mov a, [index]
2188   0C05 77            inc a
2189   0C06 42 56 19      mov [index], a
2190   0C09 AF 10 00      cmp a, fst_files_per_dir
2191   0C0C C6 38 0C      je loadfile_from_path_end
2192   0C0F 0A F3 0B      jmp loadfile_from_path_l1
2193   0C12             loadfile_from_path_name_equal:
2194   0C12 33 18 00      mov bl, [d + 24]
2195   0C15 FD 87 38      and bl, %00111000             ; directory flag
2196   0C18 C1 08         cmp bl, %00001000             ; is dir?
2197   0C1A C6 2E 0C      je loadfile_isdirectory  
2198   0C1D             ; entry is a file
2199   0C1D 2B 19 00      mov b, [d + 25]               ; get lba
2200   0C20 FD 77         inc b                         ; add 1 to b because the lba for data comes after the header sector
2201   0C22 3B 61 33      mov d, transient_area
2202   0C25 38 00 00      mov c, 0
2203   0C28 22 1F         mov ah, fs_sectors_per_file-1 ; number of sectors
2204   0C2A 07 BE 06      call ide_read_sect            ; read sector
2205   0C2D 09            ret
2206   0C2E             loadfile_isdirectory:
2207   0C2E 58 19 00      add d, 25           
2208   0C31 15            mov a, [d]                    ; set result register a = dirid
2209   0C32 07 A5 16      call get_token
2210   0C35 0A CB 0B      jmp loadfile_from_path_e0
2211   0C38             loadfile_from_path_end:
2212   0C38 09            ret
2213   0C39             
2214   0C39             ;------------------------------------------------------------------------------------------------------;
2215   0C39             ; return the id of the current directory
2216   0C39             ; id returned in b
2217   0C39             ;------------------------------------------------------------------------------------------------------;
2218   0C39             fs_get_curr_dirid:
2219   0C39 29 5E 19      mov b, [current_dir_id]
2220   0C3C 06            sysret
2221   0C3D             
2222   0C3D             ;------------------------------------------------------------------------------------------------------;
2223   0C3D             ; cd
2224   0C3D             ;------------------------------------------------------------------------------------------------------;
2225   0C3D             ; new dirid in b
2226   0C3D             fs_cd:
2227   0C3D FD 42 5E 19   mov [current_dir_id], b
2228   0C41 06            sysret  
2229   0C42             
2230   0C42             ;------------------------------------------------------------------------------------------------------;
2231   0C42             ; ls
2232   0C42             ; dirid in b
2233   0C42             ;------------------------------------------------------------------------------------------------------;
2234   0C42 00 00       ls_count:       .dw 0
2235   0C44             fs_ls:
2236   0C44 FD 77         inc b                        ; metadata sector
2237   0C46 38 00 00      mov c, 0                     ; upper lba = 0
2238   0C49 22 01         mov ah, $01                  ; 1 sector
2239   0C4B 3B 61 33      mov d, transient_area
2240   0C4E 07 BE 06      call ide_read_sect           ; read directory
2241   0C51 FD 10         cla
2242   0C53 42 56 19      mov [index], a               ; reset entry index
2243   0C56 3D 42 0C      mov [ls_count], al           ; reset item count
2244   0C59             fs_ls_l1:
2245   0C59 BD 00         cmp byte [d], 0              ; check for null
2246   0C5B C6 F2 0C      je fs_ls_next
2247   0C5E             fs_ls_non_null:
2248   0C5E 1D 42 0C      mov al, [ls_count]
2249   0C61 7A            inc al
2250   0C62 3D 42 0C      mov [ls_count], al           ; increment item count
2251   0C65 1F 18 00      mov al, [d + 24]
2252   0C68 87 38         and al, %00111000
2253   0C6A FD A2 03      shr al, 3
2254   0C6D 22 00         mov ah, 0                    ; file type
2255   0C6F B7 89 19      mov a, [a + file_type]      
2256   0C72 23            mov ah, al
2257   0C73 07 F3 12      call _putchar
2258   0C76 1F 18 00      mov al, [d + 24]
2259   0C79 87 01         and al, %00000001
2260   0C7B 22 00         mov ah, 0
2261   0C7D B7 84 19      mov a, [a + file_attrib]     ; read
2262   0C80 23            mov ah, al
2263   0C81 07 F3 12      call _putchar
2264   0C84 1F 18 00      mov al, [d + 24]
2265   0C87 87 02         and al, %00000010
2266   0C89 22 00         mov ah, 0
2267   0C8B B7 84 19      mov a, [a + file_attrib]     ; write
2268   0C8E 23            mov ah, al
2269   0C8F 07 F3 12      call _putchar
2270   0C92 1F 18 00      mov al, [d + 24]
2271   0C95 87 04         and al, %00000100
2272   0C97 22 00         mov ah, 0
2273   0C99 B7 84 19      mov a, [a + file_attrib]     ; execute
2274   0C9C 23            mov ah, al
2275   0C9D 07 F3 12      call _putchar
2276   0CA0 22 20         mov ah, $20
2277   0CA2 07 F3 12      call _putchar  
2278   0CA5 2B 1B 00      mov b, [d + 27]
2279   0CA8 07 7B 14      call print_u16x              ; filesize
2280   0CAB 22 20         mov ah, $20
2281   0CAD 07 F3 12      call _putchar  
2282   0CB0 2B 19 00      mov b, [d + 25]
2283   0CB3 07 7B 14      call print_u16x              ; dirid / lba
2284   0CB6 22 20         mov ah, $20
2285   0CB8 07 F3 12      call _putchar
2286   0CBB             ; print date
2287   0CBB 33 1D 00      mov bl, [d + 29]             ; day
2288   0CBE 07 BF 14      call print_u8x
2289   0CC1 22 20         mov ah, $20
2290   0CC3 07 F3 12      call _putchar  
2291   0CC6 1F 1E 00      mov al, [d + 30]             ; month
2292   0CC9 FD 9E 02      shl al, 2
2293   0CCC DA            push d
2294   0CCD 3B EF 1A      mov d, s_months
2295   0CD0 22 00         mov ah, 0
2296   0CD2 59            add d, a
2297   0CD3 07 82 02      call _puts
2298   0CD6 E7            pop d
2299   0CD7 22 20         mov ah, $20
2300   0CD9 07 F3 12      call _putchar
2301   0CDC 2E 20         mov bl, $20
2302   0CDE 07 BF 14      call print_u8x
2303   0CE1 33 1F 00      mov bl, [d + 31]             ; year
2304   0CE4 07 BF 14      call print_u8x  
2305   0CE7 22 20         mov ah, $20
2306   0CE9 07 F3 12      call _putchar  
2307   0CEC 07 82 02      call _puts                   ; print filename  
2308   0CEF 07 CC 13      call printnl
2309   0CF2             fs_ls_next:
2310   0CF2 14 56 19      mov a, [index]
2311   0CF5 77            inc a
2312   0CF6 42 56 19      mov [index], a
2313   0CF9 AF 10 00      cmp a, fst_files_per_dir
2314   0CFC C6 05 0D      je fs_ls_end
2315   0CFF 58 20 00      add d, 32      
2316   0D02 0A 59 0C      jmp fs_ls_l1  
2317   0D05             fs_ls_end:
2318   0D05 3B 99 19      mov d, s_ls_total
2319   0D08 07 82 02      call _puts
2320   0D0B 1D 42 0C      mov al, [ls_count]
2321   0D0E 07 D1 14      call print_u8d
2322   0D11 07 CC 13      call printnl
2323   0D14 06            sysret
2324   0D15             
2325   0D15             ;------------------------------------------------------------------------------------------------------;
2326   0D15             ; finds an empty data block
2327   0D15             ; block lba returned in b
2328   0D15             ;------------------------------------------------------------------------------------------------------;
2329   0D15             fs_find_empty_block:
2330   0D15 26 A0 00      mov b, fs_lba_start     ; raw files starting block
2331   0D18 38 00 00      mov c, 0                ; upper lba = 0
2332   0D1B             fs_find_empty_block_l1:  
2333   0D1B 22 01         mov ah, $01                  ; 1 sector
2334   0D1D 3B 61 31      mov d, transient_area - 512
2335   0D20 07 BE 06      call ide_read_sect      ; read sector
2336   0D23 BD 00         cmp byte [d], 0
2337   0D25 C6 2E 0D      je fs_find_empty_block_found_null
2338   0D28 55 20 00      add b, fs_sectors_per_file
2339   0D2B 0A 1B 0D      jmp fs_find_empty_block_l1
2340   0D2E             fs_find_empty_block_found_null:
2341   0D2E 09            ret
2342   0D2F             
2343   0D2F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
2344   0D2F             ;; create new textfile
2345   0D2F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
2346   0D2F             ; search for first null block
2347   0D2F             fs_mktxt:
2348   0D2F FD 4E       	mov si, d
2349   0D31 FD 4F 61 1F 	mov di, user_data
2350   0D35 38 00 01    	mov c, 256
2351   0D38 04          	load					; load data from user-space
2352   0D39             	
2353   0D39 26 A0 00    	mov b, fs_lba_start		; raw files starting block
2354   0D3C 38 00 00    	mov c, 0						; reset lba to 0
2355   0D3F             fs_mktxt_l1:	
2356   0D3F 10 02 01    	mov a, $0102			; disk read
2357   0D42 3B 61 33    	mov d, transient_area
2358   0D45 05 02       	syscall sys_ide ; read sector
2359   0D47 1E          	mov al, [d]
2360   0D48 B9 00       	cmp al, 0			; check for null
2361   0D4A C6 53 0D    	je fs_mktxt_found_null
2362   0D4D 55 20 00    	add b, fs_sectors_per_file
2363   0D50 0A 3F 0D    	jmp fs_mktxt_l1
2364   0D53             fs_mktxt_found_null:
2365   0D53 D8          	push b				; save lba
2366   0D54             ;create header file by grabbing file name from parameter	
2367   0D54 3B 7A 19    	mov d, s_dataentry
2368   0D57 07 82 02    	call _puts
2369   0D5A 3B 61 35    	mov d, transient_area + 512			; pointer to file contents
2370   0D5D 07 85 13    	call _gettxt
2371   0D60 07 52 12    	call _strlen						; get length of file
2372   0D63 D9          	push c							; save length
2373   0D64 19 01       	mov al, 1
2374   0D66 3D 61 33    	mov [transient_area], al					; mark sectors as used (not null)
2375   0D69 10 00 00    	mov a, 0
2376   0D6C 42 56 19    	mov [index], a
2377   0D6F 3B 61 33    	mov d, transient_area
2378   0D72 13          	mov a, d
2379   0D73 42 58 19    	mov [buffer_addr], a
2380   0D76             fs_mktxt_l2:
2381   0D76 38 00 00    	mov c, 0
2382   0D79 10 03 01    	mov a, $0103			; disk write, 1 sector
2383   0D7C 05 02       	syscall sys_ide		; write sector
2384   0D7E 14 56 19    	mov a, [index]
2385   0D81 77          	inc a
2386   0D82 42 56 19    	mov [index], a
2387   0D85 AF 20 00    	cmp a, fs_sectors_per_file
2388   0D88 C6 9A 0D    	je fs_mktxt_add_to_dir
2389   0D8B FD 77       	inc b
2390   0D8D 14 58 19    	mov a, [buffer_addr]
2391   0D90 53 00 02    	add a, 512
2392   0D93 42 58 19    	mov [buffer_addr], a
2393   0D96 3C          	mov d, a
2394   0D97 0A 76 0D    	jmp fs_mktxt_l2
2395   0D9A             ; now we add the file to the current directory!
2396   0D9A             fs_mktxt_add_to_dir:	
2397   0D9A 14 5E 19    	mov a, [current_dir_id]
2398   0D9D 77          	inc a
2399   0D9E 27          	mov b, a					; metadata sector
2400   0D9F 38 00 00    	mov c, 0
2401   0DA2 FD 79       	mov g, b					; save lba
2402   0DA4 3B 61 33    	mov d, transient_area
2403   0DA7 10 02 01    	mov a, $0102			; disk read
2404   0DAA 05 02       	syscall sys_ide		; read metadata sector
2405   0DAC             fs_mktxt_add_to_dir_l2:
2406   0DAC 1E          	mov al, [d]
2407   0DAD B9 00       	cmp al, 0
2408   0DAF C6 B8 0D    	je fs_mktxt_add_to_dir_null
2409   0DB2 58 20 00    	add d, fst_entry_size
2410   0DB5 0A AC 0D    	jmp fs_mktxt_add_to_dir_l2					; we look for a null entry here but dont check for limits. care needed when adding too many files to a directory
2411   0DB8             fs_mktxt_add_to_dir_null:
2412   0DB8 FD 4D 61 1F 	mov si, user_data
2413   0DBC FD 50       	mov di, d
2414   0DBE 07 77 12    	call _strcpy			; copy file name
2415   0DC1 58 18 00    	add d, 24			; skip name
2416   0DC4 19 06       	mov al, %00000110		; no execute, write, read, not directory
2417   0DC6 3E          	mov [d], al			
2418   0DC7 58 03 00    	add d, 3
2419   0DCA E4          	pop a
2420   0DCB 43          	mov [d], a
2421   0DCC 63 02 00    	sub d, 2
2422   0DCF E5          	pop b				; get file lba
2423   0DD0 FD 43       	mov [d], b			; save lba	
2424   0DD2             	
2425   0DD2             	; set file creation date	
2426   0DD2 58 04 00    	add d, 4
2427   0DD5 19 04       	mov al, 4
2428   0DD7 05 01       	syscall sys_rtc
2429   0DD9 1A          	mov al, ah
2430   0DDA 3E          	mov [d], al			; set day
2431   0DDB             	
2432   0DDB 79          	inc d
2433   0DDC 19 05       	mov al, 5
2434   0DDE 05 01       	syscall sys_rtc
2435   0DE0 1A          	mov al, ah
2436   0DE1 3E          	mov [d], al			; set month
2437   0DE2             	
2438   0DE2 79          	inc d
2439   0DE3 19 06       	mov al, 6
2440   0DE5 05 01       	syscall sys_rtc
2441   0DE7 1A          	mov al, ah
2442   0DE8 3E          	mov [d], al			; set year
2443   0DE9             	
2444   0DE9             ; write sector into disk for new directory entry
2445   0DE9 FD 27       	mov b, g
2446   0DEB 38 00 00    	mov c, 0
2447   0DEE 3B 61 33    	mov d, transient_area
2448   0DF1 10 03 01    	mov a, $0103			; disk write, 1 sector
2449   0DF4 05 02       	syscall sys_ide		; write sector
2450   0DF6 07 CC 13    	call printnl
2451   0DF9 06          	sysret
2452   0DFA             
2453   0DFA             ;------------------------------------------------------------------------------------------------------;
2454   0DFA             ; create new binary file
2455   0DFA             ;------------------------------------------------------------------------------------------------------;
2456   0DFA             ; search for first null block
2457   0DFA             fs_mkbin:
2458   0DFA 19 00         mov al, 0
2459   0DFC 3D 49 19      mov [sys_echo_on], al ; disable echo
2460   0DFF FD 4E         mov si, d
2461   0E01 FD 4F 61 1F   mov di, user_data
2462   0E05 38 00 02      mov c, 512
2463   0E08 04            load                          ; load data from user-space
2464   0E09 26 A0 00      mov b, fs_lba_start           ; files start when directories end
2465   0E0C 38 00 00      mov c, 0                      ; upper lba = 0
2466   0E0F             fs_mkbin_l1:  
2467   0E0F 22 01         mov ah, $01                  ; 1 sector
2468   0E11 3B 61 33      mov d, transient_area
2469   0E14 07 BE 06      call ide_read_sect            ; read sector
2470   0E17 BD 00         cmp byte[d], 0                ; check for null
2471   0E19 C6 22 0E      je fs_mkbin_found_null
2472   0E1C 55 20 00      add b, fs_sectors_per_file
2473   0E1F 0A 0F 0E      jmp fs_mkbin_l1
2474   0E22             fs_mkbin_found_null:
2475   0E22 D8            push b                        ; save lba
2476   0E23             ;create header file by grabbing file name from parameter
2477   0E23 FD 4F 61 35   mov di, transient_area + 512  ; pointer to file contents
2478   0E27 07 9D 11      call _load_hex                ; load binary hex
2479   0E2A D9            push c                        ; save size (nbr of bytes)
2480   0E2B 19 01         mov al, 1
2481   0E2D 3D 61 33      mov [transient_area], al      ; mark sectors as used (not null)
2482   0E30 FD 10         cla
2483   0E32 42 56 19      mov [index], a
2484   0E35 3B 61 33      mov d, transient_area
2485   0E38 13            mov a, d
2486   0E39 42 58 19      mov [buffer_addr], a
2487   0E3C             fs_mkbin_l2:
2488   0E3C 38 00 00      mov c, 0
2489   0E3F 22 01         mov ah, $01                   ; disk write, 1 sector
2490   0E41 07 E4 06      call ide_write_sect           ; write sector
2491   0E44 14 56 19      mov a, [index]
2492   0E47 77            inc a
2493   0E48 42 56 19      mov [index], a
2494   0E4B AF 20 00      cmp a, fs_sectors_per_file    ; remove 1 from this because we dont count the header sector
2495   0E4E C6 60 0E      je fs_mkbin_add_to_dir
2496   0E51 FD 77         inc b
2497   0E53 14 58 19      mov a, [buffer_addr]
2498   0E56 53 00 02      add a, 512
2499   0E59 42 58 19      mov [buffer_addr], a
2500   0E5C 3C            mov d, a
2501   0E5D 0A 3C 0E      jmp fs_mkbin_l2
2502   0E60             ; now we add the file to the current directory!
2503   0E60             fs_mkbin_add_to_dir:  
2504   0E60 14 5E 19      mov a, [current_dir_id]
2505   0E63 77            inc a
2506   0E64 27            mov b, a                      ; metadata sector
2507   0E65 38 00 00      mov c, 0
2508   0E68 FD 79         mov g, b                      ; save lba
2509   0E6A 3B 61 33      mov d, transient_area
2510   0E6D 22 01         mov ah, $01                  ; 1 sector
2511   0E6F 07 BE 06      call ide_read_sect            ; read metadata sector
2512   0E72             fs_mkbin_add_to_dir_l2:
2513   0E72 BD 00         cmp byte[d], 0
2514   0E74 C6 7D 0E      je fs_mkbin_add_to_dir_null
2515   0E77 58 20 00      add d, fst_entry_size
2516   0E7A 0A 72 0E      jmp fs_mkbin_add_to_dir_l2   ; we look for a null entry here but dont check for limits. care needed when adding too many files to a directory
2517   0E7D             fs_mkbin_add_to_dir_null:
2518   0E7D FD 4D 61 1F   mov si, user_data
2519   0E81 FD 50         mov di, d
2520   0E83 07 77 12      call _strcpy                  ; copy file name
2521   0E86 58 18 00      add d, 24                     ; skip name
2522   0E89 19 03         mov al, %00000011             ; type=file, no execute, write, read, 
2523   0E8B 3E            mov [d], al
2524   0E8C 58 03 00      add d, 3
2525   0E8F E4            pop a
2526   0E90 43            mov [d], a
2527   0E91 63 02 00      sub d, 2
2528   0E94 E5            pop b                         ; get file lba
2529   0E95 FD 43         mov [d], b                    ; save lba
2530   0E97               ; set file creation date  
2531   0E97 58 04 00      add d, 4
2532   0E9A 19 04         mov al, 4
2533   0E9C 05 01         syscall sys_rtc
2534   0E9E 1A            mov al, ah
2535   0E9F 3E            mov [d], al                   ; set day
2536   0EA0 79            inc d
2537   0EA1 19 05         mov al, 5
2538   0EA3 05 01         syscall sys_rtc
2539   0EA5 1A            mov al, ah
2540   0EA6 3E            mov [d], al                   ; set month
2541   0EA7 79            inc d
2542   0EA8 19 06         mov al, 6
2543   0EAA 05 01         syscall sys_rtc
2544   0EAC 1A            mov al, ah
2545   0EAD 3E            mov [d], al                   ; set year
2546   0EAE             ; write sector into disk for new directory entry
2547   0EAE FD 27         mov b, g
2548   0EB0 38 00 00      mov c, 0
2549   0EB3 3B 61 33      mov d, transient_area
2550   0EB6 22 01         mov ah, $01                   ; disk write, 1 sector
2551   0EB8 07 E4 06      call ide_write_sect           ; write sector
2552   0EBB 19 01         mov al, 1
2553   0EBD 3D 49 19      mov [sys_echo_on], al ; enable echo
2554   0EC0 06            sysret
2555   0EC1             
2556   0EC1             ;------------------------------------------------------------------------------------------------------;
2557   0EC1             ; pwd - print working directory
2558   0EC1             ;------------------------------------------------------------------------------------------------------;    
2559   0EC1             fs_pwd:
2560   0EC1 3B E1 1E      mov d, filename
2561   0EC4 19 00         mov al, 0
2562   0EC6 3E            mov [d], al                   ; initialize path string 
2563   0EC7 14 5E 19      mov a, [current_dir_id]
2564   0ECA 07 2B 0A      call fs_dir_id_to_path_e0
2565   0ECD 3B E1 1E      mov d, filename
2566   0ED0 07 0B 12      call _strrev
2567   0ED3 07 82 02      call _puts
2568   0ED6 07 CC 13      call printnl
2569   0ED9 06            sysret
2570   0EDA             
2571   0EDA             ;------------------------------------------------------------------------------------------------------;
2572   0EDA             ; get current directory lba
2573   0EDA             ; a: returned lba
2574   0EDA             ;------------------------------------------------------------------------------------------------------;
2575   0EDA             cmd_get_curr_dir_lba:
2576   0EDA 14 5E 19      mov a, [current_dir_id]
2577   0EDD 06            sysret
2578   0EDE             
2579   0EDE             ;------------------------------------------------------------------------------------------------------;
2580   0EDE             ; cat
2581   0EDE             ; userspace destination data pointer in d
2582   0EDE             ; filename starts at d, but is overwritten after the read is made
2583   0EDE             ;------------------------------------------------------------------------------------------------------;:
2584   0EDE             fs_cat:
2585   0EDE DA            push d                              ; save userspace file data destination
2586   0EDF FD 4E         mov si, d
2587   0EE1 FD 4F 61 1F   mov di, user_data
2588   0EE5 38 00 02      mov c, 512
2589   0EE8 04            load                                ; copy filename from user-space
2590   0EE9 29 5E 19      mov b, [current_dir_id]
2591   0EEC FD 77         inc b                               ; metadata sector
2592   0EEE 38 00 00      mov c, 0                            ; upper lba = 0
2593   0EF1 22 01         mov ah, $01                  ; 1 sector
2594   0EF3 3B 61 31      mov d, transient_area-512
2595   0EF6 07 BE 06      call ide_read_sect                  ; read directory
2596   0EF9 FD 10         cla
2597   0EFB 42 56 19      mov [index], a                      ; reset file counter
2598   0EFE             fs_cat_l1:
2599   0EFE FD 4E         mov si, d
2600   0F00 FD 4F 61 1F   mov di, user_data
2601   0F04 07 62 12      call _strcmp
2602   0F07 C6 1D 0F      je fs_cat_found_entry
2603   0F0A 58 20 00      add d, 32
2604   0F0D 14 56 19      mov a, [index]
2605   0F10 77            inc a
2606   0F11 42 56 19      mov [index], a
2607   0F14 AF 10 00      cmp a, fst_files_per_dir
2608   0F17 C6 38 0F      je fs_cat_not_found
2609   0F1A 0A FE 0E      jmp fs_cat_l1
2610   0F1D             fs_cat_found_entry:
2611   0F1D 58 19 00      add d, 25                           ; get to dirid of file in disk
2612   0F20 2A            mov b, [d]                          ; get lba
2613   0F21 FD 77         inc b                               ; add 1 to b because the lba for data comes after the header sector 
2614   0F23 3B 61 33      mov d, transient_area  
2615   0F26 38 00 00      mov c, 0
2616   0F29 22 1F         mov ah, fs_sectors_per_file-1       ; nbr sectors
2617   0F2B 07 BE 06      call ide_read_sect                  ; read sectors
2618   0F2E F0            pop di                              ; write userspace file data destination to di
2619   0F2F FD 4D 61 33   mov si, transient_area              ; data origin
2620   0F33 38 00 3E      mov c, 512*(fs_sectors_per_file-1)
2621   0F36 03            store
2622   0F37 06            sysret
2623   0F38             fs_cat_not_found:
2624   0F38 E7            pop d
2625   0F39 06            sysret
2626   0F3A             
2627   0F3A             ;------------------------------------------------------------------------------------------------------;
2628   0F3A             ; rmdir - remove dir by dirid
2629   0F3A             ;------------------------------------------------------------------------------------------------------;
2630   0F3A             ; deletes a directory entry in the given directory's file list 
2631   0F3A             ; also deletes the actual directory entry in the fst
2632   0F3A             ; synopsis: rmdir /usr/local/testdir
2633   0F3A             ; b = dirid
2634   0F3A             fs_rmdir:
2635   0F3A FD 79         mov g, b
2636   0F3C 11            mov a, b
2637   0F3D 07 67 0A      call get_parentid_from_dirid  ; now get the directory's parent, in a
2638   0F40 D7            push a                        ; save dirid
2639   0F41             ; search for directory's entry in the parent's directory then and delete it
2640   0F41 77            inc a                         ; metadata sector
2641   0F42 27            mov b, a
2642   0F43 38 00 00      mov c, 0                      ; upper lba = 0
2643   0F46 22 01         mov ah, $01          ;
2644   0F48 3B 61 33      mov d, transient_area
2645   0F4B 07 BE 06      call ide_read_sect            ; read directory
2646   0F4E FD 10         cla
2647   0F50 42 56 19      mov [index], a                ; reset file counter
2648   0F53 FD 27         mov b, g                      ; retrieve directory's dirid
2649   0F55             fs_rmdir_l1:
2650   0F55 16 19 00      mov a, [d + 25]               ; get entry's dirid/lba value
2651   0F58 B0            cmp a, b                      ; compare dirid's to find the directory
2652   0F59 C6 6F 0F      je fs_rmdir_found_entry
2653   0F5C 58 20 00      add d, 32
2654   0F5F 14 56 19      mov a, [index]
2655   0F62 77            inc a
2656   0F63 42 56 19      mov [index], a
2657   0F66 AF 10 00      cmp a, fst_files_per_dir
2658   0F69 C6 94 0F      je fs_rmdir_not_found
2659   0F6C 0A 55 0F      jmp fs_rmdir_l1
2660   0F6F             fs_rmdir_found_entry:
2661   0F6F FD 10         cla
2662   0F71 3E            mov [d], al                   ; make filename null
2663   0F72 44 19 00      mov [d + 25], a               ; clear dirid/lba as well not to generate problems with previously deleted directories
2664   0F75 E5            pop b
2665   0F76 FD 77         inc b                         ; metadata sector
2666   0F78 38 00 00      mov c, 0                      ; upper lba = 0
2667   0F7B 22 01         mov ah, $01          ; 
2668   0F7D 3B 61 33      mov d, transient_area
2669   0F80 07 E4 06      call ide_write_sect           ; write sector and erase file's entry in the current dir
2670   0F83             
2671   0F83 FD 27         mov b, g
2672   0F85 3B 61 33      mov d, transient_area  
2673   0F88 FD 10         cla
2674   0F8A 3E            mov [d], al                   ; make directory's name header null for re-use
2675   0F8B 38 00 00      mov c, 0
2676   0F8E 22 01         mov ah, $01                   ; disk write 1 sect
2677   0F90 07 E4 06      call ide_write_sect           ; delete directory given by dirid in b
2678   0F93 06            sysret
2679   0F94             fs_rmdir_not_found:
2680   0F94 E5            pop b
2681   0F95 06            sysret
2682   0F96             
2683   0F96             ;------------------------------------------------------------------------------------------------------;
2684   0F96             ; rm - remove file
2685   0F96             ;------------------------------------------------------------------------------------------------------;
2686   0F96             ; frees up the data sectors for the file further down the disk
2687   0F96             ; deletes file entry in the directory's file list 
2688   0F96             fs_rm:
2689   0F96 FD 4E         mov si, d
2690   0F98 FD 4F 61 1F   mov di, user_data
2691   0F9C 38 00 02      mov c, 512
2692   0F9F 04            load                          ; load data from user-space
2693   0FA0 14 5E 19      mov a, [current_dir_id]
2694   0FA3 77            inc a                         ; metadata sector
2695   0FA4 27            mov b, a
2696   0FA5 38 00 00      mov c, 0                      ; upper lba = 0
2697   0FA8 22 01         mov ah, $01                  ; 1 sector
2698   0FAA 3B 61 33      mov d, transient_area
2699   0FAD 07 BE 06      call ide_read_sect            ; read directory
2700   0FB0 10 00 00      mov a, 0
2701   0FB3 42 56 19      mov [index], a                ; reset file counter
2702   0FB6             fs_rm_l1:
2703   0FB6 FD 4E         mov si, d
2704   0FB8 FD 4F 61 1F   mov di, user_data
2705   0FBC 07 62 12      call _strcmp
2706   0FBF C6 D5 0F      je fs_rm_found_entry
2707   0FC2 58 20 00      add d, 32
2708   0FC5 14 56 19      mov a, [index]
2709   0FC8 77            inc a
2710   0FC9 42 56 19      mov [index], a
2711   0FCC AF 10 00      cmp a, fst_files_per_dir
2712   0FCF C6 FD 0F      je fs_rm_not_found
2713   0FD2 0A B6 0F      jmp fs_rm_l1
2714   0FD5             fs_rm_found_entry:
2715   0FD5 2B 19 00      mov b, [d + 25]               ; get lba
2716   0FD8 FD 79         mov g, b                      ; save lba
2717   0FDA 19 00         mov al, 0
2718   0FDC 3E            mov [d], al                   ; make file entry null
2719   0FDD 14 5E 19      mov a, [current_dir_id]
2720   0FE0 77            inc a                         ; metadata sector
2721   0FE1 27            mov b, a
2722   0FE2 38 00 00      mov c, 0                      ; upper lba = 0
2723   0FE5 22 01         mov ah, $01                   ; disk write
2724   0FE7 3B 61 33      mov d, transient_area
2725   0FEA 07 E4 06      call ide_write_sect           ; write sector and erase file's entry in the current dir
2726   0FED 3B 61 33      mov d, transient_area  
2727   0FF0 19 00         mov al, 0
2728   0FF2 3E            mov [d], al                   ; make file's data header null for re-use
2729   0FF3 38 00 00      mov c, 0
2730   0FF6 FD 27         mov b, g                      ; get data header lba
2731   0FF8 22 01         mov ah, $01                   ; disk write 1 sect
2732   0FFA 07 E4 06      call ide_write_sect           ; write sector
2733   0FFD             fs_rm_not_found:  
2734   0FFD 06            sysret  
2735   0FFE             
2736   0FFE             ;------------------------------------------------------------------------------------------------------;
2737   0FFE             ; mv - move / change file name
2738   0FFE             ;------------------------------------------------------------------------------------------------------;
2739   0FFE             fs_mv:
2740   0FFE FD 4E         mov si, d
2741   1000 FD 4F 61 1F   mov di, user_data
2742   1004 38 00 02      mov c, 512
2743   1007 04            load                          ; load data from user-space
2744   1008 14 5E 19      mov a, [current_dir_id]
2745   100B 77            inc a                         ; metadata sector
2746   100C 27            mov b, a  
2747   100D 38 00 00      mov c, 0                      ; upper lba = 0
2748   1010 22 01         mov ah, $01                  ; 1 sector
2749   1012 3B 61 33      mov d, transient_area
2750   1015 07 BE 06      call ide_read_sect            ; read directory
2751   1018 FD 10         cla
2752   101A 42 56 19      mov [index], a                ; reset file counter
2753   101D             fs_mv_l1:
2754   101D FD 4E         mov si, d
2755   101F FD 4F 61 1F   mov di, user_data
2756   1023 07 62 12      call _strcmp
2757   1026 C6 3C 10      je fs_mv_found_entry
2758   1029 58 20 00      add d, 32
2759   102C 14 56 19      mov a, [index]
2760   102F 77            inc a
2761   1030 42 56 19      mov [index], a
2762   1033 AF 10 00      cmp a, fst_files_per_dir
2763   1036 C6 6E 10      je fs_mv_not_found
2764   1039 0A 1D 10      jmp fs_mv_l1
2765   103C             fs_mv_found_entry:  
2766   103C DA            push d
2767   103D FD 4D E1 1F   mov si, user_data + 128       ; (0...127) = original filename , (128...255) = new name
2768   1041 FD 50         mov di, d
2769   1043 07 77 12      call _strcpy  
2770   1046 38 00 00      mov c, 0
2771   1049 3B 61 33      mov d, transient_area
2772   104C 22 01         mov ah, $01                   ; disk write 1 sect
2773   104E 07 E4 06      call ide_write_sect           ; write sector
2774   1051 E7            pop d
2775   1052             ;; need to check whether its a dir or a file here ;;;
2776   1052 2B 19 00      mov b, [d + 25]               ; get the dirid of the directory so we can locate its own entry in the list
2777   1055 22 01         mov ah, $01
2778   1057 3B 61 33      mov d, transient_area
2779   105A 38 00 00      mov c, 0
2780   105D 07 BE 06      call ide_read_sect            ; read directory entry
2781   1060 FD 4D E1 1F   mov si, user_data + 128
2782   1064 FD 50         mov di, d
2783   1066 07 77 12      call _strcpy                  ; change directory's name
2784   1069 22 01         mov ah, $01
2785   106B 07 E4 06      call ide_write_sect           ; rewrite directory back to disk
2786   106E             fs_mv_not_found:
2787   106E 06            sysret
2788   106F             
2789   106F             
2790   106F             ;----------------------------------------------------------------------------------------------------;
2791   106F             ; process index in a
2792   106F             ;----------------------------------------------------------------------------------------------------;
2793   106F             find_free_proc:
2794   106F FD 4D D2 1C   mov si, proc_availab_table + 1      ; skip process 0 (kernel)
2795   1073             find_free_proc_l0:
2796   1073 F6            lodsb                               ; get process state
2797   1074 B9 00         cmp al, 0
2798   1076 C6 7C 10      je find_free_proc_free              ; if free, jump
2799   1079 0A 73 10      jmp find_free_proc_l0               ; else, goto next
2800   107C             find_free_proc_free:
2801   107C 4E            mov a, si
2802   107D 5F D2 1C      sub a, 1 + proc_availab_table       ; get process index
2803   1080 09            ret
2804   1081               
2805   1081             
2806   1081             ;----------------------------------------------------------------------------------------------------;
2807   1081             ; process index in al
2808   1081             ;----------------------------------------------------------------------------------------------------;
2809   1081             proc_memory_map:
2810   1081 22 00         mov ah, 0
2811   1083 27            mov b, a                      ; page in bl, 0 in bh
2812   1084 FD 9D 05      shl a, 5                      ; multiply by 32
2813   1087 39            mov c, a                      ; save in c
2814   1088 57 20 00      add c, 32
2815   108B             proc_memory_map_l0:
2816   108B 02            pagemap
2817   108C 55 00 08      add b, $0800                  ; increase page number (msb 5 bits of bh only)
2818   108F 53 01 00      add a, 1                      ; increase both 
2819   1092 B1            cmp a, c                      ; check to see if we reached the end of memory
2820   1093 C7 8B 10      jne proc_memory_map_l0
2821   1096 09            ret
2822   1097               
2823   1097             
2824   1097             ;----------------------------------------------------------------------------------------------------;
2825   1097             ; terminate process
2826   1097             ;----------------------------------------------------------------------------------------------------;
2827   1097             syscall_terminate_proc:
2828   1097 51 05 00      add sp, 5                            ; clear stack of the values that were pushed by the interrupt (sp, status, pc)
2829   109A                                                    ; since they will not be used for anything here.
2830   109A 1D 55 19      mov al, [active_proc_index]
2831   109D 22 00         mov ah, 0  
2832   109F FD 9D 05      shl a, 5                             ; x32
2833   10A2 53 E1 1C      add a, proc_names
2834   10A5 3C            mov d, a
2835   10A6 19 00         mov al, 0
2836   10A8 3E            mov [d], al                           ; nullify process name
2837   10A9             
2838   10A9 1D 55 19      mov al, [active_proc_index]
2839   10AC 22 00         mov ah, 0  
2840   10AE 3C            mov d, a
2841   10AF 19 00         mov al, 0
2842   10B1 3F D1 1C      mov [d + proc_availab_table], al    ; make process empty again
2843   10B4               
2844   10B4 1D 54 19      mov al, [nbr_active_procs]          ; decrease nbr of active processes
2845   10B7 80            dec al
2846   10B8 3D 54 19      mov [nbr_active_procs], al
2847   10BB             
2848   10BB             ; now load the shell process again
2849   10BB 19 02         mov al, 2                           ; next process = process 2 = shell
2850   10BD 3D 55 19      mov [active_proc_index], al         ; set next active proc
2851   10C0             
2852   10C0             ; calculate lut entry for next process
2853   10C0 22 00         mov ah, 0
2854   10C2 FD 99         shl a                               ; x2
2855   10C4 B7 8D 11      mov a, [proc_table_convert + a]     ; get process state start index  
2856   10C7               
2857   10C7 4D            mov si, a                           ; source is proc state block
2858   10C8 48            mov a, sp
2859   10C9 5F 13 00      sub a, 19
2860   10CC 4F            mov di, a                           ; destination is kernel stack
2861   10CD             ; restore sp
2862   10CD 7D            dec a
2863   10CE 47            mov sp, a
2864   10CF 38 14 00      mov c, 20
2865   10D2 FD F5         rep movsb
2866   10D4             ; set vm process
2867   10D4 1D 55 19      mov al, [active_proc_index]
2868   10D7 01            setptb
2869   10D8                 
2870   10D8 4C            popa
2871   10D9 06            sysret
2872   10DA             
2873   10DA             ;----------------------------------------------------------------------------------------------------;
2874   10DA             ; pause process
2875   10DA             ;----------------------------------------------------------------------------------------------------;
2876   10DA             syscall_pause_proc:
2877   10DA             ; save all registers into kernel stack
2878   10DA 4B            pusha
2879   10DB 22 00         mov ah, 0
2880   10DD 1D 55 19      mov al, [active_proc_index]
2881   10E0 FD 99         shl a              ; x2
2882   10E2 B7 8D 11      mov a, [proc_table_convert + a]   ; get process state start index
2883   10E5                 
2884   10E5 4F            mov di, a
2885   10E6 48            mov a, sp
2886   10E7 77            inc a
2887   10E8 4D            mov si, a
2888   10E9 38 14 00      mov c, 20
2889   10EC FD F5         rep movsb                         ; save process state!
2890   10EE             ; restore kernel stack position to point before interrupt arrived
2891   10EE 51 14 00      add sp, 20
2892   10F1             ; now load the shell process again
2893   10F1 19 02         mov al, 2                         ; next process = process 2 = shell
2894   10F3 3D 55 19      mov [active_proc_index], al       ; set next active proc
2895   10F6             
2896   10F6             ; calculate lut entry for next process
2897   10F6 22 00         mov ah, 0
2898   10F8 FD 99         shl a                             ; x2
2899   10FA B7 8D 11      mov a, [proc_table_convert + a]   ; get process state start index  
2900   10FD               
2901   10FD 4D            mov si, a                         ; source is proc state block
2902   10FE 48            mov a, sp
2903   10FF 5F 13 00      sub a, 19
2904   1102 4F            mov di, a                         ; destination is kernel stack
2905   1103             ; restore sp
2906   1103 7D            dec a
2907   1104 47            mov sp, a
2908   1105 38 14 00      mov c, 20
2909   1108 FD F5         rep movsb
2910   110A             ; set vm process
2911   110A 1D 55 19      mov al, [active_proc_index]
2912   110D 01            setptb
2913   110E                 
2914   110E 4C            popa
2915   110F 06            sysret
2916   1110             
2917   1110             ;----------------------------------------------------------------------------------------------------;
2918   1110             ; create a new process
2919   1110             ; d = path of the process file to be createed
2920   1110             ; b = arguments ptr
2921   1110             ;----------------------------------------------------------------------------------------------------;
2922   1110             syscall_create_proc:
2923   1110             ; we save the active process first  
2924   1110 4B            pusha
2925   1111 22 00         mov ah, 0
2926   1113 1D 55 19      mov al, [active_proc_index]
2927   1116 FD 99         shl a              ; x2
2928   1118 B7 8D 11      mov a, [proc_table_convert + a]    ; get process state table's start index
2929   111B               
2930   111B 4F            mov di, a
2931   111C 48            mov a, sp
2932   111D 77            inc a
2933   111E 4D            mov si, a
2934   111F 38 14 00      mov c, 20
2935   1122 FD F5         rep movsb                          ; save process state!
2936   1124             ; restore kernel stack position to point before interrupt arrived
2937   1124 51 14 00      add sp, 20
2938   1127               
2939   1127 FD 4E         mov si, d                          ; copy the file path
2940   1129 FD 4F 61 1F   mov di, user_data
2941   112D 38 00 02      mov c, 512
2942   1130 04            load
2943   1131 11            mov a, b
2944   1132 4D            mov si, a                          ; copy the arguments
2945   1133 FD 4F 61 31   mov di, scrap_sector
2946   1137 38 00 02      mov c, 512
2947   113A 04            load
2948   113B 07 AD 0B      call loadfile_from_path            ; load the process file from disk by path (path is in user_data)
2949   113E                                                  ; the file data is loaded into transient_area
2950   113E             ; now we allocate a new process  
2951   113E 07 6F 10      call find_free_proc                ; index in a
2952   1141 01            setptb 
2953   1142 07 81 10      call proc_memory_map               ; map process memory pages
2954   1145             ; copy arguments into process's memory
2955   1145 FD 4D 61 31   mov si, scrap_sector
2956   1149 FD 4F 00 00   mov di, 0
2957   114D 38 00 02      mov c, 512
2958   1150 03            store
2959   1151             ; now copy process binary data into process's memory
2960   1151 FD 4D 61 33   mov si, transient_area
2961   1155 FD 4F 00 04   mov di, text_org                   ; code origin address for all user processes
2962   1159 38 00 40      mov c, fs_file_size                ; size of memory space to copy, which is equal to the max file size in disk (for now)
2963   115C 03            store                              ; copy process data
2964   115D                 
2965   115D 07 6F 10      call find_free_proc                ; index in a
2966   1160 3D 55 19      mov [active_proc_index], al        ; set new active process
2967   1163 FD 9D 05      shl a, 5                           ; x32
2968   1166 53 E1 1C      add a, proc_names
2969   1169 4F            mov di, a
2970   116A FD 4D 61 1F   mov si, user_data                  ; copy and store process filename
2971   116E 07 77 12      call _strcpy
2972   1171               
2973   1171 07 6F 10      call find_free_proc                ; index in a
2974   1174 3C            mov d, a
2975   1175 19 01         mov al, 1
2976   1177 3F D1 1C      mov [d + proc_availab_table], al   ; make process busy
2977   117A               
2978   117A 1D 54 19      mov al, [nbr_active_procs]         ; increase nbr of active processes
2979   117D 7A            inc al
2980   117E 3D 54 19      mov [nbr_active_procs], al
2981   1181             ; launch process
2982   1181 FD D7 FF FF   push word $ffff 
2983   1185 FD DB 0E      push byte %00001110                ; dma_ack = 0, interrupts enabled = 1, mode = user, paging = on, halt=0, display_reg_load=0, dir=0
2984   1188 FD D7 00 04   push word text_org
2985   118C 06            sysret
2986   118D             
2987   118D             proc_table_convert:
2988   118D 91 1B         .dw proc_state_table + 0
2989   118F A5 1B         .dw proc_state_table + 20
2990   1191 B9 1B         .dw proc_state_table + 40
2991   1193 CD 1B         .dw proc_state_table + 60
2992   1195 E1 1B         .dw proc_state_table + 80
2993   1197 F5 1B         .dw proc_state_table + 100
2994   1199 09 1C         .dw proc_state_table + 120
2995   119B 1D 1C         .dw proc_state_table + 140
2996   119D               
2997   119D             ;----------------------------------------------------------------------------------------------;
2998   119D             ; get hex file
2999   119D             ; di = destination address
3000   119D             ; return length in bytes in c
3001   119D             ;----------------------------------------------------------------------------------------------;
3002   119D             _load_hex:
3003   119D D7            push a
3004   119E D8            push b
3005   119F DA            push d
3006   11A0 E2            push si
3007   11A1 E3            push di
3008   11A2 38 00 00      mov c, 0
3009   11A5 50            mov a, di
3010   11A6 3C            mov d, a          ; start of string data block
3011   11A7 07 FA 12      call _gets        ; get program string
3012   11AA 4D            mov si, a
3013   11AB             __load_hex_loop:
3014   11AB F6            lodsb             ; load from [si] to al
3015   11AC B9 00         cmp al, 0         ; check if ascii 0
3016   11AE C6 BC 11      jz __load_hex_ret
3017   11B1 36            mov bh, al
3018   11B2 F6            lodsb
3019   11B3 2F            mov bl, al
3020   11B4 07 B0 12      call _atoi        ; convert ascii byte in b to int (to al)
3021   11B7 F7            stosb             ; store al to [di]
3022   11B8 78            inc c
3023   11B9 0A AB 11      jmp __load_hex_loop
3024   11BC             __load_hex_ret:
3025   11BC F0            pop di
3026   11BD EF            pop si
3027   11BE E7            pop d
3028   11BF E5            pop b
3029   11C0 E4            pop a
3030   11C1 09            ret
3031   11C2             
3032   11C2             ; synopsis: look inside a certain directory for files/directories
3033   11C2             ; before calling this function, cd into required directory
3034   11C2             ; for each entry inside directory:
3035   11C2             ;  if entry is a file:
3036   11C2             ;    compare filename to searched filename
3037   11C2             ;    if filenames are the same, print filename
3038   11C2             ;  else if entry is a directory:
3039   11C2             ;    cd to the given directory
3040   11C2             ;    recursively call cmd_find
3041   11C2             ;    cd outside previous directory
3042   11C2             ;  if current entry == last entry, return
3043   11C2             ; endfor
3044   11C2             f_find:
3045   11C2 09            ret
3046   11C3             
3047   11C3             
3048   11C3             ; ---------------------------------------------------------------------
3049   11C3             ; kernel reset vector
3050   11C3             ; ---------------------------------------------------------------------
3051   11C3             kernel_reset_vector:  
3052   11C3 FD 49 FF F7   mov bp, _stack_begin
3053   11C7 FD 47 FF F7   mov sp, _stack_begin
3054   11CB               
3055   11CB 19 A1         mov al, %10100001             ; mask out timer interrupt for now - enable uarts and fdc irqs 
3056   11CD FD 0F         stomsk                        
3057   11CF FD 0C         sti  
3058   11D1             
3059   11D1 0C            lodstat
3060   11D2 87 DF         and al, %11011111             ; disable display register loading
3061   11D4 0D            stostat
3062   11D5               
3063   11D5             ; reset fifo pointers
3064   11D5 10 61 21      mov a, fifo
3065   11D8 3B 5A 19      mov d, fifo_in
3066   11DB 43            mov [d], a
3067   11DC 3B 5C 19      mov d, fifo_out
3068   11DF 43            mov [d], a  
3069   11E0 19 02         mov al, 2
3070   11E2 05 03         syscall sys_io                ; enable uart in interrupt mode
3071   11E4             
3072   11E4 3B AF 19      mov d, s_kernel_welcome
3073   11E7 07 82 02      call _puts
3074   11EA             
3075   11EA 3B 50 1B      mov d, s_fdc_config
3076   11ED 07 82 02      call _puts
3077   11F0 F2 C0 FF 0D   mov byte [_fdc_config], %00001101  ; %00001001 : turn led on / head load, disable double density, select side 0, select drive 0, do not select drive 1
3078   11F4 F2 C8 FF 0B   mov byte [_fdc_stat_cmd], %00001011     ; leave this restore command in order to clear BUSY flag
3079   11F8 F2 C9 FF 00   mov byte [_fdc_track], $00 ; reset track
3080   11FC             
3081   11FC 19 10         mov al, 16
3082   11FE 05 04         syscall sys_filesystem        ; set root dirid
3083   1200             
3084   1200 3B 73 1A      mov d, s_prompt_init
3085   1203 07 82 02      call _puts
3086   1206 3B 60 19      mov d, s_init_path
3087   1209 05 05         syscall sys_create_proc       ; launch init as a new process
3088   120B             
3089   120B             ; file includes
3090   120B             .include "bios.exp"         ; to obtain the bios_reset_vector location (for reboots)
0001+  120B             boot_origin      .EQU  $8004
0002+  120B             bios_uart        .EQU  $0002
0003+  120B             bios_ide         .EQU  $0003
0004+  120B             bios_reset_vector .EQU  $01c0
0005+  120B             ide_buffer       .EQU  $8404
0006+  120B             noname._puts     .EQU  $0282
3091   120B             .include "lib/stdio.asm"
0001+  120B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002+  120B             ; stdio.s
0003+  120B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004+  120B             .include "lib/string.asm"
0001++ 120B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002++ 120B             ; string.s
0003++ 120B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004++ 120B             
0005++ 120B             
0006++ 120B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0007++ 120B             ; _strrev
0008++ 120B             ; reverse a string
0009++ 120B             ; d = string address
0010++ 120B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0011++ 120B             ; 01234
0012++ 120B             _strrev:
0013++ 120B 4B          	pusha
0014++ 120C 07 52 12    	call _strlen	; length in c
0015++ 120F 12          	mov a, c
0016++ 1210 AF 01 00    	cmp a, 1
0017++ 1213 D0 2D 12    	jleu _strrev_end	; check string length. string len must be > 1
0018++ 1216 7D          	dec a
0019++ 1217 FD 4E       	mov si, d	; beginning of string
0020++ 1219 FD 50       	mov di, d	; beginning of string (for destinations)
0021++ 121B 59          	add d, a	; end of string
0022++ 121C 12          	mov a, c
0023++ 121D FD 9B       	shr a		; divide by 2
0024++ 121F 39          	mov c, a	; c now counts the steps
0025++ 1220             _strrev_l0:
0026++ 1220 32          	mov bl, [d]	; save load right-side char into bl
0027++ 1221 F6          	lodsb		; load left-side char into al; increase si
0028++ 1222 3E          	mov [d], al	; store left char into right side
0029++ 1223 1B          	mov al, bl
0030++ 1224 F7          	stosb		; store right-side char into left-side; increase di
0031++ 1225 7E          	dec c
0032++ 1226 7F          	dec d
0033++ 1227 C2 00 00    	cmp c, 0
0034++ 122A C7 20 12    	jne _strrev_l0
0035++ 122D             _strrev_end:
0036++ 122D 4C          	popa
0037++ 122E 09          	ret
0038++ 122F             	
0039++ 122F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0040++ 122F             ; _strchr
0041++ 122F             ; search string in d for char in al
0042++ 122F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0043++ 122F             _strchr:
0044++ 122F             _strchr_l0:
0045++ 122F 32          	mov bl, [d]
0046++ 1230 C1 00       	cmp bl, 0
0047++ 1232 C6 3D 12    	je _strchr_end
0048++ 1235 BA          	cmp al, bl
0049++ 1236 C6 3D 12    	je _strchr_end
0050++ 1239 79          	inc d
0051++ 123A 0A 2F 12    	jmp _strchr_l0
0052++ 123D             _strchr_end:
0053++ 123D 1B          	mov al, bl
0054++ 123E 09          	ret
0055++ 123F             
0056++ 123F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0057++ 123F             ; _strstr
0058++ 123F             ; find sub-string
0059++ 123F             ; str1 in si
0060++ 123F             ; str2 in di
0061++ 123F             ; si points to end of source string
0062++ 123F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0063++ 123F             _strstr:
0064++ 123F DB          	push al
0065++ 1240 DA          	push d
0066++ 1241 E3          	push di
0067++ 1242             _strstr_loop:
0068++ 1242 F3          	cmpsb					; compare a byte of the strings
0069++ 1243 C7 4E 12    	jne _strstr_ret
0070++ 1246 FC 00 00    	lea d, [di + 0]
0071++ 1249 BD 00       	cmp byte[d], 0				; check if at end of string (null)
0072++ 124B C7 42 12    	jne _strstr_loop				; equal chars but not at end
0073++ 124E             _strstr_ret:
0074++ 124E F0          	pop di
0075++ 124F E7          	pop d
0076++ 1250 E8          	pop al
0077++ 1251 09          	ret
0078++ 1252             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0079++ 1252             ; length of null terminated string
0080++ 1252             ; result in c
0081++ 1252             ; pointer in d
0082++ 1252             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0083++ 1252             _strlen:
0084++ 1252 DA          	push d
0085++ 1253 38 00 00    	mov c, 0
0086++ 1256             _strlen_l1:
0087++ 1256 BD 00       	cmp byte [d], 0
0088++ 1258 C6 60 12    	je _strlen_ret
0089++ 125B 79          	inc d
0090++ 125C 78          	inc c
0091++ 125D 0A 56 12    	jmp _strlen_l1
0092++ 1260             _strlen_ret:
0093++ 1260 E7          	pop d
0094++ 1261 09          	ret
0095++ 1262             
0096++ 1262             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0097++ 1262             ; strcmp
0098++ 1262             ; compare two strings
0099++ 1262             ; str1 in si
0100++ 1262             ; str2 in di
0101++ 1262             ; create a string compairon instrucion ?????
0102++ 1262             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0103++ 1262             _strcmp:
0104++ 1262 DB          	push al
0105++ 1263 DA          	push d
0106++ 1264 E3          	push di
0107++ 1265 E2          	push si
0108++ 1266             _strcmp_loop:
0109++ 1266 F3          	cmpsb					; compare a byte of the strings
0110++ 1267 C7 72 12    	jne _strcmp_ret
0111++ 126A FB FF FF    	lea d, [si +- 1]
0112++ 126D BD 00       	cmp byte[d], 0				; check if at end of string (null)
0113++ 126F C7 66 12    	jne _strcmp_loop				; equal chars but not at end
0114++ 1272             _strcmp_ret:
0115++ 1272 EF          	pop si
0116++ 1273 F0          	pop di
0117++ 1274 E7          	pop d
0118++ 1275 E8          	pop al
0119++ 1276 09          	ret
0120++ 1277             
0121++ 1277             
0122++ 1277             ; strcpy
0123++ 1277             ; copy null terminated string from si to di
0124++ 1277             ; source in si
0125++ 1277             ; destination in di
0126++ 1277             _strcpy:
0127++ 1277 E2          	push si
0128++ 1278 E3          	push di
0129++ 1279 DB          	push al
0130++ 127A             _strcpy_l1:
0131++ 127A F6          	lodsb
0132++ 127B F7          	stosb
0133++ 127C B9 00       	cmp al, 0
0134++ 127E C7 7A 12    	jne _strcpy_l1
0135++ 1281             _strcpy_end:
0136++ 1281 E8          	pop al
0137++ 1282 F0          	pop di
0138++ 1283 EF          	pop si
0139++ 1284 09          	ret
0140++ 1285             
0141++ 1285             ; strcat
0142++ 1285             ; concatenate a null terminated string into string at di, from string at si
0143++ 1285             ; source in si
0144++ 1285             ; destination in di
0145++ 1285             _strcat:
0146++ 1285 E2          	push si
0147++ 1286 E3          	push di
0148++ 1287 D7          	push a
0149++ 1288 DA          	push d
0150++ 1289 50          	mov a, di
0151++ 128A 3C          	mov d, a
0152++ 128B             _strcat_goto_end_l1:
0153++ 128B BD 00       	cmp byte[d], 0
0154++ 128D C6 94 12    	je _strcat_start
0155++ 1290 79          	inc d
0156++ 1291 0A 8B 12    	jmp _strcat_goto_end_l1
0157++ 1294             _strcat_start:
0158++ 1294 FD 50       	mov di, d
0159++ 1296             _strcat_l1:
0160++ 1296 F6          	lodsb
0161++ 1297 F7          	stosb
0162++ 1298 B9 00       	cmp al, 0
0163++ 129A C7 96 12    	jne _strcat_l1
0164++ 129D             _strcat_end:
0165++ 129D E7          	pop d
0166++ 129E E4          	pop a
0167++ 129F F0          	pop di
0168++ 12A0 EF          	pop si
0169++ 12A1 09          	ret
0170++ 12A2             
0171++ 12A2             
0005+  12A2             
0006+  12A2             
0007+  12A2             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0008+  12A2             ; convert ascii 'o'..'f' to integer 0..15
0009+  12A2             ; ascii in bl
0010+  12A2             ; result in al
0011+  12A2             ; ascii for f = 0100 0110
0012+  12A2             ; ascii for 9 = 0011 1001
0013+  12A2             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0014+  12A2             hex_ascii_encode:
0015+  12A2 1B            mov al, bl
0016+  12A3 93 40         test al, $40        ; test if letter or number
0017+  12A5 C7 AB 12      jnz hex_letter
0018+  12A8 87 0F         and al, $0f        ; get number
0019+  12AA 09            ret
0020+  12AB             hex_letter:
0021+  12AB 87 0F         and al, $0f        ; get letter
0022+  12AD 6A 09         add al, 9
0023+  12AF 09            ret
0024+  12B0             
0025+  12B0             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0026+  12B0             ; atoi
0027+  12B0             ; 2 letter hex string in b
0028+  12B0             ; 8bit integer returned in al
0029+  12B0             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0030+  12B0             _atoi:
0031+  12B0 D8            push b
0032+  12B1 07 A2 12      call hex_ascii_encode      ; convert bl to 4bit code in al
0033+  12B4 30            mov bl, bh
0034+  12B5 DB            push al          ; save a
0035+  12B6 07 A2 12      call hex_ascii_encode
0036+  12B9 EA            pop bl  
0037+  12BA FD 9E 04      shl al, 4
0038+  12BD 8C            or al, bl
0039+  12BE E5            pop b
0040+  12BF 09            ret  
0041+  12C0             
0042+  12C0             
0043+  12C0             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0044+  12C0             ; scanf
0045+  12C0             ; no need for explanations!
0046+  12C0             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0047+  12C0             scanf:
0048+  12C0 09            ret
0049+  12C1             
0050+  12C1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0051+  12C1             ; itoa
0052+  12C1             ; 8bit value in bl
0053+  12C1             ; 2 byte ascii result in a
0054+  12C1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0055+  12C1             _itoa:
0056+  12C1 DA            push d
0057+  12C2 D8            push b
0058+  12C3 A7 00         mov bh, 0
0059+  12C5 FD A4 04      shr bl, 4  
0060+  12C8 74            mov d, b
0061+  12C9 1F 5B 15      mov al, [d + s_hex_digits]
0062+  12CC 23            mov ah, al
0063+  12CD               
0064+  12CD E5            pop b
0065+  12CE D8            push b
0066+  12CF A7 00         mov bh, 0
0067+  12D1 FD 87 0F      and bl, $0f
0068+  12D4 74            mov d, b
0069+  12D5 1F 5B 15      mov al, [d + s_hex_digits]
0070+  12D8 E5            pop b
0071+  12D9 E7            pop d
0072+  12DA 09            ret
0073+  12DB             
0074+  12DB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0075+  12DB             ; hex string to binary
0076+  12DB             ; di = destination address
0077+  12DB             ; si = source
0078+  12DB             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0079+  12DB             _hex_to_int:
0080+  12DB             _hex_to_int_l1:
0081+  12DB F6            lodsb          ; load from [si] to al
0082+  12DC B9 00         cmp al, 0        ; check if ascii 0
0083+  12DE C6 EB 12      jz _hex_to_int_ret
0084+  12E1 36            mov bh, al
0085+  12E2 F6            lodsb
0086+  12E3 2F            mov bl, al
0087+  12E4 07 B0 12      call _atoi        ; convert ascii byte in b to int (to al)
0088+  12E7 F7            stosb          ; store al to [di]
0089+  12E8 0A DB 12      jmp _hex_to_int_l1
0090+  12EB             _hex_to_int_ret:
0091+  12EB 09            ret    
0092+  12EC             
0093+  12EC             
0094+  12EC             
0095+  12EC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0096+  12EC             ; getchar
0097+  12EC             ; char in ah
0098+  12EC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0099+  12EC             getch:
0100+  12EC DB            push al
0101+  12ED             getch_retry:
0102+  12ED 19 01         mov al, 1
0103+  12EF 05 03         syscall sys_io      ; receive in ah
0104+  12F1 E8            pop al
0105+  12F2 09            ret
0106+  12F3             
0107+  12F3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0108+  12F3             ; putchar
0109+  12F3             ; char in ah
0110+  12F3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0111+  12F3             _putchar:
0112+  12F3 DB            push al
0113+  12F4 19 00         mov al, 0
0114+  12F6 05 03         syscall sys_io      ; char in ah
0115+  12F8 E8            pop al
0116+  12F9 09            ret
0117+  12FA             
0118+  12FA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0119+  12FA             ;; input a string
0120+  12FA             ;; terminates with null
0121+  12FA             ;; pointer in d
0122+  12FA             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0123+  12FA             _gets:
0124+  12FA D7            push a
0125+  12FB DA            push d
0126+  12FC             _gets_loop:
0127+  12FC 19 01         mov al, 1
0128+  12FE 05 03         syscall sys_io      ; receive in ah
0129+  1300 76 1B         cmp ah, 27
0130+  1302 C6 23 13      je _gets_ansi_esc
0131+  1305 76 0A         cmp ah, $0a        ; lf
0132+  1307 C6 7F 13      je _gets_end
0133+  130A 76 0D         cmp ah, $0d        ; cr
0134+  130C C6 7F 13      je _gets_end
0135+  130F 76 5C         cmp ah, $5c        ; '\\'
0136+  1311 C6 45 13      je _gets_escape
0137+  1314 76 08         cmp ah, $08      ; check for backspace
0138+  1316 C6 1F 13      je _gets_backspace
0139+  1319 1A            mov al, ah
0140+  131A 3E            mov [d], al
0141+  131B 79            inc d
0142+  131C 0A FC 12      jmp _gets_loop
0143+  131F             _gets_backspace:
0144+  131F 7F            dec d
0145+  1320 0A FC 12      jmp _gets_loop
0146+  1323             _gets_ansi_esc:
0147+  1323 19 01         mov al, 1
0148+  1325 05 03         syscall sys_io        ; receive in ah without echo
0149+  1327 76 5B         cmp ah, '['
0150+  1329 C7 FC 12      jne _gets_loop
0151+  132C 19 01         mov al, 1
0152+  132E 05 03         syscall sys_io          ; receive in ah without echo
0153+  1330 76 64         cmp ah, 'd'
0154+  1332 C6 3D 13      je _gets_left_arrow
0155+  1335 76 63         cmp ah, 'c'
0156+  1337 C6 41 13      je _gets_right_arrow
0157+  133A 0A FC 12      jmp _gets_loop
0158+  133D             _gets_left_arrow:
0159+  133D 7F            dec d
0160+  133E 0A FC 12      jmp _gets_loop
0161+  1341             _gets_right_arrow:
0162+  1341 79            inc d
0163+  1342 0A FC 12      jmp _gets_loop
0164+  1345             _gets_escape:
0165+  1345 19 01         mov al, 1
0166+  1347 05 03         syscall sys_io      ; receive in ah
0167+  1349 76 6E         cmp ah, 'n'
0168+  134B C6 6A 13      je _gets_lf
0169+  134E 76 72         cmp ah, 'r'
0170+  1350 C6 71 13      je _gets_cr
0171+  1353 76 30         cmp ah, '0'
0172+  1355 C6 78 13      je _gets_null
0173+  1358 76 5C         cmp ah, $5c  ; '\'
0174+  135A C6 63 13      je _gets_slash
0175+  135D 1A            mov al, ah        ; if not a known escape, it is just a normal letter
0176+  135E 3E            mov [d], al
0177+  135F 79            inc d
0178+  1360 0A FC 12      jmp _gets_loop
0179+  1363             _gets_slash:
0180+  1363 19 5C         mov al, $5c
0181+  1365 3E            mov [d], al
0182+  1366 79            inc d
0183+  1367 0A FC 12      jmp _gets_loop
0184+  136A             _gets_lf:
0185+  136A 19 0A         mov al, $0a
0186+  136C 3E            mov [d], al
0187+  136D 79            inc d
0188+  136E 0A FC 12      jmp _gets_loop
0189+  1371             _gets_cr:
0190+  1371 19 0D         mov al, $0d
0191+  1373 3E            mov [d], al
0192+  1374 79            inc d
0193+  1375 0A FC 12      jmp _gets_loop
0194+  1378             _gets_null:
0195+  1378 19 00         mov al, $00
0196+  137A 3E            mov [d], al
0197+  137B 79            inc d
0198+  137C 0A FC 12      jmp _gets_loop
0199+  137F             _gets_end:
0200+  137F 19 00         mov al, 0
0201+  1381 3E            mov [d], al        ; terminate string
0202+  1382 E7            pop d
0203+  1383 E4            pop a
0204+  1384 09            ret
0205+  1385             
0206+  1385             
0207+  1385             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0208+  1385             ;; input text
0209+  1385             ;; terminated with ctrl+d
0210+  1385             ;; pointer in d
0211+  1385             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0212+  1385             _gettxt:
0213+  1385 D7            push a
0214+  1386 DA            push d
0215+  1387             _gettxt_loop:
0216+  1387 19 01         mov al, 1
0217+  1389 05 03         syscall sys_io      ; receive in ah
0218+  138B 76 04         cmp ah, 4      ; eot
0219+  138D C6 C6 13      je _gettxt_end
0220+  1390 76 08         cmp ah, $08      ; check for backspace
0221+  1392 C6 C2 13      je _gettxt_backspace
0222+  1395 76 5C         cmp ah, $5c        ; '\'
0223+  1397 C6 A0 13      je _gettxt_escape
0224+  139A 1A            mov al, ah
0225+  139B 3E            mov [d], al
0226+  139C 79            inc d
0227+  139D 0A 87 13      jmp _gettxt_loop
0228+  13A0             _gettxt_escape:
0229+  13A0 19 01         mov al, 1
0230+  13A2 05 03         syscall sys_io      ; receive in ah
0231+  13A4 76 6E         cmp ah, 'n'
0232+  13A6 C6 B4 13      je _gettxt_lf
0233+  13A9 76 72         cmp ah, 'r'
0234+  13AB C6 BB 13      je _gettxt_cr
0235+  13AE 1A            mov al, ah        ; if not a known escape, it is just a normal letter
0236+  13AF 3E            mov [d], al
0237+  13B0 79            inc d
0238+  13B1 0A 87 13      jmp _gettxt_loop
0239+  13B4             _gettxt_lf:
0240+  13B4 19 0A         mov al, $0a
0241+  13B6 3E            mov [d], al
0242+  13B7 79            inc d
0243+  13B8 0A 87 13      jmp _gettxt_loop
0244+  13BB             _gettxt_cr:
0245+  13BB 19 0D         mov al, $0d
0246+  13BD 3E            mov [d], al
0247+  13BE 79            inc d
0248+  13BF 0A 87 13      jmp _gettxt_loop
0249+  13C2             _gettxt_backspace:
0250+  13C2 7F            dec d
0251+  13C3 0A 87 13      jmp _gettxt_loop
0252+  13C6             _gettxt_end:
0253+  13C6 19 00         mov al, 0
0254+  13C8 3E            mov [d], al        ; terminate string
0255+  13C9 E7            pop d
0256+  13CA E4            pop a
0257+  13CB 09            ret
0258+  13CC             
0259+  13CC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0260+  13CC             ; print new line
0261+  13CC             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0262+  13CC             printnl:
0263+  13CC D7            push a
0264+  13CD 10 00 0A      mov a, $0a00
0265+  13D0 05 03         syscall sys_io
0266+  13D2 10 00 0D      mov a, $0d00
0267+  13D5 05 03         syscall sys_io
0268+  13D7 E4            pop a
0269+  13D8 09            ret
0270+  13D9             
0271+  13D9             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0272+  13D9             ; _strtoint
0273+  13D9             ; 4 digit hex string number in d
0274+  13D9             ; integer returned in a
0275+  13D9             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0276+  13D9             _strtointx:
0277+  13D9 D8            push b
0278+  13DA 32            mov bl, [d]
0279+  13DB 37            mov bh, bl
0280+  13DC 33 01 00      mov bl, [d + 1]
0281+  13DF 07 B0 12      call _atoi        ; convert to int in al
0282+  13E2 23            mov ah, al        ; move to ah
0283+  13E3 33 02 00      mov bl, [d + 2]
0284+  13E6 37            mov bh, bl
0285+  13E7 33 03 00      mov bl, [d + 3]
0286+  13EA 07 B0 12      call _atoi        ; convert to int in al
0287+  13ED E5            pop b
0288+  13EE 09            ret
0289+  13EF             
0290+  13EF             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0291+  13EF             ; _strtoint
0292+  13EF             ; 5 digit base10 string number in d
0293+  13EF             ; integer returned in a
0294+  13EF             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0295+  13EF             _strtoint:
0296+  13EF E2            push si
0297+  13F0 D8            push b
0298+  13F1 D9            push c
0299+  13F2 DA            push d
0300+  13F3 07 52 12      call _strlen      ; get string length in c
0301+  13F6 7E            dec c
0302+  13F7 FD 4E         mov si, d
0303+  13F9 12            mov a, c
0304+  13FA FD 99         shl a
0305+  13FC 3B 73 15      mov d, table_power
0306+  13FF 59            add d, a
0307+  1400 38 00 00      mov c, 0
0308+  1403             _strtoint_l0:
0309+  1403 F6            lodsb      ; load ascii to al
0310+  1404 B9 00         cmp al, 0
0311+  1406 C6 19 14      je _strtoint_end
0312+  1409 6F 30         sub al, $30    ; make into integer
0313+  140B 22 00         mov ah, 0
0314+  140D 2A            mov b, [d]
0315+  140E AC            mul a, b      ; result in b since it fits in 16bits
0316+  140F 11            mov a, b
0317+  1410 28            mov b, c
0318+  1411 54            add a, b
0319+  1412 39            mov c, a
0320+  1413 63 02 00      sub d, 2
0321+  1416 0A 03 14      jmp _strtoint_l0
0322+  1419             _strtoint_end:
0323+  1419 12            mov a, c
0324+  141A E7            pop d
0325+  141B E6            pop c
0326+  141C E5            pop b
0327+  141D EF            pop si
0328+  141E 09            ret
0329+  141F             
0330+  141F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0331+  141F             ; print null terminated string
0332+  141F             ; pointer in d
0333+  141F             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0334+  141F             _puts:
lib/stdio.asm line 0334: label value misalligned.           (_puts)
0335+  141F D7            push a
0336+  1420 DA            push d
0337+  1421             _puts_l1:
0338+  1421 1E            mov al, [d]
0339+  1422 B9 00         cmp al, 0
0340+  1424 C6 30 14      jz _puts_end
0341+  1427 23            mov ah, al
0342+  1428 19 00         mov al, 0
0343+  142A 05 03         syscall sys_io
0344+  142C 79            inc d
0345+  142D 0A 21 14      jmp _puts_l1
0346+  1430             _puts_end:
0347+  1430 E7            pop d
0348+  1431 E4            pop a
0349+  1432 09            ret
0350+  1433             
0351+  1433             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0352+  1433             ; print n size string
0353+  1433             ; pointer in d
0354+  1433             ; size in c
0355+  1433             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0356+  1433             _putsn:
0357+  1433 DB            push al
0358+  1434 DA            push d
0359+  1435 D9            push c
0360+  1436             _putsn_l0:
0361+  1436 1E            mov al, [d]
0362+  1437 23            mov ah, al
0363+  1438 19 00         mov al, 0
0364+  143A 05 03         syscall sys_io
0365+  143C 79            inc d
0366+  143D 7E            dec c  
0367+  143E C2 00 00      cmp c, 0
0368+  1441 C7 36 14      jne _putsn_l0
0369+  1444             _putsn_end:
0370+  1444 E6            pop c
0371+  1445 E7            pop d
0372+  1446 E8            pop al
0373+  1447 09            ret
0374+  1448             
0375+  1448             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0376+  1448             ; print 16bit decimal number
0377+  1448             ; input number in a
0378+  1448             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0379+  1448             print_u16d:
0380+  1448 D7            push a
0381+  1449 D8            push b
0382+  144A FD D8         push g
0383+  144C 26 10 27      mov b, 10000
0384+  144F AE            div a, b      ; get 10000's coeff.
0385+  1450 07 74 14      call print_number
0386+  1453 11            mov a, b
0387+  1454 26 E8 03      mov b, 1000
0388+  1457 AE            div a, b      ; get 1000's coeff.
0389+  1458 07 74 14      call print_number
0390+  145B 11            mov a, b
0391+  145C 26 64 00      mov b, 100
0392+  145F AE            div a, b
0393+  1460 07 74 14      call print_number
0394+  1463 11            mov a, b
0395+  1464 26 0A 00      mov b, 10
0396+  1467 AE            div a, b
0397+  1468 07 74 14      call print_number
0398+  146B 1B            mov al, bl      ; 1's coeff in bl
0399+  146C 07 74 14      call print_number
0400+  146F FD F1         pop g
0401+  1471 E5            pop b
0402+  1472 E4            pop a
0403+  1473 09            ret
0404+  1474             
0405+  1474             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0406+  1474             ; print al
0407+  1474             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0408+  1474             print_number:
0409+  1474 6A 30         add al, $30
0410+  1476 23            mov ah, al
0411+  1477 07 F3 12      call _putchar
0412+  147A 09            ret
0413+  147B             
0414+  147B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0415+  147B             ; print 16bit hex integer
0416+  147B             ; integer value in reg b
0417+  147B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0418+  147B             print_u16x:
0419+  147B D7            push a
0420+  147C D8            push b
0421+  147D DD            push bl
0422+  147E 30            mov bl, bh
0423+  147F 07 C1 12      call _itoa        ; convert bh to char in a
0424+  1482 2F            mov bl, al        ; save al
0425+  1483 19 00         mov al, 0
0426+  1485 05 03         syscall sys_io        ; display ah
0427+  1487 24            mov ah, bl        ; retrieve al
0428+  1488 19 00         mov al, 0
0429+  148A 05 03         syscall sys_io        ; display al
0430+  148C             
0431+  148C EA            pop bl
0432+  148D 07 C1 12      call _itoa        ; convert bh to char in a
0433+  1490 2F            mov bl, al        ; save al
0434+  1491 19 00         mov al, 0
0435+  1493 05 03         syscall sys_io        ; display ah
0436+  1495 24            mov ah, bl        ; retrieve al
0437+  1496 19 00         mov al, 0
0438+  1498 05 03         syscall sys_io        ; display al
0439+  149A             
0440+  149A E5            pop b
0441+  149B E4            pop a
0442+  149C 09            ret
0443+  149D             
0444+  149D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0445+  149D             ; input 16bit hex integer
0446+  149D             ; read 16bit integer into a
0447+  149D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0448+  149D             scan_u16x:
0449+  149D F8 10 00      enter 16
0450+  14A0 D8            push b
0451+  14A1 DA            push d
0452+  14A2             
0453+  14A2 FA F1 FF      lea d, [bp + -15]
0454+  14A5 07 FA 12      call _gets        ; get number
0455+  14A8             
0456+  14A8 32            mov bl, [d]
0457+  14A9 37            mov bh, bl
0458+  14AA 33 01 00      mov bl, [d + 1]
0459+  14AD 07 B0 12      call _atoi        ; convert to int in al
0460+  14B0 23            mov ah, al        ; move to ah
0461+  14B1             
0462+  14B1 33 02 00      mov bl, [d + 2]
0463+  14B4 37            mov bh, bl
0464+  14B5 33 03 00      mov bl, [d + 3]
0465+  14B8 07 B0 12      call _atoi        ; convert to int in al
0466+  14BB             
0467+  14BB E7            pop d
0468+  14BC E5            pop b
0469+  14BD F9            leave
0470+  14BE 09            ret
0471+  14BF             
0472+  14BF             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0473+  14BF             ; print 8bit hex integer
0474+  14BF             ; integer value in reg bl
0475+  14BF             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0476+  14BF             print_u8x:
0477+  14BF D7            push a
0478+  14C0 DD            push bl
0479+  14C1             
0480+  14C1 07 C1 12      call _itoa        ; convert bl to char in a
0481+  14C4 2F            mov bl, al        ; save al
0482+  14C5 19 00         mov al, 0
0483+  14C7 05 03         syscall sys_io        ; display ah
0484+  14C9 24            mov ah, bl        ; retrieve al
0485+  14CA 19 00         mov al, 0
0486+  14CC 05 03         syscall sys_io        ; display al
0487+  14CE             
0488+  14CE EA            pop bl
0489+  14CF E4            pop a
0490+  14D0 09            ret
0491+  14D1             
0492+  14D1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0493+  14D1             ; print 8bit decimal unsigned number
0494+  14D1             ; input number in al
0495+  14D1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0496+  14D1             print_u8d:
0497+  14D1 D7            push a
0498+  14D2 D8            push b
0499+  14D3 FD D8         push g
0500+  14D5 22 00         mov ah, 0
0501+  14D7 26 64 00      mov b, 100
0502+  14DA AE            div a, b
0503+  14DB D8            push b      ; save remainder
0504+  14DC B9 00         cmp al, 0
0505+  14DE C6 E8 14      je skip100
0506+  14E1 6A 30         add al, $30
0507+  14E3 23            mov ah, al
0508+  14E4 19 00         mov al, 0
0509+  14E6 05 03         syscall sys_io  ; print coeff
0510+  14E8             skip100:
0511+  14E8 E4            pop a
0512+  14E9 22 00         mov ah, 0
0513+  14EB 26 0A 00      mov b, 10
0514+  14EE AE            div a, b
0515+  14EF D8            push b      ; save remainder
0516+  14F0 B9 00         cmp al, 0
0517+  14F2 C6 FC 14      je skip10
0518+  14F5 6A 30         add al, $30
0519+  14F7 23            mov ah, al
0520+  14F8 19 00         mov al, 0
0521+  14FA 05 03         syscall sys_io  ; print coeff
0522+  14FC             skip10:
0523+  14FC E4            pop a
0524+  14FD 1B            mov al, bl
0525+  14FE 6A 30         add al, $30
0526+  1500 23            mov ah, al
0527+  1501 19 00         mov al, 0
0528+  1503 05 03         syscall sys_io  ; print coeff
0529+  1505 FD F1         pop g
0530+  1507 E5            pop b
0531+  1508 E4            pop a
0532+  1509 09            ret
0533+  150A             
0534+  150A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0535+  150A             ; input 8bit hex integer
0536+  150A             ; read 8bit integer into al
0537+  150A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0538+  150A             scan_u8x:
0539+  150A F8 04 00      enter 4
0540+  150D D8            push b
0541+  150E DA            push d
0542+  150F             
0543+  150F FA FD FF      lea d, [bp + -3]
0544+  1512 07 FA 12      call _gets        ; get number
0545+  1515             
0546+  1515 32            mov bl, [d]
0547+  1516 37            mov bh, bl
0548+  1517 33 01 00      mov bl, [d + 1]
0549+  151A 07 B0 12      call _atoi        ; convert to int in al
0550+  151D             
0551+  151D E7            pop d
0552+  151E E5            pop b
0553+  151F F9            leave
0554+  1520 09            ret
0555+  1521             
0556+  1521             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0557+  1521             ; input decimal number
0558+  1521             ; result in a
0559+  1521             ; 655'\0'
0560+  1521             ; low--------high
0561+  1521             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0562+  1521             scan_u16d:
0563+  1521 F8 08 00      enter 8
0564+  1524 E2            push si
0565+  1525 D8            push b
0566+  1526 D9            push c
0567+  1527 DA            push d
0568+  1528 FA F9 FF      lea d, [bp +- 7]
0569+  152B 07 FA 12      call _gets
0570+  152E 07 52 12      call _strlen      ; get string length in c
0571+  1531 7E            dec c
0572+  1532 FD 4E         mov si, d
0573+  1534 12            mov a, c
0574+  1535 FD 99         shl a
0575+  1537 3B 73 15      mov d, table_power
0576+  153A 59            add d, a
0577+  153B 38 00 00      mov c, 0
0578+  153E             mul_loop:
0579+  153E F6            lodsb      ; load ascii to al
0580+  153F B9 00         cmp al, 0
0581+  1541 C6 54 15      je mul_exit
0582+  1544 6F 30         sub al, $30    ; make into integer
0583+  1546 22 00         mov ah, 0
0584+  1548 2A            mov b, [d]
0585+  1549 AC            mul a, b      ; result in b since it fits in 16bits
0586+  154A 11            mov a, b
0587+  154B 28            mov b, c
0588+  154C 54            add a, b
0589+  154D 39            mov c, a
0590+  154E 63 02 00      sub d, 2
0591+  1551 0A 3E 15      jmp mul_loop
0592+  1554             mul_exit:
0593+  1554 12            mov a, c
0594+  1555 E7            pop d
0595+  1556 E6            pop c
0596+  1557 E5            pop b
0597+  1558 EF            pop si
0598+  1559 F9            leave
0599+  155A 09            ret
0600+  155B             
0601+  155B             
0602+  155B 30 31 32 33 s_hex_digits:    .db "0123456789abcdef"  
0602+  155F 34 35 36 37 
0602+  1563 38 39 61 62 
0602+  1567 63 64 65 66 
0603+  156B 1B 5B 32 6A s_telnet_clear:  .db "\033[2j\033[h", 0
0603+  156F 1B 5B 68 00 
0604+  1573             
0605+  1573             table_power:
0606+  1573 01 00         .dw 1
0607+  1575 0A 00         .dw 10
0608+  1577 64 00         .dw 100
0609+  1579 E8 03         .dw 1000
0610+  157B 10 27         .dw 100003092   157D             .include "lib/ctype.asm"
0001+  157D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0002+  157D             ; ctype.s
0003+  157D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0004+  157D             
0005+  157D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0006+  157D             ;; c character classification is an operation provided by a group of functions in the ansi c standard library
0007+  157D             ;; for the c programming language. these functions are used to test characters for membership in a particular
0008+  157D             ;; class of characters, such as alphabetic characters, control characters, etc. both single-byte, and wide
0009+  157D             ;; characters are supported.
0010+  157D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0011+  157D             ;; _isalnum 
0012+  157D             ;; _isalpha 
0013+  157D             ;; islower 
0014+  157D             ;; isupper 
0015+  157D             ;; _isdigit 
0016+  157D             ;; isxdigit
0017+  157D             ;; iscntrl 
0018+  157D             ;; isgraph 
0019+  157D             ;; _isspace 
0020+  157D             ;; isblank 
0021+  157D             ;; isprint 
0022+  157D             ;; ispunct 
0023+  157D             ;; tolower 
0024+  157D             ;; toupper
0025+  157D             
0026+  157D             
0027+  157D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0028+  157D             ;; is alphanumeric
0029+  157D             ;; sets zf according with result
0030+  157D             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0031+  157D             _isalnum:
0032+  157D 07 9A 15    	call _isalpha
0033+  1580 C6 86 15    	je _isalnum_exit
0034+  1583 07 87 15    	call _isdigit
0035+  1586             _isalnum_exit:
0036+  1586 09          	ret	
0037+  1587             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0038+  1587             ;; is digit
0039+  1587             ;; sets zf according with result
0040+  1587             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0041+  1587             _isdigit:
0042+  1587 DB          	push al
0043+  1588 B9 30       	cmp al, '0'
0044+  158A C8 96 15    	jlu _isdigit_false
0045+  158D B9 39       	cmp al, '9'
0046+  158F D1 96 15    	jgu _isdigit_false
0047+  1592 87 00       	and al, 0	; set zf
0048+  1594 E8          	pop al
0049+  1595 09          	ret
0050+  1596             _isdigit_false:
0051+  1596 8B 01       	or al, 1	; clear zf
0052+  1598 E8          	pop al
0053+  1599 09          	ret	
0054+  159A             	
0055+  159A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0056+  159A             ;; is alpha
0057+  159A             ;; sets zf according with result
0058+  159A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0059+  159A             _isalpha:
0060+  159A DB          	push al
0061+  159B B9 5F       	cmp al, '_'
0062+  159D C6 BD 15    	je _isalpha_true
0063+  15A0 B9 2E       	cmp al, '.'
0064+  15A2 C6 BD 15    	je _isalpha_true
0065+  15A5 B9 61       	cmp al, 'a'
0066+  15A7 C8 B9 15    	jlu _isalpha_false
0067+  15AA B9 7A       	cmp al, 'z'
0068+  15AC D1 B9 15    	jgu _isalpha_false
0069+  15AF B9 7A       	cmp al, 'z'
0070+  15B1 D0 BD 15    	jleu _isalpha_true
0071+  15B4 B9 61       	cmp al, 'a'
0072+  15B6 C9 BD 15    	jgeu _isalpha_true
0073+  15B9             _isalpha_false:
0074+  15B9 8B 01       	or al, 1	; clear zf
0075+  15BB E8          	pop al
0076+  15BC 09          	ret
0077+  15BD             _isalpha_true:
0078+  15BD 87 00       	and al, 0	; set zf
0079+  15BF E8          	pop al
0080+  15C0 09          	ret
0081+  15C1             
0082+  15C1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0083+  15C1             ;; is path-alpha
0084+  15C1             ;; sets zf according with result
0085+  15C1             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0086+  15C1             ispath:
0087+  15C1 DB          	push al
0088+  15C2 07 87 15    	call _isdigit
0089+  15C5 C6 EF 15    	je ispath_true
0090+  15C8 B9 5F       	cmp al, '_'
0091+  15CA C6 EF 15    	je ispath_true
0092+  15CD B9 2F       	cmp al, '/'
0093+  15CF C6 EF 15    	je ispath_true
0094+  15D2 B9 2E       	cmp al, '.'
0095+  15D4 C6 EF 15    	je ispath_true
0096+  15D7 B9 61       	cmp al, 'a'
0097+  15D9 C8 EB 15    	jlu ispath_false
0098+  15DC B9 7A       	cmp al, 'z'
0099+  15DE D1 EB 15    	jgu ispath_false
0100+  15E1 B9 7A       	cmp al, 'z'
0101+  15E3 D0 EF 15    	jleu ispath_true
0102+  15E6 B9 61       	cmp al, 'a'
0103+  15E8 C9 EF 15    	jgeu ispath_true
0104+  15EB             ispath_false:
0105+  15EB 8B 01       	or al, 1	; clear zf
0106+  15ED E8          	pop al
0107+  15EE 09          	ret
0108+  15EF             ispath_true:
0109+  15EF 87 00       	and al, 0	; set zf
0110+  15F1 E8          	pop al
0111+  15F2 09          	ret
0112+  15F3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0113+  15F3             ;; is space
0114+  15F3             ;; sets zf according with result
0115+  15F3             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0116+  15F3             _isspace:
0117+  15F3 B9 20       	cmp al, $20		; ' '
0118+  15F5 C6 09 16    	je _isspace_exit
0119+  15F8 B9 09       	cmp al, $09		; '\t'
0120+  15FA C6 09 16    	je _isspace_exit
0121+  15FD B9 0A       	cmp al, $0a		; '\n'
0122+  15FF C6 09 16    	je _isspace_exit
0123+  1602 B9 0D       	cmp al, $0d		; '\r'
0124+  1604 C6 09 16    	je _isspace_exit
0125+  1607 B9 0B       	cmp al, $0b		; '\v'
0126+  1609             _isspace_exit:
0127+  1609 09          	ret	
0128+  160A             
0129+  160A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0130+  160A             ; to lower
0131+  160A             ; input in al
0132+  160A             ; output in al
0133+  160A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0134+  160A             _to_lower:
0135+  160A B9 7A       	cmp al, 'z'
0136+  160C D1 11 16    	jgu _to_lower_ret
0137+  160F 6A 20       	add al, $20				; convert to lower case
0138+  1611             _to_lower_ret:
0139+  1611 09          	ret
0140+  1612             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0141+  1612             ; to upper
0142+  1612             ; input in al
0143+  1612             ; output in al
0144+  1612             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0145+  1612             _to_upper:
0146+  1612 B9 61       	cmp al, 'a'
0147+  1614 C8 19 16    	jlu _to_upper_ret
0148+  1617 6F 20       	sub al, $20			; convert to upper case
0149+  1619             _to_upper_ret:
0150+  1619 09          	ret
0151+  161A             
3093   161A             .include "lib/token.asm"
0001+  161A             toktyp_identifier  .equ 0
0002+  161A             toktyp_keyword     .equ 1
0003+  161A             toktyp_delimiter   .equ 2
0004+  161A             toktyp_string      .equ 3
0005+  161A             toktyp_char        .equ 4
0006+  161A             toktyp_numeric     .equ 5
0007+  161A             toktyp_end         .equ 6
0008+  161A             
0009+  161A             tok_null           .equ 0
0010+  161A             tok_fslash         .equ 1
0011+  161A             tok_times          .equ 2
0012+  161A             tok_plus           .equ 3
0013+  161A             tok_minus          .equ 4
0014+  161A             tok_dot            .equ 5
0015+  161A             tok_semi           .equ 6
0016+  161A             tok_angle          .equ 7
0017+  161A             tok_tilde          .equ 8
0018+  161A             tok_equal          .equ 9
0019+  161A             tok_colon          .equ 10
0020+  161A             tok_comma          .equ 11
0021+  161A             
0022+  161A             tok_end            .equ 20
0023+  161A             
0024+  161A             
0025+  161A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0026+  161A             ;; read a full command argment from shell input buffer
0027+  161A             ;; argument is written into tokstr
0028+  161A             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0029+  161A             get_arg:
0030+  161A D7            push a
0031+  161B E2            push si
0032+  161C E3            push di
0033+  161D 19 00         mov al, 0
0034+  161F 3D 48 18      mov [tokstr], al      ; nullify tokstr string
0035+  1622 14 44 18      mov a, [prog]
0036+  1625 4D            mov si, a
0037+  1626 FD 4F 48 18   mov di, tokstr
0038+  162A             get_arg_skip_spaces:
0039+  162A F6            lodsb
0040+  162B 07 F3 15      call _isspace
0041+  162E C6 2A 16      je get_arg_skip_spaces
0042+  1631             get_arg_l0:
0043+  1631 B9 3B         cmp al, $3b        ; check if is ';'
0044+  1633 C6 40 16      je get_arg_end
0045+  1636 B9 00         cmp al, 0
0046+  1638 C6 40 16      je get_arg_end      ; check if end of input
0047+  163B F7            stosb
0048+  163C F6            lodsb
0049+  163D 0A 31 16      jmp get_arg_l0
0050+  1640             get_arg_end:
0051+  1640 19 00         mov al, 0
0052+  1642 F7            stosb
0053+  1643 D5 01 00      sub si, 1
0054+  1646 4E            mov a, si
0055+  1647 42 44 18      mov [prog], a    ; update pointer
0056+  164A F0            pop di
0057+  164B EF            pop si
0058+  164C E4            pop a
0059+  164D 09            ret
0060+  164E             
0061+  164E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0062+  164E             ;; read a path formation from shell input buffer
0063+  164E             ;; path is written into tokstr
0064+  164E             ;; /usr/bin
0065+  164E             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0066+  164E             get_path:
0067+  164E D7            push a
0068+  164F E2            push si
0069+  1650 E3            push di
0070+  1651 19 00         mov al, 0
0071+  1653 3D 48 18      mov [tokstr], al      ; nullify tokstr string
0072+  1656 14 44 18      mov a, [prog]
0073+  1659 4D            mov si, a
0074+  165A FD 4F 48 18   mov di, tokstr
0075+  165E             get_path_skip_spaces:
0076+  165E F6            lodsb
0077+  165F 07 F3 15      call _isspace
0078+  1662 C6 5E 16      je get_path_skip_spaces
0079+  1665             get_path_is_pathchar:
0080+  1665 F7            stosb
0081+  1666 F6            lodsb
0082+  1667 07 7D 15      call _isalnum      ;check if is alphanumeric
0083+  166A C6 65 16      je get_path_is_pathchar
0084+  166D B9 2F         cmp al, '/'        ; check if is '/'
0085+  166F C6 65 16      je get_path_is_pathchar
0086+  1672 19 00         mov al, 0
0087+  1674 F7            stosb
0088+  1675 D5 01 00      sub si, 1
0089+  1678 4E            mov a, si
0090+  1679 42 44 18      mov [prog], a    ; update pointer
0091+  167C             get_path_end:
0092+  167C F0            pop di
0093+  167D EF            pop si
0094+  167E E4            pop a
0095+  167F 09            ret
0096+  1680             
0097+  1680             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0098+  1680             ;; read a line
0099+  1680             ;; line is written into tokstr
0100+  1680             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0101+  1680             get_line:
0102+  1680 D7            push a
0103+  1681 E2            push si
0104+  1682 E3            push di
0105+  1683 19 00         mov al, 0
0106+  1685 3D 48 18      mov [tokstr], al      ; nullify tokstr string
0107+  1688 14 44 18      mov a, [prog]
0108+  168B 4D            mov si, a
0109+  168C FD 4F 48 18   mov di, tokstr
0110+  1690             get_line_l0:
0111+  1690 F6            lodsb
0112+  1691 B9 0A         cmp al, $0a    ; check for new line
0113+  1693 C6 9A 16      je get_line_exit
0114+  1696 F7            stosb
0115+  1697 0A 90 16      jmp get_line_l0
0116+  169A             get_line_exit:
0117+  169A 19 00         mov al, 0
0118+  169C F7            stosb
0119+  169D 4E            mov a, si
0120+  169E 42 44 18      mov [prog], a    ; update pointer
0121+  16A1 F0            pop di
0122+  16A2 EF            pop si
0123+  16A3 E4            pop a
0124+  16A4 09            ret
0125+  16A5             
0126+  16A5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0127+  16A5             ;; token parser
0128+  16A5             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0129+  16A5             get_token:
0130+  16A5 D7            push a
0131+  16A6 DA            push d
0132+  16A7 E2            push si
0133+  16A8 E3            push di
0134+  16A9 19 00         mov al, 0
0135+  16AB 3D 48 18      mov [tokstr], al      ; nullify tokstr string
0136+  16AE 19 00         mov al, tok_null
0137+  16B0 3D 47 18      mov [tok], al        ; nullify token
0138+  16B3 14 44 18      mov a, [prog]
0139+  16B6 4D            mov si, a
0140+  16B7 FD 4F 48 18   mov di, tokstr
0141+  16BB             get_tok_skip_spaces:
0142+  16BB F6            lodsb
0143+  16BC 07 F3 15      call _isspace
0144+  16BF C6 BB 16      je get_tok_skip_spaces
0145+  16C2 B9 00         cmp al, 0      ; check for end of input (null)
0146+  16C4 C6 A9 17      je get_token_end
0147+  16C7 B9 23         cmp al, '#'      ; comments!
0148+  16C9 C6 D7 17      je get_tok_comment
0149+  16CC 07 7D 15      call _isalnum
0150+  16CF C6 B6 17      jz is_alphanumeric
0151+  16D2             ; other token types
0152+  16D2             get_token_slash:
0153+  16D2 B9 2F         cmp al, '/'        ; check if '/'
0154+  16D4 C7 EC 16      jne get_token_minus
0155+  16D7 F7            stosb          ; store '/' into token string
0156+  16D8 19 00         mov al, 0
0157+  16DA F7            stosb          ; terminate token string
0158+  16DB 19 01         mov al, tok_fslash
0159+  16DD 3D 47 18      mov [tok], al      
0160+  16E0 19 02         mov al, toktyp_delimiter
0161+  16E2 3D 46 18      mov [toktyp], al
0162+  16E5 4E            mov a, si
0163+  16E6 42 44 18      mov [prog], a    ; update pointer
0164+  16E9 0A D2 17      jmp get_token_return
0165+  16EC             get_token_minus:
0166+  16EC B9 2D         cmp al, '-'        ; check if '-'
0167+  16EE C7 06 17      jne get_token_comma
0168+  16F1 F7            stosb          ; store '-' into token string
0169+  16F2 19 00         mov al, 0
0170+  16F4 F7            stosb          ; terminate token string
0171+  16F5 19 04         mov al, tok_minus
0172+  16F7 3D 47 18      mov [tok], al      
0173+  16FA 19 02         mov al, toktyp_delimiter
0174+  16FC 3D 46 18      mov [toktyp], al
0175+  16FF 4E            mov a, si
0176+  1700 42 44 18      mov [prog], a    ; update pointer
0177+  1703 0A D2 17      jmp get_token_return
0178+  1706             get_token_comma:
0179+  1706 B9 2C         cmp al, ','        ; check if ','
0180+  1708 C7 20 17      jne get_token_semi
0181+  170B F7            stosb          ; store ',' into token string
0182+  170C 19 00         mov al, 0
0183+  170E F7            stosb          ; terminate token string
0184+  170F 19 0B         mov al, tok_comma
0185+  1711 3D 47 18      mov [tok], al      
0186+  1714 19 02         mov al, toktyp_delimiter
0187+  1716 3D 46 18      mov [toktyp], al
0188+  1719 4E            mov a, si
0189+  171A 42 44 18      mov [prog], a    ; update pointer
0190+  171D 0A D2 17      jmp get_token_return
0191+  1720             get_token_semi:
0192+  1720 B9 3B         cmp al, $3b        ; check if ';'
0193+  1722 C7 3A 17      jne get_token_colon
0194+  1725 F7            stosb          ; store ';' into token string
0195+  1726 19 00         mov al, 0
0196+  1728 F7            stosb          ; terminate token string
0197+  1729 19 06         mov al, tok_semi
0198+  172B 3D 47 18      mov [tok], al      
0199+  172E 19 02         mov al, toktyp_delimiter
0200+  1730 3D 46 18      mov [toktyp], al
0201+  1733 4E            mov a, si
0202+  1734 42 44 18      mov [prog], a    ; update pointer
0203+  1737 0A D2 17      jmp get_token_return
0204+  173A             get_token_colon:
0205+  173A B9 3A         cmp al, $3a        ; check if ':'
0206+  173C C7 54 17      jne get_token_angle
0207+  173F F7            stosb          ; store ':' into token string
0208+  1740 19 00         mov al, 0
0209+  1742 F7            stosb          ; terminate token string
0210+  1743 19 0A         mov al, tok_colon
0211+  1745 3D 47 18      mov [tok], al      
0212+  1748 19 02         mov al, toktyp_delimiter
0213+  174A 3D 46 18      mov [toktyp], al
0214+  174D 4E            mov a, si
0215+  174E 42 44 18      mov [prog], a    ; update pointer
0216+  1751 0A D2 17      jmp get_token_return
0217+  1754             get_token_angle:
0218+  1754 B9 3E         cmp al, $3e        ; check if '>'
0219+  1756 C7 6E 17      jne get_token_tilde
0220+  1759 F7            stosb          ; store '>' into token string
0221+  175A 19 00         mov al, 0
0222+  175C F7            stosb          ; terminate token string
0223+  175D 19 07         mov al, tok_angle
0224+  175F 3D 47 18      mov [tok], al      
0225+  1762 19 02         mov al, toktyp_delimiter
0226+  1764 3D 46 18      mov [toktyp], al
0227+  1767 4E            mov a, si
0228+  1768 42 44 18      mov [prog], a    ; update pointer
0229+  176B 0A D2 17      jmp get_token_return
0230+  176E             get_token_tilde:
0231+  176E B9 7E         cmp al, '~'        ; check if '~'
0232+  1770 C7 88 17      jne get_token_equal
0233+  1773 F7            stosb          ; store '~' into token string
0234+  1774 19 00         mov al, 0
0235+  1776 F7            stosb          ; terminate token string
0236+  1777 19 08         mov al, tok_tilde
0237+  1779 3D 47 18      mov [tok], al      
0238+  177C 19 02         mov al, toktyp_delimiter
0239+  177E 3D 46 18      mov [toktyp], al
0240+  1781 4E            mov a, si
0241+  1782 42 44 18      mov [prog], a    ; update pointer
0242+  1785 0A D2 17      jmp get_token_return
0243+  1788             get_token_equal:
0244+  1788 B9 3D         cmp al, '='        ; check if '='
0245+  178A C7 A2 17      jne get_token_skip
0246+  178D F7            stosb          ; store '=' into token string
0247+  178E 19 00         mov al, 0
0248+  1790 F7            stosb          ; terminate token string
0249+  1791 19 09         mov al, tok_equal
0250+  1793 3D 47 18      mov [tok], al      
0251+  1796 19 02         mov al, toktyp_delimiter
0252+  1798 3D 46 18      mov [toktyp], al
0253+  179B 4E            mov a, si
0254+  179C 42 44 18      mov [prog], a    ; update pointer
0255+  179F 0A D2 17      jmp get_token_return
0256+  17A2             get_token_skip:
0257+  17A2 4E            mov a, si
0258+  17A3 42 44 18      mov [prog], a    ; update pointer
0259+  17A6 0A D2 17      jmp get_token_return
0260+  17A9             get_token_end:        ; end of file token
0261+  17A9 19 14         mov al, tok_end
0262+  17AB 3D 47 18      mov [tok], al
0263+  17AE 19 06         mov al, toktyp_end
0264+  17B0 3D 46 18      mov [toktyp], al
0265+  17B3 0A D2 17      jmp get_token_return
0266+  17B6             is_alphanumeric:
0267+  17B6 F7            stosb
0268+  17B7 F6            lodsb
0269+  17B8 07 7D 15      call _isalnum      ;check if is alphanumeric
0270+  17BB C6 B6 17      jz is_alphanumeric
0271+  17BE B9 2E         cmp al, $2e        ; check if is '.'
0272+  17C0 C6 B6 17      je is_alphanumeric
0273+  17C3 19 00         mov al, 0
0274+  17C5 F7            stosb
0275+  17C6 19 00         mov al, toktyp_identifier
0276+  17C8 3D 46 18      mov [toktyp], al
0277+  17CB D5 01 00      sub si, 1
0278+  17CE 4E            mov a, si
0279+  17CF 42 44 18      mov [prog], a    ; update pointer
0280+  17D2             get_token_return:
0281+  17D2 F0            pop di
0282+  17D3 EF            pop si
0283+  17D4 E7            pop d
0284+  17D5 E4            pop a
0285+  17D6 09            ret
0286+  17D7             get_tok_comment:
0287+  17D7 F6            lodsb
0288+  17D8 B9 0A         cmp al, $0a      ; new line
0289+  17DA C7 D7 17      jne get_tok_comment
0290+  17DD 0A BB 16      jmp get_tok_skip_spaces
0291+  17E0             
0292+  17E0             
0293+  17E0             get_number:
0294+  17E0 D7            push a
0295+  17E1 DA            push d
0296+  17E2 E2            push si
0297+  17E3 E3            push di
0298+  17E4 19 00         mov al, 0
0299+  17E6 3D 48 18      mov [tokstr], al      ; nullify tokstr string
0300+  17E9 19 00         mov al, tok_null
0301+  17EB 3D 47 18      mov [tok], al        ; nullify token
0302+  17EE 14 44 18      mov a, [prog]
0303+  17F1 4D            mov si, a
0304+  17F2 FD 4F 48 18   mov di, tokstr
0305+  17F6             get_number_skip_spaces:
0306+  17F6 F6            lodsb
0307+  17F7 07 F3 15      call _isspace
0308+  17FA C6 F6 17      je get_number_skip_spaces
0309+  17FD B9 00         cmp al, 0      ; check for end of input (null)
0310+  17FF C7 0F 18      jne get_number_l0
0311+  1802 19 14         mov al, tok_end
0312+  1804 3D 47 18      mov [tok], al
0313+  1807 19 06         mov al, toktyp_end
0314+  1809 3D 46 18      mov [toktyp], al
0315+  180C 0A 26 18      jmp get_number_return
0316+  180F             get_number_l0:
0317+  180F F7            stosb
0318+  1810 F6            lodsb
0319+  1811 07 87 15      call _isdigit      ;check if is numeric
0320+  1814 C6 0F 18      jz get_number_l0
0321+  1817 19 00         mov al, 0
0322+  1819 F7            stosb
0323+  181A 19 05         mov al, toktyp_numeric
0324+  181C 3D 46 18      mov [toktyp], al
0325+  181F D5 01 00      sub si, 1
0326+  1822 4E            mov a, si
0327+  1823 42 44 18      mov [prog], a    ; update pointer
0328+  1826             get_number_return:
0329+  1826 F0            pop di
0330+  1827 EF            pop si
0331+  1828 E7            pop d
0332+  1829 E4            pop a
0333+  182A 09            ret
0334+  182B             
0335+  182B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0336+  182B             ;; put back token
0337+  182B             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  
0338+  182B             _putback:
0339+  182B D7            push a
0340+  182C E2            push si
0341+  182D FD 4D 48 18   mov si, tokstr  
0342+  1831             _putback_loop:
0343+  1831 F6            lodsb
0344+  1832 B9 00         cmp al, 0
0345+  1834 C6 41 18      je _putback_end
0346+  1837 14 44 18      mov a, [prog]
0347+  183A 7D            dec a
0348+  183B 42 44 18      mov [prog], a      ; update pointer
0349+  183E 0A 31 18      jmp _putback_loop
0350+  1841             _putback_end:
0351+  1841 EF            pop si
0352+  1842 E4            pop a
0353+  1843 09            ret
0354+  1844             
0355+  1844             
0356+  1844             
0357+  1844             
0358+  1844 00 00       prog:      .dw 0          ; pointer to current position in buffer
0359+  1846             
0360+  1846 00          toktyp:    .db 0          ; token type symbol
0361+  1847 00          tok:       .db 0          ; current token symbol
0362+  1848 00 00 00 00 tokstr:    .fill 256, 0   ; token as a string
0362+  184C 00 00 00 00 
0362+  1850 00 00 00 00 
0362+  1854 00 00 00 00 
0362+  1858 00 00 00 00 
0362+  185C 00 00 00 00 
0362+  1860 00 00 00 00 
0362+  1864 00 00 00 00 
0362+  1868 00 00 00 00 
0362+  186C 00 00 00 00 
0362+  1870 00 00 00 00 
0362+  1874 00 00 00 00 
0362+  1878 00 00 00 00 
0362+  187C 00 00 00 00 
0362+  1880 00 00 00 00 
0362+  1884 00 00 00 00 
0362+  1888 00 00 00 00 
0362+  188C 00 00 00 00 
0362+  1890 00 00 00 00 
0362+  1894 00 00 00 00 
0362+  1898 00 00 00 00 
0362+  189C 00 00 00 00 
0362+  18A0 00 00 00 00 
0362+  18A4 00 00 00 00 
0362+  18A8 00 00 00 00 
0362+  18AC 00 00 00 00 
0362+  18B0 00 00 00 00 
0362+  18B4 00 00 00 00 
0362+  18B8 00 00 00 00 
0362+  18BC 00 00 00 00 
0362+  18C0 00 00 00 00 
0362+  18C4 00 00 00 00 
0362+  18C8 00 00 00 00 
0362+  18CC 00 00 00 00 
0362+  18D0 00 00 00 00 
0362+  18D4 00 00 00 00 
0362+  18D8 00 00 00 00 
0362+  18DC 00 00 00 00 
0362+  18E0 00 00 00 00 
0362+  18E4 00 00 00 00 
0362+  18E8 00 00 00 00 
0362+  18EC 00 00 00 00 
0362+  18F0 00 00 00 00 
0362+  18F4 00 00 00 00 
0362+  18F8 00 00 00 00 
0362+  18FC 00 00 00 00 
0362+  1900 00 00 00 00 
0362+  1904 00 00 00 00 
0362+  1908 00 00 00 00 
0362+  190C 00 00 00 00 
0362+  1910 00 00 00 00 
0362+  1914 00 00 00 00 
0362+  1918 00 00 00 00 
0362+  191C 00 00 00 00 
0362+  1920 00 00 00 00 
0362+  1924 00 00 00 00 
0362+  1928 00 00 00 00 
0362+  192C 00 00 00 00 
0362+  1930 00 00 00 00 
0362+  1934 00 00 00 00 
0362+  1938 00 00 00 00 
0362+  193C 00 00 00 00 
0362+  1940 00 00 00 00 
0362+  1944 00 00 00 00 
3094   1948             
3095   1948             ; kernel parameters
3096   1948             sys_debug_mode:
3097   1948 00            .db 0   ; debug modes: 0=normal mode, 1=debug mode
3098   1949             sys_echo_on:
3099   1949 01            .db 1
3100   194A             sys_uart0_lcr:
3101   194A 0F            .db %00001111 ; 8 data bits, 2 stop bits, enable parity, odd parity
3102   194B             sys_uart0_inten:
3103   194B 01            .db 1
3104   194C             sys_uart0_fifoen:
3105   194C 00            .db 0
3106   194D             sys_uart0_div0:
3107   194D 03            .db 3
3108   194E             sys_uart0_div1:
3109   194E 00            .db 0   ; default baud = 38400
3110   194F             ; baud  divisor
3111   194F             ; 50    2304
3112   194F             ; 110   1047
3113   194F             ; 300    384
3114   194F             ; 600    192
3115   194F             ; 1200    96
3116   194F             ; 9600    12
3117   194F             ; 19200    6
3118   194F             ; 38400    3
3119   194F             sys_uart1_lcr:
3120   194F 0F            .db %00001111 ; 8 data bits, 2 stop bits, enable parity, odd parity
3121   1950             sys_uart1_inten:
3122   1950 01            .db 1
3123   1951             sys_uart1_fifoen:
3124   1951 00            .db 0
3125   1952             sys_uart1_div0:
3126   1952 03            .db 3
3127   1953             sys_uart1_div1:
3128   1953 00            .db 0   ; default baud = 38400
3129   1954             
3130   1954             nbr_active_procs:
3131   1954 00            .db 0
3132   1955             active_proc_index:
3133   1955 01            .db 1
3134   1956             
3135   1956             index:
3136   1956 00 00         .dw 0
3137   1958             buffer_addr:
3138   1958 00 00         .dw 0
3139   195A             
3140   195A             fifo_in:
3141   195A 61 21         .dw fifo
3142   195C             fifo_out:
3143   195C 61 21         .dw fifo
3144   195E             
3145   195E             ; file system variables
3146   195E             current_dir_id:
3147   195E 00 00         .dw 0     ; keep dirid of current directory
3148   1960             s_init_path:
3149   1960 2F 73 62 69   .db "/sbin/init", 0
3149   1964 6E 2F 69 6E 
3149   1968 69 74 00 
3150   196B             
3151   196B             s_uname:
3152   196B 73 6F 6C 61   .db "solarium v.1.0", 0
3152   196F 72 69 75 6D 
3152   1973 20 76 2E 31 
3152   1977 2E 30 00 
3153   197A             s_dataentry:
3154   197A 3E 20 00      .db "> ", 0
3155   197D             s_parent_dir:
3156   197D 2E 2E 00      .db "..", 0
3157   1980             s_current_dir:
3158   1980 2E 00         .db ".", 0
3159   1982             s_fslash:
3160   1982 2F 00         .db "/", 0
3161   1984             file_attrib:
3162   1984 2D 72 77 20   .db "-rw x"      ; chars at powers of 2
3162   1988 78 
3163   1989             file_type:
3164   1989 2D 64 63      .db "-dc"
3165   198C             s_ps_header:
3166   198C 70 69 64 20   .db "pid command\n", 0
3166   1990 63 6F 6D 6D 
3166   1994 61 6E 64 0A 
3166   1998 00 
3167   1999             s_ls_total:
3168   1999 74 6F 74 61   .db "total: ", 0
3168   199D 6C 3A 20 00 
3169   19A1             
3170   19A1             s_int_en:
3171   19A1 69 72 71 73   .db "irqs enabled\n", 0
3171   19A5 20 65 6E 61 
3171   19A9 62 6C 65 64 
3171   19AD 0A 00 
3172   19AF             s_kernel_welcome:
3173   19AF 2A 2A 2A 2A   .db "************************************************\n"
3173   19B3 2A 2A 2A 2A 
3173   19B7 2A 2A 2A 2A 
3173   19BB 2A 2A 2A 2A 
3173   19BF 2A 2A 2A 2A 
3173   19C3 2A 2A 2A 2A 
3173   19C7 2A 2A 2A 2A 
3173   19CB 2A 2A 2A 2A 
3173   19CF 2A 2A 2A 2A 
3173   19D3 2A 2A 2A 2A 
3173   19D7 2A 2A 2A 2A 
3173   19DB 2A 2A 2A 2A 
3173   19DF 0A 
3174   19E0 2A 2A 2A 20   .db "*** Welcome to Solarium OS - Kernel ver. 1.0 ***\n"
3174   19E4 57 65 6C 63 
3174   19E8 6F 6D 65 20 
3174   19EC 74 6F 20 53 
3174   19F0 6F 6C 61 72 
3174   19F4 69 75 6D 20 
3174   19F8 4F 53 20 2D 
3174   19FC 20 4B 65 72 
3174   1A00 6E 65 6C 20 
3174   1A04 76 65 72 2E 
3174   1A08 20 31 2E 30 
3174   1A0C 20 2A 2A 2A 
3174   1A10 0A 
3175   1A11 2A 2A 2A 20   .db "*** type help for more information           ***\n"
3175   1A15 74 79 70 65 
3175   1A19 20 68 65 6C 
3175   1A1D 70 20 66 6F 
3175   1A21 72 20 6D 6F 
3175   1A25 72 65 20 69 
3175   1A29 6E 66 6F 72 
3175   1A2D 6D 61 74 69 
3175   1A31 6F 6E 20 20 
3175   1A35 20 20 20 20 
3175   1A39 20 20 20 20 
3175   1A3D 20 2A 2A 2A 
3175   1A41 0A 
3176   1A42 2A 2A 2A 2A   .db "************************************************\n"
3176   1A46 2A 2A 2A 2A 
3176   1A4A 2A 2A 2A 2A 
3176   1A4E 2A 2A 2A 2A 
3176   1A52 2A 2A 2A 2A 
3176   1A56 2A 2A 2A 2A 
3176   1A5A 2A 2A 2A 2A 
3176   1A5E 2A 2A 2A 2A 
3176   1A62 2A 2A 2A 2A 
3176   1A66 2A 2A 2A 2A 
3176   1A6A 2A 2A 2A 2A 
3176   1A6E 2A 2A 2A 2A 
3176   1A72 0A 
3177   1A73             s_prompt_init:
3178   1A73 73 74 61 72   .db "starting init\n", 0
3178   1A77 74 69 6E 67 
3178   1A7B 20 69 6E 69 
3178   1A7F 74 0A 00 
3179   1A82             s_priviledge:
3180   1A82 0A 65 78 63   .db "\nexception: privilege\n", 0
3180   1A86 65 70 74 69 
3180   1A8A 6F 6E 3A 20 
3180   1A8E 70 72 69 76 
3180   1A92 69 6C 65 67 
3180   1A96 65 0A 00 
3181   1A99             s_divzero:
3182   1A99 0A 65 78 63   .db "\nexception: zero division\n", 0
3182   1A9D 65 70 74 69 
3182   1AA1 6F 6E 3A 20 
3182   1AA5 7A 65 72 6F 
3182   1AA9 20 64 69 76 
3182   1AAD 69 73 69 6F 
3182   1AB1 6E 0A 00 
3183   1AB4             
3184   1AB4             s_set_year:
3185   1AB4 79 65 61 72   .db "year: ", 0
3185   1AB8 3A 20 00 
3186   1ABB             s_set_month:
3187   1ABB 6D 6F 6E 74   .db "month: ", 0
3187   1ABF 68 3A 20 00 
3188   1AC3             s_set_day:
3189   1AC3 64 61 79 3A   .db "day: ", 0
3189   1AC7 20 00 
3190   1AC9             s_set_week:
3191   1AC9 77 65 65 6B   .db "weekday: ", 0
3191   1ACD 64 61 79 3A 
3191   1AD1 20 00 
3192   1AD3             s_set_hours:
3193   1AD3 68 6F 75 72   .db "hours: ", 0
3193   1AD7 73 3A 20 00 
3194   1ADB             s_set_minutes:
3195   1ADB 6D 69 6E 75   .db "minutes: ", 0
3195   1ADF 74 65 73 3A 
3195   1AE3 20 00 
3196   1AE5             s_set_seconds:
3197   1AE5 73 65 63 6F   .db "seconds: ", 0
3197   1AE9 6E 64 73 3A 
3197   1AED 20 00 
3198   1AEF             s_months:      
3199   1AEF 20 20 20 00   .db "   ", 0
3200   1AF3 6A 61 6E 00   .db "jan", 0
3201   1AF7 66 65 62 00   .db "feb", 0
3202   1AFB 6D 61 72 00   .db "mar", 0
3203   1AFF 61 70 72 00   .db "apr", 0
3204   1B03 6D 61 79 00   .db "may", 0
3205   1B07 6A 75 6E 00   .db "jun", 0
3206   1B0B 6A 75 6C 00   .db "jul", 0
3207   1B0F 61 75 67 00   .db "aug", 0
3208   1B13 73 65 70 00   .db "sep", 0
3209   1B17 6F 63 74 00   .db "oct", 0
3210   1B1B 6E 6F 76 00   .db "nov", 0
3211   1B1F 64 65 63 00   .db "dec", 0
3212   1B23             
3213   1B23             s_week:        
3214   1B23 73 75 6E 00   .db "sun", 0 
3215   1B27 6D 6F 6E 00   .db "mon", 0 
3216   1B2B 74 75 65 00   .db "tue", 0 
3217   1B2F 77 65 64 00   .db "wed", 0 
3218   1B33 74 68 75 00   .db "thu", 0 
3219   1B37 66 72 69 00   .db "fri", 0 
3220   1B3B 73 61 74 00   .db "sat", 0
3221   1B3F             
3222   1B3F 0A 49 52 51 s_fdc_irq: .db "\nIRQ0 Executed.\n", 0
3222   1B43 30 20 45 78 
3222   1B47 65 63 75 74 
3222   1B4B 65 64 2E 0A 
3222   1B4F 00 
3223   1B50             s_fdc_config:
3224   1B50 73 65 6C 65   .db "selecting diskette drive 0, side 0, single density, head loaded\n", 0
3224   1B54 63 74 69 6E 
3224   1B58 67 20 64 69 
3224   1B5C 73 6B 65 74 
3224   1B60 74 65 20 64 
3224   1B64 72 69 76 65 
3224   1B68 20 30 2C 20 
3224   1B6C 73 69 64 65 
3224   1B70 20 30 2C 20 
3224   1B74 73 69 6E 67 
3224   1B78 6C 65 20 64 
3224   1B7C 65 6E 73 69 
3224   1B80 74 79 2C 20 
3224   1B84 68 65 61 64 
3224   1B88 20 6C 6F 61 
3224   1B8C 64 65 64 0A 
3224   1B90 00 
3225   1B91             
3226   1B91             proc_state_table:   
3227   1B91 00 00 00 00   .fill 16 * 20, 0  ; for 15 processes max
3227   1B95 00 00 00 00 
3227   1B99 00 00 00 00 
3227   1B9D 00 00 00 00 
3227   1BA1 00 00 00 00 
3227   1BA5 00 00 00 00 
3227   1BA9 00 00 00 00 
3227   1BAD 00 00 00 00 
3227   1BB1 00 00 00 00 
3227   1BB5 00 00 00 00 
3227   1BB9 00 00 00 00 
3227   1BBD 00 00 00 00 
3227   1BC1 00 00 00 00 
3227   1BC5 00 00 00 00 
3227   1BC9 00 00 00 00 
3227   1BCD 00 00 00 00 
3227   1BD1 00 00 00 00 
3227   1BD5 00 00 00 00 
3227   1BD9 00 00 00 00 
3227   1BDD 00 00 00 00 
3227   1BE1 00 00 00 00 
3227   1BE5 00 00 00 00 
3227   1BE9 00 00 00 00 
3227   1BED 00 00 00 00 
3227   1BF1 00 00 00 00 
3227   1BF5 00 00 00 00 
3227   1BF9 00 00 00 00 
3227   1BFD 00 00 00 00 
3227   1C01 00 00 00 00 
3227   1C05 00 00 00 00 
3227   1C09 00 00 00 00 
3227   1C0D 00 00 00 00 
3227   1C11 00 00 00 00 
3227   1C15 00 00 00 00 
3227   1C19 00 00 00 00 
3227   1C1D 00 00 00 00 
3227   1C21 00 00 00 00 
3227   1C25 00 00 00 00 
3227   1C29 00 00 00 00 
3227   1C2D 00 00 00 00 
3227   1C31 00 00 00 00 
3227   1C35 00 00 00 00 
3227   1C39 00 00 00 00 
3227   1C3D 00 00 00 00 
3227   1C41 00 00 00 00 
3227   1C45 00 00 00 00 
3227   1C49 00 00 00 00 
3227   1C4D 00 00 00 00 
3227   1C51 00 00 00 00 
3227   1C55 00 00 00 00 
3227   1C59 00 00 00 00 
3227   1C5D 00 00 00 00 
3227   1C61 00 00 00 00 
3227   1C65 00 00 00 00 
3227   1C69 00 00 00 00 
3227   1C6D 00 00 00 00 
3227   1C71 00 00 00 00 
3227   1C75 00 00 00 00 
3227   1C79 00 00 00 00 
3227   1C7D 00 00 00 00 
3227   1C81 00 00 00 00 
3227   1C85 00 00 00 00 
3227   1C89 00 00 00 00 
3227   1C8D 00 00 00 00 
3227   1C91 00 00 00 00 
3227   1C95 00 00 00 00 
3227   1C99 00 00 00 00 
3227   1C9D 00 00 00 00 
3227   1CA1 00 00 00 00 
3227   1CA5 00 00 00 00 
3227   1CA9 00 00 00 00 
3227   1CAD 00 00 00 00 
3227   1CB1 00 00 00 00 
3227   1CB5 00 00 00 00 
3227   1CB9 00 00 00 00 
3227   1CBD 00 00 00 00 
3227   1CC1 00 00 00 00 
3227   1CC5 00 00 00 00 
3227   1CC9 00 00 00 00 
3227   1CCD 00 00 00 00 
3228   1CD1             proc_availab_table: 
3229   1CD1 00 00 00 00   .fill 16, 0       ; space for 15 processes. 0 = process empty, 1 = process taken
3229   1CD5 00 00 00 00 
3229   1CD9 00 00 00 00 
3229   1CDD 00 00 00 00 
3230   1CE1             proc_names:
3231   1CE1 00 00 00 00   .fill 16 * 32, 0  ; process names
3231   1CE5 00 00 00 00 
3231   1CE9 00 00 00 00 
3231   1CED 00 00 00 00 
3231   1CF1 00 00 00 00 
3231   1CF5 00 00 00 00 
3231   1CF9 00 00 00 00 
3231   1CFD 00 00 00 00 
3231   1D01 00 00 00 00 
3231   1D05 00 00 00 00 
3231   1D09 00 00 00 00 
3231   1D0D 00 00 00 00 
3231   1D11 00 00 00 00 
3231   1D15 00 00 00 00 
3231   1D19 00 00 00 00 
3231   1D1D 00 00 00 00 
3231   1D21 00 00 00 00 
3231   1D25 00 00 00 00 
3231   1D29 00 00 00 00 
3231   1D2D 00 00 00 00 
3231   1D31 00 00 00 00 
3231   1D35 00 00 00 00 
3231   1D39 00 00 00 00 
3231   1D3D 00 00 00 00 
3231   1D41 00 00 00 00 
3231   1D45 00 00 00 00 
3231   1D49 00 00 00 00 
3231   1D4D 00 00 00 00 
3231   1D51 00 00 00 00 
3231   1D55 00 00 00 00 
3231   1D59 00 00 00 00 
3231   1D5D 00 00 00 00 
3231   1D61 00 00 00 00 
3231   1D65 00 00 00 00 
3231   1D69 00 00 00 00 
3231   1D6D 00 00 00 00 
3231   1D71 00 00 00 00 
3231   1D75 00 00 00 00 
3231   1D79 00 00 00 00 
3231   1D7D 00 00 00 00 
3231   1D81 00 00 00 00 
3231   1D85 00 00 00 00 
3231   1D89 00 00 00 00 
3231   1D8D 00 00 00 00 
3231   1D91 00 00 00 00 
3231   1D95 00 00 00 00 
3231   1D99 00 00 00 00 
3231   1D9D 00 00 00 00 
3231   1DA1 00 00 00 00 
3231   1DA5 00 00 00 00 
3231   1DA9 00 00 00 00 
3231   1DAD 00 00 00 00 
3231   1DB1 00 00 00 00 
3231   1DB5 00 00 00 00 
3231   1DB9 00 00 00 00 
3231   1DBD 00 00 00 00 
3231   1DC1 00 00 00 00 
3231   1DC5 00 00 00 00 
3231   1DC9 00 00 00 00 
3231   1DCD 00 00 00 00 
3231   1DD1 00 00 00 00 
3231   1DD5 00 00 00 00 
3231   1DD9 00 00 00 00 
3231   1DDD 00 00 00 00 
3231   1DE1 00 00 00 00 
3231   1DE5 00 00 00 00 
3231   1DE9 00 00 00 00 
3231   1DED 00 00 00 00 
3231   1DF1 00 00 00 00 
3231   1DF5 00 00 00 00 
3231   1DF9 00 00 00 00 
3231   1DFD 00 00 00 00 
3231   1E01 00 00 00 00 
3231   1E05 00 00 00 00 
3231   1E09 00 00 00 00 
3231   1E0D 00 00 00 00 
3231   1E11 00 00 00 00 
3231   1E15 00 00 00 00 
3231   1E19 00 00 00 00 
3231   1E1D 00 00 00 00 
3231   1E21 00 00 00 00 
3231   1E25 00 00 00 00 
3231   1E29 00 00 00 00 
3231   1E2D 00 00 00 00 
3231   1E31 00 00 00 00 
3231   1E35 00 00 00 00 
3231   1E39 00 00 00 00 
3231   1E3D 00 00 00 00 
3231   1E41 00 00 00 00 
3231   1E45 00 00 00 00 
3231   1E49 00 00 00 00 
3231   1E4D 00 00 00 00 
3231   1E51 00 00 00 00 
3231   1E55 00 00 00 00 
3231   1E59 00 00 00 00 
3231   1E5D 00 00 00 00 
3231   1E61 00 00 00 00 
3231   1E65 00 00 00 00 
3231   1E69 00 00 00 00 
3231   1E6D 00 00 00 00 
3231   1E71 00 00 00 00 
3231   1E75 00 00 00 00 
3231   1E79 00 00 00 00 
3231   1E7D 00 00 00 00 
3231   1E81 00 00 00 00 
3231   1E85 00 00 00 00 
3231   1E89 00 00 00 00 
3231   1E8D 00 00 00 00 
3231   1E91 00 00 00 00 
3231   1E95 00 00 00 00 
3231   1E99 00 00 00 00 
3231   1E9D 00 00 00 00 
3231   1EA1 00 00 00 00 
3231   1EA5 00 00 00 00 
3231   1EA9 00 00 00 00 
3231   1EAD 00 00 00 00 
3231   1EB1 00 00 00 00 
3231   1EB5 00 00 00 00 
3231   1EB9 00 00 00 00 
3231   1EBD 00 00 00 00 
3231   1EC1 00 00 00 00 
3231   1EC5 00 00 00 00 
3231   1EC9 00 00 00 00 
3231   1ECD 00 00 00 00 
3231   1ED1 00 00 00 00 
3231   1ED5 00 00 00 00 
3231   1ED9 00 00 00 00 
3231   1EDD 00 00 00 00 
3232   1EE1             filename:
3233   1EE1 00 00 00 00   .fill 128, 0      ; holds a path for file search
3233   1EE5 00 00 00 00 
3233   1EE9 00 00 00 00 
3233   1EED 00 00 00 00 
3233   1EF1 00 00 00 00 
3233   1EF5 00 00 00 00 
3233   1EF9 00 00 00 00 
3233   1EFD 00 00 00 00 
3233   1F01 00 00 00 00 
3233   1F05 00 00 00 00 
3233   1F09 00 00 00 00 
3233   1F0D 00 00 00 00 
3233   1F11 00 00 00 00 
3233   1F15 00 00 00 00 
3233   1F19 00 00 00 00 
3233   1F1D 00 00 00 00 
3233   1F21 00 00 00 00 
3233   1F25 00 00 00 00 
3233   1F29 00 00 00 00 
3233   1F2D 00 00 00 00 
3233   1F31 00 00 00 00 
3233   1F35 00 00 00 00 
3233   1F39 00 00 00 00 
3233   1F3D 00 00 00 00 
3233   1F41 00 00 00 00 
3233   1F45 00 00 00 00 
3233   1F49 00 00 00 00 
3233   1F4D 00 00 00 00 
3233   1F51 00 00 00 00 
3233   1F55 00 00 00 00 
3233   1F59 00 00 00 00 
3233   1F5D 00 00 00 00 
3234   1F61             user_data:
3235   1F61 00 00 00 00   .fill 512, 0      ;  user space data
3235   1F65 00 00 00 00 
3235   1F69 00 00 00 00 
3235   1F6D 00 00 00 00 
3235   1F71 00 00 00 00 
3235   1F75 00 00 00 00 
3235   1F79 00 00 00 00 
3235   1F7D 00 00 00 00 
3235   1F81 00 00 00 00 
3235   1F85 00 00 00 00 
3235   1F89 00 00 00 00 
3235   1F8D 00 00 00 00 
3235   1F91 00 00 00 00 
3235   1F95 00 00 00 00 
3235   1F99 00 00 00 00 
3235   1F9D 00 00 00 00 
3235   1FA1 00 00 00 00 
3235   1FA5 00 00 00 00 
3235   1FA9 00 00 00 00 
3235   1FAD 00 00 00 00 
3235   1FB1 00 00 00 00 
3235   1FB5 00 00 00 00 
3235   1FB9 00 00 00 00 
3235   1FBD 00 00 00 00 
3235   1FC1 00 00 00 00 
3235   1FC5 00 00 00 00 
3235   1FC9 00 00 00 00 
3235   1FCD 00 00 00 00 
3235   1FD1 00 00 00 00 
3235   1FD5 00 00 00 00 
3235   1FD9 00 00 00 00 
3235   1FDD 00 00 00 00 
3235   1FE1 00 00 00 00 
3235   1FE5 00 00 00 00 
3235   1FE9 00 00 00 00 
3235   1FED 00 00 00 00 
3235   1FF1 00 00 00 00 
3235   1FF5 00 00 00 00 
3235   1FF9 00 00 00 00 
3235   1FFD 00 00 00 00 
3235   2001 00 00 00 00 
3235   2005 00 00 00 00 
3235   2009 00 00 00 00 
3235   200D 00 00 00 00 
3235   2011 00 00 00 00 
3235   2015 00 00 00 00 
3235   2019 00 00 00 00 
3235   201D 00 00 00 00 
3235   2021 00 00 00 00 
3235   2025 00 00 00 00 
3235   2029 00 00 00 00 
3235   202D 00 00 00 00 
3235   2031 00 00 00 00 
3235   2035 00 00 00 00 
3235   2039 00 00 00 00 
3235   203D 00 00 00 00 
3235   2041 00 00 00 00 
3235   2045 00 00 00 00 
3235   2049 00 00 00 00 
3235   204D 00 00 00 00 
3235   2051 00 00 00 00 
3235   2055 00 00 00 00 
3235   2059 00 00 00 00 
3235   205D 00 00 00 00 
3235   2061 00 00 00 00 
3235   2065 00 00 00 00 
3235   2069 00 00 00 00 
3235   206D 00 00 00 00 
3235   2071 00 00 00 00 
3235   2075 00 00 00 00 
3235   2079 00 00 00 00 
3235   207D 00 00 00 00 
3235   2081 00 00 00 00 
3235   2085 00 00 00 00 
3235   2089 00 00 00 00 
3235   208D 00 00 00 00 
3235   2091 00 00 00 00 
3235   2095 00 00 00 00 
3235   2099 00 00 00 00 
3235   209D 00 00 00 00 
3235   20A1 00 00 00 00 
3235   20A5 00 00 00 00 
3235   20A9 00 00 00 00 
3235   20AD 00 00 00 00 
3235   20B1 00 00 00 00 
3235   20B5 00 00 00 00 
3235   20B9 00 00 00 00 
3235   20BD 00 00 00 00 
3235   20C1 00 00 00 00 
3235   20C5 00 00 00 00 
3235   20C9 00 00 00 00 
3235   20CD 00 00 00 00 
3235   20D1 00 00 00 00 
3235   20D5 00 00 00 00 
3235   20D9 00 00 00 00 
3235   20DD 00 00 00 00 
3235   20E1 00 00 00 00 
3235   20E5 00 00 00 00 
3235   20E9 00 00 00 00 
3235   20ED 00 00 00 00 
3235   20F1 00 00 00 00 
3235   20F5 00 00 00 00 
3235   20F9 00 00 00 00 
3235   20FD 00 00 00 00 
3235   2101 00 00 00 00 
3235   2105 00 00 00 00 
3235   2109 00 00 00 00 
3235   210D 00 00 00 00 
3235   2111 00 00 00 00 
3235   2115 00 00 00 00 
3235   2119 00 00 00 00 
3235   211D 00 00 00 00 
3235   2121 00 00 00 00 
3235   2125 00 00 00 00 
3235   2129 00 00 00 00 
3235   212D 00 00 00 00 
3235   2131 00 00 00 00 
3235   2135 00 00 00 00 
3235   2139 00 00 00 00 
3235   213D 00 00 00 00 
3235   2141 00 00 00 00 
3235   2145 00 00 00 00 
3235   2149 00 00 00 00 
3235   214D 00 00 00 00 
3235   2151 00 00 00 00 
3235   2155 00 00 00 00 
3235   2159 00 00 00 00 
3235   215D 00 00 00 00 
3236   2161             fifo:
3237   2161 FF FF FF FF   .fill _fifo_size
3237   2165 FF FF FF FF 
3237   2169 FF FF FF FF 
3237   216D FF FF FF FF 
3237   2171 FF FF FF FF 
3237   2175 FF FF FF FF 
3237   2179 FF FF FF FF 
3237   217D FF FF FF FF 
3237   2181 FF FF FF FF 
3237   2185 FF FF FF FF 
3237   2189 FF FF FF FF 
3237   218D FF FF FF FF 
3237   2191 FF FF FF FF 
3237   2195 FF FF FF FF 
3237   2199 FF FF FF FF 
3237   219D FF FF FF FF 
3237   21A1 FF FF FF FF 
3237   21A5 FF FF FF FF 
3237   21A9 FF FF FF FF 
3237   21AD FF FF FF FF 
3237   21B1 FF FF FF FF 
3237   21B5 FF FF FF FF 
3237   21B9 FF FF FF FF 
3237   21BD FF FF FF FF 
3237   21C1 FF FF FF FF 
3237   21C5 FF FF FF FF 
3237   21C9 FF FF FF FF 
3237   21CD FF FF FF FF 
3237   21D1 FF FF FF FF 
3237   21D5 FF FF FF FF 
3237   21D9 FF FF FF FF 
3237   21DD FF FF FF FF 
3237   21E1 FF FF FF FF 
3237   21E5 FF FF FF FF 
3237   21E9 FF FF FF FF 
3237   21ED FF FF FF FF 
3237   21F1 FF FF FF FF 
3237   21F5 FF FF FF FF 
3237   21F9 FF FF FF FF 
3237   21FD FF FF FF FF 
3237   2201 FF FF FF FF 
3237   2205 FF FF FF FF 
3237   2209 FF FF FF FF 
3237   220D FF FF FF FF 
3237   2211 FF FF FF FF 
3237   2215 FF FF FF FF 
3237   2219 FF FF FF FF 
3237   221D FF FF FF FF 
3237   2221 FF FF FF FF 
3237   2225 FF FF FF FF 
3237   2229 FF FF FF FF 
3237   222D FF FF FF FF 
3237   2231 FF FF FF FF 
3237   2235 FF FF FF FF 
3237   2239 FF FF FF FF 
3237   223D FF FF FF FF 
3237   2241 FF FF FF FF 
3237   2245 FF FF FF FF 
3237   2249 FF FF FF FF 
3237   224D FF FF FF FF 
3237   2251 FF FF FF FF 
3237   2255 FF FF FF FF 
3237   2259 FF FF FF FF 
3237   225D FF FF FF FF 
3237   2261 FF FF FF FF 
3237   2265 FF FF FF FF 
3237   2269 FF FF FF FF 
3237   226D FF FF FF FF 
3237   2271 FF FF FF FF 
3237   2275 FF FF FF FF 
3237   2279 FF FF FF FF 
3237   227D FF FF FF FF 
3237   2281 FF FF FF FF 
3237   2285 FF FF FF FF 
3237   2289 FF FF FF FF 
3237   228D FF FF FF FF 
3237   2291 FF FF FF FF 
3237   2295 FF FF FF FF 
3237   2299 FF FF FF FF 
3237   229D FF FF FF FF 
3237   22A1 FF FF FF FF 
3237   22A5 FF FF FF FF 
3237   22A9 FF FF FF FF 
3237   22AD FF FF FF FF 
3237   22B1 FF FF FF FF 
3237   22B5 FF FF FF FF 
3237   22B9 FF FF FF FF 
3237   22BD FF FF FF FF 
3237   22C1 FF FF FF FF 
3237   22C5 FF FF FF FF 
3237   22C9 FF FF FF FF 
3237   22CD FF FF FF FF 
3237   22D1 FF FF FF FF 
3237   22D5 FF FF FF FF 
3237   22D9 FF FF FF FF 
3237   22DD FF FF FF FF 
3237   22E1 FF FF FF FF 
3237   22E5 FF FF FF FF 
3237   22E9 FF FF FF FF 
3237   22ED FF FF FF FF 
3237   22F1 FF FF FF FF 
3237   22F5 FF FF FF FF 
3237   22F9 FF FF FF FF 
3237   22FD FF FF FF FF 
3237   2301 FF FF FF FF 
3237   2305 FF FF FF FF 
3237   2309 FF FF FF FF 
3237   230D FF FF FF FF 
3237   2311 FF FF FF FF 
3237   2315 FF FF FF FF 
3237   2319 FF FF FF FF 
3237   231D FF FF FF FF 
3237   2321 FF FF FF FF 
3237   2325 FF FF FF FF 
3237   2329 FF FF FF FF 
3237   232D FF FF FF FF 
3237   2331 FF FF FF FF 
3237   2335 FF FF FF FF 
3237   2339 FF FF FF FF 
3237   233D FF FF FF FF 
3237   2341 FF FF FF FF 
3237   2345 FF FF FF FF 
3237   2349 FF FF FF FF 
3237   234D FF FF FF FF 
3237   2351 FF FF FF FF 
3237   2355 FF FF FF FF 
3237   2359 FF FF FF FF 
3237   235D FF FF FF FF 
3237   2361 FF FF FF FF 
3237   2365 FF FF FF FF 
3237   2369 FF FF FF FF 
3237   236D FF FF FF FF 
3237   2371 FF FF FF FF 
3237   2375 FF FF FF FF 
3237   2379 FF FF FF FF 
3237   237D FF FF FF FF 
3237   2381 FF FF FF FF 
3237   2385 FF FF FF FF 
3237   2389 FF FF FF FF 
3237   238D FF FF FF FF 
3237   2391 FF FF FF FF 
3237   2395 FF FF FF FF 
3237   2399 FF FF FF FF 
3237   239D FF FF FF FF 
3237   23A1 FF FF FF FF 
3237   23A5 FF FF FF FF 
3237   23A9 FF FF FF FF 
3237   23AD FF FF FF FF 
3237   23B1 FF FF FF FF 
3237   23B5 FF FF FF FF 
3237   23B9 FF FF FF FF 
3237   23BD FF FF FF FF 
3237   23C1 FF FF FF FF 
3237   23C5 FF FF FF FF 
3237   23C9 FF FF FF FF 
3237   23CD FF FF FF FF 
3237   23D1 FF FF FF FF 
3237   23D5 FF FF FF FF 
3237   23D9 FF FF FF FF 
3237   23DD FF FF FF FF 
3237   23E1 FF FF FF FF 
3237   23E5 FF FF FF FF 
3237   23E9 FF FF FF FF 
3237   23ED FF FF FF FF 
3237   23F1 FF FF FF FF 
3237   23F5 FF FF FF FF 
3237   23F9 FF FF FF FF 
3237   23FD FF FF FF FF 
3237   2401 FF FF FF FF 
3237   2405 FF FF FF FF 
3237   2409 FF FF FF FF 
3237   240D FF FF FF FF 
3237   2411 FF FF FF FF 
3237   2415 FF FF FF FF 
3237   2419 FF FF FF FF 
3237   241D FF FF FF FF 
3237   2421 FF FF FF FF 
3237   2425 FF FF FF FF 
3237   2429 FF FF FF FF 
3237   242D FF FF FF FF 
3237   2431 FF FF FF FF 
3237   2435 FF FF FF FF 
3237   2439 FF FF FF FF 
3237   243D FF FF FF FF 
3237   2441 FF FF FF FF 
3237   2445 FF FF FF FF 
3237   2449 FF FF FF FF 
3237   244D FF FF FF FF 
3237   2451 FF FF FF FF 
3237   2455 FF FF FF FF 
3237   2459 FF FF FF FF 
3237   245D FF FF FF FF 
3237   2461 FF FF FF FF 
3237   2465 FF FF FF FF 
3237   2469 FF FF FF FF 
3237   246D FF FF FF FF 
3237   2471 FF FF FF FF 
3237   2475 FF FF FF FF 
3237   2479 FF FF FF FF 
3237   247D FF FF FF FF 
3237   2481 FF FF FF FF 
3237   2485 FF FF FF FF 
3237   2489 FF FF FF FF 
3237   248D FF FF FF FF 
3237   2491 FF FF FF FF 
3237   2495 FF FF FF FF 
3237   2499 FF FF FF FF 
3237   249D FF FF FF FF 
3237   24A1 FF FF FF FF 
3237   24A5 FF FF FF FF 
3237   24A9 FF FF FF FF 
3237   24AD FF FF FF FF 
3237   24B1 FF FF FF FF 
3237   24B5 FF FF FF FF 
3237   24B9 FF FF FF FF 
3237   24BD FF FF FF FF 
3237   24C1 FF FF FF FF 
3237   24C5 FF FF FF FF 
3237   24C9 FF FF FF FF 
3237   24CD FF FF FF FF 
3237   24D1 FF FF FF FF 
3237   24D5 FF FF FF FF 
3237   24D9 FF FF FF FF 
3237   24DD FF FF FF FF 
3237   24E1 FF FF FF FF 
3237   24E5 FF FF FF FF 
3237   24E9 FF FF FF FF 
3237   24ED FF FF FF FF 
3237   24F1 FF FF FF FF 
3237   24F5 FF FF FF FF 
3237   24F9 FF FF FF FF 
3237   24FD FF FF FF FF 
3237   2501 FF FF FF FF 
3237   2505 FF FF FF FF 
3237   2509 FF FF FF FF 
3237   250D FF FF FF FF 
3237   2511 FF FF FF FF 
3237   2515 FF FF FF FF 
3237   2519 FF FF FF FF 
3237   251D FF FF FF FF 
3237   2521 FF FF FF FF 
3237   2525 FF FF FF FF 
3237   2529 FF FF FF FF 
3237   252D FF FF FF FF 
3237   2531 FF FF FF FF 
3237   2535 FF FF FF FF 
3237   2539 FF FF FF FF 
3237   253D FF FF FF FF 
3237   2541 FF FF FF FF 
3237   2545 FF FF FF FF 
3237   2549 FF FF FF FF 
3237   254D FF FF FF FF 
3237   2551 FF FF FF FF 
3237   2555 FF FF FF FF 
3237   2559 FF FF FF FF 
3237   255D FF FF FF FF 
3237   2561 FF FF FF FF 
3237   2565 FF FF FF FF 
3237   2569 FF FF FF FF 
3237   256D FF FF FF FF 
3237   2571 FF FF FF FF 
3237   2575 FF FF FF FF 
3237   2579 FF FF FF FF 
3237   257D FF FF FF FF 
3237   2581 FF FF FF FF 
3237   2585 FF FF FF FF 
3237   2589 FF FF FF FF 
3237   258D FF FF FF FF 
3237   2591 FF FF FF FF 
3237   2595 FF FF FF FF 
3237   2599 FF FF FF FF 
3237   259D FF FF FF FF 
3237   25A1 FF FF FF FF 
3237   25A5 FF FF FF FF 
3237   25A9 FF FF FF FF 
3237   25AD FF FF FF FF 
3237   25B1 FF FF FF FF 
3237   25B5 FF FF FF FF 
3237   25B9 FF FF FF FF 
3237   25BD FF FF FF FF 
3237   25C1 FF FF FF FF 
3237   25C5 FF FF FF FF 
3237   25C9 FF FF FF FF 
3237   25CD FF FF FF FF 
3237   25D1 FF FF FF FF 
3237   25D5 FF FF FF FF 
3237   25D9 FF FF FF FF 
3237   25DD FF FF FF FF 
3237   25E1 FF FF FF FF 
3237   25E5 FF FF FF FF 
3237   25E9 FF FF FF FF 
3237   25ED FF FF FF FF 
3237   25F1 FF FF FF FF 
3237   25F5 FF FF FF FF 
3237   25F9 FF FF FF FF 
3237   25FD FF FF FF FF 
3237   2601 FF FF FF FF 
3237   2605 FF FF FF FF 
3237   2609 FF FF FF FF 
3237   260D FF FF FF FF 
3237   2611 FF FF FF FF 
3237   2615 FF FF FF FF 
3237   2619 FF FF FF FF 
3237   261D FF FF FF FF 
3237   2621 FF FF FF FF 
3237   2625 FF FF FF FF 
3237   2629 FF FF FF FF 
3237   262D FF FF FF FF 
3237   2631 FF FF FF FF 
3237   2635 FF FF FF FF 
3237   2639 FF FF FF FF 
3237   263D FF FF FF FF 
3237   2641 FF FF FF FF 
3237   2645 FF FF FF FF 
3237   2649 FF FF FF FF 
3237   264D FF FF FF FF 
3237   2651 FF FF FF FF 
3237   2655 FF FF FF FF 
3237   2659 FF FF FF FF 
3237   265D FF FF FF FF 
3237   2661 FF FF FF FF 
3237   2665 FF FF FF FF 
3237   2669 FF FF FF FF 
3237   266D FF FF FF FF 
3237   2671 FF FF FF FF 
3237   2675 FF FF FF FF 
3237   2679 FF FF FF FF 
3237   267D FF FF FF FF 
3237   2681 FF FF FF FF 
3237   2685 FF FF FF FF 
3237   2689 FF FF FF FF 
3237   268D FF FF FF FF 
3237   2691 FF FF FF FF 
3237   2695 FF FF FF FF 
3237   2699 FF FF FF FF 
3237   269D FF FF FF FF 
3237   26A1 FF FF FF FF 
3237   26A5 FF FF FF FF 
3237   26A9 FF FF FF FF 
3237   26AD FF FF FF FF 
3237   26B1 FF FF FF FF 
3237   26B5 FF FF FF FF 
3237   26B9 FF FF FF FF 
3237   26BD FF FF FF FF 
3237   26C1 FF FF FF FF 
3237   26C5 FF FF FF FF 
3237   26C9 FF FF FF FF 
3237   26CD FF FF FF FF 
3237   26D1 FF FF FF FF 
3237   26D5 FF FF FF FF 
3237   26D9 FF FF FF FF 
3237   26DD FF FF FF FF 
3237   26E1 FF FF FF FF 
3237   26E5 FF FF FF FF 
3237   26E9 FF FF FF FF 
3237   26ED FF FF FF FF 
3237   26F1 FF FF FF FF 
3237   26F5 FF FF FF FF 
3237   26F9 FF FF FF FF 
3237   26FD FF FF FF FF 
3237   2701 FF FF FF FF 
3237   2705 FF FF FF FF 
3237   2709 FF FF FF FF 
3237   270D FF FF FF FF 
3237   2711 FF FF FF FF 
3237   2715 FF FF FF FF 
3237   2719 FF FF FF FF 
3237   271D FF FF FF FF 
3237   2721 FF FF FF FF 
3237   2725 FF FF FF FF 
3237   2729 FF FF FF FF 
3237   272D FF FF FF FF 
3237   2731 FF FF FF FF 
3237   2735 FF FF FF FF 
3237   2739 FF FF FF FF 
3237   273D FF FF FF FF 
3237   2741 FF FF FF FF 
3237   2745 FF FF FF FF 
3237   2749 FF FF FF FF 
3237   274D FF FF FF FF 
3237   2751 FF FF FF FF 
3237   2755 FF FF FF FF 
3237   2759 FF FF FF FF 
3237   275D FF FF FF FF 
3237   2761 FF FF FF FF 
3237   2765 FF FF FF FF 
3237   2769 FF FF FF FF 
3237   276D FF FF FF FF 
3237   2771 FF FF FF FF 
3237   2775 FF FF FF FF 
3237   2779 FF FF FF FF 
3237   277D FF FF FF FF 
3237   2781 FF FF FF FF 
3237   2785 FF FF FF FF 
3237   2789 FF FF FF FF 
3237   278D FF FF FF FF 
3237   2791 FF FF FF FF 
3237   2795 FF FF FF FF 
3237   2799 FF FF FF FF 
3237   279D FF FF FF FF 
3237   27A1 FF FF FF FF 
3237   27A5 FF FF FF FF 
3237   27A9 FF FF FF FF 
3237   27AD FF FF FF FF 
3237   27B1 FF FF FF FF 
3237   27B5 FF FF FF FF 
3237   27B9 FF FF FF FF 
3237   27BD FF FF FF FF 
3237   27C1 FF FF FF FF 
3237   27C5 FF FF FF FF 
3237   27C9 FF FF FF FF 
3237   27CD FF FF FF FF 
3237   27D1 FF FF FF FF 
3237   27D5 FF FF FF FF 
3237   27D9 FF FF FF FF 
3237   27DD FF FF FF FF 
3237   27E1 FF FF FF FF 
3237   27E5 FF FF FF FF 
3237   27E9 FF FF FF FF 
3237   27ED FF FF FF FF 
3237   27F1 FF FF FF FF 
3237   27F5 FF FF FF FF 
3237   27F9 FF FF FF FF 
3237   27FD FF FF FF FF 
3237   2801 FF FF FF FF 
3237   2805 FF FF FF FF 
3237   2809 FF FF FF FF 
3237   280D FF FF FF FF 
3237   2811 FF FF FF FF 
3237   2815 FF FF FF FF 
3237   2819 FF FF FF FF 
3237   281D FF FF FF FF 
3237   2821 FF FF FF FF 
3237   2825 FF FF FF FF 
3237   2829 FF FF FF FF 
3237   282D FF FF FF FF 
3237   2831 FF FF FF FF 
3237   2835 FF FF FF FF 
3237   2839 FF FF FF FF 
3237   283D FF FF FF FF 
3237   2841 FF FF FF FF 
3237   2845 FF FF FF FF 
3237   2849 FF FF FF FF 
3237   284D FF FF FF FF 
3237   2851 FF FF FF FF 
3237   2855 FF FF FF FF 
3237   2859 FF FF FF FF 
3237   285D FF FF FF FF 
3237   2861 FF FF FF FF 
3237   2865 FF FF FF FF 
3237   2869 FF FF FF FF 
3237   286D FF FF FF FF 
3237   2871 FF FF FF FF 
3237   2875 FF FF FF FF 
3237   2879 FF FF FF FF 
3237   287D FF FF FF FF 
3237   2881 FF FF FF FF 
3237   2885 FF FF FF FF 
3237   2889 FF FF FF FF 
3237   288D FF FF FF FF 
3237   2891 FF FF FF FF 
3237   2895 FF FF FF FF 
3237   2899 FF FF FF FF 
3237   289D FF FF FF FF 
3237   28A1 FF FF FF FF 
3237   28A5 FF FF FF FF 
3237   28A9 FF FF FF FF 
3237   28AD FF FF FF FF 
3237   28B1 FF FF FF FF 
3237   28B5 FF FF FF FF 
3237   28B9 FF FF FF FF 
3237   28BD FF FF FF FF 
3237   28C1 FF FF FF FF 
3237   28C5 FF FF FF FF 
3237   28C9 FF FF FF FF 
3237   28CD FF FF FF FF 
3237   28D1 FF FF FF FF 
3237   28D5 FF FF FF FF 
3237   28D9 FF FF FF FF 
3237   28DD FF FF FF FF 
3237   28E1 FF FF FF FF 
3237   28E5 FF FF FF FF 
3237   28E9 FF FF FF FF 
3237   28ED FF FF FF FF 
3237   28F1 FF FF FF FF 
3237   28F5 FF FF FF FF 
3237   28F9 FF FF FF FF 
3237   28FD FF FF FF FF 
3237   2901 FF FF FF FF 
3237   2905 FF FF FF FF 
3237   2909 FF FF FF FF 
3237   290D FF FF FF FF 
3237   2911 FF FF FF FF 
3237   2915 FF FF FF FF 
3237   2919 FF FF FF FF 
3237   291D FF FF FF FF 
3237   2921 FF FF FF FF 
3237   2925 FF FF FF FF 
3237   2929 FF FF FF FF 
3237   292D FF FF FF FF 
3237   2931 FF FF FF FF 
3237   2935 FF FF FF FF 
3237   2939 FF FF FF FF 
3237   293D FF FF FF FF 
3237   2941 FF FF FF FF 
3237   2945 FF FF FF FF 
3237   2949 FF FF FF FF 
3237   294D FF FF FF FF 
3237   2951 FF FF FF FF 
3237   2955 FF FF FF FF 
3237   2959 FF FF FF FF 
3237   295D FF FF FF FF 
3237   2961 FF FF FF FF 
3237   2965 FF FF FF FF 
3237   2969 FF FF FF FF 
3237   296D FF FF FF FF 
3237   2971 FF FF FF FF 
3237   2975 FF FF FF FF 
3237   2979 FF FF FF FF 
3237   297D FF FF FF FF 
3237   2981 FF FF FF FF 
3237   2985 FF FF FF FF 
3237   2989 FF FF FF FF 
3237   298D FF FF FF FF 
3237   2991 FF FF FF FF 
3237   2995 FF FF FF FF 
3237   2999 FF FF FF FF 
3237   299D FF FF FF FF 
3237   29A1 FF FF FF FF 
3237   29A5 FF FF FF FF 
3237   29A9 FF FF FF FF 
3237   29AD FF FF FF FF 
3237   29B1 FF FF FF FF 
3237   29B5 FF FF FF FF 
3237   29B9 FF FF FF FF 
3237   29BD FF FF FF FF 
3237   29C1 FF FF FF FF 
3237   29C5 FF FF FF FF 
3237   29C9 FF FF FF FF 
3237   29CD FF FF FF FF 
3237   29D1 FF FF FF FF 
3237   29D5 FF FF FF FF 
3237   29D9 FF FF FF FF 
3237   29DD FF FF FF FF 
3237   29E1 FF FF FF FF 
3237   29E5 FF FF FF FF 
3237   29E9 FF FF FF FF 
3237   29ED FF FF FF FF 
3237   29F1 FF FF FF FF 
3237   29F5 FF FF FF FF 
3237   29F9 FF FF FF FF 
3237   29FD FF FF FF FF 
3237   2A01 FF FF FF FF 
3237   2A05 FF FF FF FF 
3237   2A09 FF FF FF FF 
3237   2A0D FF FF FF FF 
3237   2A11 FF FF FF FF 
3237   2A15 FF FF FF FF 
3237   2A19 FF FF FF FF 
3237   2A1D FF FF FF FF 
3237   2A21 FF FF FF FF 
3237   2A25 FF FF FF FF 
3237   2A29 FF FF FF FF 
3237   2A2D FF FF FF FF 
3237   2A31 FF FF FF FF 
3237   2A35 FF FF FF FF 
3237   2A39 FF FF FF FF 
3237   2A3D FF FF FF FF 
3237   2A41 FF FF FF FF 
3237   2A45 FF FF FF FF 
3237   2A49 FF FF FF FF 
3237   2A4D FF FF FF FF 
3237   2A51 FF FF FF FF 
3237   2A55 FF FF FF FF 
3237   2A59 FF FF FF FF 
3237   2A5D FF FF FF FF 
3237   2A61 FF FF FF FF 
3237   2A65 FF FF FF FF 
3237   2A69 FF FF FF FF 
3237   2A6D FF FF FF FF 
3237   2A71 FF FF FF FF 
3237   2A75 FF FF FF FF 
3237   2A79 FF FF FF FF 
3237   2A7D FF FF FF FF 
3237   2A81 FF FF FF FF 
3237   2A85 FF FF FF FF 
3237   2A89 FF FF FF FF 
3237   2A8D FF FF FF FF 
3237   2A91 FF FF FF FF 
3237   2A95 FF FF FF FF 
3237   2A99 FF FF FF FF 
3237   2A9D FF FF FF FF 
3237   2AA1 FF FF FF FF 
3237   2AA5 FF FF FF FF 
3237   2AA9 FF FF FF FF 
3237   2AAD FF FF FF FF 
3237   2AB1 FF FF FF FF 
3237   2AB5 FF FF FF FF 
3237   2AB9 FF FF FF FF 
3237   2ABD FF FF FF FF 
3237   2AC1 FF FF FF FF 
3237   2AC5 FF FF FF FF 
3237   2AC9 FF FF FF FF 
3237   2ACD FF FF FF FF 
3237   2AD1 FF FF FF FF 
3237   2AD5 FF FF FF FF 
3237   2AD9 FF FF FF FF 
3237   2ADD FF FF FF FF 
3237   2AE1 FF FF FF FF 
3237   2AE5 FF FF FF FF 
3237   2AE9 FF FF FF FF 
3237   2AED FF FF FF FF 
3237   2AF1 FF FF FF FF 
3237   2AF5 FF FF FF FF 
3237   2AF9 FF FF FF FF 
3237   2AFD FF FF FF FF 
3237   2B01 FF FF FF FF 
3237   2B05 FF FF FF FF 
3237   2B09 FF FF FF FF 
3237   2B0D FF FF FF FF 
3237   2B11 FF FF FF FF 
3237   2B15 FF FF FF FF 
3237   2B19 FF FF FF FF 
3237   2B1D FF FF FF FF 
3237   2B21 FF FF FF FF 
3237   2B25 FF FF FF FF 
3237   2B29 FF FF FF FF 
3237   2B2D FF FF FF FF 
3237   2B31 FF FF FF FF 
3237   2B35 FF FF FF FF 
3237   2B39 FF FF FF FF 
3237   2B3D FF FF FF FF 
3237   2B41 FF FF FF FF 
3237   2B45 FF FF FF FF 
3237   2B49 FF FF FF FF 
3237   2B4D FF FF FF FF 
3237   2B51 FF FF FF FF 
3237   2B55 FF FF FF FF 
3237   2B59 FF FF FF FF 
3237   2B5D FF FF FF FF 
3237   2B61 FF FF FF FF 
3237   2B65 FF FF FF FF 
3237   2B69 FF FF FF FF 
3237   2B6D FF FF FF FF 
3237   2B71 FF FF FF FF 
3237   2B75 FF FF FF FF 
3237   2B79 FF FF FF FF 
3237   2B7D FF FF FF FF 
3237   2B81 FF FF FF FF 
3237   2B85 FF FF FF FF 
3237   2B89 FF FF FF FF 
3237   2B8D FF FF FF FF 
3237   2B91 FF FF FF FF 
3237   2B95 FF FF FF FF 
3237   2B99 FF FF FF FF 
3237   2B9D FF FF FF FF 
3237   2BA1 FF FF FF FF 
3237   2BA5 FF FF FF FF 
3237   2BA9 FF FF FF FF 
3237   2BAD FF FF FF FF 
3237   2BB1 FF FF FF FF 
3237   2BB5 FF FF FF FF 
3237   2BB9 FF FF FF FF 
3237   2BBD FF FF FF FF 
3237   2BC1 FF FF FF FF 
3237   2BC5 FF FF FF FF 
3237   2BC9 FF FF FF FF 
3237   2BCD FF FF FF FF 
3237   2BD1 FF FF FF FF 
3237   2BD5 FF FF FF FF 
3237   2BD9 FF FF FF FF 
3237   2BDD FF FF FF FF 
3237   2BE1 FF FF FF FF 
3237   2BE5 FF FF FF FF 
3237   2BE9 FF FF FF FF 
3237   2BED FF FF FF FF 
3237   2BF1 FF FF FF FF 
3237   2BF5 FF FF FF FF 
3237   2BF9 FF FF FF FF 
3237   2BFD FF FF FF FF 
3237   2C01 FF FF FF FF 
3237   2C05 FF FF FF FF 
3237   2C09 FF FF FF FF 
3237   2C0D FF FF FF FF 
3237   2C11 FF FF FF FF 
3237   2C15 FF FF FF FF 
3237   2C19 FF FF FF FF 
3237   2C1D FF FF FF FF 
3237   2C21 FF FF FF FF 
3237   2C25 FF FF FF FF 
3237   2C29 FF FF FF FF 
3237   2C2D FF FF FF FF 
3237   2C31 FF FF FF FF 
3237   2C35 FF FF FF FF 
3237   2C39 FF FF FF FF 
3237   2C3D FF FF FF FF 
3237   2C41 FF FF FF FF 
3237   2C45 FF FF FF FF 
3237   2C49 FF FF FF FF 
3237   2C4D FF FF FF FF 
3237   2C51 FF FF FF FF 
3237   2C55 FF FF FF FF 
3237   2C59 FF FF FF FF 
3237   2C5D FF FF FF FF 
3237   2C61 FF FF FF FF 
3237   2C65 FF FF FF FF 
3237   2C69 FF FF FF FF 
3237   2C6D FF FF FF FF 
3237   2C71 FF FF FF FF 
3237   2C75 FF FF FF FF 
3237   2C79 FF FF FF FF 
3237   2C7D FF FF FF FF 
3237   2C81 FF FF FF FF 
3237   2C85 FF FF FF FF 
3237   2C89 FF FF FF FF 
3237   2C8D FF FF FF FF 
3237   2C91 FF FF FF FF 
3237   2C95 FF FF FF FF 
3237   2C99 FF FF FF FF 
3237   2C9D FF FF FF FF 
3237   2CA1 FF FF FF FF 
3237   2CA5 FF FF FF FF 
3237   2CA9 FF FF FF FF 
3237   2CAD FF FF FF FF 
3237   2CB1 FF FF FF FF 
3237   2CB5 FF FF FF FF 
3237   2CB9 FF FF FF FF 
3237   2CBD FF FF FF FF 
3237   2CC1 FF FF FF FF 
3237   2CC5 FF FF FF FF 
3237   2CC9 FF FF FF FF 
3237   2CCD FF FF FF FF 
3237   2CD1 FF FF FF FF 
3237   2CD5 FF FF FF FF 
3237   2CD9 FF FF FF FF 
3237   2CDD FF FF FF FF 
3237   2CE1 FF FF FF FF 
3237   2CE5 FF FF FF FF 
3237   2CE9 FF FF FF FF 
3237   2CED FF FF FF FF 
3237   2CF1 FF FF FF FF 
3237   2CF5 FF FF FF FF 
3237   2CF9 FF FF FF FF 
3237   2CFD FF FF FF FF 
3237   2D01 FF FF FF FF 
3237   2D05 FF FF FF FF 
3237   2D09 FF FF FF FF 
3237   2D0D FF FF FF FF 
3237   2D11 FF FF FF FF 
3237   2D15 FF FF FF FF 
3237   2D19 FF FF FF FF 
3237   2D1D FF FF FF FF 
3237   2D21 FF FF FF FF 
3237   2D25 FF FF FF FF 
3237   2D29 FF FF FF FF 
3237   2D2D FF FF FF FF 
3237   2D31 FF FF FF FF 
3237   2D35 FF FF FF FF 
3237   2D39 FF FF FF FF 
3237   2D3D FF FF FF FF 
3237   2D41 FF FF FF FF 
3237   2D45 FF FF FF FF 
3237   2D49 FF FF FF FF 
3237   2D4D FF FF FF FF 
3237   2D51 FF FF FF FF 
3237   2D55 FF FF FF FF 
3237   2D59 FF FF FF FF 
3237   2D5D FF FF FF FF 
3237   2D61 FF FF FF FF 
3237   2D65 FF FF FF FF 
3237   2D69 FF FF FF FF 
3237   2D6D FF FF FF FF 
3237   2D71 FF FF FF FF 
3237   2D75 FF FF FF FF 
3237   2D79 FF FF FF FF 
3237   2D7D FF FF FF FF 
3237   2D81 FF FF FF FF 
3237   2D85 FF FF FF FF 
3237   2D89 FF FF FF FF 
3237   2D8D FF FF FF FF 
3237   2D91 FF FF FF FF 
3237   2D95 FF FF FF FF 
3237   2D99 FF FF FF FF 
3237   2D9D FF FF FF FF 
3237   2DA1 FF FF FF FF 
3237   2DA5 FF FF FF FF 
3237   2DA9 FF FF FF FF 
3237   2DAD FF FF FF FF 
3237   2DB1 FF FF FF FF 
3237   2DB5 FF FF FF FF 
3237   2DB9 FF FF FF FF 
3237   2DBD FF FF FF FF 
3237   2DC1 FF FF FF FF 
3237   2DC5 FF FF FF FF 
3237   2DC9 FF FF FF FF 
3237   2DCD FF FF FF FF 
3237   2DD1 FF FF FF FF 
3237   2DD5 FF FF FF FF 
3237   2DD9 FF FF FF FF 
3237   2DDD FF FF FF FF 
3237   2DE1 FF FF FF FF 
3237   2DE5 FF FF FF FF 
3237   2DE9 FF FF FF FF 
3237   2DED FF FF FF FF 
3237   2DF1 FF FF FF FF 
3237   2DF5 FF FF FF FF 
3237   2DF9 FF FF FF FF 
3237   2DFD FF FF FF FF 
3237   2E01 FF FF FF FF 
3237   2E05 FF FF FF FF 
3237   2E09 FF FF FF FF 
3237   2E0D FF FF FF FF 
3237   2E11 FF FF FF FF 
3237   2E15 FF FF FF FF 
3237   2E19 FF FF FF FF 
3237   2E1D FF FF FF FF 
3237   2E21 FF FF FF FF 
3237   2E25 FF FF FF FF 
3237   2E29 FF FF FF FF 
3237   2E2D FF FF FF FF 
3237   2E31 FF FF FF FF 
3237   2E35 FF FF FF FF 
3237   2E39 FF FF FF FF 
3237   2E3D FF FF FF FF 
3237   2E41 FF FF FF FF 
3237   2E45 FF FF FF FF 
3237   2E49 FF FF FF FF 
3237   2E4D FF FF FF FF 
3237   2E51 FF FF FF FF 
3237   2E55 FF FF FF FF 
3237   2E59 FF FF FF FF 
3237   2E5D FF FF FF FF 
3237   2E61 FF FF FF FF 
3237   2E65 FF FF FF FF 
3237   2E69 FF FF FF FF 
3237   2E6D FF FF FF FF 
3237   2E71 FF FF FF FF 
3237   2E75 FF FF FF FF 
3237   2E79 FF FF FF FF 
3237   2E7D FF FF FF FF 
3237   2E81 FF FF FF FF 
3237   2E85 FF FF FF FF 
3237   2E89 FF FF FF FF 
3237   2E8D FF FF FF FF 
3237   2E91 FF FF FF FF 
3237   2E95 FF FF FF FF 
3237   2E99 FF FF FF FF 
3237   2E9D FF FF FF FF 
3237   2EA1 FF FF FF FF 
3237   2EA5 FF FF FF FF 
3237   2EA9 FF FF FF FF 
3237   2EAD FF FF FF FF 
3237   2EB1 FF FF FF FF 
3237   2EB5 FF FF FF FF 
3237   2EB9 FF FF FF FF 
3237   2EBD FF FF FF FF 
3237   2EC1 FF FF FF FF 
3237   2EC5 FF FF FF FF 
3237   2EC9 FF FF FF FF 
3237   2ECD FF FF FF FF 
3237   2ED1 FF FF FF FF 
3237   2ED5 FF FF FF FF 
3237   2ED9 FF FF FF FF 
3237   2EDD FF FF FF FF 
3237   2EE1 FF FF FF FF 
3237   2EE5 FF FF FF FF 
3237   2EE9 FF FF FF FF 
3237   2EED FF FF FF FF 
3237   2EF1 FF FF FF FF 
3237   2EF5 FF FF FF FF 
3237   2EF9 FF FF FF FF 
3237   2EFD FF FF FF FF 
3237   2F01 FF FF FF FF 
3237   2F05 FF FF FF FF 
3237   2F09 FF FF FF FF 
3237   2F0D FF FF FF FF 
3237   2F11 FF FF FF FF 
3237   2F15 FF FF FF FF 
3237   2F19 FF FF FF FF 
3237   2F1D FF FF FF FF 
3237   2F21 FF FF FF FF 
3237   2F25 FF FF FF FF 
3237   2F29 FF FF FF FF 
3237   2F2D FF FF FF FF 
3237   2F31 FF FF FF FF 
3237   2F35 FF FF FF FF 
3237   2F39 FF FF FF FF 
3237   2F3D FF FF FF FF 
3237   2F41 FF FF FF FF 
3237   2F45 FF FF FF FF 
3237   2F49 FF FF FF FF 
3237   2F4D FF FF FF FF 
3237   2F51 FF FF FF FF 
3237   2F55 FF FF FF FF 
3237   2F59 FF FF FF FF 
3237   2F5D FF FF FF FF 
3237   2F61 FF FF FF FF 
3237   2F65 FF FF FF FF 
3237   2F69 FF FF FF FF 
3237   2F6D FF FF FF FF 
3237   2F71 FF FF FF FF 
3237   2F75 FF FF FF FF 
3237   2F79 FF FF FF FF 
3237   2F7D FF FF FF FF 
3237   2F81 FF FF FF FF 
3237   2F85 FF FF FF FF 
3237   2F89 FF FF FF FF 
3237   2F8D FF FF FF FF 
3237   2F91 FF FF FF FF 
3237   2F95 FF FF FF FF 
3237   2F99 FF FF FF FF 
3237   2F9D FF FF FF FF 
3237   2FA1 FF FF FF FF 
3237   2FA5 FF FF FF FF 
3237   2FA9 FF FF FF FF 
3237   2FAD FF FF FF FF 
3237   2FB1 FF FF FF FF 
3237   2FB5 FF FF FF FF 
3237   2FB9 FF FF FF FF 
3237   2FBD FF FF FF FF 
3237   2FC1 FF FF FF FF 
3237   2FC5 FF FF FF FF 
3237   2FC9 FF FF FF FF 
3237   2FCD FF FF FF FF 
3237   2FD1 FF FF FF FF 
3237   2FD5 FF FF FF FF 
3237   2FD9 FF FF FF FF 
3237   2FDD FF FF FF FF 
3237   2FE1 FF FF FF FF 
3237   2FE5 FF FF FF FF 
3237   2FE9 FF FF FF FF 
3237   2FED FF FF FF FF 
3237   2FF1 FF FF FF FF 
3237   2FF5 FF FF FF FF 
3237   2FF9 FF FF FF FF 
3237   2FFD FF FF FF FF 
3237   3001 FF FF FF FF 
3237   3005 FF FF FF FF 
3237   3009 FF FF FF FF 
3237   300D FF FF FF FF 
3237   3011 FF FF FF FF 
3237   3015 FF FF FF FF 
3237   3019 FF FF FF FF 
3237   301D FF FF FF FF 
3237   3021 FF FF FF FF 
3237   3025 FF FF FF FF 
3237   3029 FF FF FF FF 
3237   302D FF FF FF FF 
3237   3031 FF FF FF FF 
3237   3035 FF FF FF FF 
3237   3039 FF FF FF FF 
3237   303D FF FF FF FF 
3237   3041 FF FF FF FF 
3237   3045 FF FF FF FF 
3237   3049 FF FF FF FF 
3237   304D FF FF FF FF 
3237   3051 FF FF FF FF 
3237   3055 FF FF FF FF 
3237   3059 FF FF FF FF 
3237   305D FF FF FF FF 
3237   3061 FF FF FF FF 
3237   3065 FF FF FF FF 
3237   3069 FF FF FF FF 
3237   306D FF FF FF FF 
3237   3071 FF FF FF FF 
3237   3075 FF FF FF FF 
3237   3079 FF FF FF FF 
3237   307D FF FF FF FF 
3237   3081 FF FF FF FF 
3237   3085 FF FF FF FF 
3237   3089 FF FF FF FF 
3237   308D FF FF FF FF 
3237   3091 FF FF FF FF 
3237   3095 FF FF FF FF 
3237   3099 FF FF FF FF 
3237   309D FF FF FF FF 
3237   30A1 FF FF FF FF 
3237   30A5 FF FF FF FF 
3237   30A9 FF FF FF FF 
3237   30AD FF FF FF FF 
3237   30B1 FF FF FF FF 
3237   30B5 FF FF FF FF 
3237   30B9 FF FF FF FF 
3237   30BD FF FF FF FF 
3237   30C1 FF FF FF FF 
3237   30C5 FF FF FF FF 
3237   30C9 FF FF FF FF 
3237   30CD FF FF FF FF 
3237   30D1 FF FF FF FF 
3237   30D5 FF FF FF FF 
3237   30D9 FF FF FF FF 
3237   30DD FF FF FF FF 
3237   30E1 FF FF FF FF 
3237   30E5 FF FF FF FF 
3237   30E9 FF FF FF FF 
3237   30ED FF FF FF FF 
3237   30F1 FF FF FF FF 
3237   30F5 FF FF FF FF 
3237   30F9 FF FF FF FF 
3237   30FD FF FF FF FF 
3237   3101 FF FF FF FF 
3237   3105 FF FF FF FF 
3237   3109 FF FF FF FF 
3237   310D FF FF FF FF 
3237   3111 FF FF FF FF 
3237   3115 FF FF FF FF 
3237   3119 FF FF FF FF 
3237   311D FF FF FF FF 
3237   3121 FF FF FF FF 
3237   3125 FF FF FF FF 
3237   3129 FF FF FF FF 
3237   312D FF FF FF FF 
3237   3131 FF FF FF FF 
3237   3135 FF FF FF FF 
3237   3139 FF FF FF FF 
3237   313D FF FF FF FF 
3237   3141 FF FF FF FF 
3237   3145 FF FF FF FF 
3237   3149 FF FF FF FF 
3237   314D FF FF FF FF 
3237   3151 FF FF FF FF 
3237   3155 FF FF FF FF 
3237   3159 FF FF FF FF 
3237   315D FF FF FF FF 
3238   3161             
3239   3161             scrap_sector:
3240   3161 FF FF FF FF   .fill 512         ; scrap sector
3240   3165 FF FF FF FF 
3240   3169 FF FF FF FF 
3240   316D FF FF FF FF 
3240   3171 FF FF FF FF 
3240   3175 FF FF FF FF 
3240   3179 FF FF FF FF 
3240   317D FF FF FF FF 
3240   3181 FF FF FF FF 
3240   3185 FF FF FF FF 
3240   3189 FF FF FF FF 
3240   318D FF FF FF FF 
3240   3191 FF FF FF FF 
3240   3195 FF FF FF FF 
3240   3199 FF FF FF FF 
3240   319D FF FF FF FF 
3240   31A1 FF FF FF FF 
3240   31A5 FF FF FF FF 
3240   31A9 FF FF FF FF 
3240   31AD FF FF FF FF 
3240   31B1 FF FF FF FF 
3240   31B5 FF FF FF FF 
3240   31B9 FF FF FF FF 
3240   31BD FF FF FF FF 
3240   31C1 FF FF FF FF 
3240   31C5 FF FF FF FF 
3240   31C9 FF FF FF FF 
3240   31CD FF FF FF FF 
3240   31D1 FF FF FF FF 
3240   31D5 FF FF FF FF 
3240   31D9 FF FF FF FF 
3240   31DD FF FF FF FF 
3240   31E1 FF FF FF FF 
3240   31E5 FF FF FF FF 
3240   31E9 FF FF FF FF 
3240   31ED FF FF FF FF 
3240   31F1 FF FF FF FF 
3240   31F5 FF FF FF FF 
3240   31F9 FF FF FF FF 
3240   31FD FF FF FF FF 
3240   3201 FF FF FF FF 
3240   3205 FF FF FF FF 
3240   3209 FF FF FF FF 
3240   320D FF FF FF FF 
3240   3211 FF FF FF FF 
3240   3215 FF FF FF FF 
3240   3219 FF FF FF FF 
3240   321D FF FF FF FF 
3240   3221 FF FF FF FF 
3240   3225 FF FF FF FF 
3240   3229 FF FF FF FF 
3240   322D FF FF FF FF 
3240   3231 FF FF FF FF 
3240   3235 FF FF FF FF 
3240   3239 FF FF FF FF 
3240   323D FF FF FF FF 
3240   3241 FF FF FF FF 
3240   3245 FF FF FF FF 
3240   3249 FF FF FF FF 
3240   324D FF FF FF FF 
3240   3251 FF FF FF FF 
3240   3255 FF FF FF FF 
3240   3259 FF FF FF FF 
3240   325D FF FF FF FF 
3240   3261 FF FF FF FF 
3240   3265 FF FF FF FF 
3240   3269 FF FF FF FF 
3240   326D FF FF FF FF 
3240   3271 FF FF FF FF 
3240   3275 FF FF FF FF 
3240   3279 FF FF FF FF 
3240   327D FF FF FF FF 
3240   3281 FF FF FF FF 
3240   3285 FF FF FF FF 
3240   3289 FF FF FF FF 
3240   328D FF FF FF FF 
3240   3291 FF FF FF FF 
3240   3295 FF FF FF FF 
3240   3299 FF FF FF FF 
3240   329D FF FF FF FF 
3240   32A1 FF FF FF FF 
3240   32A5 FF FF FF FF 
3240   32A9 FF FF FF FF 
3240   32AD FF FF FF FF 
3240   32B1 FF FF FF FF 
3240   32B5 FF FF FF FF 
3240   32B9 FF FF FF FF 
3240   32BD FF FF FF FF 
3240   32C1 FF FF FF FF 
3240   32C5 FF FF FF FF 
3240   32C9 FF FF FF FF 
3240   32CD FF FF FF FF 
3240   32D1 FF FF FF FF 
3240   32D5 FF FF FF FF 
3240   32D9 FF FF FF FF 
3240   32DD FF FF FF FF 
3240   32E1 FF FF FF FF 
3240   32E5 FF FF FF FF 
3240   32E9 FF FF FF FF 
3240   32ED FF FF FF FF 
3240   32F1 FF FF FF FF 
3240   32F5 FF FF FF FF 
3240   32F9 FF FF FF FF 
3240   32FD FF FF FF FF 
3240   3301 FF FF FF FF 
3240   3305 FF FF FF FF 
3240   3309 FF FF FF FF 
3240   330D FF FF FF FF 
3240   3311 FF FF FF FF 
3240   3315 FF FF FF FF 
3240   3319 FF FF FF FF 
3240   331D FF FF FF FF 
3240   3321 FF FF FF FF 
3240   3325 FF FF FF FF 
3240   3329 FF FF FF FF 
3240   332D FF FF FF FF 
3240   3331 FF FF FF FF 
3240   3335 FF FF FF FF 
3240   3339 FF FF FF FF 
3240   333D FF FF FF FF 
3240   3341 FF FF FF FF 
3240   3345 FF FF FF FF 
3240   3349 FF FF FF FF 
3240   334D FF FF FF FF 
3240   3351 FF FF FF FF 
3240   3355 FF FF FF FF 
3240   3359 FF FF FF FF 
3240   335D FF FF FF FF 
3241   3361             transient_area:
3242   3361 00            .db 0             ; beginning of the transient memory area. used for disk reads and other purposes    
3243   3362             
3244   3362             .end
tasm: Number of errors = 2
