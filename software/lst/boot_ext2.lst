0001   0000             .include bios.exp
0001+  0000             boot_origin      .EQU  $8004
0002+  0000             bios_uart        .EQU  $0002
0003+  0000             bios_ide         .EQU  $0003
0004+  0000             bios_reset_vector .EQU  $0190
0005+  0000             ide_buffer       .EQU  $8404
0006+  0000             noname.__puts    .EQU  $0252
0007+  0000             noname.__print_u16d .EQU  $0379
0008+  0000             xput_u8          .EQU  $023e
0002   0000             
0003   8004             .org boot_origin
0004   8004             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0005   8004             ; system constants / equations
0006   8004             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0007   8004             _uart0_data      .equ $ff80            ; data
0008   8004             _uart0_dlab_0    .equ $ff80            ; divisor latch low byte
0009   8004             _uart0_dlab_1    .equ $ff81            ; divisor latch high byte
0010   8004             _uart0_ier       .equ $ff81            ; interrupt enable register
0011   8004             _uart0_fcr       .equ $ff82            ; fifo control register
0012   8004             _uart0_lcr       .equ $ff83            ; line control register
0013   8004             _uart0_lsr       .equ $ff85            ; line status register
0014   8004             
0015   8004             _ide_base        .equ $ffd0            ; ide base
0016   8004             _ide_r0          .equ _ide_base + 0    ; data port
0017   8004             _ide_r1          .equ _ide_base + 1    ; read: error code, write: feature
0018   8004             _ide_r2          .equ _ide_base + 2    ; number of sectors to transfer
0019   8004             _ide_r3          .equ _ide_base + 3    ; sector address lba 0 [0:7]
0020   8004             _ide_r4          .equ _ide_base + 4    ; sector address lba 1 [8:15]
0021   8004             _ide_r5          .equ _ide_base + 5    ; sector address lba 2 [16:23]
0022   8004             _ide_r6          .equ _ide_base + 6    ; sector address lba 3 [24:27 (lsb)]
0023   8004             _ide_r7          .equ _ide_base + 7    ; read: status, write: command
0024   8004             
0025   8004             ;  SUPERBLOCK:
0026   8004             ;  | Field               | Description                               | Typical Size (bytes) | Notes                           |
0027   8004             ;  | ------------------- | ----------------------------------------- | -------------------- | ------------------------------- |
0028   8004             ;  | inodes_count        | Total number of inodes in the filesystem  | 2                    | 16-bit unsigned int             |
0029   8004             ;  | blocks_count        | Total number of data blocks               | 2                    | 16-bit unsigned int             |
0030   8004             ;  | free_inodes_count   | Number of free inodes                     | 2                    | 16-bit unsigned int             |
0031   8004             ;  | free_blocks_count   | Number of free blocks                     | 2                    | 16-bit unsigned int             |
0032   8004             ;  | block_bitmap        | Block ID of the **block bitmap**          | 2                    | 16-bit unsigned int
0033   8004             ;  | inode_bitmap        | Block ID of the **inode bitmap**          | 2                    | 16-bit unsigned int
0034   8004             ;  | inode_table         | Block ID of **inode table**               | 2                    | 16-bit unsigned int
0035   8004             ;  | first_data_block    | Block ID of the data blocks area          | 2                    | 16-bit unsigned int             |
0036   8004             ;  | used_dirs_count     | Number of inodes allocated to directories | 2
0037   8004             ;  | log_block_size      | Block size = 1024 << `s_log_block_size    | 2                    | 16-bit unsigned int             |
0038   8004             ;  | mtime               | Last mount time                           | 4                    | 32-bit unsigned int (Unix time) |
0039   8004             ;  | wtime               | Last write time                           | 4                    | 32-bit unsigned int (Unix time) |
0040   8004             ;  | uuid                | Unique ID of the filesystem               | 16     (28 to 43)    | 128-bit UUID                    |
0041   8004             ;  | volume_name         | Label of the filesystem                   | 16     (44 to 59)    | Usually ASCII, padded           |
0042   8004             ;  | feature_flags       | Compatibility flags                       | 4                    | 32-bit unsigned int             |
0043   8004             boot_start:
0044   8004 3B 86 81      mov d, s_read_super
0045   8007 07 52 02      call __puts
0046   800A             
0047   800A             ; read Superblock
0048   800A 26 02 00      mov b, 2
0049   800D 38 00 00      mov c, 0                    ; LBA = 2 = byte 1024
0050   8010 3B 04 84      mov d, ide_buffer           ; we read into the bios ide buffer
0051   8013 10 02 02      mov a, $0202                ; disk read, 2 sectors. Superblock
0052   8016 05 03         syscall bios_ide            ; read sector
0053   8018             
0054   8018             ; print Superblock information
0055   8018 3B 9B 81      mov d, s_total_inodes
0056   801B 07 52 02      call __puts
0057   801E 3B 04 84      mov d, ide_buffer
0058   8021 15            mov a, [d]
0059   8022 07 79 03      call __print_u16d
0060   8025             
0061   8025 3B AB 81      mov d, s_total_blocks
0062   8028 07 52 02      call __puts
0063   802B 3B 06 84      mov d, ide_buffer + 2
0064   802E 15            mov a, [d]
0065   802F 07 79 03      call __print_u16d
0066   8032             
0067   8032 3B BB 81      mov d, s_free_inodes
0068   8035 07 52 02      call __puts
0069   8038 3B 08 84      mov d, ide_buffer + 4
0070   803B 15            mov a, [d]
0071   803C 07 79 03      call __print_u16d
0072   803F             
0073   803F 3B CA 81      mov d, s_free_blocks
0074   8042 07 52 02      call __puts
0075   8045 3B 0A 84      mov d, ide_buffer + 6
0076   8048 15            mov a, [d]
0077   8049 07 79 03      call __print_u16d
0078   804C             
0079   804C 3B D9 81      mov d, s_block_bitmap
0080   804F 07 52 02      call __puts
0081   8052 3B 0C 84      mov d, ide_buffer + 8
0082   8055 15            mov a, [d]
0083   8056 07 79 03      call __print_u16d
0084   8059             
0085   8059 3B E9 81      mov d, s_inode_bitmap
0086   805C 07 52 02      call __puts
0087   805F 3B 0E 84      mov d, ide_buffer + 10
0088   8062 15            mov a, [d]
0089   8063 07 79 03      call __print_u16d
0090   8066             
0091   8066 3B F9 81      mov d, s_inode_table
0092   8069 07 52 02      call __puts
0093   806C 3B 10 84      mov d, ide_buffer + 12
0094   806F 15            mov a, [d]
0095   8070 07 79 03      call __print_u16d
0096   8073             
0097   8073 3B 08 82      mov d, s_first_data_block
0098   8076 07 52 02      call __puts
0099   8079 3B 12 84      mov d, ide_buffer + 14
0100   807C 15            mov a, [d]
0101   807D 07 79 03      call __print_u16d
0102   8080             
0103   8080 3B 1C 82      mov d, s_used_dirs
0104   8083 07 52 02      call __puts
0105   8086 3B 14 84      mov d, ide_buffer + 16
0106   8089 15            mov a, [d]
0107   808A 07 79 03      call __print_u16d
0108   808D             
0109   808D 3B 3A 82      mov d, s_uuid
0110   8090 07 52 02      call __puts
0111   8093 3B 2F 84      mov d, ide_buffer + 43
0112   8096             uuid_loop:
0113   8096 32            mov bl, [d]
0114   8097 07 3E 02      call xput_u8
0115   809A 7F            dec d
0116   809B C5 1F 84      cmp d, ide_buffer + 27
0117   809E C7 96 80      jne uuid_loop
0118   80A1             
0119   80A1 3B 42 82      mov d, s_vol_name
0120   80A4 07 52 02      call __puts
0121   80A7 3B 30 84      mov d, ide_buffer + 44
0122   80AA 07 52 02      call __puts
0123   80AD             
0124   80AD             loop1:
0125   80AD 0A AD 80      jmp loop1
0126   80B0             
0127   80B0             ; interrupt masks  
0128   80B0 19 FF         mov al, $ff
0129   80B2 FD 0F         stomsk                      ; store masks
0130   80B4 3B 0C 81      mov d, s_masks
0131   80B7 07 52 02      call __puts
0132   80BA               
0133   80BA 3B 4D 81      mov d, s_bios2
0134   80BD 07 52 02      call __puts
0135   80C0             
0136   80C0             ; now we start the kernel.
0137   80C0 FD 12         mov a, g                    ; retrieve kernel reset vector
0138   80C2             
0139   80C2 FD D7 FF FF   push word $ffff             ; stack. dummy value since the real value is set in the kernel code
0140   80C6 FD DB 08      push byte %00001000         ; mode =supervisor, paging=on
0141   80C9 D7            push a                      ; pc
0142   80CA 06            sysret
0143   80CB             
0144   80CB 65 78 65 63 s_boot1:         .db "executing bootloader\n", 0
0144   80CF 75 74 69 6E 
0144   80D3 67 20 62 6F 
0144   80D7 6F 74 6C 6F 
0144   80DB 61 64 65 72 
0144   80DF 0A 00 
0145   80E1 6D 61 70 70 s_kernel_setup:  .db "mapping kernel page-table to physical RAM\n", 0
0145   80E5 69 6E 67 20 
0145   80E9 6B 65 72 6E 
0145   80ED 65 6C 20 70 
0145   80F1 61 67 65 2D 
0145   80F5 74 61 62 6C 
0145   80F9 65 20 74 6F 
0145   80FD 20 70 68 79 
0145   8101 73 69 63 61 
0145   8105 6C 20 52 41 
0145   8109 4D 0A 00 
0146   810C 0A 0D 69 6E s_masks:         .db "\n\rinterrupt masks register set to 0xFF\n", 0
0146   8110 74 65 72 72 
0146   8114 75 70 74 20 
0146   8118 6D 61 73 6B 
0146   811C 73 20 72 65 
0146   8120 67 69 73 74 
0146   8124 65 72 20 73 
0146   8128 65 74 20 74 
0146   812C 6F 20 30 78 
0146   8130 46 46 0A 00 
0147   8134 6C 6F 61 64 s_boot:          .db "loading kernel from disk", 0
0147   8138 69 6E 67 20 
0147   813C 6B 65 72 6E 
0147   8140 65 6C 20 66 
0147   8144 72 6F 6D 20 
0147   8148 64 69 73 6B 
0147   814C 00 
0148   814D 65 6E 74 65 s_bios2:         .db "entering protected-mode\n"
0148   8151 72 69 6E 67 
0148   8155 20 70 72 6F 
0148   8159 74 65 63 74 
0148   815D 65 64 2D 6D 
0148   8161 6F 64 65 0A 
0149   8165 73 74 61 72                  .db "starting kernel\n", 0
0149   8169 74 69 6E 67 
0149   816D 20 6B 65 72 
0149   8171 6E 65 6C 0A 
0149   8175 00 
0150   8176             
0151   8176 30 31 32 33 s_hex_digits:   .db "0123456789ABCDEF"
0151   817A 34 35 36 37 
0151   817E 38 39 41 42 
0151   8182 43 44 45 46 
0152   8186             
0153   8186 0A 72 65 61 s_read_super:       .db "\nreading superblock\n", 0
0153   818A 64 69 6E 67 
0153   818E 20 73 75 70 
0153   8192 65 72 62 6C 
0153   8196 6F 63 6B 0A 
0153   819A 00 
0154   819B 0A 74 6F 74 s_total_inodes:     .db "\ntotal inodes: ", 0
0154   819F 61 6C 20 69 
0154   81A3 6E 6F 64 65 
0154   81A7 73 3A 20 00 
0155   81AB 0A 74 6F 74 s_total_blocks:     .db "\ntotal blocks: ", 0
0155   81AF 61 6C 20 62 
0155   81B3 6C 6F 63 6B 
0155   81B7 73 3A 20 00 
0156   81BB 0A 66 72 65 s_free_inodes:      .db "\nfree inodes: ", 0
0156   81BF 65 20 69 6E 
0156   81C3 6F 64 65 73 
0156   81C7 3A 20 00 
0157   81CA 0A 66 72 65 s_free_blocks:      .db "\nfree blocks: ", 0
0157   81CE 65 20 62 6C 
0157   81D2 6F 63 6B 73 
0157   81D6 3A 20 00 
0158   81D9 0A 62 6C 6F s_block_bitmap:     .db "\nblock bitmap: ", 0
0158   81DD 63 6B 20 62 
0158   81E1 69 74 6D 61 
0158   81E5 70 3A 20 00 
0159   81E9 0A 69 6E 6F s_inode_bitmap:     .db "\ninode bitmap: ", 0
0159   81ED 64 65 20 62 
0159   81F1 69 74 6D 61 
0159   81F5 70 3A 20 00 
0160   81F9 0A 69 6E 6F s_inode_table:      .db "\ninode table: ", 0
0160   81FD 64 65 20 74 
0160   8201 61 62 6C 65 
0160   8205 3A 20 00 
0161   8208 0A 66 69 72 s_first_data_block: .db "\nfirst data block: ", 0
0161   820C 73 74 20 64 
0161   8210 61 74 61 20 
0161   8214 62 6C 6F 63 
0161   8218 6B 3A 20 00 
0162   821C 0A 6E 75 6D s_used_dirs:        .db "\nnumber of used directories: ", 0
0162   8220 62 65 72 20 
0162   8224 6F 66 20 75 
0162   8228 73 65 64 20 
0162   822C 64 69 72 65 
0162   8230 63 74 6F 72 
0162   8234 69 65 73 3A 
0162   8238 20 00 
0163   823A 0A 75 75 69 s_uuid:             .db "\nuuid: ", 0
0163   823E 64 3A 20 00 
0164   8242 0A 76 6F 6C s_vol_name:         .db "\nvolume name: ", 0
0164   8246 75 6D 65 20 
0164   824A 6E 61 6D 65 
0164   824E 3A 20 00 
0165   8251             
0166   8251             .end
tasm: Number of errors = 0
