0001   0000             .include bios.exp
0001+  0000             boot_origin      .EQU  $8004
0002+  0000             bios_uart        .EQU  $0002
0003+  0000             bios_ide         .EQU  $0003
0004+  0000             bios_reset_vector .EQU  $0190
0005+  0000             ide_buffer       .EQU  $8404
0006+  0000             noname._puts     .EQU  $0252
0007+  0000             print_u16d       .EQU  $0379
0008+  0000             printnl          .EQU  $03bd
0002   0000             
0003   8004             .org boot_origin
0004   8004             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0005   8004             ; system constants / equations
0006   8004             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
0007   8004             _uart0_data      .equ $ff80            ; data
0008   8004             _uart0_dlab_0    .equ $ff80            ; divisor latch low byte
0009   8004             _uart0_dlab_1    .equ $ff81            ; divisor latch high byte
0010   8004             _uart0_ier       .equ $ff81            ; interrupt enable register
0011   8004             _uart0_fcr       .equ $ff82            ; fifo control register
0012   8004             _uart0_lcr       .equ $ff83            ; line control register
0013   8004             _uart0_lsr       .equ $ff85            ; line status register
0014   8004             
0015   8004             _ide_base        .equ $ffd0            ; ide base
0016   8004             _ide_r0          .equ _ide_base + 0    ; data port
0017   8004             _ide_r1          .equ _ide_base + 1    ; read: error code, write: feature
0018   8004             _ide_r2          .equ _ide_base + 2    ; number of sectors to transfer
0019   8004             _ide_r3          .equ _ide_base + 3    ; sector address lba 0 [0:7]
0020   8004             _ide_r4          .equ _ide_base + 4    ; sector address lba 1 [8:15]
0021   8004             _ide_r5          .equ _ide_base + 5    ; sector address lba 2 [16:23]
0022   8004             _ide_r6          .equ _ide_base + 6    ; sector address lba 3 [24:27 (lsb)]
0023   8004             _ide_r7          .equ _ide_base + 7    ; read: status, write: command
0024   8004             
0025   8004             boot_start:
0026   8004 3B 80 81      mov d, s_read_super
0027   8007 07 52 02      call _puts
0028   800A             
0029   800A             ; read Superblock
0030   800A 26 02 00      mov b, 2
0031   800D 38 00 00      mov c, 0                    ; LBA = 2 = byte 1024
0032   8010 3B 04 84      mov d, ide_buffer           ; we read into the bios ide buffer
0033   8013 10 02 02      mov a, $0202                ; disk read, 2 sectors. Superblock
0034   8016 05 03         syscall bios_ide            ; read sector
0035   8018             
0036   8018             ;  SUPERBLOCK:
0037   8018             ;  | Field               | Description                               | Typical Size (bytes) | Notes                           |
0038   8018             ;  | ------------------- | ----------------------------------------- | -------------------- | ------------------------------- |
0039   8018             ;  | inodes_count        | Total number of inodes in the filesystem  | 2                    | 16-bit unsigned int             |
0040   8018             ;  | blocks_count        | Total number of data blocks               | 2                    | 16-bit unsigned int             |
0041   8018             ;  | free_inodes_count   | Number of free inodes                     | 2                    | 16-bit unsigned int             |
0042   8018             ;  | free_blocks_count   | Number of free blocks                     | 2                    | 16-bit unsigned int             |
0043   8018             ;  | block_bitmap        | Block ID of the **block bitmap**          | 2                    | 16-bit unsigned int
0044   8018             ;  | inode_bitmap        | Block ID of the **inode bitmap**          | 2                    | 16-bit unsigned int
0045   8018             ;  | inode_table         | Block ID of **inode table**               | 2                    | 16-bit unsigned int
0046   8018             ;  | first_data_block    | Block ID of the data blocks area          | 2                    | 16-bit unsigned int             |
0047   8018             ;  | used_dirs_count     | Number of inodes allocated to directories | 2
0048   8018             ;  | log_block_size      | Block size = 1024 << `s_log_block_size    | 2                    | 16-bit unsigned int             |
0049   8018             ;  | mtime               | Last mount time                           | 4                    | 32-bit unsigned int (Unix time) |
0050   8018             ;  | wtime               | Last write time                           | 4                    | 32-bit unsigned int (Unix time) |
0051   8018             ;  | uuid                | Unique ID of the filesystem               | 16                   | 128-bit UUID                    |
0052   8018             ;  | volume_name         | Label of the filesystem                   | 16                   | Usually ASCII, padded           |
0053   8018             ;  | feature_flags       | Compatibility flags                       | 4                    | 32-bit unsigned int             |
0054   8018             ; print Superblock information
0055   8018 3B 98 81      mov d, s_total_inodes
0056   801B 07 52 02      call _puts
0057   801E 3B 04 84      mov d, ide_buffer
0058   8021 15            mov a, [d]
0059   8022 07 79 03      call print_u16d
0060   8025 07 BD 03      call printnl
0061   8028             
0062   8028 3B A8 81      mov d, s_total_blocks
0063   802B 07 52 02      call _puts
0064   802E 3B 06 84      mov d, ide_buffer + 2
0065   8031 15            mov a, [d]
0066   8032 07 79 03      call print_u16d
0067   8035 07 BD 03      call printnl
0068   8038             
0069   8038 3B B8 81      mov d, s_free_inodes
0070   803B 07 52 02      call _puts
0071   803E 3B 08 84      mov d, ide_buffer + 4
0072   8041 15            mov a, [d]
0073   8042 07 79 03      call print_u16d
0074   8045 07 BD 03      call printnl
0075   8048             
0076   8048 3B C7 81      mov d, s_free_blocks
0077   804B 07 52 02      call _puts
0078   804E 3B 0A 84      mov d, ide_buffer + 6
0079   8051 15            mov a, [d]
0080   8052 07 79 03      call print_u16d
0081   8055 07 BD 03      call printnl
0082   8058             
0083   8058 3B D6 81      mov d, s_block_bitmap
0084   805B 07 52 02      call _puts
0085   805E 3B 0C 84      mov d, ide_buffer + 8
0086   8061 15            mov a, [d]
0087   8062 07 79 03      call print_u16d
0088   8065 07 BD 03      call printnl
0089   8068             
0090   8068 3B E6 81      mov d, s_inode_bitmap
0091   806B 07 52 02      call _puts
0092   806E 3B 0E 84      mov d, ide_buffer + 10
0093   8071 15            mov a, [d]
0094   8072 07 79 03      call print_u16d
0095   8075 07 BD 03      call printnl
0096   8078             
0097   8078 3B F6 81      mov d, s_inode_table
0098   807B 07 52 02      call _puts
0099   807E 3B 10 84      mov d, ide_buffer + 12
0100   8081 15            mov a, [d]
0101   8082 07 79 03      call print_u16d
0102   8085 07 BD 03      call printnl
0103   8088             
0104   8088             ;  mov d, s_first_data_block
0105   8088             ;  call _puts
0106   8088             ;  mov d, ide_buffer + 14
0107   8088             ;  mov a, [d]
0108   8088             ;  call print_u16d
0109   8088             ;  call printnl
0110   8088             
0111   8088 3B 05 82      mov d, s_used_dirs
0112   808B 07 52 02      call _puts
0113   808E 3B 14 84      mov d, ide_buffer + 16
0114   8091 15            mov a, [d]
0115   8092 07 79 03      call print_u16d
0116   8095 07 BD 03      call printnl
0117   8098             
0118   8098             ;  mov d, s_uuid
0119   8098             ;  call _puts
0120   8098             ;  mov d, ide_buffer + 28
0121   8098             ;  mov bl, [d]
0122   8098             ;  call xput_u8
0123   8098             
0124   8098 3B 3E 82      mov d, s_vol_name
0125   809B 07 52 02      call _puts
0126   809E 3B 30 84      mov d, ide_buffer + 44
0127   80A1 07 52 02      call _puts
0128   80A4 07 BD 03      call printnl
0129   80A7             
0130   80A7             
0131   80A7             loop1:
0132   80A7 0A A7 80      jmp loop1
0133   80AA             
0134   80AA             ; interrupt masks  
0135   80AA 19 FF         mov al, $ff
0136   80AC FD 0F         stomsk                      ; store masks
0137   80AE 3B 06 81      mov d, s_masks
0138   80B1 07 52 02      call _puts
0139   80B4               
0140   80B4 3B 47 81      mov d, s_bios2
0141   80B7 07 52 02      call _puts
0142   80BA             
0143   80BA             ; now we start the kernel.
0144   80BA FD 12         mov a, g                    ; retrieve kernel reset vector
0145   80BC             
0146   80BC FD D7 FF FF   push word $ffff             ; stack. dummy value since the real value is set in the kernel code
0147   80C0 FD DB 08      push byte %00001000         ; mode =supervisor, paging=on
0148   80C3 D7            push a                      ; pc
0149   80C4 06            sysret
0150   80C5             
0151   80C5 65 78 65 63 s_boot1:         .db "executing bootloader\n", 0
0151   80C9 75 74 69 6E 
0151   80CD 67 20 62 6F 
0151   80D1 6F 74 6C 6F 
0151   80D5 61 64 65 72 
0151   80D9 0A 00 
0152   80DB 6D 61 70 70 s_kernel_setup:  .db "mapping kernel page-table to physical RAM\n", 0
0152   80DF 69 6E 67 20 
0152   80E3 6B 65 72 6E 
0152   80E7 65 6C 20 70 
0152   80EB 61 67 65 2D 
0152   80EF 74 61 62 6C 
0152   80F3 65 20 74 6F 
0152   80F7 20 70 68 79 
0152   80FB 73 69 63 61 
0152   80FF 6C 20 52 41 
0152   8103 4D 0A 00 
0153   8106 0A 0D 69 6E s_masks:         .db "\n\rinterrupt masks register set to 0xFF\n", 0
0153   810A 74 65 72 72 
0153   810E 75 70 74 20 
0153   8112 6D 61 73 6B 
0153   8116 73 20 72 65 
0153   811A 67 69 73 74 
0153   811E 65 72 20 73 
0153   8122 65 74 20 74 
0153   8126 6F 20 30 78 
0153   812A 46 46 0A 00 
0154   812E 6C 6F 61 64 s_boot:          .db "loading kernel from disk", 0
0154   8132 69 6E 67 20 
0154   8136 6B 65 72 6E 
0154   813A 65 6C 20 66 
0154   813E 72 6F 6D 20 
0154   8142 64 69 73 6B 
0154   8146 00 
0155   8147 65 6E 74 65 s_bios2:         .db "entering protected-mode\n"
0155   814B 72 69 6E 67 
0155   814F 20 70 72 6F 
0155   8153 74 65 63 74 
0155   8157 65 64 2D 6D 
0155   815B 6F 64 65 0A 
0156   815F 73 74 61 72                  .db "starting kernel\n", 0
0156   8163 74 69 6E 67 
0156   8167 20 6B 65 72 
0156   816B 6E 65 6C 0A 
0156   816F 00 
0157   8170             
0158   8170 30 31 32 33 s_hex_digits:   .db "0123456789ABCDEF"
0158   8174 34 35 36 37 
0158   8178 38 39 41 42 
0158   817C 43 44 45 46 
0159   8180             
0160   8180 0A 72 65 61 s_read_super:      .db "\nreading superblock...\n", 0
0160   8184 64 69 6E 67 
0160   8188 20 73 75 70 
0160   818C 65 72 62 6C 
0160   8190 6F 63 6B 2E 
0160   8194 2E 2E 0A 00 
0161   8198 0A 74 6F 74 s_total_inodes:    .db "\ntotal inodes: ", 0
0161   819C 61 6C 20 69 
0161   81A0 6E 6F 64 65 
0161   81A4 73 3A 20 00 
0162   81A8 0A 74 6F 74 s_total_blocks:    .db "\ntotal blocks: ", 0
0162   81AC 61 6C 20 62 
0162   81B0 6C 6F 63 6B 
0162   81B4 73 3A 20 00 
0163   81B8 0A 66 72 65 s_free_inodes:     .db "\nfree inodes: ", 0
0163   81BC 65 20 69 6E 
0163   81C0 6F 64 65 73 
0163   81C4 3A 20 00 
0164   81C7 0A 66 72 65 s_free_blocks:     .db "\nfree blocks: ", 0
0164   81CB 65 20 62 6C 
0164   81CF 6F 63 6B 73 
0164   81D3 3A 20 00 
0165   81D6 0A 62 6C 6F s_block_bitmap:    .db "\nblock bitmap: ", 0
0165   81DA 63 6B 20 62 
0165   81DE 69 74 6D 61 
0165   81E2 70 3A 20 00 
0166   81E6 0A 69 6E 6F s_inode_bitmap:    .db "\ninode bitmap: ", 0
0166   81EA 64 65 20 62 
0166   81EE 69 74 6D 61 
0166   81F2 70 3A 20 00 
0167   81F6 0A 69 6E 6F s_inode_table:     .db "\ninode table: ", 0
0167   81FA 64 65 20 74 
0167   81FE 61 62 6C 65 
0167   8202 3A 20 00 
0168   8205 0A 6E 75 6D s_used_dirs:       .db "\nnumber of used directories: ", 0
0168   8209 62 65 72 20 
0168   820D 6F 66 20 75 
0168   8211 73 65 64 20 
0168   8215 64 69 72 65 
0168   8219 63 74 6F 72 
0168   821D 69 65 73 3A 
0168   8221 20 00 
0169   8223 0A 75 73 65 s_used_dirs_count: .db "\nused dirs count: ", 0
0169   8227 64 20 64 69 
0169   822B 72 73 20 63 
0169   822F 6F 75 6E 74 
0169   8233 3A 20 00 
0170   8236 0A 75 75 69 s_uuid:            .db "\nuuid: ", 0
0170   823A 64 3A 20 00 
0171   823E 0A 76 6F 6C s_vol_name:        .db "\nvolume name: ", 0
0171   8242 75 6D 65 20 
0171   8246 6E 61 6D 65 
0171   824A 3A 20 00 
0172   824D             
0173   824D             .end
tasm: Number of errors = 0
